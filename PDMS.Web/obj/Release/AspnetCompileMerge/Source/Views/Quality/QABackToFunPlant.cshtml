@*@model IEnumerable<PDMS.Model.SystemRoleDTO>*@
<!-- Main content -->

@{

    ViewBag.Edit = T("QA.Edit").Text;
    ViewBag.Enterpercentages = T("QA.Enterpercentages").Text;
    ViewBag.Successfullymodified = T("QA.Successfullymodified").Text;
    ViewBag.Submittedsuccessfully = T("QA.Submittedsuccessfully").Text;

}
<style>
    tr:hover {
        background-color: Highlight !important;
        color: red;
    }
</style>
<section class="content-header portal-content-header">
    <h1>
        <input type="hidden" id="CriteriaHidden" value=@ViewBag.Criteria />
        <small>@ViewBag.Criteria</small>
    </h1>
</section>
<section class="content portal-content">
    <div class="row">
        <div class="col-md-12 col-lg-9">

        </div>
        <div class="col-md-12 search-field col-lg-3">
            <a class="btn btn-primary btn-sm" data-toggle="modal" data-target="#js_search_modal" id="js_btn_search"><i class="fa fa-search"></i> @T("QA.Search")</a>
        </div>
    </div>

    <hr class="hr-custom">


    <!--row Search Keyword collapse-->
    <div id="day_label_th">
        <label>@T("QA.Plantarea"):</label><label id="js_Plant"></label>&
        <label>@T("QA.OPType"):</label><label id="js_OPType"></label>&
        <label>@T("QA.Project"):</label><label id="js_project"></label>&
        <label>@T("QA.Part"):</label><label id="js_PartType"></label>&
        <label>@T("QA.Yieldtype"):</label><label id="js_RateType"></label>&
        <label>@T("QA.Date"):</label><label id="js_datetime"></label>&
        <label>@T("QA.Materialtypes"):</label><label id="js_meterialType"></label>&
        <label>@T("QA.Colour"):</label><label id="js_color"></label>
        <label>@T("QA.Functionfactory"):</label><label id="js_FunPlant"></label>&
        <label>@T("QA.Checkpoint"):</label><label id="js_Process"></label>
    </div>
    <!--row Search Keyword collapse-->
    <!--內容 表格列-->
    <div class="row">
        <!--表格-->
        <div class="col-md-12 table-container">
            <table class="table table-striped table-hover table-condensed nowrap" id="js_QABackToFunPlant_datatable">
                <thead>
                    <tr>

                        <th class="table-col-seq nosort">@T("Common.Seq")</th>
                        <th class="table-col-action nosort">@T("Common.Action")</th>
                        <th>@T("QA.Baddetail")</th>
                        <th>@T("QA.Badrate")</th>
                        <th>@T("QA.CNC")</th>
                        <th>@T("QA.Surface")</th>
                        <th>@T("QA.Anode")</th>
                        <th>@T("QA.Assembly")</th>
                        <th>@T("QA.OQC")</th>
                    </tr>
                </thead>

            </table>
            <div id="page" class="row" hidden="hidden"></div>

        </div><!--/表格-->
    </div><!-- / 內容 表格列 -->
    <div class="bottom_btn">
        <div class="col-xs-12" style="padding-top:20px">
            <div class="col-xs-9"></div>
            <div class="col-xs-1"></div>
            <div class="col-xs-1">
                <button id="btn-submit-inner" type="button" class="btn btn-primary btn-query">@T("QA.Submit")</button>
            </div>
        </div><!-- /col-次標題與Search keyword -->

    </div>

</section><!-- /.content -->
@section ViewModals{

    <!-- Search Modal -->
    <div class="modal fade" id="js_search_modal" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title">@T("QA.Queryconditions")</h4>
                </div>
                <div class="modal-body form-horizontal">
                    <div class="row">
                        <form id="js_form_query" data-need-validate="true">
                            <input type="hidden" name="ProjectName" id="js_s_input_ProjectName" value="0" />

                            <div class="form-group col-xs-12 col-md-6">
                                <label class="col-sm-5 control-label" for="js_s_input_Plant">@T("QA.Plantarea")</label>
                                <div class="col-sm-7 ">
                                    <select class="form-control input-sm" id="js_s_input_Plant" name="Plant"></select>
                                </div>
                            </div>

                            <div class="form-group col-xs-12 col-md-6">
                                <label class="col-sm-5 control-label" for="js_s_input_OPType">@T("QA.OPType")</label>
                                <div class="col-sm-7 ">
                                    <select class="form-control input-sm" id="js_s_input_OPType" name="OPType"></select>
                                </div>
                            </div>

                            <div class="form-group col-xs-12 col-md-6">
                                <label class="col-sm-5 control-label" for="js_s_input_project">@T("QA.Project")</label>
                                <div class="col-sm-7 ">
                                    <select class="form-control input-sm " id="js_s_input_project" name="Project_UID"></select>
                                </div>
                            </div>

                            <div class="form-group col-xs-12 col-md-6">
                                <label class="col-sm-5 control-label" for="js_s_input_Part_Type">@T("QA.Part")</label>
                                <div class="col-sm-7 ">
                                    <select class="form-control input-sm " id="js_s_input_Part_Type" name="FlowChart_Master_UID"></select>
                                </div>
                            </div>
                            <div class="form-group col-xs-12 col-md-6">
                                <label class="col-sm-5 control-label" for="js_s_RateType">@T("QA.Querytype")</label>
                                <div class="col-sm-7">
                                    <select id="js_s_RateType" name="RateType" class="form-control input-sm">
                                        <option value="1" selected="selected">@T("QA.Ayield")</option>
                                        <option value="2">@T("QA.Secondaryyield")</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group col-xs-12 col-md-6">
                                <label class="col-sm-5 control-label" for="js_s_input_MaterialType">@T("QA.Materialtypes")</label>
                                <div class="col-sm-7 ">

                                    <select class="form-control input-sm" id="js_s_input_MaterialType" name="MaterialType"></select>
                                </div>
                            </div>

                            <div class="form-group col-xs-12 col-md-6">
                                <label class="col-sm-5 control-label" for="js_s_input_FunPlant">@T("QA.Functionfactory")</label>
                                <div class="col-sm-7 ">
                                    <select class="form-control input-sm" id="js_s_input_FunPlant" name="System_FunPlant_UID"></select>
                                </div>
                            </div>

                            @*日报选项*@
                            <div class="form-group col-xs-12 col-md-6" id="day_Select">
                                <label class="col-sm-5 control-label" for="js_s_input_date">@T("QA.Date")</label>
                                <div class="col-sm-7">
                                    <div class="input-group">
                                        <div class="input-group-addon">
                                            <i class="fa fa-calendar"></i>
                                        </div>
                                        <input type="text" name="ProductDate" class="form-control input-sm date" id="js_s_input_date">
                                    </div>
                                </div>
                            </div>

                            <div class="form-group col-xs-12 col-md-6">
                                <label class="col-sm-5 control-label" for="js_s_input_color">@T("QA.Colour")</label>
                                <div class="col-sm-7 ">
                                    <select class="form-control input-sm" id="js_s_input_color" name="Color"></select>
                                </div>
                            </div>

                            <div class="form-group col-xs-12 col-md-6">
                                <label class="col-sm-5 control-label" for="js_s_input_process">@T("QA.Checkpoint")</label>
                                <div class="col-sm-7 ">
                                    <select class="form-control input-sm" id="js_s_input_process" name="FlowChart_Detail_UID"></select>
                                </div>
                            </div>


                            <input type="hidden" name="Tab_Select_Text" id="js_tab_select_text" value="0" />
                        </form>
                    </div>
                </div>
                <div class="modal-footer">
                    <button id="btn-search" type="button" class="btn btn-primary btn-query">
                        @T("QA.Inquire")
                    </button>
                    <button id="btn-export" type="button" class="btn btn-primary btn-query">
                        @T("QA.Cancel")
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div class="modal fade" id="js_edit_modal" role="dialog">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title">@T("QA.Edit")</h4>
                </div>
                <form id="js_form_org_edit" class="form-horizontal clearfix">
                    <div class="modal-body">
                        <div class="form-group col-xs-12 col-md-6 col-lg-6">
                            <input type="hidden" name="QualityAssurance_DistributeRate_UID" id="js_s_select_QualityAssurance_DistributeRate_UID" />
                            <label class="col-sm-4 control-label" for="js_s_edit_ExceptionTypeName">@T("QA.Baddetail")</label>
                            <div class="col-sm-8">
                                <input type="text" name="ExceptionTypeName" disabled="disabled" class="form-control input-sm" id="js_s_edit_ExceptionTypeName">
                            </div>
                        </div>
                        <div class="form-group col-xs-12 col-md-6 col-lg-6">
                            <label class="col-sm-4 control-label" for="js_s_select_Yield">@T("QA.Badrate")</label>
                            <div class="col-sm-8">
                                <input type="text" name="Yield" class="form-control input-sm" disabled="disabled" id="js_s_select_Yield">
                            </div>
                        </div>
                        <div class="form-group col-xs-12 col-md-6 col-lg-6">
                            <label class="col-sm-4 control-label" for="js_s_input_CNC_Yield">@T("QA.CNC")</label>
                            <div class="col-sm-8">
                                <input type="text" name="CNC_RateVM" class="form-control input-sm" id="js_s_input_CNC_Yield">
                            </div>

                        </div>
                        <div class="form-group col-xs-12 col-md-6 col-lg-6">
                            <label class="col-sm-4 control-label" for="js_s_input_Surface_Yield">@T("QA.Surface")</label>
                            <div class="col-sm-8">
                                <input type="text" name="Surface_RateVM" class="form-control input-sm" id="js_s_input_Surface_Yield">
                            </div>
                        </div>

                        <div class="form-group col-xs-12 col-md-6 col-lg-6">
                            <label class="col-sm-4 control-label" for="js_s_input_Anode_Yield">@T("QA.Anode")</label>
                            <div class="col-sm-8">
                                <input type="text" name="Anode_RateVM" class="form-control input-sm" id="js_s_input_Anode_Yield">
                            </div>
                        </div>

                        <div class="form-group col-xs-12 col-md-6 col-lg-6">
                            <label class="col-sm-4 control-label" for="js_s_input_Assemble_Yield">@T("QA.Assembly")</label>
                            <div class="col-sm-8">
                                <input type="text" name="Assemble_RateVM" class="form-control input-sm" id="js_s_input_Assemble_Yield">
                            </div>
                        </div>

                        <div class="form-group col-xs-12 col-md-6 col-lg-6">
                            <label class="col-sm-4 control-label" for="js_s_input_OQC_Yield">@T("QA.OQC")</label>
                            <div class="col-sm-8">
                                <input type="text" class="form-control input-sm" id="js_s_input_OQC_Yield" name="OQC_RateVM">
                            </div>
                        </div>

                    </div>
                </form>
                <div class="modal-footer">
                    <button class="btn btn-primary btn-sm" data-dismiss="modal"><i class="fa fa-times"></i> @T("QA.Cancel")</button>
                    <button type="button" class="btn btn-primary btn-sm" id="js_btn_save"><i class="fa fa-save"></i> @T("QA.Save")</button>
                </div>
                <div class="col-xs-12"><ul class="list-group validate-error"></ul></div>
            </div>
        </div>
    </div>

}

@section ViewScripts{
    <script type="text/javascript">
        $(function () {

            var QABackToFunPlantUrls = {
                queryBackToFunPlantInfo: '@Url.Action("QueryQABackToFunPlantInfo", "Quality")',
                QueryQABTFInfoByUID: '@Url.Action("QueryQABTFInfoByUID", "Quality")',
                UpdateQABTFInfoByUID: '@Url.Action("UpdateQABTFInfoByUID", "Quality")',
                SaveBackToFunPlantInfo: '@Url.Action("SaveBackToFunPlantInfo", "Quality")',
                QueryFunPlant: '@Url.Action("QueryFunPlant", "Quality")',
                UpdateBackToFunPlantInfo: '@Url.Action("UpdateBackToFunPlantInfo", "Quality")',
            };
            //#region QABackToFunPlantsetting
            var QABackToFunPlantsetting = (function () {
                var functionDatatable = null,
                    subDatatable = null,
                    editData = null;
                //#region columns
                var columns = [
                {
                    data: null,
                    className: "table-col-seq min-col-xs"
                },
                {
                    data: null,
                    createdCell: function (td, cellData, rowData, row, col) {
                        if (rowData.QualityAssurance_DistributeRate_UID == null || rowData.QualityAssurance_DistributeRate_UID == "00000000-0000-0000-0000-000000000000" || !rowData.CanModify)
                        {
                            var editHtml = '<button type="button" class="btn btn-primary btn-xs js-grid-edit" disabled="disabled"  data-id="' + rowData.QualityAssurance_DistributeRate_UID + '">@ViewBag.Edit</button>'
                            + '  <input type="text"   style="display:none;" name="QualityAssurance_DistributeRate_UID"  value="' + rowData.QualityAssurance_DistributeRate_UID + '">'
                            + '  <input type="text" style="display:none;" name="Flowchart_Master_UID"  value="' + rowData.Flowchart_Master_UID + '">'
                            + '  <input type="text" style="display:none;" name="FlowChart_Detail_UID"  value="' + rowData.FlowChart_Detail_UID + '">'
                            + '  <input type="text" style="display:none;" name="System_FunPlant_UID"  value="' + rowData.System_FunPlant_UID + '">'
                            + '  <input type="text" style="display:none;" name="RejectionRateVM"  value="' + rowData.RejectionRateVM + '">'
                            + '  <input type="text" style="display:none;" name="ExceptionTypeName"  value="' + rowData.ExceptionTypeName + '">'
                            + '  <input type="text"   style="display:none;" name="ExceptionType_UID"  value="' + rowData.ExceptionType_UID + '">';
                            $(td).html(editHtml);
                        }
                        else
                        {
                            var editHtml = '<button type="button" class="btn btn-primary btn-xs js-grid-edit" data-id="' + rowData.QualityAssurance_DistributeRate_UID + '">@ViewBag.Edit</button>'
                            + '  <input type="text" style="display:none;" name="QualityAssurance_DistributeRate_UID"  value="' + rowData.QualityAssurance_DistributeRate_UID + '">'
                            + '  <input type="text" style="display:none;" name="Flowchart_Master_UID"  value="' + rowData.Flowchart_Master_UID + '">'
                            + '  <input type="text" style="display:none;" name="FlowChart_Detail_UID"  value="' + rowData.FlowChart_Detail_UID + '">'
                            + '  <input type="text" style="display:none;" name="System_FunPlant_UID"  value="' + rowData.System_FunPlant_UID + '">'
                            + '  <input type="text" style="display:none;" name="RejectionRateVM"  value="' + rowData.RejectionRateVM + '">'
                            + '  <input type="text" style="display:none;" name="ExceptionTypeName"  value="' + rowData.ExceptionTypeName + '">'
                            + '  <input type="text" style="display:none;" name="ExceptionType_UID"  value="' + rowData.ExceptionType_UID + '">';
                            $(td).html(editHtml);
                        }
                    },
                    className: "text-center min-col-xs"
                },
                {
                    data: "ExceptionTypeName",
                    className: "min-col-xs"
                },
                {
                    data: "RejectionRateVM",
                    className: "min-col-xs"
                },
                {
                    data: null,
                    createdCell: function (td, cellData, rowData, row, col) {

                        if (rowData.QualityAssurance_DistributeRate_UID != null && rowData.QualityAssurance_DistributeRate_UID != "00000000-0000-0000-0000-000000000000")
                            $(td).html('  <input type="text" class="form-control input-xs text-center" disabled="disabled"   name="CNC_RateVM"  value="' + rowData.CNC_RateVM + '">');
                        else

                            $(td).html('  <input type="text" class="form-control input-xs text-center"  name="CNC_RateVM"  value="' + "" + '">');

                    },
                    className: "min-col-xs"
                },
                {
                    data:null,
                    createdCell: function (td, cellData, rowData, row, col) {

                        if (rowData.QualityAssurance_DistributeRate_UID != null&& rowData.QualityAssurance_DistributeRate_UID != "00000000-0000-0000-0000-000000000000")
                            $(td).html('  <input type="text" class="form-control input-xs text-center" disabled="disabled"   name="Surface_RateVM"  value="' + rowData.Surface_RateVM + '">');
                        else

                            $(td).html('  <input type="text" class="form-control input-xs text-center"  name="Surface_RateVM"  value="' + "" + '">');

                    },
                    className: "min-col-xs"
                }, {
                    data:null,
                    createdCell: function (td, cellData, rowData, row, col) {

                        if (rowData.QualityAssurance_DistributeRate_UID != null && rowData.QualityAssurance_DistributeRate_UID != "00000000-0000-0000-0000-000000000000")
                            $(td).html('  <input type="text" class="form-control input-xs text-center" disabled="disabled"   name="Anode_RateVM"  value="' + rowData.Anode_RateVM + '">');
                        else

                            $(td).html('  <input type="text" class="form-control input-xs text-center"  name="Anode_RateVM"  value="' + "" + '">');

                    },
                    className: "min-col-lg"
                },
                {
                    data: null,
                    createdCell: function (td, cellData, rowData, row, col) {

                        if (rowData.QualityAssurance_DistributeRate_UID != null && rowData.QualityAssurance_DistributeRate_UID != "00000000-0000-0000-0000-000000000000")
                            $(td).html('  <input type="text" class="form-control input-xs text-center" disabled="disabled"   name="Assemble_RateVM"  value="' + rowData.Assemble_RateVM + '">');
                        else

                            $(td).html('  <input type="text" class="form-control input-xs text-center"  name="Assemble_RateVM"  value="' + "" + '">');

                    },
                    className: "min-col-lg"
                }, {
                    data:null,
                    createdCell: function (td, cellData, rowData, row, col) {
                        if (rowData.QualityAssurance_DistributeRate_UID != null && rowData.QualityAssurance_DistributeRate_UID != "00000000-0000-0000-0000-000000000000")
                            $(td).html('  <input type="text" class="form-control input-xs text-center" disabled="disabled"   name="OQC_RateVM"  value="' + rowData.OQC_RateVM + '">');
                        else

                            $(td).html('  <input type="text" class="form-control input-xs text-center"  name="OQC_RateVM"  value="' + "" + '">');

                    },
                    className: "min-col-lg"
                }
                ];
                //#endregion
                var _getParams = function () {
                    return $('#js_form_query').serialize().replace(/\+/g, " ");
                };

                var _queryQABackToFunPlants = function (firstLoad) {
                    var config = {
                        pageId: "#page",
                        tableId: "#js_QABackToFunPlant_datatable",
                        remoteUrl: QABackToFunPlantUrls.queryBackToFunPlantInfo,
                        searchParams: _getParams(),
                        tableOptions: {
                            scrollX: true,
                            scrollCollapse: false,
                            autoWidth: true,
                            columns: columns
                        }
                    };

                    if (!firstLoad) {
                        $('#page').page('destroy');
                        PDMS.Utility.Criteria.Build();
                    }

                    PDMS.Utility.Pages.Set(config);
                };

                return {
                    Init: function () {
                        PDMS.Utility.Criteria.Init();
                        _queryQABackToFunPlants(true);
                    },
                    QueryQABackToFunPlants: function () {
                        _queryQABackToFunPlants(false);
                    },
                    GetFunctionDatatable: function () {
                        if (functionDatatable == null) {
                            functionDatatable = $('#js_QABackToFunPlant_datatable').DataTable({
                                paging: false,
                                searching: false,
                                ordering: false,
                                retrieve: true,
                                columns: columns,
                            });
                        }
                        return functionDatatable;
                    },
                }
            })();
            //#endregion
            QABackToFunPlantsetting.Init();
            QueryPlant();
            //#region ------ 查询条件的五级联动
            $("#js_s_input_Plant").change(function ff() {
                GetOPType();
            });
            $("#js_s_input_OPType").change(function ff() {
                GetProject();
            });
            $("#js_s_input_project").change(function ff() {
                GetPartType();
            });
            $("#js_s_input_Part_Type").change(function ff() {
                QueryFunPlant();
            });
            $("#js_s_input_FunPlant").change(function ff() {
                QueryColor();
            });
            $("#js_s_input_date").change(function ff() {
                QueryColor();
            });
            $("#js_s_input_MaterialType").change(function ff() {
                QueryColor();
            });
            function QueryPlant() {
                var url = '../Quality/QueryPlant';
                $.post(url, function (data) {
                    if (data != "") {
                        $("#js_s_input_Plant").empty();
                        $.each(data, function (i, item) {
                            $("<option></option>")
                                .val(item.Organization_UID)
                                .text(item.Name)
                                .appendTo($("#js_s_input_Plant"));
                        });
                        GetOPType();
                    }
                });
            }
            function GetOPType() {
                var Plant_OrganizationUID = $("#js_s_input_Plant").val();
                var url = '../Quality/QueryOPType';
                $.post(url, { Plant_OrganizationUID: Plant_OrganizationUID }, function (data) {
                    if (data != "") {
                        $("#js_s_input_OPType").empty();
                        $.each(data, function (i, item) {
                            $("<option></option>")
                                .val(item.Organization_UID)
                                .text(item.Name)
                                .appendTo($("#js_s_input_OPType"));
                        });
                        GetProject();
                    }
                });
            }
            function GetProject() {
                var OPType_Organization_UID = $("#js_s_input_OPType").val();
                var url = '../Quality/GetQAProject';
                $.post(url, { OPType_Organization_UID: OPType_Organization_UID }, function (data) {
                    if (data != "") {
                        var mType = data.MaterielType;
                        var project = data.Project;
                        $("#js_s_input_project").empty();
                        $.each(project, function (i, item) {
                            $("<option></option>")
                                .val(item.Project_UID)
                                .text(item.ProjectName)
                                .appendTo($("#js_s_input_project"));
                        });

                        $("#js_s_input_MaterialType").empty();
                        $.each(mType, function (i, item) {
                            $("<option></option>")
                                .val(item)
                                .text(item)
                                .appendTo($("#js_s_input_MaterialType"));
                        });
                        GetPartType();
                    }
                });
            }
            function GetPartType() {
                $("#js_s_input_Part_Type").empty();
                var Project_UID = $("#js_s_input_project").val();
                var url = '../Quality/GetPartType';
                $.post(url, { Project_UID: Project_UID }, function (data) {
                    if (data != "") {
                        $.each(data, function (i, item) {
                            $("<option></option>")
                                .val(item.FlowChart_Master_UID)
                                .text(item.Part_Type)
                                .appendTo($("#js_s_input_Part_Type"));
                        });
                    }
                    QueryFunPlant();
                });
            }
            function QueryFunPlant() {
                var FlowChart_Master_UID = $("#js_s_input_Part_Type").val();
                if (FlowChart_Master_UID == null) {
                    return;
                }
                $.post(QABackToFunPlantUrls.QueryFunPlant, { FlowChart_Master_UID: FlowChart_Master_UID }, function (data) {
                    if (data != "") {
                        $("#js_s_input_FunPlant").empty();
                        $.each(data, function (i, item) {
                            $("<option></option>")
                                .val(item.System_FunPlant_UID)
                                .text(item.FunPlant)
                                .appendTo($("#js_s_input_FunPlant"));
                        });
                    }
                    QueryColor();
                });
            }
            function QueryColor() {
                $("#js_s_input_color").empty();
                var fun_plant = "IPQC";
                var Flowchart_Master_UID = $("#js_s_input_Part_Type").find("option:selected").val();
                var productDate = $("#js_s_input_date").val();
                var MaterialType = $("#js_s_input_MaterialType").val();
                if (productDate == null || productDate == "") {
                    return;
                }
                if (Flowchart_Master_UID == null || Flowchart_Master_UID == "") {
                    return;
                }
                var url = '../Quality/QueryRecordColor';
                $.post(url, { Flowchart_Master_UID: Flowchart_Master_UID, FunPlant: fun_plant, ProductDate: productDate, MaterialType: MaterialType }, function (data) {
                    if (data != "") {
                        $.each(data, function (i, item) {
                            $("<option></option>")
                                .val(item)
                                .text(item)
                                .appendTo($("#js_s_input_color"));
                        });
                    }
                    GetProcess();
                });

            }
            function GetProcess() {
                var Product_Date = $("#js_s_input_date").val();
                if (Product_Date == "") {
                    return;
                }
                var Flowchart_Master_UID = $('#js_s_input_Part_Type').val();

                $("#js_s_input_process").empty();
                var FunPlant = $('#js_s_input_FunPlant').find("option:selected").text();
                var url = '../Quality/GetProcessSource';
                var Color = $("#js_s_input_color").val();
                $.post(url, { Flowchart_Master_UID: Flowchart_Master_UID, FunPlant: FunPlant, Product_Date: Product_Date, Color: Color }, function (data) {
                    if (data != "") {
                        $("<option></option>").val(0).text("ALL").appendTo($("#js_s_input_process"));
                        $.each(data, function (i, item) {
                            $("<option></option>")
                                .val(item.FlowChart_Detail_UID)
                                .text(item.ProcessName)
                                .appendTo($("#js_s_input_process"));
                        });
                    }
                });
            }
            //#endregion
            //查询按钮
            $('#btn-search').click(function () {
                if ($("#js_form_query").valid()) {
                    QABackToFunPlantsetting.QueryQABackToFunPlants();
                    var date = $("#js_s_input_date").val();
                    var mtype = $("#js_s_input_MaterialType").val();
                    var color = $("#js_s_input_color").val();
                    var project = $("#js_s_input_project").find("option:selected").text();
                    var plant = $("#js_s_input_plant").find("option:selected").text();
                    var OpType = $("#js_s_input_OPType").find("option:selected").text();
                    var PartType = $("#js_s_input_Part_Type").find("option:selected").text();
                    var RateType = $("#js_s_RateType").find("option:selected").text();
                    var funplant = $("#js_s_input_FunPlant").find("option:selected").text();
                    var RateType = $("#js_s_input_process").find("option:selected").text();
                    $("#js_Plant").val(plant);
                    $("#js_OPType").val(OpType);
                    $("#js_project").text(project);
                    $("#js_PartType").text(PartType);
                    $("#js_RateType").text(RateType);
                    $("#js_datetime").text(date);
                    $("#js_meterialType").text(mtype);
                    $("#js_color").text(color);
                    $("#js_FunPlant").text(funplant);
                    $("#js_Process").text(RateType);
                    $('#js_search_modal').modal('hide');
                }
            });
            //查询清除
            $('#js_btn_clear').click(function () {
                PDMS.Utility.Criteria.Clear(function () {
                    $('#js_s_querytype_valid').prop('checked', true);
                });
            });
            function SetSearchTypeName() {
                var result = $("#js_s_select_first_type").find("option:selected").text();
                if (result == '') {
                    result = $("#js_s_select_second_type").find("option:selected").text();
                    if (result == '') {
                        result = $("#js_s_select_three_type").find("option:selected").text();
                    }
                }
                $("#js_s_select_type_name").empty();
                $("#js_s_select_type_name").val(result);
            }
            $('#js_search_add_modal').on('hide.bs.modal', function (event) {
                $("#js_s_add_type_name").val("");
                $("#js_s_add_function_id").val("");
                $("#js_s_add_function_name").val("");
                $("#js_s_add_first_type").empty();
                $("#js_s_add_second_type").empty();
                $("#js_s_add_three_type").empty();
            });
            $('#js_search_modal').on('hide.bs.modal', function (event) {
                $("#js_s_select_type_name").val("");
                $("#js_s_input_function_ShortName").val("");
                $("#js_s_input_function_name").val("");
                $("#js_s_select_first_type").empty();
                $("#js_s_select_second_type").empty();
                $("#js_s_select_three_type").empty();
            });
            //#endregion
            //#endregion
            //保存修改
            $("#js_btn_save").click(function ff() {
                function checkRate(input) {
                    var re = /^(100|[1-9]?\d(\.\d\d?\d?)?)%$|0$/;
                    if (!re.test(input)) {
                        PDMS.Utility.MessageBox.error("@ViewBag.Enterpercentages");
                        flag = false;
                    }
                }
                function GetRate(input) {
                    if (input == 0) {
                        return 0;
                    }
                    else {
                        return input.replace(/%/, '') / 100 * 1.0;
                    }
                }
                var CNC_Rate = $('#js_s_input_CNC_Yield').val();
                var Surface_Rate = $('#js_s_input_Surface_Yield').val();
                var Anode_Rate = $('#js_s_input_Anode_Yield').val();
                var Assemble_Rate = $('#js_s_input_Assemble_Yield').val();
                var OQC_Rate = $('#js_s_input_OQC_Yield').val();
                var QualityAssurance_DistributeRate_UID = $('#js_s_select_QualityAssurance_DistributeRate_UID').val();
                if (CNC_Rate == "") {
                    CNC_Rate = 0;
                }
                else {
                    checkRate(CNC_Rate);
                }

                if (Surface_Rate == "") {
                    Surface_Rate = 0;
                }
                else {
                    checkRate(Surface_Rate);
                }

                if (Anode_Rate == "") {
                    Anode_Rate = 0;
                }
                else {
                    checkRate(Anode_Rate);
                }
                if (Assemble_Rate == "") {
                    Assemble_Rate = 0;
                }
                else {
                    checkRate(Assemble_Rate);
                }

                if (OQC_Rate == "") {
                    OQC_Rate = 0;
                }
                else {
                    checkRate(OQC_Rate);
                }
                var sub = {};
                sub["QualityAssurance_DistributeRate_UID"] = QualityAssurance_DistributeRate_UID;
                sub["CNC_Rate"] = GetRate(CNC_Rate);
                sub["Surface_Rate"] = GetRate(Surface_Rate);
                sub["Anode_Rate"] = GetRate(Anode_Rate);
                sub["Assemble_Rate"] = GetRate(Assemble_Rate);
                sub["OQC_Rate"] = GetRate(OQC_Rate);
                $.post(QABackToFunPlantUrls.UpdateBackToFunPlantInfo, { jsonWithProduct: JSON.stringify(sub) }, function (data) {
                    if (data == 'Success') {
                        PDMS.Utility.MessageBox.info("@ViewBag.Successfullymodified");
                        $('#js_edit_modal').modal('hide');
                        QABackToFunPlantsetting.QueryQABackToFunPlants();
                    } else {
                        PDMS.Utility.MessageBox.error(data);
                        $('#errorModal').on('click', '.btn-default', function () {
                            QABackToFunPlantsetting.QueryQABackToFunPlants();
                        });
                    }
                });
            });
            //Grid中编辑按钮
            $('body').on('click', '.js-grid-edit', function () {
                var $sender = $(this);
                var QualityAssurance_DistributeRate_UID = $sender.attr('data-id'),
                    url = QABackToFunPlantUrls.QueryQABTFInfoByUID;
                $.post(url, { QualityAssurance_DistributeRate_UID: QualityAssurance_DistributeRate_UID }, function (data) {
                    $('#js_s_select_QualityAssurance_DistributeRate_UID').val(QualityAssurance_DistributeRate_UID);
                    $('#js_s_edit_ExceptionTypeName').val(data.ExceptionTypeName);
                    $('#js_s_select_Yield').val(data.RejectionRateVM);
                    $('#js_s_input_CNC_Yield').val(data.CNC_RateVM);
                    $('#js_s_input_Surface_Yield').val(data.Surface_RateVM);
                    $('#js_s_input_Anode_Yield').val(data.Anode_RateVM);
                    $('#js_s_input_Assemble_Yield').val(data.Assemble_RateVM);
                    $('#js_s_input_OQC_Yield').val(data.OQC_RateVM);
                });
                $('#js_edit_modal').modal('show', $(this));
            });
            //保存资料按钮
            $('#btn-submit-inner').click('click', function () {
                var dataTable = QABackToFunPlantsetting.GetFunctionDatatable();
                var funPlantValue = {};
                var funPlantInfo = [];
                var flag = true;
                // 首先检查用户输入的数字是否为 百分数
                function checkRate(input) {
                    if (!flag)
                    { return; }
                    var re = /^(100|[1-9]?\d(\.\d\d?\d?)?)%$|0$/;

                    if (!re.test(input)) {
                        PDMS.Utility.MessageBox.error("@ViewBag.Enterpercentages");
                        flag = false;
                    }
                }
                function GetRate(input)
                {
                    if(input==0)
                    {
                        return 0;
                    }
                    else
                    {
                        return input.replace(/%/, '')/100*1.0;
                    }
                }
                var ProductDate = $("#js_datetime").text();
                dataTable
                    .rows()
                    .every(function (rowIdx, tableLoop, rowLoop) {
                        var sub = {};
                        var row = $('#js_QABackToFunPlant_datatable>tbody>tr').eq(rowIdx);
                        var QualityAssurance_DistributeRate_UID = $.trim(row.find('input[name=QualityAssurance_DistributeRate_UID]').val());
                        var Flowchart_Master_UID = $.trim(row.find('input[name=Flowchart_Master_UID]').val());
                        var FlowChart_Detail_UID = $.trim(row.find('input[name=FlowChart_Detail_UID]').val());
                        var ExceptionType_UID = $.trim(row.find('input[name=ExceptionType_UID]').val());
                        var ExceptionTypeName = $.trim(row.find('input[name=ExceptionTypeName]').val());
                        var RejectionRate = $.trim(row.find('input[name=RejectionRateVM]').val());
                        var CNC_Rate = $.trim(row.find('input[name=CNC_RateVM]').val());
                        var Surface_Rate = $.trim(row.find('input[name=Surface_RateVM]').val());
                        var Anode_Rate = $.trim(row.find('input[name=Anode_RateVM]').val());
                        var Assemble_Rate = $.trim(row.find('input[name=Assemble_RateV]').val());
                        var OQC_Rate = $.trim(row.find('input[name=OQC_RateVM]').val());
                        var System_FunPlant_UID = $.trim(row.find('input[name=System_FunPlant_UID]').val());
                        var Color = $('#js_s_input_color').val();
                        var RateType = $('#js_s_RateType').val();
                        var MaterialType = $('#js_s_input_MaterialType').val();
                        // 用户未输入值时候，系统默认为"0"，输入值提交时 需要验证用户输入的值是否为自然数。
                        if (CNC_Rate == "") {
                            CNC_Rate = 0;
                        }
                        else {
                            checkRate(CNC_Rate);
                        }
                        if (Surface_Rate == "") {
                            Surface_Rate = 0;
                        }
                        else {
                            checkRate(Surface_Rate);
                        }
                        if (Anode_Rate == "") {
                            Anode_Rate = 0;
                        }
                        else {
                            checkRate(Anode_Rate);
                        }
                        if (Assemble_Rate == "") {
                            Assemble_Rate = 0;
                        }
                        else {
                            checkRate(Assemble_Rate);
                        }
                        if (OQC_Rate == "") {
                            OQC_Rate = 0;
                        }
                        else {
                            checkRate(OQC_Rate);
                        }
                        sub["MaterialType"] = MaterialType;
                        sub["Color"] = Color;
                        sub["RateType"] = RateType;
                        sub["Flowchart_Master_UID"] = Flowchart_Master_UID;
                        sub["FlowChart_Detail_UID"] = FlowChart_Detail_UID;
                        sub["QualityAssurance_DistributeRate_UID"] = QualityAssurance_DistributeRate_UID;
                        sub["ExceptionType_UID"] = ExceptionType_UID;
                        sub["ExceptionTypeName"] = ExceptionTypeName;
                        sub["System_FunPlant_UID"] = System_FunPlant_UID;
                        sub["RejectionRate"] = GetRate(RejectionRate);
                        sub["CNC_Rate"] = GetRate(CNC_Rate);
                        sub["Surface_Rate"] = GetRate(Surface_Rate);
                        sub["Anode_Rate"] = GetRate(Anode_Rate);
                        sub["Assemble_Rate"] =GetRate(Assemble_Rate);
                        sub["OQC_Rate"] = GetRate(OQC_Rate);
                        sub["ProductDate"] = ProductDate;
                        funPlantInfo.push(sub);
                    });
                funPlantValue.DataList = funPlantInfo;
                if (funPlantInfo.length > 0)
                {
                    if (flag) {
                        $.post(QABackToFunPlantUrls.SaveBackToFunPlantInfo, { jsonWithProduct: JSON.stringify(funPlantValue) }, function (data) {
                            if (data == 'Success') {
                                alert("@ViewBag.Submittedsuccessfully");
                                QABackToFunPlantsetting.QueryQABackToFunPlants();
                            } else {
                                PDMS.Utility.MessageBox.error(data);
                                $('#errorModal').on('click', '.btn-default', function () {
                                    QABackToFunPlantsetting.QueryQABackToFunPlants();
                                });
                            }
                        });
                    }
                }
            });
            function initVal()
            {
                if($("#CanModify").val() == false)
                {
                    $("#js_btn_add_role_function").css('display', 'none');
                    $("#btn-submit-inner").css('display', 'none');
                }
            }
            initVal();
        });
    </script>
}
