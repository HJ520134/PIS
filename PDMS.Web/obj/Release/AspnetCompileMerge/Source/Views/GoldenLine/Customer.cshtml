@model PDMS.Model.ViewModels.Fixture_PartVM

<style type="text/css">
    #customerDashbord {
        margin-top: 60px;
        margin-bottom: 20px;
    }

    .titlewhite {
        /*font-size: 12px;
        background-color: #546a74;
        border-color: #C6C6C6;
        border-top-left-radius: 3px;
        border: 1px ;
        padding: 6px 12px;*/
        font-size: 13px;
        background-color: #3c8dbc;
        border-top-left-radius: 3px;
        border: 1px solid #546a74;
        padding: 5px 10px;
        font-family: "Times New Roman", Times, serif;
        color: #ffffff;
    }

    .details {
        height: 140px;
    }

        .details .desctitle {
            float: left;
            font-size: 18px;
            line-height: 36px;
            font-weight: 300;
            text-align: left;
            padding-top: 50px;
            padding-left: 10px;
            width: 271px;
            text-align: center;
        }

            .details .desctitle span {
                color: #3c8dbc;
                background-color: rgba(255,255,255,0.5);
                padding: 5px;
            }

        .details .number {
            float: right;
            font-size: 34px;
            line-height: 36px;
            font-weight: 300;
            text-align: right;
            color: rgb(255, 0, 0);
            text-shadow: rgb(190, 190, 190) 5px 2px 6px;
            padding-top: 50px;
            padding-right: 46px;
        }

    .descfooter {
        clear: both;
        line-height: 20px;
        font-size: 18px;
        padding: 5px;
        background-color: rgba(5,5,5,0.3);
    }
    /*下拉框设置为白色背景*/
    #js_form_query select {
        background-color: #ffffff;
    }
</style>
<script type="text/javascript">
    function fullSr() {
        var docElm = document.documentElement;
        if (docElm.requestFullscreen) {
            docElm.requestFullscreen();
        }
        else if (docElm.msRequestFullscreen) {
            docElm = document.body; //overwrite the element (for IE)
            docElm.msRequestFullscreen();
        }
        else if (docElm.mozRequestFullScreen) {
            docElm.mozRequestFullScreen();
        }
        else if (docElm.webkitRequestFullScreen) {
            docElm.webkitRequestFullScreen();
        }
        $(".navbar-static-top").hide();
    }

    function cancFullSr() {
        if (document.exitFullscreen) {
            document.exitFullscreen();
        }
        else if (document.msExitFullscreen) {
            document.msExitFullscreen();
        }
        else if (document.mozCancelFullScreen) {
            document.mozCancelFullScreen();
        }
        else if (document.webkitCancelFullScreen) {
            document.webkitCancelFullScreen();
        }
        $(".navbar-static-top").show();
    }
</script>
<!-- Main content -->
<section class="content portal-content">
    <button id="view-fullscreen" class="titlewhite" onclick="fullSr()">@T("GL.FullScreen")</button>
    <button id="cancel-fullscreen" class="titlewhite" onclick="cancFullSr()">@T("GL.CancelFullScreen")</button>
    @*<div class="row">
            <div class="col-md-12 col-lg-8">
                <h4 class="margin-td-5" id="js_search_keywords"></h4>
            </div>
        </div>*@
    <hr class="hr-custom">


    @*<div class="row">
            <div id="js_criteria_alert_cnt">
            </div>
        </div>*@
    @*查询条件*@
    <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
        <form class="form-inline" id="js_form_query">
            <div class='form-group'>
                <label for="js_select_factory_query" class="titlewhite"><strong>@T("GL.Site")</strong></label>
                <select class="btn btn-default" id="js_select_factory_query" data-live-search="true">
                    @foreach (var item in Model.Plants)
                    {
                        <option value=@item.Plant_OrganizationUID>@item.Plant</option>
                    }
                </select>
            </div>
            <div class='form-group'>
                <label class="titlewhite" for="js_select_optype_query"><strong> @T("GL.BG")</strong></label>
                <select class="btn btn-default" id="js_select_optype_query" name="BG_Organization_UID" data-live-search="true"></select>
            </div>
            <div class='form-group' style="display:none">
                <label class="titlewhite" for="js_select_funplant_query"><strong> @T("GL.FunctionPlant")</strong></label>
                <select class="btn btn-default" id="js_select_funplant_query" name="FunPlant_Organization_UID" data-live-search="true"></select>
            </div>
            <div class='form-group'>
                <label class="titlewhite" for="js_select_project_query"><strong> @T("GL.Project")</strong></label>
                <select class="btn btn-default" id="js_select_project_query" name="customerId" data-live-search="true"></select>
            </div>
            <div class='form-group'>
                <label for="js_date_query" class="titlewhite"><strong> @T("GL.Date")</strong></label>
                <div class='input-group date' id='datetimepicker'>
                    <span class="input-group-addon">
                        <span class="glyphicon glyphicon-calendar"></span>
                    </span>
                    <input type='text' class="form-control" id="js_date_query" name="outputDate"data-date-format="mm/dd/yyyy" />
                </div>
            </div>
            <div class='form-group'>
                <label for="js_select_shiftTime_query" class="titlewhite"><strong> @T("GL.Shift")</strong></label>
                <select class="btn btn-default" id="js_select_shiftTime_query" name="shiftTimeId" data-live-search="true"></select>
            </div>
            <div class='form-group'>
                <input type="button" value='@T("GL.Search")' id="js_btn_query" class="btn btn-primary" />
            </div>
            <div class='form-group'>
                <button type="button" id="js_btn_exce_add" class="btn btn-info">@T("Exception.Publish")</button>
            </div>
        </form>
    </div>
    @*报表指数*@
    <div class="row" id="customerDashbord">
        <div class="col-lg-3 col-md-3 col-sm-3 col-xs-3">
            @*background-color:#3598dc;*@
            <div class="dashboard-stat blue" style="background:url(../Content/img/customer_1.png); background-size:100%;" title='@T("GL.ActualOutputVSPlanFormula")'>
                <div class="details">
                    <div class="number">
                        <span data-counter="counterup" id="outputvsplan">0.0</span>%
                    </div>
                </div>
                <div class="descfooter">
                    <a class="more" href="javascript:; " style="color:#ffffff;">
                        @T("GL.ActualOutputVSPlan")
                    </a>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-3 col-sm-3 col-xs-3">
            <div class="dashboard-stat green" style="background:url(../Content/img/customer_2.png); background-size:100%;" title='@T("GL.ActualOutputVSRealTimePlanFormula")'>
                <div class="details">
                    <div class="number">
                        <span data-counter="counterup" id="outputvsrealtimeplan">0.0</span>%
                    </div>
                </div>
                <div class="descfooter">
                    <a class="more" href="javascript:;" style="color:#ffffff;">
                        @T("GL.ActualOutputVSRealTimePlan")
                    </a>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-3 col-sm-3 col-xs-3">
            <div class="dashboard-stat blue-sharp" style="background:url(../Content/img/customer_3.png); background-size:100%;" title='@T("GL.LineUtilizationFormula")'>
                <div class="details">
                    <div class="number">
                        <span data-counter="counterup" id="lineutil">0.0</span>%
                    </div>
                </div>
                <div class="descfooter">
                    <a class="more" href="javascript:;" style="color:#ffffff;">
                        @T("GL.LineUtilization")
                    </a>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-3 col-sm-3 col-xs-3">
            <div class="dashboard-stat green-sharp" style="background:url(../Content/img/customer_4.png); background-size:100%;" title='@T("GL.VAOLEFormula")'>
                <div class="details">
                    <div class="number">
                        <span data-counter="counterup" id="vaole">0.0</span>%
                    </div>
                </div>
                <div class="descfooter">
                    <a class="more" href="javascript:;" style="color:#ffffff;">
                        @T("GL.VAOLE")
                    </a>
                </div>
            </div>
        </div>
    </div>
    <!--內容 表格列-->
    <div class="row">
        <!--表格-->
        <div class="col-md-12 table-container">
            <table class="table table-striped table-hover table-condensed nowrap" id="js_WorkStation_datatable">
                <thead>
                    <tr>
                        <th class="table-col-checkbox nosort">
                            <input type="checkbox" class="js-checkbox-all" />
                        </th>
                        <th class="table-col-seq nosort">@T("GL.Seq")<br /><br /><br /></th>
                        <th class="nosort">@T("GL.LineName")<br /><br /><br /></th>
                        <th class="nosort">
                            @T("GL.Plan")
                            <br />@T("GL.Output")
                            <br />
                            [@T("GL.pcs")]<br />
                        </th>
                        <th class="nosort">
                            @T("GL.RealTime")
                            <br />@T("GL.Plan")
                            <br />
                            [@T("GL.pcs")]<br />
                        </th>
                        <th class="nosort">
                            @T("GL.Actual")
                            <br /> @T("GL.Output")
                            <br />
                            [@T("GL.pcs")]<br />
                        </th>
                        <th class="nosort">
                            @T("GL.Gap")
                            <br />
                            [@T("GL.pcs")]<br />
                            <br />
                        </th>
                        <th class="nosort" title='@T("GL.ShiftActualOutputVSPlanFormula")'>
                            @T("GL.Shiftly")
                            <br /> @T("GL.Actual") @T("GL.Output")
                            <br />
                            VS @T("GL.Plan") [%]
                        </th>
                        <th class="nosort" title='@T("GL.HourlyActualOutputVSRealTimePlanFormula")'>
                            @T("GL.Hourly")
                            <br />@T("GL.Actual") @T("GL.Output") VS
                            <br />
                            @T("GL.RealTime") @T("GL.Plan") [%]
                        </th>
                        <th class="nosort" title='@T("GL.LineUtilFormula")'>
                            @T("GL.LineUtil")
                            <br />
                            [%]<br />
                            <br />
                        </th>
                        <th class="nosort" title='@T("GL.VAOLEFormula2")'>
                            @T("GL.VAOLE")
                            <br />
                            [%]<br />
                            <br />
                        </th>
                        <th class="nosort" title="=<3x CycleTime">
                            @T("GL.RunTime")
                            <br />
                            [@T("GL.Hours")]<br />
                            <br />
                        </th>
                        <th class="nosort">
                            @T("GL.Plan")
                            <br /> @T("GL.DownTime")
                            <br />[@T("GL.Hours")]
                            <br />
                        </th>
                        <th class="nosort" title=">3x CycleTime">
                            @T("GL.UnPlan")
                            <br /> @T("GL.DownTime")
                            <br />
                            [@T("GL.Hours")]<br />

                        </th>
                        <th class="nosort">@T("GL.Status")<br /><br /><br /></th>
                        <th class="nosort" title='@T("GL.StdUPHFormula")'>@T("GL.StdUPH")<br /><br /><br /></th>
                        <th class="nosort" title='@T("GL.ResponsibleUser")'>@T("GL.ResponsibleUser")<br /><br /><br /></th>
                    </tr>
                </thead>
            </table>

            <input type="hidden" name="System_edit_id" id="js_hidden_edit_id" value="0" />
            <div id="page" class="row"></div>
            <div class="col-xs-3">
                Idle &le; 30x CycleTime<span style="color:green" class="glyphicon glyphicon-record"></span>
            </div>
            <div class="col-xs-3">
                30x CycleTime &lt; Idle &le; 40x CycleTime<span style="color:orange" class="glyphicon glyphicon-record"></span>
            </div>
            <div class="col-xs-3">
                Idle &gt; 40x CycleTime<span style="color:red" class="glyphicon glyphicon-record"></span>
            </div>
            <div class="col-xs-3" style="color:darkgreen;">
                @T("GL.LatestRefresh"): <span id="js-LatestRefersh"></span>
            </div>
        </div><!--/表格-->
    </div><!-- / 內容 表格列 -->

</section><!-- /.content -->
<!-- 查询 -->
@section ViewModals{
    <div class="modal fade" id="js_edit_exception_modal" role="dialog">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title">@T("Exception.Publish")</h4>
                </div>
                @using (Html.BeginForm("AddExceptionRecord", "Exception", FormMethod.Post, new { id = "js_form_exception" }))
                {
                    <input type="hidden" name="fixturelist" id="fixturelist" />
                    <div class="modal-body" style="padding-bottom:0px">
                        <div class="col-sm-12" style="text-align:left">
                            <h4>
                                <b>@T("Exception.BaseInfo")</b>
                            </h4>
                        </div>
                        <div class="form-group col-xs-12 col-md-6 col-lg-6 hidden">
                            <label class="col-sm-4 control-label" for="js_input_LineID">线体编号</label>
                            <div class="col-sm-8">
                                <input class="form-control input-sm" id="js_input_LineID" name="LineID" readonly />
                            </div>
                        </div>

                        <div class="col-xs-12 col-md-6 col-lg-6">
                            <div class="form-group">
                                <label class="col-sm-3 control-label" for="js_select_station">@T("Exception.Station")</label>
                                <div class="col-sm-9">
                                    <select class="form-control input-sm" id="js_select_station" name="StationID"></select>
                                </div>
                            </div>
                        </div>

                        <div class="col-xs-12 col-md-6 col-lg-6">
                            <div class="form-group">
                                <label class="col-sm-3 control-label" for="js_select_Exception_Dept_Name">@T("Exception.DeptName")</label>
                              
                                <div class="col-sm-9">
                                    <select class="form-control input-sm" id="js_select_Exception_Dept_Name" name="Exception_Dept_Name">
                                        @if (Model.ExceDepts != null)
                                        {
                                            <option value=0></option>
                                            foreach (var item in Model.ExceDepts)
                                            {
                                                <option value=@item.Exception_Dept_UID>@item.Exception_Dept_Name</option>
                                            }
                                        }
                                    </select>
                               </div>
                            </div>                       
                        </div>

                        <div class="col-xs-12 col-md-12 col-lg-12" style="margin-top:20px;">
                            <div class="form-group">
                                <label class="col-sm-2 control-label" for="js_select_Exception_Name">@T("Exception.Code")</label>
                                <div class="col-sm-10">
                                    <select multiple="multiple" size="6" class="form-control" required id="js_select_Exception_Name" name="Exception_Code_UIDs" style="width:100%">
                                    </select>

                                </div>
                                 
                            </div>

                        </div>

                    </div>

                    <div class="modal-footer" style="padding-bottom:0px">
                        <div class="form-group col-xs-12 col-md-12 col-lg-12">
                            <label class="col-sm-2 control-label" for="js_input_send">@T("Exception.ReceivePeople")</label>
                            <div class="col-sm-10">
                                @*<input id="js_input_send" class="form-control" readonly />*@
                                <select class="selectpicker form-control" data-live-search="true" id="js_input_send" multiple></select>
                            </div>
                        </div>
                        <div class="form-group col-xs-12 col-md-12 col-lg-12">
                            <label class="col-sm-2 control-label" for="js_input_cc">@T("Exception.CCPeople")</label>
                            <div class="col-sm-10">
                                @*<input id="js_input_cc" class="form-control" readonly />*@
                                <select class="selectpicker form-control" data-live-search="true" id="js_input_cc" multiple></select>
                            </div>
                        </div>
                        <div class="form-group col-xs-12 col-md-12 col-lg-12">
                            <label class="col-sm-2 control-label" for="js_text_Contact_Person">@T("Exception.ContactPerson")</label>
                            <div class="col-sm-10">
                                <textarea id="js_text_Contact_Person" class="form-control"></textarea>
                            </div>
                        </div>
                        <div class="form-group col-xs-12 col-md-12 col-lg-12">
                            <label class="col-sm-2 control-label" for="js_text_ContactPhone">@T("Exception.ContactPhone")</label>
                            <div class="col-sm-10">
                                <textarea id="js_text_ContactPhone" class="form-control"></textarea>
                            </div>
                        </div>
                        <div class="form-group col-xs-12 col-md-12 col-lg-12">
                            <label class="col-sm-1 control-label" for="js_text_Note">@T("Exception.Note")</label>
                            <div class="col-sm-11">
                                <textarea id="js_text_Note" class="form-control"></textarea>
                            </div>
                        </div>


                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary btn-sm" data-dismiss="modal"><i class="fa fa-times"></i> @T("Common.Close")</button>
                        <button type="button" class="btn btn-primary btn-sm" id="btn_exception_save"><i class="fa fa-save"></i> @T("Exception.SavaAndEmail")</button>
                    </div>
                }
            </div>
        </div>
    </div>
}

@section ViewScripts{
    <link rel="stylesheet" type="text/css" href="~/Content/css/bootstrap-select.css" />
    <script type="text/javascript" src="~/Scripts/EQP/bootstrap-select.js"></script>
    <script src="~/Scripts/plugins/jquery.select-multiple.js"></script>
    <link href="~/Content/css/select-multiple.css" rel="stylesheet" />
    <script type="text/javascript">
        $(function () {
            intervalInt = 0;

            total_planOutput = 0;
            total_actualOutput = 0;

            //统计LineUtil
            total_seconds = 0;
            total_runTime = 0;

            //设置当前日期
            //$('#datetimepicker').datetimepicker('setDate', (new Date()));

            //javaScript获取url中的参数
            function getUrlParam(name) {
                var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)"); //构造一个含有目标参数的正则表达式对象
                var r = PDMS.Utility.Settings.Pages.remote.params.match(reg);  //匹配目标参数
                if (r != null) return unescape(r[2]); return null; //返回参数值
            }

            var WorkStationMaintenance = (function () {
                var needBuildCriteria = true;
                var urls =
                    {
                        queryWorkStations: '@Url.Action("GetCustomerLinePerf", "GoldenLine")',
                        //根据厂区取得OP类型
                        getCurrentOPType: '@Url.Action("GetCurrentOPType", "Fixture")',
                        //根据OP类型取得功能厂
                        getFunPlantByOPTypes: '@Url.Action("GetFunPlantByOPTypes", "Fixture")',
                        getProjectByOPType: '@Url.Action("GetCustomers", "GoldenLine")',
                        getShiftTimeByOPType: '@Url.Action("GetShiftTimes", "GoldenLine")',
                        getCustomerActualVSRealTimePlan: '@Url.Action("GetCustomerActualVSRealTimePlan", "GoldenLine")',
                        getCustomerVAOLE: '@Url.Action("GetCustomerVAOLE", "GoldenLine")',

                    };
                var columns = [{
                    createdCell: function (td, cellData, rowData, row, col) {
                        $(td).html('<input type="checkbox" name="cktrans" class="js-checkbox-item" value="' + rowData.LineID + '">')
                        .addClass('table-col-checkbox');
                    },
                    className: "text-center"
                }, {
                    data: null,
                    className: "table-col-seq"
                }, {
                    data: "LineName",
                    createdCell: function (td, cellData, rowData, row, col) {

                        var PlantUID = $("#js_select_factory_query").val();
                        var OpUID = $("#js_select_optype_query").val();
                        var FuncUID = $("#js_select_optype_query").val();
                        var renderHtml = '<a href="Show?customerId=' + rowData.CustomerID + '&lineId=' + rowData.LineID + '&stationId=' + 0 + '&dt=' + rowData.OutputDate + '&shiftIndex=' + rowData.ShiftTimeID + '&Plant_Organization_UID=' + PlantUID + '&BG_Organization_UID=' + OpUID + '&FunPlant_Organization_UID=' + FuncUID + '">' + rowData.LineName + '<a>';
                        $(td).html(renderHtml);
                    },
                    className: "min-col-xs text-center"
                }, {
                    data: "PlanOutput",
                    createdCell: function (td, cellData, rowData, row, col) {

                        $(td).html(rowData.PlanOutput);
                    },
                    className: "min-col-xs text-center"
                }, {
                    data: "RealTimePlan",
                    createdCell: function (td, cellData, rowData, row, col) {

                        $(td).html(rowData.RealTimePlan);
                    },
                    className: "min-col-xs text-center"
                }, {
                    data: "ActualOutput",
                    createdCell: function (td, cellData, rowData, row, col) {
                        $(td).html(rowData.ActualOutput);
                    },
                    className: "min-col-xs text-center"
                }, {
                    data: "Gap",
                    createdCell: function (td, cellData, rowData, row, col) {
                        $(td).html(rowData.Gap);
                        if (rowData.Gap < 0) {
                            $(td).css("background", "#d9534f");
                            $(td).css("color", "#ffffff");
                        }
                    },
                    className: "min-col-xs text-center"
                }, {
                    data: "ActualOutputVSPlan",
                    createdCell: function (td, cellData, rowData, row, col) {

                        $(td).html((rowData.ActualOutputVSPlan * 100).toFixed(1) + "%");
                    },
                    className: "min-col-xs text-center"
                }, {
                    data: "ActualOutputVSRealTimePlan",
                    createdCell: function (td, cellData, rowData, row, col) {

                        $(td).html((rowData.ActualOutputVSRealTimePlan * 100).toFixed(1) + "%");
                    },
                    className: "min-col-xs text-center"
                }, {
                    data: "LineUtil",
                    createdCell: function (td, cellData, rowData, row, col) {

                        $(td).html((rowData.LineUtil * 100).toFixed(1) + "%");
                    },
                    className: "min-col-xs text-center"
                }, {
                    data: "VAOLE",
                    createdCell: function (td, cellData, rowData, row, col) {

                        $(td).html((rowData.VAOLE * 100).toFixed(1) + "%");
                    },
                    className: "min-col-xs text-center"
                }, {
                    data: "RunTime",
                    createdCell: function (td, cellData, rowData, row, col) {

                        $(td).html((rowData.RunTime / 3600).toFixed(2));
                    },
                    className: "min-col-xs text-center"
                }, {
                    data: "PlanDownTime",
                    createdCell: function (td, cellData, rowData, row, col) {

                        $(td).html((rowData.PlanDownTime / 3600).toFixed(2));
                    },
                    className: "min-col-xs text-center"
                }, {
                    data: "UPDownTime",
                    createdCell: function (td, cellData, rowData, row, col) {

                        $(td).html((rowData.UPDownTime / 3600).toFixed(2));
                    },
                    className: "min-col-xs text-center"
                }, {
                    data: "LineStatus",
                    createdCell: function (td, cellData, rowData, row, col) {
                        var renderHtml = '<span style="color:red" class="glyphicon glyphicon-record"></span>';
                        if (rowData.LineStatus == '0') {
                            renderHtml = '<span style="color:green" class="glyphicon glyphicon-record"></span>';
                        } else if (rowData.LineStatus == '1') {
                            renderHtml = '<span style="color:orange" class="glyphicon glyphicon-record"></span>';
                        }
                        $(td).html(renderHtml);

                        //累计4个指标

                        //累计输出
                        if (rowData.PlanOutput > 0) {
                            total_planOutput += rowData.PlanOutput;
                            //Project report : for Actual output vs. plan metrics, add one rule prior metric calculation, when actual output greater than plan output, use plan output for metrics calculation.
                            //若实际输出大于计划输出，取计划输出
                            total_actualOutput += rowData.ActualOutput > rowData.PlanOutput ? rowData.PlanOutput : rowData.ActualOutput;
                        }
                        var outputvsplan = $("#outputvsplan");
                        if (total_planOutput > 0) {
                            //2018-09-05 outputvsplan不能超过100%
                            var outputvsplan_value = total_actualOutput / total_planOutput;
                            if (outputvsplan_value > 1) {
                                outputvsplan_value = 1;
                            }
                            outputvsplan[0].innerText = (outputvsplan_value * 100).toFixed(1);
                        }

                        //产线利用率
                        var lineutil = $("#lineutil");
                        total_seconds += rowData.RunTime + rowData.PlanDownTime + rowData.UPDownTime;
                        total_runTime += rowData.RunTime;
                        if (total_seconds != 0) {
                            lineutil[0].innerText = (total_runTime / total_seconds * 100).toFixed(1);
                        }

                        //vaole人力资源利用率
                        var vaole = $("#vaole");
                        if (vaole != undefined) {
                            var newvaole = (parseFloat(vaole[0].innerText) + rowData.VAOLE * 100).toFixed(1);
                            vaole[0].innerText = newvaole;
                        }


                        $("#js-LatestRefersh")[0].innerText = rowData.Modified_Date;
                    },
                    className: "min-col-xs text-center"
                }, {
                    data: "UPH",
                    createdCell: function (td, cellData, rowData, row, col) {
                        //用户要求显示整数
                        $(td).html(rowData.UPH.toFixed(0));
                    },
                    className: "min-col-xs text-center"
                }, {
                    data: "ResponsibleUserName",
                    createdCell: function (td, cellData, rowData, row, col) {
                        //负责人
                        $(td).html(rowData.ResponsibleUserName);
                    },
                    className: "min-col-xs text-center"
                }
                ];

                var _getParams = function (needBuildCriteria) {
                    debugger;
                    if (needBuildCriteria) {
                        PDMS.Utility.Settings.Pages.remote.params = $('#js_form_query').serialize().replace(/\+/g, " ");
                    }
                    return PDMS.Utility.Settings.Pages.remote.params;
                };

                var _queryWorkStations = function (firstLoad) {

                    var config = {
                        pageId: "#page",
                        tableId: "#js_WorkStation_datatable",
                        remoteUrl: urls.queryWorkStations,
                        searchParams: _getParams(firstLoad),
                        tableOptions: {
                            //scrollX: true,
                            //scrollCollapse: false,
                            //autoWidth: true,
                            columns: columns
                        }
                    };

                    //if (!firstLoad) {
                    $('#page').page('destroy');
                    //}

                    //if (needBuildCriteria) {
                    //    PDMS.Utility.Criteria.Build();
                    //}

                    PDMS.Utility.Pages.Set(config);
                };

                return {
                    urls: urls,
                    Init: function () {
                        //页面初始化加载查询时，初始化Criteria
                        PDMS.Utility.Criteria.Init();
                        _queryWorkStations(true);
                    },
                    queryWorkStations: function (isSearchBtn) {
                        _queryWorkStations(isSearchBtn);
                    }
                }

            })();
            WorkStationMaintenance.Init();

            //查询界面厂区是OP类型变化
            $('#js_select_factory_query').change(function () {
                GetOPTypes();
            })

            $('#js_btn_query').click(function () {
                var isQueryValid = true;
                var info = "";
                var opTypeValue = $("#js_select_optype_query").val();
                if (opTypeValue == "" || opTypeValue == null) {
                    info = "请选择[OP类型];";
                    isQueryValid = false;
                }

                var projectValue = $("#js_select_project_query").val();
                if (projectValue == "" || projectValue == null) {
                    info += "请选择[专案];";
                    isQueryValid = false;
                }
                var dateValue = $("#js_date_query").val();
                if (dateValue == "" || dateValue == null) {
                    info += "请选择[日期];";
                    isQueryValid = false;
                }

                var shiftTimeValue = $("#js_select_shiftTime_query").val();
                if (shiftTimeValue == "" || shiftTimeValue == null) {
                    info += "请选择[班次];";
                    isQueryValid = false;
                }
                if (isQueryValid == false) {
                    PDMS.Utility.MessageBox.info(info);
                    return false;
                }
                setGolbleVariable();//oscar 设置全局变量
                queryFunction(true);

                //60秒刷新
                if (intervalInt != 0) {
                    clearInterval(intervalInt);
                }
                intervalInt = setInterval(function () {
                    queryFunction(false);
                }, 1000 * 60);
            });

            //查询函数
            function queryFunction(needBuildCriteria) {
                initIndexValues();
                WorkStationMaintenance.queryWorkStations(needBuildCriteria);
                GetIndexValues();
                setNumberColor();
            }

            function setNumberColor() {
                var numbers = $(".number");
                numbers.each(function (index, element) {
                    var span = $(element).find("span")[0];
                    var value = span.innerText;
                    //<60% 红色#FF0000，>=60% <=75 橙色#FF9900，>75 绿色#00CC33
                    var vaole_color = value < 60 ? "#FF0000" : value > 75 ? "#00CC33" : "#FF9900";
                    $(element).css({ 'color': vaole_color });
                });
            }

            //初始化4个指标,置0
            function initIndexValues() {
                total_planOutput = 0;
                total_actualOutput = 0;

                //统计LineUtil
                total_seconds = 0;
                total_runTime = 0;

                $("#outputvsplan")[0].innerText = "0.0";
                $("#outputvsrealtimeplan")[0].innerText = "0.0";
                $("#lineutil")[0].innerText = "0.0";
                $("#vaole")[0].innerText = "0.0";
            }

            function GetIndexValues() {
                //查询指标数据
                debugger;
                PDMS.Utility.Settings.Pages.remote.params
                var projectValue = getUrlParam("customerId"); //$("#js_select_project_query").val();
                var shiftTimeID = getUrlParam("shiftTimeId"); //$("#js_select_shiftTime_query").val();
                var outputDate = getUrlParam("outputDate");//$("#js_date_query").val();
                $.get(WorkStationMaintenance.urls.getCustomerActualVSRealTimePlan, { customerID: projectValue, shiftTimeID: shiftTimeID, outputDate: outputDate }, function (data) {
                    var value = parseFloat(data);
                    if (value > 1) {
                        value = 1;
                    }
                    $("#outputvsrealtimeplan")[0].innerText = (value * 100).toFixed(1);
                });
                $.get(WorkStationMaintenance.urls.getCustomerVAOLE, { customerID: projectValue, shiftTimeID: shiftTimeID, outputDate: outputDate }, function (data) {
                    $("#vaole")[0].innerText = (parseFloat(data) * 100).toFixed(1);
                });
            }

            //clear query conditions in search modal
            $('#js_btn_clear').click(function () {

                PDMS.Utility.Criteria.Clear(function () {
                    $('#js_s_radio_valid').prop('checked', true);
                    $("#js_s_input_reference_date").val(moment().format('YYYY-MM-DD'));
                });
            });

            firstSearch = true;
            $('#bt_search').click(function () {
                if (firstSearch) {
                    $('#js_select_factory_query').trigger('change');
                    firstSearch = false;
                }
            })

            $('#js_select_factory_add').change(function () {
                var oporgid = $('#js_select_factory_add option:selected').val();
                if (oporgid != 0) {
                    //op类型
                    url = WorkStationMaintenance.urls.getCurrentOPType;
                    $('#js_select_optype_add').empty();
                    $.post(url, { plant_OrganizationUID: oporgid }, function (data) {
                        for (var i = 0; i < data.length; i++) {
                            $('#js_select_optype_add').append('<option value="' + data[i].Organization_UID + '">' + data[i].OP_TYPES + '</option>');
                        }
                    });
                    $('#js_select_optype_add').selectpicker('refresh');
                    //$('#js_select_optype_add').trigger('change');
                }
            })

            function GetOPTypes() {
                var oporgid = $('#js_select_factory_query option:selected').val();
                url = WorkStationMaintenance.urls.getCurrentOPType;
                $('#js_select_optype_query').empty();
                $('#js_select_funplant_query').empty();
                if (oporgid != 0) {
                    $.post(url, { plant_OrganizationUID: oporgid }, function (data) {
                        for (var i = 0; i < data.length; i++) {
                            if ($('#js_select_optype_query').find('option[value=' + data[i].Organization_UID + ']').length == 0) {
                                $('#js_select_optype_query').append('<option value="' + data[i].Organization_UID + '">' + data[i].OP_TYPES + '</option>');
                            }
                        }
                    });
                }
                $('#js_select_optype_query').trigger('change');
            }

            //OP类型变更  start
            $('#js_select_optype_query').change(function () {
                if ($('#js_select_optype_query option:selected').text() != "") {
                    //refreshSearchFuncPlantSelect();
                    refreshSearchProjectSelect();
                    refreshShiftTimeSelect();
                } else {
                    //$('#js_select_funplant_query').empty();
                    $('#js_select_project_query').empty();
                    $('#js_select_shiftTime_query').empty();
                }
            })

            //功能厂变更
            $('#js_select_funplant_query').change(function () {
                refreshSearchProjectSelect();
                refreshShiftTimeSelect();
            })

            //刷新功能厂下拉框
            function refreshSearchFuncPlantSelect() {
                $('#js_select_funplant_query').empty();
                $('#js_select_funplant_query').html('<option></option>');
                var url = WorkStationMaintenance.urls.getFunPlantByOPTypes;
                $.post(url, { Optype: $('#js_select_optype_query').val() }, function (data) {
                    for (var i = 0; i < data.length; i++) {
                        $('#js_select_funplant_query').append('<option value="' + data[i].FunPlant_OrganizationUID + '">' + data[i].FunPlant + '</option>');
                    }
                });
                //$('#js_select_funplant_query').selectpicker('refresh');
                $('#js_select_funplant_query').trigger('change');
            }

            //刷新搜索中专案下拉框
            function refreshSearchProjectSelect() {
                $('#js_select_project_query').empty();
                //$('#js_select_project_query').html('<option></option>');
                var getProjectByOPTypeUrl = WorkStationMaintenance.urls.getProjectByOPType;
                var optypeUid = $('#js_select_optype_query').val();
                //var funcUid = $('#js_select_funplant_query').val();
                //if (!(funcUid > 0)) {
                //    funcUid = null;
                //}
                $.get(getProjectByOPTypeUrl, { oporgid: optypeUid }, function (data) {
                    for (var i = 0; i < data.length; i++) {
                        $('#js_select_project_query').append('<option value="' + data[i].Project_UID + '">' + data[i].Project_Name + '</option>');
                    }
                });
            }

            //刷新班次下拉框
            function refreshShiftTimeSelect() {
                $('#js_select_shiftTime_query').empty();
                var getShiftTimeByOPTypeUrl = WorkStationMaintenance.urls.getShiftTimeByOPType;
                var optypeUid = $('#js_select_optype_query').val();
                var funcUid = $('#js_select_funplant_query').val();
                if (!(funcUid > 0)) {
                    funcUid = null;
                }
                $.get(getShiftTimeByOPTypeUrl, { oporgid: optypeUid, funcgid: funcUid }, function (data) {
                    for (var i = 0; i < data.length; i++) {
                        $('#js_select_shiftTime_query').append('<option value="' + data[i].ShiftTimeID + '">' + data[i].Shift + '</option>');
                    }
                });
            }

            //最后触发
            $('#js_select_factory_query').trigger('change');
        });
    </script>

    <script>
        $(function () {
            $('#js_select_Exception_Name').selectMultiple();
            $('#ms-js_select_Exception_Name').css("width", "100%");
            $('#ms-js_select_Exception_Name').css("text-align", "left");

            var emails = @Html.Raw(Json.Encode(@ViewBag.Email));
            $.each(emails, function (index,item)
            {
                $('#js_input_send').append('<option value="' + item.Account_UID + '">' + item.Email+'|'+ item.User_Name+ '</option>');
                $('#js_input_cc').append('<option value="' + item.Account_UID + '">' + item.Email +'|'+ item.User_Name+'</option>');
            })
            $('#js_input_send,#js_input_cc').selectpicker('refresh');
        });
        function setGolbleVariable() {
            _BG_Organization_UID = $('#js_select_optype_query').val();
            _Plant_Organization_UID = $('#js_select_factory_query').val();
            _WorkDate = $('#js_date_query').val();
            _ShiftTimeID = $('#js_select_shiftTime_query').val();
            _Project = $('#js_select_project_query').val();
            _Project_Name = $('#js_select_project_query').text();
            }

        var ExceptionOperateURL = (function () {
            var urls ={
                    exceptionRecordAdd: '@Url.Action("ExceptionRecordAdd", "Exception")',
                    //异常部门变化,设置异常编码
                    fetchExceptionCodeBasedDept: '@Url.Action("FetchExceptionCodeBasedDept", "Exception")',
                    //根据LineID获取工站
                    fetchStations: '@Url.Action("FetchStations", "Exception")',
                    //获取班次开始和结束时间
                    fetchShifTime: '@Url.Action("FetchShifTime", "Exception")',
                    //获取收件人和CC人员的信息
                    fetchEmail: '@Url.Action("fetchEmail", "Exception")',
                    //根据Plant,BG获取Depts
                    fetchExceptionDepts: '@Url.Action("FetchExceptionDepts", "Exception")',
                    //获取收件人
                    fetchExceptionEmail: '@Url.Action("FetchExceptionEmail", "Exception")',
                    fetchCurrentDate: '@Url.Action("FetchDatetimeNow", "Exception")',
                };
            //$('#datetimepicker').datetimepicker('setDate', (new Date())); 
            $.post(urls.fetchCurrentDate, {}, function(data){
                debugger;
                var da=new Date(data);
                $('#datetimepicker').datetimepicker({
                    format: 'LT'
                });
                $('#datetimepicker').datetimepicker('setDate', new Date(data)); 
               // $("#datetimepicker").datepicker("update");

            });

            return {
                urls: urls
            }
        })();

        $('#js_form_exception').validate({
            errorContainer: $('ul.validate-error'),
            errorLabelContainer: $('#js_edit_exception_modal ul.validate-error'),
            wrapper: 'li'
        });

        $('#js_edit_exception_modal').on('show.bs.modal', function (event) {
            var button = $(event.relatedTarget);
            $('#ms-js_select_Exception_Name').css("width", "100%");
            $('#ms-js_select_Exception_Name').css("text-align", "left");
        });

        $('#js_btn_exce_add').click(function () {
            //要先判断白夜班，获取当前时分秒
            var WorkDate = _WorkDate;

            var ShiftTimeID = _ShiftTimeID;
            var date = new Date;
            var seconds = date.getSeconds();
            var minutes = date.getMinutes();
            var hour = date.getHours();
            var urlShit = ExceptionOperateURL.urls.fetchShifTime;
            var currenDate = WorkDate + " " + hour + ":" + minutes + ":" + seconds
            $.post(urlShit, { ShiftTimeID: ShiftTimeID }, function (data) {
                if (data.success != null) {
                    //if (data.success.StartTime <= currenDate && data.success.End_Time >= currenDate) {

                    //}
                    //else {
                    //    PDMS.Utility.MessageBox.info("Please add exception on current day and current shift!");
                    //    return;
                    //}
                }
                else {
                    PDMS.Utility.MessageBox.info("no shift time fetched !");
                }
            });

            //获取去LineID,然后根据LineID去获取station
            var url = ExceptionOperateURL.urls.fetchStations;
            //验证日期不能夸班次
            var $checkedItems = $('#js_WorkStation_datatable .js-checkbox-item:checked');

            if ($checkedItems.length == 0) {
                PDMS.Utility.MessageBox.info("Please select data");
                return;
            } else if ($checkedItems.length > 1) {
                PDMS.Utility.MessageBox.info("Please select one row data");
                return;
            } else {
                //1.先从数据库删除，2.在刷新表
                var lineID = $checkedItems.val();
                $('#js_input_LineID').val(lineID);
                $.post(url, { lineID: lineID }, function (data) {
                    $('#js_select_station').html('<option value="0"></option>');
                    $("#js_select_station").selectpicker('refresh');
                    if (data.success.length > 0) {
                        $.each(data.success, function (index, item) {
                            $('#js_select_station').append('<option value="' + item.StationID + '">' + item.StationName + '</option>');
                        })
                        $("#js_select_station").selectpicker('refresh');
                    }
                    else {
                        PDMS.Utility.MessageBox.info("no data fetched");
                        $('#js_select_station').html('<option value=0></option>');
                        $("#js_select_station").selectpicker('refresh');
                        return;
                    }
                });
            }
            $('#js_select_Exception_Dept_Name').val('');
            //根据plant 和 BG 获取异常部门

            //_Plant_Organization_UID = $('#js_select_factory_query').val();
            //_BG_Organization_UID = $('#js_select_optype_query').val();
            var url = ExceptionOperateURL.urls.fetchExceptionDepts;


            if (_BG_Organization_UID == null || _BG_Organization_UID == undefined) {
                PDMS.Utility.MessageBox.info("Please select BG !");
                return;
            }
            if (_Plant_Organization_UID == null ||_Plant_Organization_UID == undefined) {
                PDMS.Utility.MessageBox.info("Please select plant !");
                return;
            }
            $.post(url, { BG_Organization_UID: _BG_Organization_UID, Plant_Organization_UID: _Plant_Organization_UID }, function (data) {
                $('#js_select_Exception_Dept_Name').html('<option value=0></option>');
                if (data.length <= 0) {
                    PDMS.Utility.MessageBox.info("There is no exception departments infomation !");
                    return;
                }
                for (var i = 0; i < data.length; i++) {
                    $('#js_select_Exception_Dept_Name').append('<option value="' + data[i].Exception_Dept_UID + '">' + data[i].Exception_Dept_Name + '</option>');
                }
                $("#js_select_Exception_Dept_Name").selectpicker('refresh');
                $("#js_select_Exception_Dept_Name").trigger('change');
            });

            //获取收件人和CC人员

            var url = ExceptionOperateURL.urls.fetchEmail;

            if (_Project == 0) {
                PDMS.Utility.MessageBox.info("There is no recipient person unnder " + _Project_Name +"!, please add recipient person first. ");
            }
            //$.post(url, { uid: _Project }, function (data) {
            //    if (data.sendEmail.length > 0) {
            //        $('#js_input_send').val(data.sendEmail)

            //    }
            //    if (data.ccEmail.length > 0) {
            //        $('#js_input_cc').val(data.ccEmail)
            //    }
            //});

            $('#js_edit_exception_modal').modal('show', $(this));



        })

        $('#js_edit_exception_modal').on('hidden.bs.modal', function (e) {
            $('#js_edit_exception_modal').find('input').val('');//清空所有input
            $('#js_edit_exception_modal').find('textarea').val('');
            $('#js_input_send').selectpicker('deselectAll');
            $('#js_input_cc').selectpicker('deselectAll');
            $('#js_input_send,#js_input_cc').selectpicker('refresh');

            $('#js_select_station').html('<option value="0"></option>');
            $("#js_select_station").selectpicker('refresh');

            $("#js_select_Exception_Dept_Name").html('<option value=0></option>');//部门清空
            $("#js_select_Exception_Dept_Name").selectpicker('refresh');
            $("#js_select_Exception_Dept_Name").trigger('change');

            $("#js_select_Exception_Name").empty();
            $('#js_select_Exception_Name').selectMultiple("refresh");
            $('#ms-js_select_Exception_Name').css("width", "100%");
            $('#ms-js_select_Exception_Name').css("text-align", "left");

        });

        $('#js_select_Exception_Dept_Name').change(function () {
            var url = ExceptionOperateURL.urls.fetchExceptionCodeBasedDept;
            var deptUID = $('#js_select_Exception_Dept_Name option:selected').val();
            $('#js_select_Exception_Name').empty();
            if (deptUID == 0) {
                //$('#js_select_Exception_Name').html('<option value=0></option>');
                $("#js_select_Exception_Name").empty();
                return;
            }

            $.post(url, { deptUID: deptUID }, function (data) {

                if (data.success.length > 0) {
                    $.each(data.success, function (index, item) {
                        $("<option></option>").val(item.Exception_Code_UID).text(item.Exception_Nub + '-' + item.Exception_Name).appendTo($("#js_select_Exception_Name"));
                        //$('#js_select_Exception_Name').append('<option value="' + item.Exception_Code_UID + '">' + item.Exception_Nub + '-' + item.Exception_Name + '</option>');

                    });
                    $('#js_select_Exception_Name').selectMultiple("refresh");
                    $('#ms-js_select_Exception_Name').css("width", "100%");
                    $('#ms-js_select_Exception_Name').css("text-align", "left");
                }
                else {
                    PDMS.Utility.MessageBox.info("no exception data fetched");
                    $("#js_select_Exception_Name").empty();
                    $('#js_select_Exception_Name').selectMultiple("refresh");
                    $('#ms-js_select_Exception_Name').css("width", "100%");
                    $('#ms-js_select_Exception_Name').css("text-align", "left");
                    return;
                }
            });


        });

        $('#btn_exception_save').click(function () {
            var WorkDate = _WorkDate;
            var ShiftTimeID = _ShiftTimeID;
            var ProjectID = _Project;
            var LintID = $('#js_input_LineID').val();
            var codeID = $('#js_select_Exception_Name').val();
            var deptID = $('#js_select_Exception_Dept_Name option:selected').val();
            var stationID = $('#js_select_station option:selected').val();
            var note = $('#js_text_Note').val();
            var person = $('#js_text_Contact_Person').val();
            var tel = $('#js_text_ContactPhone').val();
            var SendIDs= $('#js_input_send').val();
            var CCIDs= $('#js_input_cc').val();
            if (LintID == 0) {
                PDMS.Utility.MessageBox.info('Please select line !');
                return;
            }
            if (ShiftTimeID == 0) {
                PDMS.Utility.MessageBox.info('Please select shift !');
                return;
            }
            if (codeID == 0||codeID==null) {
                PDMS.Utility.MessageBox.info('Please select issue code !');
                return;
            }
            if (deptID == undefined || deptID == 0) {
                PDMS.Utility.MessageBox.info('Please select department !');
                return;
            }
            if (stationID == 0) {
                PDMS.Utility.MessageBox.info('Please select station !');
                return;
            }
            if(SendIDs=='' || SendIDs==null){
                PDMS.Utility.MessageBox.info('Please select recipients !');
                return;
            }
            var url = ExceptionOperateURL.urls.exceptionRecordAdd;
            $.post(url, { WorkDate: WorkDate, ShiftTimeID: ShiftTimeID, LintID: LintID, codeID: codeID.join(), stationID: stationID, note: note, ProjectID: ProjectID, ContactPerson: person, ContactPhone: tel ,SendIDs:SendIDs,CCIDs:CCIDs}, function (data) {
                if (data.success > 0) {
                    PDMS.Utility.MessageBox.info("Issue add successfully!");
                    $('#js_edit_exception_modal').modal('hide');
                }
                else {
                    PDMS.Utility.MessageBox.info("add failed");
                    return;
                }
            });




        });


    </script>
}