<!-- Main content -->
<section class="content portal-content">

    <!--次標題 與 搜尋-->
    <div class="row">
        <!--次標題與Search keyword-->
        <div class="col-md-12 col-lg-9">
            <h4 class="margin-td-5" id="js_search_keywords"></h4>
        </div><!-- /col-次標題與Search keyword -->
        <!--col-右方搜尋與功能按鈕列-->
        <div class="col-md-12 search-field col-lg-3">
            <a class="btn btn-primary btn-sm" data-toggle="modal" data-target="#js_search_modal"><i class="fa fa-search"></i> Search</a>
            <a class="btn btn-primary btn-sm" role="button" data-toggle="modal" data-target="#js_edit_modal" id="js_btn_add_bu">
                <i class="fa fa-plus"></i> Add
            </a>
            <a id="js_btn_export" class="btn btn-primary btn-sm" role="button">
                <i class="glyphicon glyphicon-save"></i> Export
            </a>
        </div><!-- /col-右方搜尋與功能按鈕列-->
    </div><!--/次標題 與 搜尋-->
    <hr class="hr-custom">

    <!--row Search Keyword collapse-->
    <div class="row">
        <div class="col-xs-12" id="js_criteria_alert_cnt">
        </div>
    </div> <!--/row Search Keyword collapse-->
    <!--內容 表格列-->
    <div class="row">
        <!--表格-->
        <div class="col-md-12 table-container">
            <table class="table table-striped table-hover table-condensed nowrap" id="js_user_datatable">
                <thead>
                    <tr>
                        <th class="table-col-checkbox nosort">
                            <input type="checkbox" class="js-checkbox-all" />
                        </th>
                        <th class="table-col-action nosort">Action</th>
                        <th class="table-col-seq nosort">Seq</th>
                        <th>User NTID</th>
                        <th>User Name</th>
                        <th>BU ID</th>
                        <th>BU Name</th>
                        <th>BU Customer ID</th>
                        <th>BU Customer Name</th>
                        <th>Begin Date</th>
                        <th>End Date</th>
                        <th>Modified User</th>
                        <th>Modified Date</th>
                    </tr>
                </thead>
                <tfoot>
                    <tr>
                        <th class="table-col-checkbox nosort"></th>
                        <th class="table-col-action nosort">Action</th>
                        <th class="table-col-seq nosort">Seq</th>
                        <th>User NTID</th>
                        <th>User Name</th>
                        <th>BU ID</th>
                        <th>BU Name</th>
                        <th>BU Customer ID</th>
                        <th>BU Customer Name</th>
                        <th>Begin Date</th>
                        <th>End Date</th>
                        <th>Modified User</th>
                        <th>Modified Date</th>
                    </tr>
                </tfoot>
            </table>
            <div id="page" class="row"></div>

        </div><!--/表格-->
    </div><!-- / 內容 表格列 -->


</section><!-- /.content -->

@section ViewModals{
    <!-- Modal -->
    <div class="modal fade" id="js_search_modal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title">Search</h4>
            </div>
            <div class="modal-body form-horizontal">
                <div class="row">
                    <form id="js_form_query" data-need-validate="true">
                            <div class="form-group col-xs-12 col-md-6 col-lg-6">
                                <label class="col-sm-5 control-label" for="js_s_input_user_ntid">User NTID</label>
                                <div class="col-sm-7">
                                    <input type="text" name="User_NTID" class="form-control input-sm" id="js_s_input_user_ntid" placeholder="User NTID">
                                </div>
                            </div>
                            <div class="form-group col-xs-12 col-md-6 col-lg-6">
                                <label class="col-sm-5 control-label" for="js_s_input_user_name">User Name</label>
                                <div class="col-sm-7">
                                    <input type="text" name="User_Name" class="form-control input-sm" id="js_s_input_user_name" placeholder="User Name">
                                </div>
                            </div>

                            <div class="form-group col-xs-12 col-md-6 col-lg-6">
                                <label class="col-sm-5 control-label" for="js_s_input_bu_id">BU ID</label>
                                <div class="col-sm-7">
                                    <input type="text" name="BU_ID" class="form-control input-sm" id="js_s_input_bu_id" placeholder="BU ID">
                                </div>
                            </div>
                            <div class="form-group col-xs-12 col-md-6 col-lg-6">
                                <label class="col-sm-5 control-label" for="js_s_input_bu_name">BU Name</label>
                                <div class="col-sm-7">
                                    <input type="text" name="BU_Name" class="form-control input-sm" id="js_s_input_bu_name" placeholder="BU Name">
                                </div>
                            </div>

                            <div class="form-group col-xs-12 col-md-6 col-lg-6">
                                <label class="col-sm-5 control-label" for="js_s_input_bu_d_id">BU Customer ID</label>
                                <div class="col-sm-7">
                                    <input type="text" name="BU_D_ID" class="form-control input-sm" id="js_s_input_bu_d_id" placeholder="BU Customer ID">
                                </div>
                            </div>
                            <div class="form-group col-xs-12 col-md-6 col-lg-6">
                                <label class="col-sm-5 control-label" for="js_s_input_bu_d_name">BU Customer Name</label>
                                <div class="col-sm-7">
                                    <input type="text" name="BU_D_Name" class="form-control input-sm" id="js_s_input_bu_d_name" placeholder="BU Customer Name">
                                </div>
                            </div>

                            <div class="form-group col-xs-12 col-md-6">
                                <label class="col-sm-5 control-label" for="js_s_input_ref_date">Reference Date</label>
                                <div class="col-sm-7">
                                    <div class="input-group">
                                        <div class="input-group-addon">
                                            <i class="fa fa-calendar"></i>
                                        </div>
                                        <input type="text" name="Reference_Date" class="form-control input-sm date" id="js_s_input_ref_date" placeholder="Reference Date" value="@DateTime.Now.ToString("yyyy-MM-dd")">
                                    </div>
                                </div>
                            </div>
                            <div class="form-group col-xs-12 col-md-6">
                                <label class="col-sm-5 control-label" data-type ="radio" data-for-name="queryTypes">Query Types</label>
                                <div class="col-sm-7 search-radio-cnt">
                                    <label class="radio-inline">
                                        <input type="radio" name="queryTypes" id="inlineRadio1" value="0" checked> Valid
                                    </label>
                                    <label class="radio-inline">
                                        <input type="radio" name="queryTypes" id="inlineRadio2" value="1"> Invalid
                                    </label>
                                    <label class="radio-inline">
                                        <input type="radio" name="queryTypes" id="inlineRadio3" value="2"> All
                                    </label>
                                </div>
                            </div>

                            <div class="form-group col-xs-12 col-md-6">
                                <label class="col-sm-5 control-label" for="js_s_input_m_from">Modified From</label>
                                <div class="col-sm-7">
                                    <div class="input-group">
                                        <div class="input-group-addon">
                                            <i class="fa fa-calendar"></i>
                                        </div>
                                        <input type="text" name="Modified_Date_From" class="form-control input-sm date" id="js_s_input_m_from" placeholder="Modified From">
                                    </div>
                                </div>
                            </div>
                            <div class="form-group col-xs-12 col-md-6">
                                <label class="col-sm-5 control-label" for="js_s_input_m_to">Modified To</label>
                                <div class="col-sm-7">
                                    <div class="input-group">
                                        <div class="input-group-addon">
                                            <i class="fa fa-calendar"></i>
                                        </div>
                                        <input type="text" name="Modified_Date_End" class="form-control input-sm date" id="js_s_input_m_to" placeholder="Modified To">
                                    </div>
                                </div>
                            </div>

                            <div class="form-group col-xs-12 col-md-6">
                                <label class="col-sm-5 control-label" for="js_s_input_modified_by_ntid">Modified By</label>
                                <div class="col-sm-7">
                                    <input type="text" name="Modified_By" class="form-control input-sm" id="js_s_input_modified_by_ntid" placeholder="Modified By(NTID)">
                                </div>
                            </div>

                    </form>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary btn-sm" id="js_btn_clear"><i class="fa fa-eraser"></i> Clear</button>
                <button type="button" class="btn btn-primary btn-sm" id="js_btn_query"><i class="fa fa-search"></i> Query</button>
            </div>
        </div>
    </div>
</div>

    <!-- Add/Edit Modal -->
<div class="modal fade" id="js_edit_modal" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title">User BU Setting</h4>
            </div>
            <div class="modal-body">
                <form id="js_form_userbu" data-need-validate="true" class="form-horizontal clearfix">
                    <div class="col-xs-12 col-md-6">
                        <div class="form-group">
                            <label class="col-sm-6 control-label" for="js_input_parent_function_id">User NTID</label>
                            <div class="col-sm-6">
                                <input type="text" name="User_NTID" class="form-control input-sm " id="js_input_user_ntid" placeholder="User NTID"
                                       required data-msg-required="Please enter User NTID"
                                       maxlength="20" data-msg-maxlength="Please enter no more than {0} characters in User NTID.">
                                @*<input type="hidden" name="Parent_Function_UID" id="js_hidden_parent_function_uid">*@
                            </div>
                        </div>
                    </div>
                    <div class="col-xs-12 col-md-6">
                        <div class="form-group">
                            <label class="col-sm-6 control-label" for="js_input_parent_function_name">User Name</label>
                            <div class="col-sm-6">
                                <input type="text" name="User_Name" class="form-control input-sm" id="js_input_user_name" placeholder="User_Name" readonly="readonly"
                                required data-msg-required="Please enter User Name"
                                maxlength="50" data-msg-maxlength="Please enter no more than {0} characters in User Name.">
                            </div>
                        </div>
                    </div>
                    <input type="hidden" name="System_User_BU_UID" id="js_hidden_uid" value="0" />
                    <!--jquery validata error container-->
                    <div class="col-xs-12 "><ul class="list-group validate-error"></ul></div>
                </form>
                <hr class="no-margin" />
                <h4>
                    BU Data
                    <button class="btn btn-primary btn-sm" id="js_btn_add_sub_func">Add BU</button>
                    <button class="btn btn-primary btn-sm" id="js_btn_del_sub_func">Delete BU</button>
                </h4>
                <div class="row">
                    <div class="col-xs-12">
                        <table id="js_sub_bu_bud_table" class="table table-condensed">
                            <thead>
                                <tr>
                                    <th class="table-col-checkbox nosort">
                                        <input type="checkbox" class="js-checkbox-all" />
                                    </th>
                                    <th class="table-col-seq nosort">Seq</th>
                                    <th class="nosort">BU ID</th>
                                    <th class="nosort">BU Name</th>
                                    <th class="nosort">BU Customer ID</th>
                                    <th class="nosort">BU Customer Name</th>
                                    <th class="nosort">Begin Date</th>
                                    <th class="nosort">End Date</th>
                                </tr>
                            </thead>
                        </table>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary btn-sm" data-dismiss="modal"><i class="fa fa-times"></i> Cancel</button>
                <button type="button" class="btn btn-primary btn-sm" id="js_btn_save_new_userbu"><i class="fa fa-save"></i> Save</button>
                <button type="button" class="btn btn-primary btn-sm" id="js_btn_save_edit_userbu"><i class="fa fa-save"></i> Edit Save</button>
            </div>
        </div>
    </div>
</div>

}

@section ViewScripts{
<script type="text/javascript">
    $(function () {
        var UserBUSetting = (function () {
            var urls = {
                //画面初始化加载
                queryUserBUS: '@Url.Action("QueryUserBUs", "Settings")',
                //根据输入的UserNTID获取UserName
                getUserName: '@Url.Action("GetSystemUserByNTId", "Common")',
                //通过主键获取单笔信息
                queryUserBU: '@Url.Action("QueryUserBU", "Settings")',
                //通过BU_ID通过BU信息及相关明细信息
                queryBUAndBUDSByBUID: '@Url.Action("QueryBUAndBUDSByBUID", "Settings")',
                //通过BU_D_ID获取BU_D_Name信息
                queryBUDInfoByBU_D_ID: '@Url.Action("QueryBUDInfoByBU_D_ID","Settings")',
                //新增UserBU信息
                addOrEditUserBU: '@Url.Action("AddOrEditUserBU","Settings")',
                //导出UserBU信息
                doExportUserBU: '@Url.Action("ExportUserBU","Settings")'
            };

            var subDatatable = null;

            //#region 定义字段列
            var columns = [{
                createdCell: function (td, cellData, rowData, row, col) {
                    $(td).html('<input type="checkbox" name="cktrans" class="js-checkbox-item" value="' + rowData.SystemUserBusinessGroupDTO.System_User_BU_UID + '">')
                         .addClass('table-col-checkbox');
                },
                className: "text-center"
            }, {
                createdCell: function (td, cellData, rowData, row, col) {
                    var buttonEdit = '<button type="button" class="btn btn-primary btn-sm js-grid-edit" data-id="' + rowData.SystemUserBusinessGroupDTO.System_User_BU_UID + '">Edit</button> ';
                    var result = '<button class="btn btn-primary btn-xs" rel="action-popover">' +
                                '<i class="fa fa-reorder"></i>' +
                                '</button>' +
                                '<div class="hidden popover-content">' +
                                    '{0}' +
                                '</div>';

                    if (rowData.SystemUserBusinessGroupDTO.End_Date == null) {
                        result = result.replace('{0}', buttonEdit);
                    }
                    else {
                        var nowDate = moment().format("YYYY-MM-DD");
                        var systemTime = rowData.SystemUserBusinessGroupDTO.End_Date;
                        if (moment(nowDate).isBefore(systemTime) || moment(nowDate).isSame(systemTime)) { //如果系统日期大于当前日期则显示Edit按钮
                            result = result.replace('{0}', buttonEdit);
                        }
                        else {
                            result = result.replace('{0}', '');
                        }
                    }

                    $(td).html(result);
                },
                className: "text-center"
            }, {
                data: null,
                className: "table-col-seq"
            }, {
                data: "SystemUserDTO.User_NTID",
                className: "min-col-xs"
            }, {
                data: "SystemUserDTO.User_Name",
                className: "min-col-xs"
            }, {
                data: "SystemBUMDTO.BU_ID",
                className: "min-col-xs"
            }, {
                data: "SystemBUMDTO.BU_Name",
                className: "min-col-xs"
            }, {
                data: "SystemBUDDTO",
                className: "min-col-xs",
                render: function (data, type, full, meta) {
                    if (data != null) {
                        return data.BU_D_ID;
                    } else {
                        return '';
                    }
                }
            }, {
                data: "SystemBUDDTO",
                className: "min-col-xs",
                render: function (data, type, full, meta) {
                    if (data != null) {
                        return data.BU_D_Name;
                    } else {
                        return '';
                    }
                }
            }, {
                data: "SystemUserBusinessGroupDTO.Begin_Date",
                className: "min-col-xs"
            }, {
                data: "SystemUserBusinessGroupDTO.End_Date",
                className: "min-col-xs"
            }, {
                data: "SystemUserDTO1.User_Name",
                className: "min-col-lg"
            }, {
                data: "SystemUserBusinessGroupDTO.Modified_Date",
                className: "min-col-lg"
            }];
            //#endregion 定义字段列

            //#region 定义子列
            var subColumns = [{
                createdCell: function (td, cellData, rowData, row, col) {
                    $(td).html('<input type="checkbox" name="cktrans" class="js-checkbox-item" value="' + rowData.System_User_BU_UID + '">')
                         .addClass('table-col-checkbox');
                },
                className: "text-center",
                defaultContent: ' ',
            }, {
                className: "table-col-seq",
                render: function (data, type, full, meta) {
                    return ++meta.row;
                }
            }, {
                data: "BU_ID",
                className: "min-col-lg",
                render: function (data, type, full, meta) {
                    var readOnlyHtml = '<input type="text" name="BU_ID" class="form-control input-sm js_sub_bu_id" {0} value="' + data + '">';
                    var isEdit = $('#js_hidden_uid').val() > 0;
                    if (!isEdit) {//新增
                        readOnlyHtml = readOnlyHtml.replace('{0}', '');
                    }
                    else {//编辑
                        if (data != '') {//编辑的时候读取旧行
                            readOnlyHtml = readOnlyHtml.replace('{0}', 'Disabled="true"');
                        }
                        else {//编辑的时候新增新行
                            readOnlyHtml = readOnlyHtml.replace('{0}', '');
                        }
                    }
                    return readOnlyHtml;
                }
            }, {
                data: "BU_Name",
                className: "min-col-lg sub_bu_name",
            }, {
                data: "BUDList", //这个值无意义，但需要赋值
                className: "min-col-lg",
                createdCell: function (td, cellData, rowData, row, col) {
                    var result;
                    var readOnlyHtml = '<select name="BUDIDS"  class="form-control input-sm sub_bu_d_id"></select>';
                    if (rowData.BU_ID == '') {//新增或编辑状态的新增
                        result = readOnlyHtml;
                    }
                    else {
                        if (rowData.BUDList == null) {//编辑的时候没有BUDeatil信息
                            result = readOnlyHtml;
                        }
                        else {
                            readOnlyHtml = $(readOnlyHtml).append("<option value='All'>All</option>");
                            var optionSub;
                            var data = rowData.BUDList;
                            for (i = 0; i < data.length; i++) {
                                if (rowData.BU_D_ID == data[i].BU_D_ID) {
                                    optionSub = '<option value="' + data[i].BU_D_ID + '" selected="selected">' + data[i].BU_D_ID + '</option>';
                                }
                                else {
                                    optionSub = '<option value="' + data[i].BU_D_ID + '">' + data[i].BU_D_ID + '</option>';
                                }
                                readOnlyHtml = $(readOnlyHtml).append(optionSub);
                            }
                            
                        }
                        result = $(readOnlyHtml).attr("Disabled",true);
                        result = readOnlyHtml[0].outerHTML;
                    }
                    $(td).html(result);
                },
            }, {
                data: "BU_D_Name",
                className: "min-col-lg sub_bu_d_name",
                render: function (data, type, full, meta) {
                    if (data != '') {
                        return data;
                    }
                    else {
                        return '';
                    }
                }
            }, {
                data: "Begin_Date",
                className: "min-col-lg",
                createdCell: function (td, cellData, rowData, row, col) {

                    var html = '<div class="input-group"><div class="input-group-addon"><i class="fa fa-calendar"></i></div><input type="text" class="form-control input-sm date" id="s_input_begin_date" name="Begin_Date" placeholder="Begin Date" value="' + rowData.Begin_Date + '"> </div>';
                    var isEdit = $('#js_hidden_uid').val() > 0;
                    if (isEdit) {
                        if (rowData.BU_ID != '') { //编辑状态初始化，已经有的数据设置为只读
                            html = $(html).find('#s_input_begin_date').attr("Disabled", "true");
                        }
                    }
                    $(td).html(html);
                }
            }, {
                data: "End_Date",
                className: "min-col-lg",
                createdCell: function (td, cellData, rowData, row, col) {
                    if (rowData.End_Date == null) {
                        rowData.End_Date = '';
                    }
                    var html = '<div class="input-group"><div class="input-group-addon"><i class="fa fa-calendar"></i></div><input type="text" class="form-control input-sm date" id="s_input_end_date" name="End_Date" placeholder="End Date" value="' + rowData.End_Date + '"></div>';
                    var isEdit = $('#js_hidden_uid').val() > 0;
                    if (isEdit) {
                        if (rowData.End_Date != '' && rowData.End_Date != null) {
                            var nowDate = moment().format("YYYY-MM-DD");
                            var systemTime = rowData.End_Date;
                            if (moment(systemTime).isBefore(nowDate)) { //如果系统日期小于当前日期则显示Edit按钮
                                html = $(html).find('#s_input_end_date').attr("Disabled", "true");
                            }
                        }
                    }
                    $(td).html(html);
                }
            }];
            //#endregion

            var _getParams = function () {
                return $('#js_form_query').serialize().replace(/\+/g, " ");
            };

            var _queryUsers = function (firstLoad, buildCriteria) {
                var config = {
                    pageId: "#page",
                    tableId: "#js_user_datatable",
                    remoteUrl: urls.queryUserBUS,
                    searchParams: _getParams(),
                    tableOptions: {
                        columns: columns
                    }
                };
                if (!firstLoad) {
                    $('#page').page('destroy');
                }
                if (buildCriteria) {
                    PDMS.Utility.Criteria.Build();
                }
                PDMS.Utility.Pages.Set(config);
            };


            return {
                urls: urls,
                Init: function () {
                    PDMS.Utility.Criteria.Init();
                    _queryUsers(true,false);
                },
                QueryUserBUs: function (buildCriteria) {
                    if (!buildCriteria) {
                        buildCriteria = false;
                    }
                    _queryUsers(false, buildCriteria);
                },
                GetSubDatatable: function () {

                    if (subDatatable == null) {

                        subDatatable = $('#js_sub_bu_bud_table').DataTable({
                            paging: false,
                            searching: false,
                            ordering: false,
                            retrieve: true,
                            columns: subColumns,
                        });
                    }
                    return subDatatable;
                },
                SetSubDatatable: function (datatable) {
                    subDatatable = datatable;
                },
                DestroySubTable: function () {
                    if (subDatatable != null) {
                        subDatatable.destroy();
                    }
                },
                SubColumns: subColumns
            }
        })();

        UserBUSetting.Init();


        //Form Validate
        $('#js_form_userbu').validate({
            errorContainer: $('ul.validate-error'),
            errorLabelContainer: $('#js_edit_modal ul.validate-error'),
            wrapper: 'li'
        });

        //clear query conditions按钮
        $('#js_btn_clear').click(function () {
            PDMS.Utility.Criteria.Clear(function () {
                $('#inlineRadio1').prop('checked', true);
                $('#js_s_input_ref_date').val(moment().format("YYYY-MM-DD"));
            });
        });

        //#region Add/Edit model 出现和消失事件
        $('#js_edit_modal').on('show.bs.modal', function (event) {
            var button = $(event.relatedTarget)
            var modal = $(this)
            var title = modal.find('.modal-title');
            if (button.attr('id') == 'js_btn_add_bu') {
                title.text("Add User BU Setting");
                $('#js_edit_modal').find('input[name=User_NTID]').removeAttr("Readonly");
                $('#js_btn_del_sub_func').show();
                $('#js_btn_save_edit_userbu').hide();
                $('#js_btn_save_new_userbu').show();
                $('#js_hidden_uid').val(0);
            }
            else if ($("#js_hidden_uid").val() > 0) {
                $('#js_edit_modal').find('.modal-title').text('Edit User BU Setting');
                $('#js_edit_modal').find('input[name=User_NTID]').attr("Readonly", "Readonly");
                $('#js_btn_del_sub_func').hide();
                $('#js_btn_save_edit_userbu').show();
                $('#js_btn_save_new_userbu').hide();
            }
        });
        //#endregion Add/Edit model 出现和消失事件

        //region 搜索方法
        $('#js_btn_query').click(function () {
            if ($("#js_form_query").valid()) {
                UserBUSetting.QueryUserBUs(true);
                $('#js_search_modal').modal('hide');
            }
        });
        //endregion 搜索方法

        //User NTID文本框失去焦点后根据内容自动填充User Name
        $('#js_input_user_ntid').on('blur', function () {

            $.get(UserBUSetting.urls.getUserName, { User_NTID: $(this).val() },
                function (data) {
                    var userName = '';
                    if (data !== 'null') {
                        userName = data.User_Name;
                    }
                    $('#js_input_user_name').val(userName);
                });
        });


        //点击gridview Edit事件
        $('body').on('click', '.js-grid-edit', function () {
            var System_User_BU_UID = $(this).attr('data-id');
            var url = UserBUSetting.urls.queryUserBU;

            $.post(url, { System_User_BU_UID: System_User_BU_UID }, function (data) {
                $('#js_edit_modal').find('input[name=User_NTID]').val(data[0].User_NTID);
                $('#js_edit_modal').find('input[name=User_Name]').val(data[0].User_Name);
                $('#js_hidden_uid').val(System_User_BU_UID);
                $('#js_hidden_bu_d_id').val(data[0].BU_D_ID);
                //绑定子表
                var subTable = $('#js_sub_bu_bud_table').DataTable({
                    columns: UserBUSetting.SubColumns,
                    ordering: false,
                    data: data,
                    destroy: true,
                    createdRow: function (row, data, index) {
                        $(row).find('.date').datetimepicker(PDMS.Utility.Settings.Datetimepicker);
                    }
                });
                UserBUSetting.SetSubDatatable(subTable);
                $('#js_edit_modal').modal('show');
            });
        });


        //增加BU，BUD行按钮
        $('#js_btn_add_sub_func').on('click', function () {
            if ($("#js_form_userbu").valid()) {
                var dataTable = UserBUSetting.GetSubDatatable();
                var allowAdd = true;
                allowAdd = validateSubTable(dataTable);

                if (allowAdd) {
                    var row = dataTable.row.add({
                        "BU_ID": "",
                        "BU_Name": "",
                        "BUDList": null,
                        "BU_D_Name": "",
                        "Begin_Date": "",
                        "End_Date":""
                    }).draw();
                    $('.date').datetimepicker(PDMS.Utility.Settings.Datetimepicker);
                    //$(row.node()).find('input[name=Sub_Fun]').removeAttr("readonly");
                }
            }
        });


        var validateSubTable = function (dataTable) {
            var allowAdd = true;
            dataTable.rows().every(function (rowIdx, tableLoop, rowLoop) {
                if ($.trim($(dataTable.cell(rowIdx, 2).node()).find('input').val()) === "") {
                    allowAdd = false;
                    PDMS.Utility.MessageBox.info('Incomplete context at row #' + (rowIdx + 1) + ", Please fill complete before add new row.");
                    return;
                }
                if ($.trim($(dataTable.cell(rowIdx, 3).node()).text()) === "") {
                    allowAdd = false;
                    PDMS.Utility.MessageBox.info('Incomplete context at row #' + (rowIdx + 1) + ", Please fill complete before add new row.");
                    return;
                }
                //判断Begin_Date是否为空
                if ($.trim($(dataTable.cell(rowIdx, 6).node()).find('#s_input_begin_date').val()) == "") {
                    allowAdd = false;
                    PDMS.Utility.MessageBox.info('Incomplete context at row #' + (rowIdx + 1) + ", Please fill complete before add new row.");
                    return;
                }
                //如果End_Date不为空，则判断End_Date要大于Begin_Date
                if ($.trim($(dataTable.cell(rowIdx, 7).node()).find('#s_input_end_date').val()) != "") {
                    var beginDate = $(dataTable.cell(rowIdx, 6).node()).find('#s_input_begin_date').val();
                    var endDate = $(dataTable.cell(rowIdx, 7).node()).find('#s_input_end_date').val();
                    if (moment(endDate).isBefore(beginDate)) {
                        allowAdd = false;
                        PDMS.Utility.MessageBox.info('Incomplete context at row #' + (rowIdx + 1) + ", End Date must great than Begin Date.");
                        return;
                    }
                }
            });
            return allowAdd;
        }

        $('#js_edit_modal').on('blur', '.js_sub_bu_id', function () {
            var object = $(this);
            var BU_ID = $(this).val();
            $.get(UserBUSetting.urls.queryBUAndBUDSByBUID, { BU_ID: BU_ID }, function (data) {
                object.closest('tr').find('.sub_bu_name').text(data.BU_Name);
                if (data.BU_Name != null) {
                    var optionHead = object.closest('tr').find('.sub_bu_d_id');
                    optionHead.empty();
                    if (data.SystemBUDDTOList != null) {
                        optionHead.append("<option value='All'>All</option>");
                    }
                    for (i = 0; i < data.SystemBUDDTOList.length; i++) {
                        var optionSub = '<option value="' + data.SystemBUDDTOList[i].BU_D_ID + '">' + data.SystemBUDDTOList[i].BU_D_ID + '</option>';
                        optionHead.append(optionSub);
                    }
                }
                else {
                    object.closest('tr').find('.sub_bu_d_id').empty();
                }
            });
        });

        $('#js_edit_modal').on('change', '.sub_bu_d_id', function () {
            var object = $(this);
            var BU_D_ID = $(this).val();
            $.get(UserBUSetting.urls.queryBUDInfoByBU_D_ID, { BU_D_ID: BU_D_ID }, function (data) {
                object.closest('tr').find('.sub_bu_d_name').text(data.BU_D_Name);
            });
        });

        //#region 删除某子表某一行的值
        $('#js_btn_del_sub_func').on('click', function () {
            var dataTable = UserBUSetting.GetSubDatatable();
            var $checkedItems = $('#js_sub_bu_bud_table .js-checkbox-item:checked');
            if ($checkedItems.length == 0) {
                PDMS.Utility.MessageBox.info("Please select data to delete");
                return;
            } else {
                //var functionUid = $('#js_hidden_uid').val();
                $.map($checkedItems, function (checkbox) {
                    dataTable.row($(checkbox).parents('tr')).remove().draw();
                });
                dataTable.rows().every(function (rowIdx, tableLoop, rowLoop) {
                    dataTable.cell(rowIdx, 1).data(rowIdx + 1).draw()
                });

            }
        });
        //#endregion 删除某子表某一行的值

        //#region 新增或编辑保存按钮事件
        $('#js_btn_save_new_userbu').on('click', function () {
            AddAndEdit();
        });

        
        $('#js_btn_save_edit_userbu').on('click', function () {
            AddAndEdit();
        });


        var AddAndEdit = function () {
            if ($("#js_form_userbu").valid()) {
                var flag = true;
                var dataTable = UserBUSetting.GetSubDatatable();
                var submitJson = $('#js_form_userbu').serializeObject();
                var FunctionSubs = [];

                flag = validateSubTable(dataTable);
                if (!flag) {
                    return;
                }
                dataTable
                .rows()
                .every(function (rowIdx, tableLoop, rowLoop) {
                    var sub = {};
                    var row = $('#js_sub_bu_bud_table>tbody>tr').eq(rowIdx);
                    var keyID = $.trim(row.find('input[name=cktrans]').val());
                    sub["System_User_BU_UID"] = keyID == "undefined"?0:keyID;
                    var BU_ID = $.trim(row.find('input[name=BU_ID]').val());
                    sub["BU_ID"] = BU_ID;
                    var BU_D_ID = $.trim(row.find('.sub_bu_d_id option:selected').val());
                    sub["BU_D_ID"] = BU_D_ID;
                    var Begin_Date = $.trim(row.find('#s_input_begin_date').val());
                    sub["Begin_Date"] = Begin_Date;
                    var End_Date = $.trim(row.find('#s_input_end_date').val());
                    sub["End_Date"] = End_Date;
                    FunctionSubs.push(sub);
                });

                submitJson.FunctionSubs = FunctionSubs;

                var isEdit = $("#js_hidden_uid").val() > 0
                $.post(UserBUSetting.urls.addOrEditUserBU, { jsonUserBUWithSubs: JSON.stringify(submitJson), isEdit: isEdit }, function (data) {
                    if (data != 'Success') {
                        PDMS.Utility.MessageBox.info(data);
                    }
                    else {
                        PDMS.Utility.MessageBox.info("Save Success");
                        $("#js_form_userbu input[type!='hidden']").val('');
                        UserBUSetting.QueryUserBUs(false);
                        $('#js_edit_modal').modal('hide');
                    }

                });
            };
        }
        //#endregion

        //#region 导出按钮
        $('#js_btn_export').click(function () {
            var $selectList = $('#js_user_datatable').find('.js-checkbox-item:checked');
            var len = $selectList.length;
            if (len == 0) {
                PDMS.Utility.MessageBox.info('please select datas to export!');
            } else {
                var uids = $.map($selectList, function (row) {
                    return row.value;
                });
                var url = UserBUSetting.urls.doExportUserBU;
                url += "?uids=" + uids.toString();
                window.location.href = url;
            }

        })
        //#endregion

        //#region 隐藏modal框时清空值

        //隐藏modal框时清空值
        $('#js_edit_modal').on('hidden.bs.modal', function (e) {
            var dataTable = UserBUSetting.GetSubDatatable();
            dataTable.clear().draw();

            $('#js_edit_modal').find('input').val('');
            $('.list-group.validate-error').empty();
        });
        //#endregion 隐藏modal框时清空值

    });

</script>

}