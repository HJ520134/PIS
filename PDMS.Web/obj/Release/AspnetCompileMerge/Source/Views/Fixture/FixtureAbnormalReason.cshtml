<section class="content portal-content">
    <div class="row">
        <div class="col-xs-12" id="js_criteria_alert_cnt">
        </div>
        <div class="col-md-12 col-lg-9">
            <h4 class="margin-td-5" id="js_search_keywords"></h4>
        </div>
    </div>
    <div class="row">
        <div class="col-xs-12">
            <div class="col-md-12 col-lg-8">
            </div>
            <div class="col-md-12 search-field col-lg-4">
            
                <a href="~/ExcelTemplate/FixtureDefectCode_Setting.xlsx" class="fa fa-download btn btn-primary" target="_blank"> 模板下载</a>
                <button type="button" class="fa fa-upload btn btn-primary" id="btn_import_fl"> 上传</button>   
                 <a class="fa fa-search btn btn-primary" data-toggle="modal" id="bt_search" data-target="#js_search_modal"> 查询</a>
                 <a class="fa fa-plus btn btn-primary" role="button" data-toggle="modal" id="btn_add"> 添加</a>
                 <button type="button" class="fa fa-download btn btn-primary" id="js_btn_export"> 导出</button>
        
            </div>

        </div>
    </div>
    <hr class="hr-custom">
    
    <div class="row">
        <div class="col-md-12 table-container">
            <table class="table table-striped table-hover table-condensed nowrap" id="js_Bom_datatable">
                <thead>
                    <tr>
                        <th class="table-col-checkbox nosort"><input type="checkbox" class="js-checkbox-all" /></th>
                        <th class="table-col-seq nosort">序号</th>
                        <th class="table-col-action nosort">操作</th>
                        <th>厂区</th>
                        <th>Business Group</th>
                        <th>功能厂</th>                                 
                        <th>治具编号(图号)</th>
                        <th>异常代码</th>
                        <th>治具异常原因</th>
                        <th>是否启用</th>
                        <th>最后更新者</th>
                        <th>最后更新日期</th>
                    </tr>
                </thead>
                <tfoot>
                    <tr>
                        <th class="table-col-checkbox nosort"></th>
                        <th class="table-col-seq nosort">序号</th>
                        <th class="table-col-action nosort">操作</th>
                        <th>厂区</th>
                        <th>Business Group</th>
                        <th>功能厂</th>
                        <th>治具编号(图号)</th>
                        <th>异常代码</th>
                        <th>治具异常原因</th>
                        <th>是否启用</th>
                        <th>最后更新者</th>
                        <th>最后更新日期</th>
                    </tr>
                </tfoot>
            </table>
            <div id="page" class="row"></div>

        </div><!--/表格-->
    </div>

</section>
@section ViewModals{
<div class="modal fade" id="js_search_modal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title">查询</h4>
            </div>
            <div class="modal-body">
                <form id="js_form_query" class="form-horizontal" data-need-validate="true">
                    <div class="row">

                        <div class="form-group col-xs-12 col-md-6 col-lg-6">
                            <label class="col-sm-5 control-label" for="js_select_factory_query">厂区</label>
                            <div class="col-sm-7">
                                <select class="selectpicker form-control input-sm" id="js_select_factory_query" name="Plant_Organization_UID" data-live-search="true">
                                    @foreach (var item in Model.Plants)
                                    {
                                        <option value=@item.Plant_OrganizationUID>@item.Plant</option>
                                    }
                                </select>
                            </div>
                        </div>
                        <div class="form-group col-xs-12 col-md-6 col-lg-6">
                            <label class="col-sm-5 control-label" for="js_select_optype_query">OP类型</label>
                            <div class="col-sm-7">
                                <select class="selectpicker form-control input-sm" id="js_select_optype_query" name="BG_Organization_UID" data-live-search="true"></select>
                            </div>
                        </div>

                        <div class="form-group col-xs-12 col-md-6 col-lg-6">
                            <label class="col-sm-5 control-label" for="js_select_funplant_query">功能厂</label>
                            <div class="col-sm-7">
                                <select class="selectpicker form-control input-sm" id="js_select_funplant_query" name="FunPlant_Organization_UID" data-live-search="true"></select>
                            </div>
                        </div>
                        <div class="form-group col-xs-12 col-md-6 col-lg-6">
                            <label class="col-sm-5 control-label" for="s_input_Fixture_NO_query">治具编号</label>
                            <div class="col-sm-7">
                                <input type="text" class="form-control input-sm" id="s_input_Fixture_NO_query" name="Fixture_NO" placeholder="Fixture_NO">
                            </div>
                        </div>                                  
                        <div class="form-group col-xs-12 col-md-6 col-lg-6">
                            <label class="col-sm-5 control-label" for="s_input_DefectCode_ID_query">异常代码</label>
                            <div class="col-sm-7">
                                <input type="text" class="form-control input-sm" id="s_input_DefectCode_ID_query" name="DefectCode_ID" placeholder="DefectCode_ID">

                           </div>
                        </div>
                        <div class="form-group col-xs-12 col-md-6 col-lg-6">
                            <label class="col-sm-5 control-label" for="s_input_DefectCode_Name_query">异常名称</label>
                            <div class="col-sm-7">
                                <input type="text" class="form-control input-sm" id="s_input_DefectCode_Name_query" name="DefectCode_Name" placeholder="DefectCode_ID">
                          </div>
                        </div> 
                        <div class="form-group col-xs-12 col-md-6 col-lg-6">
                            <label class="col-sm-5 control-label" for="s_input_Is_Enable_query">是否启用</label>
                            <div class="col-sm-7">
                                <select class="selectpicker form-control input-sm" id="s_input_Is_Enable_query" name="Is_Enable" data-live-search="true">
                                    <option></option>
                                    <option value="true">启用</option>
                                    <option value="false">禁用</option>
                                </select>
                            </div>
                        </div>
                                    
                        <div class="form-group col-xs-12 col-md-6 col-lg-6">
                            <label class="col-sm-5 control-label" for="s_input_Modified_UID_query">最后修改者</label>
                            <div class="col-sm-7">
                                <input type="text" class="form-control input-sm" id="s_input_Modified_UID_query" name="Modifieder" placeholder="Modifieder">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="col-sm-4 control-label no-padding-hr" data-type="date-interval">修改日期</label>
                                <div class="col-sm-8">
                                    <div class="input-group">
                                        <span class="input-group-addon"><i class="fa fa-calendar"></i></span>
                                        <span class="input-group-addon">From</span>
                                        <input type="text" name="End_Date_From" class="form-control input-sm date" id="js_s_input_modified_from">
                                        <span class="input-group-addon">To</span>
                                        <input type="text" name="End_Date_To" class="form-control input-sm date" id="js_s_input_modified_to">
                                    </div>
                                </div>
                            </div>
                        </div>                
                        <div class="col-xs-12">
                            <ul class="list-group validate-error"></ul>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary btn-sm" id="js_btn_clear"><i class="fa fa-eraser"></i> 清空</button>
                <button type="button" class="btn btn-primary btn-sm" id="js_btn_query"><i class="fa fa-search"></i> 查询</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="js_edit_modal" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title">新增</h4>
            </div>          
                <div class="modal-body form-horizontal">
                    <div class="row">
                        <div class="form-group col-xs-12 col-md-6 col-lg-6">
                            <label class="col-sm-5 control-label" for="s_input_optype_add">厂区</label>
                            <div class="col-sm-7">
                                <select class="selectpicker form-control input-sm" id="js_select_factory_add" name="Plant_Organization_UID" data-live-search="true">
                                    @foreach (var item in Model.Plants)
                                    {
                                        <option value=@item.Plant_OrganizationUID>@item.Plant</option>
                                    }
                                </select>
                            </div>
                        </div>
                        <div class="form-group col-xs-12 col-md-6 col-lg-6">
                            <label class="col-sm-5 control-label" for="s_input_optype_add">OP类型</label>
                            <div class="col-sm-7">
                                <select class="selectpicker form-control input-sm" id="js_select_optype_add" name="BG_Organization_UID" data-live-search="true"></select>
                            </div>
                        </div>

                        <div class="form-group col-xs-12 col-md-6 col-lg-6">
                            <label class="col-sm-5 control-label">功能厂</label>
                            <div class="col-sm-7">
                                <select class="selectpicker form-control input-sm" id="js_select_funplant_add" name="FunPlant_Organization_UID" data-live-search="true"></select>
                            </div>
                        </div>
                        <div class="form-group col-xs-12 col-md-6 col-lg-6">
                            <label class="col-sm-5 control-label" for="s_input_Fixture_NO_add">治具编号</label>
                            <div class="col-sm-7">
                                <select class="selectpicker form-control input-sm" id="s_input_Fixture_NO_add" name="Fixture_NO" data-live-search="true"></select>

                           </div>
                        </div>

                        @*<div class="form-group col-xs-12 col-md-6 col-lg-6">
                            <label class="col-sm-5 control-label" for="s_input_Version_add">版本</label>
                            <div class="col-sm-7">
                                <input type="text" class="form-control input-sm required" required data-rule-maxlength="2" id="s_input_Version_add" name="Version" placeholder="Version">
                            </div>
                        </div>*@
                        <input type="hidden" id="isEdit" name="isEdit" />
                        <div class="col-xs-12">
                            <ul class="list-group validate-error"></ul>
                        </div>

                    </div>
                    <div class="row">
                        <div class="form-group col-xs-12 col-md-12 col-lg-12">
                            <hr class="no-margin" />
                        </div>
                        <div class="form-group col-xs-12 col-md-6 col-lg-6">
                            <label class="col-sm-5 control-label" for="js_select_Group_add">异常原因群组</label>
                            <div class="col-sm-7">
                                <select class="selectpicker form-control input-sm" id="js_select_Group_add" name="DefectCode_Group_ID" data-live-search="true"></select>
                            </div>
                        
                        </div>
                        <div class="form-group col-xs-12 col-md-6 col-lg-6">
                            <div class="col-sm-3">
                                <button class="btn btn-primary btn-sm" id="js_btn_DefectCode_Group_main"> 确认选取群组</button>
                            </div>
                            <div class="col-sm-9">
                            </div>
                        </div>
                            <div class="form-group col-xs-12 col-md-12 col-lg-12">
                                <hr class="no-margin" />
                            </div>

                        </div>
                    <div class="row">
                        <div class="form-group col-xs-12 col-md-6 col-lg-6">
                            <div class="col-sm-7">
                                <strong> 异常原因资料区</strong>
                            </div>
                            <div class="col-sm-5">
                            </div>

                        </div>
                        <div class="form-group col-xs-12 col-md-6 col-lg-6">
                            <div class="col-sm-3">

                            </div>
                            <div class="col-sm-9">
                            </div>
                        </div>
                    </div>
                        <div class="row">                     
                            <div class="form-group col-xs-12 col-md-6 col-lg-6">
                                <div class="col-sm-3">
                                    <button class="btn btn-primary btn-sm" id="js_btn_Reason_add"> 新增异常原因</button>
                                </div>
                                <div class="col-sm-3">
                                    <button class="btn btn-primary btn-sm" id="js_btn_Reason_delete"> 删除异常原因</button>
                                </div>
                                <div class="col-sm-6">
                                </div>
                            </div>
                            <div class="form-group col-xs-12 col-md-6 col-lg-6">

                            </div>
                        </div>
                        <table id="js_AbnormalReason_table" class="table table-condensed">
                            <thead>
                                <tr>
                                    <th class="table-col-checkbox nosort">
                                        <input type="checkbox" class="js-checkbox-all" />
                                    </th>
                                    <th class="table-col-seq nosort">序号</th>
                                    <th class="padding-l-5-i">异常代码</th>
                                    <th class="padding-l-5-i">异常名称</th>
                                    <th class="padding-l-5-i">是否启用</th>
                                </tr>
                            </thead>
                        </table>

                    </div>


                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary btn-sm" data-dismiss="modal"><i class="fa fa-times"></i> 取消</button>
                        <button type="button" class="btn btn-primary btn-sm" id="js_btn_save_new_function"><i class="fa fa-save"></i> 保存</button>
                  </div>
         
        </div>
    </div>
</div>
<div class="modal fade" id="js_view_modal" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title">查看治具异常原因设定资料</h4>
            </div>
            <div class="modal-body form-horizontal">
                <div class="form-group col-xs-12 col-md-6 col-lg-6">
                    <label class="col-sm-5 control-label" for="s_input_optype_view">厂区</label>
                    <div class="col-sm-7">
                        <input type="text" class="form-control input-sm" id="js_select_factory_view" name="Plant_Organization_UID" placeholder="Plant" readonly>
                    </div>
                </div>
                <div class="form-group col-xs-12 col-md-6 col-lg-6">
                    <label class="col-sm-5 control-label" for="s_input_optype_view">OP类型</label>
                    <div class="col-sm-7">
                        <input type="text" class="form-control input-sm" id="js_select_optype_view" name="BG_Organization_UID" placeholder="OP Type" readonly>
                    </div>
                </div>

                <div class="form-group col-xs-12 col-md-6 col-lg-6">
                    <label class="col-sm-5 control-label" for="s_input_funplant_view">功能厂</label>
                    <div class="col-sm-7">
                        <input type="text" class="form-control input-sm" id="js_select_funplant_view" name="FunPlant_Organization_UID" placeholder="FunPlant" readonly>
                    </div>
                </div>
                <div class="form-group col-xs-12 col-md-6 col-lg-6">
                    <label class="col-sm-5 control-label" for="s_input_Fixture_NO_view">治具编号</label>
                    <div class="col-sm-7">
                        <input type="text" class="form-control input-sm" id="s_input_Fixture_NO_view" name="Fixture_NO" placeholder="Fixture_NO" readonly>
                    </div>
                </div>
            
                <div class="form-group col-xs-12 col-md-6 col-lg-6">
                    <label class="col-sm-5 control-label" for="js_select_DefectCode_ID_view">异常代码</label>
                    <div class="col-sm-7">
                        <input type="text" class="form-control input-sm" id="js_select_DefectCode_ID_view" name="DefectCode_ID" placeholder="DefectCode_ID" readonly>
                    </div>
                </div>

                <div class="form-group col-xs-12 col-md-6 col-lg-6">
                    <label class="col-sm-5 control-label" for="js_select_DefectCode_Name_view">异常名称</label>
                    <div class="col-sm-7">
                        <input type="text" class="form-control input-sm" id="js_select_DefectCode_Name_view" name="DefectCode_Name" placeholder="DefectCode_Name" readonly>
                    </div>
                </div>
                <div class="form-group col-xs-12 col-md-6 col-lg-6">
                    <label class="col-sm-5 control-label" for="s_input_Is_Enable_view">是否启用</label>
                    <div class="col-sm-7">
                        <input type="text" class="form-control input-sm" id="s_input_Is_Enable_view" name="Is_Enable" placeholder="Is_Enable" readonly>
                    </div>
                </div>
                <div class="form-group col-xs-12 col-md-6 col-lg-6">
                    <label class="col-sm-5 control-label" for="s_input_Modified_UID_view">最后更新者</label>
                    <div class="col-sm-7">
                        <input type="text" class="form-control input-sm" id="s_input_Modified_UID_view" name="Modifieder" placeholder="Modifieder" readonly>
                    </div>
                </div>
                <div class="form-group col-xs-12 col-md-6 col-lg-6">
                    <label class="col-sm-5 control-label" for="s_input_Modified_Date_view">最后更新日期</label>
                    <div class="col-sm-7">
                        <input type="text" class="form-control input-sm" id="s_input_Modified_Date_view" name="Modified_Date" placeholder="Modified_Date" readonly>
                    </div>
                </div>
                <div class="col-xs-12">
                    <ul class="list-group validate-error"></ul>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary btn-sm" data-dismiss="modal"><i class="fa fa-times"></i> 关闭</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="js_viewedit_modal" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title">编辑治具异常原因设定资料</h4>
            </div>
@using (Html.BeginForm("EditFixtureDefectCode_Setting", "Fixture", FormMethod.Post, new { id = "js_form_user_edit" }))
{
            <div class="modal-body form-horizontal">
                <div class="form-group col-xs-12 col-md-6 col-lg-6">
                    <label class="col-sm-5 control-label" for="s_input_optype_viewedit">厂区</label>
                    <div class="col-sm-7">
                        <select class="selectpicker form-control input-sm" id="js_select_factory_viewedit" name="Plant_Organization_UID" data-live-search="true" readonly>
                            <option></option>
                             @foreach (var item in Model.Plants)
                             {
                                <option value=@item.Plant_OrganizationUID>@item.Plant</option>
                             }
                        </select>
                    </div>
                </div>
                <div class="form-group col-xs-12 col-md-6 col-lg-6">
                    <label class="col-sm-5 control-label" for="s_input_optype_viewedit">OP类型</label>
                    <div class="col-sm-7">
                        <select class="selectpicker form-control input-sm" id="js_select_optype_viewedit" name="BG_Organization_UID" data-live-search="true" readonly></select>
                    </div>
                </div>

                <div class="form-group col-xs-12 col-md-6 col-lg-6">
                    <label class="col-sm-5 control-label" for="s_input_funplant_viewedit">功能厂</label>
                    <div class="col-sm-7">
                        <select class="selectpicker form-control input-sm" id="js_select_funplant_viewedit" name="FunPlant_Organization_UID" data-live-search="true" readonly></select>
                    </div>
                </div>
                <div class="form-group col-xs-12 col-md-6 col-lg-6">
                    <label class="col-sm-5 control-label" for="s_input_Fixture_NO_viewedit">治具编号</label>
                    <div class="col-sm-7">
                        <input type="text" class="form-control input-sm" id="s_input_Fixture_NO_viewedit" name="Fixture_NO"  placeholder="Fixture_NO" >
                    </div>
                </div>

                <div class="form-group col-xs-12 col-md-6 col-lg-6">
                    <label class="col-sm-5 control-label" for="js_select_DefectCode_ID_viewedit">异常代码</label>
                    <div class="col-sm-7">
                        <input type="text" class="form-control input-sm" id="js_select_DefectCode_ID_viewedit" name="DefectCode_ID" placeholder="DefectCode_ID" >
                    </div>
                </div>

                <div class="form-group col-xs-12 col-md-6 col-lg-6">
                    <label class="col-sm-5 control-label" for="js_select_DefectCode_Name_viewedit">异常名称</label>
                    <div class="col-sm-7">
                        <input type="text" class="form-control input-sm" id="js_select_DefectCode_Name_viewedit" name="DefectCode_Name" placeholder="DefectCode_Name" readonly>
                    </div>
                </div>
                <div class="form-group col-xs-12 col-md-6 col-lg-6">
                    <label class="col-sm-5 control-label" for="s_input_Is_Enable_viewedit">是否启用</label>
                    <div class="col-sm-7">
                        <select class="selectpicker form-control input-sm" id="s_input_Is_Enable_viewedit" name="Is_Enable" data-live-search="true">
                            
                                <option value="true">启用</option>
                               <option value="false">禁用</option>
                        </select>
                    </div>
                </div>
                @*<div class="form-group col-xs-12 col-md-6 col-lg-6">
                    <label class="col-sm-5 control-label" for="s_input_Modified_UID_viewedit">最后更新者</label>
                    <div class="col-sm-7">
                        <input type="text" class="form-control input-sm" id="s_input_Modified_UID_viewedit" name="Modified_UID" placeholder="Modified_UID" readonly>
                    </div>
                </div>
                <div class="form-group col-xs-12 col-md-6 col-lg-6">
                    <label class="col-sm-5 control-label" for="s_input_Modified_Date_viewedit">最后更新日期</label>
                    <div class="col-sm-7">
                        <input type="text" class="form-control input-sm" id="s_input_Modified_Date_viewedit" name="Modified_Date" placeholder="Modified_Date" readonly>
                    </div>
                </div>*@

                <input type="hidden" id="fixtureDefectCode_Setting_UID" name="FixtureDefectCode_Setting_UID" />
                <div class="col-xs-12">
                    <ul class="list-group validate-error"></ul>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary btn-sm" data-dismiss="modal"><i class="fa fa-times"></i> 关闭</button>
                <button type="button" class="btn btn-primary btn-sm" id="js_btn_save_new"><i class="fa fa-save"></i> 保存</button>

            </div>
}
        </div>
    </div>
</div>
<div class="modal fade" id="js_importExcel_modal" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title">导入治具异常原因资料</h4>
            </div>
            @using (Html.BeginForm("ImportFixtureDefectCode_Setting", "Fixture", FormMethod.Post, new { enctype = "multipart/form-data", id = "js_form_excel_upload" }))
            {
                <div class="modal-body">
                    <div class="row">
                        <div class="col-sm-2">
                            <label class="control-label" for="js_s_input_import">选择Excel档</label>
                        </div>
                        <div class="col-sm-8">
                            <input type="file" class="form-control" id="js_s_input_import" name="uploadName" placeholder="选择文件"
                                   required data-msg-required="请选择要上传的Excel档!" />
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-primary btn-sm" id="btn_clear_Update"><i class="fa fa-times"></i>取消</button>
                    <button type="button" class="btn btn-primary btn-sm" id="btn_excel_upload"><i class="fa fa-save"></i>提交</button>

                </div>
            }
        </div>
    </div>
</div>

    }

@section ViewScripts{
    <link rel="stylesheet" type="text/css" href="~/Content/css/bootstrap-select.css" />
    <script type="text/javascript" src="~/Scripts/EQP/bootstrap-select.js"></script>
<div>
    <script type="text/javascript">


    $('#btn_import_fl').on('click', function () {
        $('#js_importExcel_modal').modal('show');
    });
    $('#btn_clear_Update').on('click', function () {
        $('#js_importExcel_modal').modal('hide');
    });

    $('#js_btn_clear').click(function () {
        var $searchform = $('#js_form_query');
        $searchform.find("select").each(function() {
            $(this).find("option").attr("selected", false);
            $(this).find("option").first().attr("selected", true);
            $(this).selectpicker('refresh');
        });
        PDMS.Utility.Criteria.Clear();

    });

    $(function () {
        fixtureDataTable=null;
        editData = null;
        var StorageReportSetting = (function () {
            var urls = {
                //画面初始化加载
                queryFixture: '@Url.Action("QueryFixtureDefectCode_Setting", "Fixture")',
                //根据厂区取得OP类型
                getCurrentOPType: '@Url.Action("GetCurrentOPType", "Fixture")',
                //根据OP类型取得功能厂
                getFunPlantByOPTypes: '@Url.Action("GetFunPlantByOPTypes", "Fixture")',
                //根据厂区，OP，异常原因ID获取治具异常原因
                getFixture_DefectCode: '@Url.Action("GetFixture_DefectCode", "Fixture")',
                //根据厂区，BG，功能厂 获取治具编码
                fixtureList:'@Url.Action("FixtureList", "Fixture")',

                //根据厂区，BG，功能厂 获取治具分组
                defectCode_GroupList:'@Url.Action("DefectCode_GroupList", "Fixture")',

                //根据厂区，OP，功能厂 ，异常群组ID，获取治具异常原因
                getDefectCodeByGroup: '@Url.Action("GetDefectCodeByGroup", "Fixture")',

                //新建治具分组
                addFixtureDefectCode_Setting:'@Url.Action("AddFixtureDefectCode_Setting", "Fixture")',

                //删除数据库中已存在的治具原因
                deleteFixtureDefectCode_SettingByID:'@Url.Action("DeleteFixtureDefectCode_SettingByID", "Fixture")',
                //根据ID获取治具配置信息
                getFixtureDefectCode_SettingDTOByUID:'@Url.Action("GetFixtureDefectCode_SettingDTOByUID", "Fixture")',



                //导出excel
                doExportFunction: '@Url.Action("DoExportFixtureDefectCode_SettingReprot", "Fixture")',
                //下载模板
                downloadExcel: '@Url.Action("FixtureDefectCode_Setting", "Fixture")',

                doAllExportFunction: '@Url.Action("DoAllExportFixtureDefectCode_SettingReprot", "Fixture")',


            };
            //#region 定义字段列
            var columns = [{
                createdCell: function (td, cellData, rowData, row, col) {
                    $(td).html('<input type="checkbox" name="cktrans" class="js-checkbox-item" value="' + rowData.FixtureDefectCode_Setting_UID + '">')
                    .addClass('table-col-checkbox');
                },
                className: "text-center"
            }, {
                data: null,
                className: "table-col-seq"
            },
            {
                createdCell: function (td, cellData, rowData, row, col) {
                    var buttonEdit = '<button type="button" class="btn btn-primary btn-xs js-grid-edit" data-id="' + rowData.FixtureDefectCode_Setting_UID + '">编辑</button>';
                    var result = '<button class="btn btn-primary btn-xs" rel="action-popover">' +
                                '<i class="fa fa-reorder"></i>' +
                                '</button>' +
                                '<div class="hidden popover-content">' +
                                    '{0}' +
                                    '{1}' +
                                    '{2}' +
                                '</div>';
                    var buttonview = '<button type="button" class="btn btn-primary btn-xs js-grid-view" data-id="' + rowData.FixtureDefectCode_Setting_UID + '">查看</button>';
                    var buttondelete = '<button type="button" class="btn btn-primary btn-xs js-grid-delete" data-id="' + rowData.FixtureDefectCode_Setting_UID + '">删除</button>';
                    result = result.replace('{0}', buttonEdit);
                    result = result.replace('{1}', buttonview);
                    result = result.replace('{2}', buttondelete);
                    $(td).html(result);
                },
                className: "text-center"
            },
            {
                data: "PlantName",
                className: "min-col-xs"
            }, {
                data: "OPName",
                className: "min-col-xs"
            }, {
                data: "FunPlantName",
                className: "min-col-xs"
            },
            {
                data: "Fixture_NO",
                className: "min-col-xs"
            },
            {
                data: "DefectCode_ID",
                className: "min-col-xs"
            },
            {
                data: "DefectCode_Name",
                className: "min-col-xs"
            },
             {
                 data: "Is_Enable",
                 render: function (data, type, full, meta) {
                     return data ? "启用" : "禁用";
                 },
                 className: "min-col-xs"
             },
             {
                 data: "Modifieder",
                 className: "min-col-xs text-right"
             }, {
                 data: "Modified_Date",
                 className: "min-col-xs text-right"
             }
            ];
            //领用的table Column
            var funcGetColumns = [
           {
               data: null,
               createdCell: function (td, cellData, rowData, row, col) {
                   $(td).html('<input type="checkbox" name="cktrans" class="js-checkbox-item" value="' + rowData.Fixtrue_Defect_UID + '">')
                        .addClass('table-col-checkbox');
               },
               className: "text-center min-col-xs"
           },                     {
               render: function (data, type, full, meta) {
                   return ++meta.row;
               }
           }, {
               data: "DefectCode_ID",
               render: function (data, type, full, meta) {
                   var isEdit = true;
                   var html = '<input type="text" name="DefectCode_ID" class="form-control input-sm js-input-function-id"' + (isEdit ? 'disabled' : '') + ' value="' + data + '">';
                   return html;
               },
               className: "min-col-xs"
           }, {
               data: "DefectCode_Name",
               //render: function (data, type, full, meta) {

               //    var html = '<input type="text" name="DefectCode_Name" class="form-control input-sm js-input-function-id"' + ('disabled' ) + ' value="' + data + '">';
               //    return html;
               //},
               className: "min-col-lg"
           }, {
               data: "Is_Enable",
               render: function (data, type, full, meta) {
                   var html = '<select class="form-control input-sm js-select-subfunc-isshow">' +
                          '<option value="true" ' + (data ? 'selected' : '') + '>Y</option>' +
                          '<option value="false" ' + (!data ? 'selected' : '') + '>N</option>' +
                      '</select>'
                   return html;
               },
               className: "min-col-lg",
           }
            ];

            //#endregion
            var _getParams = function () {

                PDMS.Utility.Settings.Pages.remote.params = $('#js_form_query').serialize().replace(/\+/g, " ");
                
                return $('#js_form_query').serialize().replace(/\+/g, " ");
            };

            var _queryStorageReports = function (firstLoad, buildCriteria) {

                var config = {
                    pageId: "#page",
                    tableId: "#js_Bom_datatable",
                    remoteUrl: urls.queryFixture,
                    searchParams: _getParams(),
                    tableOptions: {
                        scrollX: true,
                        autoWidth: true,
                        columns: columns
                    }
                };
                if (!firstLoad) {
                    $('#page').page('destroy');
                }
                if (buildCriteria) {
                    PDMS.Utility.Criteria.Build();
                }
                PDMS.Utility.Pages.Set(config);
                $('#js_Bom_datatable tbody tr td').addClass('text-center');
            };
            return {
                urls: urls,
                Init: function () {
                    PDMS.Utility.Criteria.Init();
                    _queryStorageReports(true, false);
                    //  GetOPTypes();
                },
                queryStorageReports: function (buildCriteria) {
                    if (!buildCriteria) {
                        buildCriteria = false;
                    }
                    _queryStorageReports(false, buildCriteria);
                },
                GetDatatable: function () {
                    if (subDatatable == null) {
                        subDatatable = $('#js_Bom_datatable').DataTable({
                            paging: false,
                            searching: false,
                            ordering: false,
                            retrieve: true,
                            columns: columns
                        });
                    }
                    return subDatatable;
                },
                GetFixtureDataTable: function () {

                    if (fixtureDataTable == null) {

                        fixtureDataTable = $('#js_AbnormalReason_table').DataTable({
                            paging: false,
                            searching: false,
                            ordering: false,
                            retrieve: true,
                            columns: funcGetColumns,
                        });
                    }
                    return fixtureDataTable;
                },
                SetfixtureDataTable: function (datatable) {
                    fixtureDataTable = datatable;
                },
                GetEditData: function () { return editData },
                SetEditData: function (editdata) {
                    editData = editdata;
                },

                FuncGetColumns:{ funcGetColumns: funcGetColumns},
            }
        })();
        StorageReportSetting.Init();
        $('#js_form_user_edit').validate({
            errorContainer: $('ul.validate-error'),
            errorLabelContainer: $('#js_edit_modal ul.validate-error'),
            wrapper: 'li'
        });

        $('#bt_search').click(function () {
            $('#js_select_factory_query').trigger('change');
        })
        $('.needint').keydown(function (event) {
            var value = event.key;
            if (value.length > 1)
                return true;
            if (!((/^(\+|-)?\d+$/.test(value) && value >= 0)))
                return false;
        })
        //查询按钮
        $('#js_btn_query').click(function () {
            if ($('#js_form_query').valid()) {
                StorageReportSetting.queryStorageReports(true);
                $('#js_search_modal').modal('hide');
                // $('#js_btn_query')
            }
        });

        $('#js_select_factory_query,#js_select_optype_query,#js_select_funplant_query,#js_select_Production_Line_query,#js_select_Process_Info_UID_query'+
          ',#js_select_Workstation_UID_query,#js_select_Fixture_Machine_UID_query,#js_select_Fixture_Status_query').selectpicker({ 'selectedText': 'cat' });

        //查询界面厂区是OP类型变化
        $('#js_select_factory_query').change(function () {
            GetOPTypes();
            Setsearchbtn();
        })

        function GetOPTypes() {
            
            var oporgid = $('#js_select_factory_query option:selected').val();
            url = StorageReportSetting.urls.getCurrentOPType;
            $('#js_select_optype_query').html('<option></option>');
            $('#js_select_optype_query').selectpicker('refresh');
            $('#js_select_funplant_query').html('<option></option>');
            $('#js_select_funplant_query').selectpicker('refresh');

            if (oporgid != 0) {
                //设置OP
                $.post(url, { plant_OrganizationUID: oporgid }, function (data) {
                    for (var i = 0; i < data.length; i++) {
                        if ($('#js_select_optype_query').find('option[value=' + data[i].Organization_UID + ']').length == 0) {
                            if(@Model.OptypeID!=0)
                            {
                                if(@Model.OptypeID==data[i].Organization_UID )
                                {
                                    $('#js_select_optype_query').append('<option value="' + data[i].Organization_UID + '">' + data[i].OP_TYPES + '</option>');
                                   // $('#js_select_optype_query').selectpicker('refresh');
                                }
                            }else
                            {
                                $('#js_select_optype_query').append('<option value="' + data[i].Organization_UID + '">' + data[i].OP_TYPES + '</option>');
                              //  $('#js_select_optype_query').selectpicker('refresh');
                            }
                        }
                    }
                    $('#js_select_optype_query').selectpicker('refresh');
                });

            }
        }
        //OP类型变更  start
        $('#js_select_optype_query').change(function () {
            var url = StorageReportSetting.urls.getFunPlantByOPTypes;
            $('#js_select_funplant_query').html('<option></option>');
            $('#js_select_funplant_query').selectpicker('refresh');

            if ($('#js_select_optype_query option:selected').text() != "") {
                //设置功能厂
                $.post(url, { Optype: $('#js_select_optype_query').val() }, function (data) {
                    for (var i = 0; i < data.length; i++) {
                        if(@Model.FunPlantID!=0)
                        {
                            if(@Model.FunPlantID==data[i].FunPlant_OrganizationUID )
                            {
                                $('#js_select_funplant_query').append('<option value="' + data[i].FunPlant_OrganizationUID + '">' + data[i].FunPlant + '</option>');
                               // $('#js_select_funplant_query').selectpicker('refresh');
                            }
                        }else
                        {
                            $('#js_select_funplant_query').append('<option value="' + data[i].FunPlant_OrganizationUID + '">' + data[i].FunPlant + '</option>');
                            //$('#js_select_funplant_query').selectpicker('refresh');
                        }
                    }
                    $('#js_select_funplant_query').selectpicker('refresh');
                });

            }
        });

        $('#js_select_funplant_query').change(function () {




        });

        function Setsearchbtn(){
            $('#js_search_modal').find('input[name=Fixture_NO]').val("");
            $('#js_search_modal').find('input[name=Version]').val("");
            $('#js_search_modal').find('input[name=Created_Date]').val("");
            $('#js_search_modal').find('input[name=Modified_UID]').val("");
            $('#js_search_modal').find('input[name=End_Date_From]').val("");
            $('#js_search_modal').find('input[name=End_Date_To]').val("");
        }

        //添加按钮//OP类型变更  end
        $('#btn_add').click(function () {
            
            $("#js_AbnormalReason_table  tr:not(:first)").empty("");
            editData=null;
            fixtureDataTable=null;
            StorageReportSetting.SetfixtureDataTable(null);
            StorageReportSetting.SetEditData(null);
            var dataTable=StorageReportSetting.GetFixtureDataTable();
            dataTable.clear().draw();

            StorageReportSetting.GetFixtureDataTable().clear().draw();

            dataTable.rows().every(function (rowIdx, tableLoop, rowLoop) {
                dataTable.cell(rowIdx, 1).data(rowIdx + 1).draw()
            });

            $('#isEdit').val(false);
            $('#js_edit_modal').modal('hide');
            $('#js_edit_modal').modal('show', $(this));
            $('#js_select_factory_add').trigger('change');
        });

        //查询界面厂区是OP类型变化
        $('#js_select_factory_add').change(function () {
            GetOPTypesadd();

        })

        function GetOPTypesadd() {
            
            var oporgid = $('#js_select_factory_add option:selected').val();
            url = StorageReportSetting.urls.getCurrentOPType;
            $('#js_select_optype_add').html('<option></option>');
            $('#js_select_optype_add').selectpicker('refresh');
            $('#js_select_funplant_add').html('<option></option>');
            $('#js_select_funplant_add').selectpicker('refresh');
            $('#s_input_Fixture_NO_add').html('<option></option>');
            $('#s_input_Fixture_NO_add').selectpicker('refresh');
            $('#js_select_Group_add').html('<option></option>');
            $('#js_select_Group_add').selectpicker('refresh');
            if (oporgid != 0) {
                //设置OP
                $.post(url, { plant_OrganizationUID: oporgid }, function (data) {
                    for (var i = 0; i < data.length; i++) {
                        if ($('#js_select_optype_add').find('option[value=' + data[i].Organization_UID + ']').length == 0) {
                            if(@Model.OptypeID!=0)
                            {
                                if(@Model.OptypeID==data[i].Organization_UID )
                                {
                                    $('#js_select_optype_add').append('<option value="' + data[i].Organization_UID + '">' + data[i].OP_TYPES + '</option>');
                                    $('#js_select_optype_add').selectpicker('refresh');
                                }
                            }else
                            {
                                $('#js_select_optype_add').append('<option value="' + data[i].Organization_UID + '">' + data[i].OP_TYPES + '</option>');
                                $('#js_select_optype_add').selectpicker('refresh');
                            }
                        }
                    }
                });
                //设置治具编号
                //var arr = new Array();
                //url=StorageReportSetting.urls.fixtureList;
                //$.post(url, { Plant_Organization_UID: oporgid ,BG_Organization_UID:0,FunPlant_Organization_UID:0}, function (data) {
                //    for (var i = 0; i < data.length; i++) {
                //        var isRepeated = false;
                //        $.each(arr,function (index,item) {
                //            if(item == data[i].Fixture_NO){
                //                isRepeated=true;
                //            }
                //        });
                //        if (!isRepeated) {
                //            arr.push(data[i].Fixture_NO);
                //        }
                //    }
                //    $.each(arr,function (index,item) {
                //        $('#s_input_Fixture_NO_add').append('<option value="' + item + '">' + item + '</option>');
                //    });
                //    $('#s_input_Fixture_NO_add').selectpicker('refresh');
                //});
                ////设置治具群组
                //url=StorageReportSetting.urls.defectCode_GroupList;
                //$.post(url, { Plant_Organization_UID: oporgid ,BG_Organization_UID:0,FunPlant_Organization_UID:0}, function (data) {
                //    for (var i = 0; i < data.length; i++) {

                //        $('#js_select_Group_add').append('<option value="' + data[i].DefectCode_Group_ID + '">' + data[i].DefectCode_Group_Name + '</option>');
                  
                //    }
                //    $('#js_select_Group_add').selectpicker('refresh');
                //});

            }
        }
        //OP类型变更  start
        $('#js_select_optype_add').change(function () {
            
            var url = StorageReportSetting.urls.getFunPlantByOPTypes;
            $('#js_select_funplant_add').html('<option></option>');
            $('#js_select_funplant_add').selectpicker('refresh');
            $('#s_input_Fixture_NO_add').html('<option></option>');
            $('#s_input_Fixture_NO_add').selectpicker('refresh');
            $('#js_select_Group_add').html('<option></option>');
            $('#js_select_Group_add').selectpicker('refresh');
            if ($('#js_select_optype_add option:selected').text() != "") {
                //设置功能厂
                $.post(url, { Optype: $('#js_select_optype_add option:selected').val() }, function (data) {
                    for (var i = 0; i < data.length; i++) {
                        if(@Model.FunPlantID!=0)
                        {
                            if(@Model.FunPlantID==data[i].FunPlant_OrganizationUID )
                            {
                                $('#js_select_funplant_add').append('<option value="' + data[i].FunPlant_OrganizationUID + '">' + data[i].FunPlant + '</option>');
                                $('#js_select_funplant_add').selectpicker('refresh');
                            }
                        }else
                        {
                            $('#js_select_funplant_add').append('<option value="' + data[i].FunPlant_OrganizationUID + '">' + data[i].FunPlant + '</option>');
                            $('#js_select_funplant_add').selectpicker('refresh');
                        }
                    }
                });
                var oporgid = $('#js_select_factory_add option:selected').val();
                var opTypeUid =$('#js_select_optype_add option:selected').val();
                
                if (opTypeUid=="" ||opTypeUid==undefined) {
                    opTypeUid=0;
                }
                $.post(StorageReportSetting.urls.defectCode_GroupList, { Plant_Organization_UID: oporgid ,BG_Organization_UID:opTypeUid,FunPlant_Organization_UID:0}, function (data) {
                    for (var i = 0; i < data.length; i++) {

                        $('#js_select_Group_add').append('<option value="' + data[i].DefectCode_Group_ID + '">' + data[i].DefectCode_Group_Name + '</option>');
                     
                    }
                    $('#js_select_Group_add').selectpicker('refresh');
                });
                //设置治具编号
                var arr = new Array();
                $.post(StorageReportSetting.urls.fixtureList, { Plant_Organization_UID: oporgid ,BG_Organization_UID:opTypeUid,FunPlant_Organization_UID:0}, function (data) {
                    for (var i = 0; i < data.length; i++) {
                        var isRepeated = false;
                        $.each(arr,function (index,item) {
                            if(item == data[i].Fixture_NO){
                                isRepeated=true;
                            }
                        });
                        if (!isRepeated) {
                            arr.push(data[i].Fixture_NO);
                        }
                    }
                    $.each(arr,function (index,item) {
                        $('#s_input_Fixture_NO_add').append('<option value="' + item + '">' + item + '</option>');
                    });
                    $('#s_input_Fixture_NO_add').selectpicker('refresh');
                    //for (var i = 0; i < data.length; i++) {
                    //    $('#s_input_Fixture_NO_add').append('<option value="' + data[i].Fixture_NO + '">' + data[i].Fixture_NO + '</option>');
                    //}
                    //$('#s_input_Fixture_NO_add').selectpicker('refresh');
                });
                
            }

           
        })

        $('#js_select_funplant_add').change(function () {
            $('#s_input_Fixture_NO_add').html('<option></option>');
            $('#s_input_Fixture_NO_add').selectpicker('refresh');
            $('#js_select_Group_add').html('<option></option>');
            $('#js_select_Group_add').selectpicker('refresh');
            //设置治具编号
            var oporgid = $('#js_select_factory_add option:selected').val();
            url=StorageReportSetting.urls.fixtureList;
            $.post(url, { Plant_Organization_UID: oporgid ,BG_Organization_UID:$('#js_select_optype_add option:selected').val(),FunPlant_Organization_UID:$('#js_select_funplant_add option:selected').val()}, function (data) {
                for (var i = 0; i < data.length; i++) {
                    $('#s_input_Fixture_NO_add').append('<option value="' + data[i].Fixture_NO + '">' + data[i].Fixture_NO + '</option>');
               
                }
                $('#s_input_Fixture_NO_add').selectpicker('refresh');
            });
            url=StorageReportSetting.urls.defectCode_GroupList;
            $.post(url, { Plant_Organization_UID: oporgid ,BG_Organization_UID:$('#js_select_optype_add option:selected').val(),FunPlant_Organization_UID:$('#js_select_funplant_add option:selected').val()}, function (data) {
                for (var i = 0; i < data.length; i++) {
                    $('#js_select_Group_add').append('<option value="' + data[i].DefectCode_Group_ID + '">' + data[i].DefectCode_Group_Name + '</option>');
                
                }
                $('#js_select_Group_add').selectpicker('refresh');
            });
        });

        function SetEdit() {
            $('#js_select_optype_add').html('<option></option>');
            $('#js_select_optype_add').selectpicker('refresh');
            //加载功能厂
            $('#js_select_funplant_add').html('<option></option>');
            $('#js_select_funplant_add').selectpicker('refresh');
            //治具编号
            $('#js_edit_modal').find('input[name=Fixture_NO]').val("");
            //版本
            $('#js_edit_modal').find('input[name=Version]').val("");

        }

        //增加领用治具行按钮
        $('#js_btn_Reason_add').on('click', function () {

            
            var dataTable = StorageReportSetting.GetFixtureDataTable();
            var allowAdd = true;

            dataTable.rows().every(function (rowIdx, tableLoop, rowLoop) {

                for (var i = 3; i < 4; i++) {
                    if ($(dataTable.cell(rowIdx, i).node())[0].innerText == ""||$(dataTable.cell(rowIdx, i).node())[0].innerText==undefined) {
                        PDMS.Utility.MessageBox.info('请先确保上一条数据正确，然后才能添加新的一条数据.');
                        allowAdd = false;
                        return;
                    }
                }

            });
            if (allowAdd) {
                var row = dataTable.row.add({
                    "Fixtrue_Defect_UID": 0,
                    "DefectCode_ID": "" ,
                    "DefectCode_Name": "",
                    "Is_Enable": true
                }).draw();

                $(row.node()).find('input[name=DefectCode_ID]').removeAttr("disabled");

            }
        });

        //删除Function按钮
        $('#js_btn_Reason_delete').on('click', function () {

            var dataTable = StorageReportSetting.GetFixtureDataTable();

            var $checkedItems = $('#js_AbnormalReason_table .js-checkbox-item:checked');

            if ($checkedItems.length == 0) {

                PDMS.Utility.MessageBox.info("请选择需要删除的行。");
                return;

            } else {

                
                $.map($checkedItems, function (checkbox) {
                    var $sender = $(checkbox);
                    var systemFuncUId = $sender.val();
                    var $tr = $sender.closest('tr');
                    var trIndex = $tr.index();
                    var editData = StorageReportSetting.GetFixtureDataTable();

                    if (systemFuncUId > 0) {
                        //这是是编辑的时候用于删除的。
                        $.get(StorageReportSetting.urls.deleteFixtureDefectCode_SettingByID
                            , { uid: systemFuncUId }
                            , function (data) {
                                if (data != "SUCCESS") {
                                    PDMS.Utility.MessageBox.error(data);
                                } else {
                                    dataTable.row($tr).remove().draw();
                                    editData.splice(trIndex, 1);
                                    //StorageReportSetting.GetFixtureDataTable().clear().draw();
                                }
                            });//end get

                    } else {
                        dataTable.row($tr).remove().draw();
                        if (trIndex < editData.length) {
                            editData.splice(trIndex, 1);
                        }
                    }

                });

                dataTable.rows().every(function (rowIdx, tableLoop, rowLoop) {
                    dataTable.cell(rowIdx, 1).data(rowIdx + 1).draw()
                });
            }
        });

        $('#js_AbnormalReason_table').on('blur', '.js-input-function-id', function () {
            

            if ($('#js_select_factory_add option:selected').text() == "") {
                PDMS.Utility.MessageBox.info('请选择厂区');
                return false;
            }


            if ($('#js_select_optype_add option:selected').text() == "") {
                PDMS.Utility.MessageBox.info('请选择OP');
                return false;
            }

            var bG_Organization_UID = $('#js_select_optype_add option:selected').val();
            var plant_OrganizationUID = $('#js_select_factory_add option:selected').val();


            //初始化获取数据信息
            var  $sender = $(this),
                 inputValue = $.trim($sender.val()),
                 $tr = $sender.closest('tr'),
                 trIndex = $tr.index(),
                 $tds = $tr.find('td');
            fixtureDataTable = StorageReportSetting.GetFixtureDataTable();
            editData  = StorageReportSetting.GetFixtureDataTable();

            var clearTd = function (tds) {
                $tds[3].innerText = '';
            };
            if (inputValue=="")
            {
                PDMS.Utility.MessageBox.info('请填写异常代码');
                return false;
            }

            $.get(StorageReportSetting.urls.getFixture_DefectCode, { DefectCode_ID: inputValue,Plant_Organization_UID:plant_OrganizationUID, BG_Organization_UID:bG_Organization_UID}, function (data) {

                if(data!=null)
                {
                    if (data.Fixture_Defect_UID === 0) {
                        PDMS.Utility.MessageBox.error('没有对应的异常原因编码"' + inputValue + '" ');
                        // $tr.data('Fixture_Defect_UID', 0);
                        clearTd($tds);
                        return false;
                    }
                    if (data.DefectCode_Name === null || $.trim(data.DefectCode_Name) === '') {
                        PDMS.Utility.MessageBox.error('此治具异常原因不能添加！');

                        // $tr.data('Fixture_Defect_UID', 0);
                        clearTd($tds);
                        return false;
                    }

                    var flag = true;

                    $.each(editData, function (index, item) {
                        if (item.Fixture_Defect_UID === data.Fixture_Defect_UID && trIndex != index) {
                            flag = false;
                            return false;
                        }
                    });

                    if (flag) {
                        
                        $tds[3].innerText = data.DefectCode_Name;
                        data.Is_Enable = true;
                        editData.push(data);
                        $('#js_maingroup_table').data('selected-index', trIndex);
                        $sender.attr('disabled', 'disabled');

                    } else {
                        PDMS.Utility.MessageBox.error('此治具异常原因已经添加');

                        clearTd($tds);
                        return;
                    }
                }else
                {
                    PDMS.Utility.MessageBox.error('没有找到对应的治具异常原因');

                    clearTd($tds);
                    return;
                }

            });

        });


        $('#js_btn_DefectCode_Group_main').on('click', function () {

            if ($('#js_select_factory_add option:selected').text() == "") {
                PDMS.Utility.MessageBox.info('请选择厂区');
                return false;
            }


            if ($('#js_select_optype_add option:selected').text() == "") {
                PDMS.Utility.MessageBox.info('请选择OP');
                return false;
            }
            if ($('#js_select_Group_add option:selected').text() == "") {
                PDMS.Utility.MessageBox.info('请选择治具分组');
                return false;
            }
            var plant_OrganizationUID = $('#js_select_factory_add option:selected').val();
            var bG_Organization_UID = $('#js_select_optype_add option:selected').val();
            var funPlant_Organization_UID = $('#js_select_funplant_add option:selected').val();
            if(funPlant_Organization_UID=="")
                funPlant_Organization_UID=0;
            var defectCode_Group_ID = $('#js_select_Group_add option:selected').val();
            //根据厂区，OP， 功能厂，组编码 获取治具原因列表


            $.get(StorageReportSetting.urls.getDefectCodeByGroup, {Plant_Organization_UID:plant_OrganizationUID, BG_Organization_UID:bG_Organization_UID,FunPlant_Organization_UID:funPlant_Organization_UID,DefectCode_Group_ID:defectCode_Group_ID}, function (data) {
                
                if(data!=null)
                {
                    //这里循环添加
                    $.each(data, function (index, item) {

                        var dataTable = StorageReportSetting.GetFixtureDataTable();
                        var allowAdd = true;

                        dataTable.rows().every(function (rowIdx, tableLoop, rowLoop) {
                            for (var i = 3; i < 4; i++) {
                                if ($(dataTable.cell(rowIdx, i).node())[0].innerText == ""||$(dataTable.cell(rowIdx, i).node())[0].innerText==undefined) {
                                    PDMS.Utility.MessageBox.info('请先确保上一条数据正确，然后才能添加新的一条数据！');
                                    allowAdd = false;
                                    return;
                                }
                            }

                        });

                        if (allowAdd) {
                            var row = dataTable.row.add({
                                "Fixtrue_Defect_UID": 0,
                                "DefectCode_ID": "" ,
                                "DefectCode_Name": "",
                                "Is_Enable": true
                            }).draw();

                            $(row.node()).find('input[name=DefectCode_ID]').removeAttr("disabled");
                            var // $sender = $('#js_maingroup_table'),
                                 $sender = $(row.node()).find('input[name=DefectCode_ID]');
                            // inputValue = $.trim($sender.val()),
                            $tr = $sender.closest('tr'),
                            trIndex = $tr.index(),
                            $tds = $tr.find('td');
                            editData  = StorageReportSetting.GetFixtureDataTable();

                            var clearTd = function (tds) {
                                $tds[3].innerText = '';
                            };

                            var flag = true;
                            $.each(editData, function (index, item1) {
                                if (item1.Fixture_Defect_UID === item.Fixture_Defect_UID && trIndex != index) {
                                    flag = false;
                                    return false;
                                }
                            });

                            if (flag) {
                                
                                $tds[3].innerText = item.DefectCode_Name;
                                //$tds[2].innerText=item.DefectCode_ID;
                                $tr.find('input[name=DefectCode_ID]').val(item.DefectCode_ID);
                                item.Is_Enable = true;
                                editData.push(item);
                                $('#js_AbnormalReason_table').data('selected-index', trIndex);
                                $sender.attr('disabled', 'disabled');

                            } else {
                                PDMS.Utility.MessageBox.error('治具异常原因已经存在！');

                                clearTd($tds);
                                return;
                            }
                        }

                    });
                }

            });

        });


        $('#js_btn_save_new_function').click(function () {

            if ($('#js_select_factory_add option:selected').text() == "") {
                PDMS.Utility.MessageBox.info('请选择厂区');
                return false;
            }
            if ($('#js_select_optype_add option:selected').text() == "") {
                PDMS.Utility.MessageBox.info('请选择OP');
                return false;
            }
            if ($('#s_input_Fixture_NO_add option:selected').text() == "") {
                PDMS.Utility.MessageBox.info('请选择治具编号');
                return false;
            }

            var editData = StorageReportSetting.GetEditData();
            //获取厂区 , BG, 功能厂，异常群组代码，异常群组名称。
            var plant_Organization_UID= $('#js_select_factory_add option:selected').val();
            var bG_Organization_UID=$('#js_select_optype_add option:selected').val()
            var funPlant_Organization_UID= $('#js_select_funplant_add option:selected').val();
            if(funPlant_Organization_UID=="")
            {
                funPlant_Organization_UID=0;
            }

            var fixture_NO= $('#s_input_Fixture_NO_add').val();

            var dataTable =StorageReportSetting.GetFixtureDataTable();

            var allowAdd = true;
            dataTable.rows().every(function (rowIdx, tableLoop, rowLoop) {

                for (var i = 3; i < 4; i++) {
                    if ($(dataTable.cell(rowIdx, i).node())[0].innerText == ""||$(dataTable.cell(rowIdx, i).node())[0].innerText==undefined) {
                        PDMS.Utility.MessageBox.info('请确保列表异常原因正确！才能做保存。' );
                        allowAdd = false;
                        return false;
                    }
                }

            });

            if (allowAdd) {
                if(  editData==null)
                {
                    PDMS.Utility.MessageBox.info('请添加异常原因！');
                    return false;
                }
                if (editData.length > 0) {
                    

                    var  fixture_DefectCodeDTOs=editData.toArray();
                    $.post(StorageReportSetting.urls.addFixtureDefectCode_Setting
                            , { Fixture_DefectCodeDTOs:fixture_DefectCodeDTOs,Plant_Organization_UID:plant_Organization_UID, BG_Organization_UID:bG_Organization_UID,FunPlant_Organization_UID:funPlant_Organization_UID,Fixture_NO:fixture_NO}
                            , function (data) {
                                

                                //StorageReportSetting.GetFixtureDataTable().clear().draw();
                                //StorageReportSetting.SetEditData(null);
                                $('#js_edit_modal').modal('hide');
                                StorageReportSetting.queryStorageReports(true);
                                PDMS.Utility.MessageBox.info(data);
                                $('#js_AbnormalReason_table').data('selected-index', 0);
                            });
                } else {
                    PDMS.Utility.MessageBox.error("请确保最后一条异常原因数据正确！");
                }
            }

        });

        //导出按钮

        $('#js_btn_delete').click(function () {
            

            var $selectList = $('#js_Bom_datatable').find('.js-checkbox-item:checked');
            var len = $selectList.length;
            if (len == 0) {
                PDMS.Utility.MessageBox.info('请选择要删除的数据!');
            } else {

                PDMS.Utility.MessageBox.confirm("确定要删除?", function () {
                    var url = StorageReportSetting.urls.deleteFixtureDefectCode_SettingByID;
                    var FixtureDefectCode_Setting_UIDs = $.map($selectList, function (row) {
                        return row.value;
                    });
                    $.post(url, { FixtureDefectCode_Setting_UIDs: FixtureDefectCode_Setting_UIDs.toString() }, function (data) {

                        StorageReportSetting.queryStorageReports();
                        PDMS.Utility.MessageBox.info(data);
                    });
                });

            }
        });
        //点击删除的时候的加载的界面
        $('body').on('click', '.js-grid-delete', function () {
            var FixtureDefectCode_Setting_UIDs = $(this).attr('data-id');
            PDMS.Utility.MessageBox.confirm("确定要删除?", function () {
                var url = StorageReportSetting.urls.deleteFixtureDefectCode_SettingByID;
                $.post(url, { FixtureDefectCode_Setting_UIDs: FixtureDefectCode_Setting_UIDs }, function (data) {
                    StorageReportSetting.queryStorageReports();
                    PDMS.Utility.MessageBox.info(data);

                });
            });
        });
        $('#js_btn_export').click(function () {
            
            var $selectList = $('#js_Bom_datatable').find('.js-checkbox-item:checked');
            var len = $selectList.length;
            if (len == 0) {
                //全部导出
                var url = StorageReportSetting.urls.doAllExportFunction;
                //没有查询条件的情况，从查询页面获取
                if (PDMS.Utility.Settings.Pages.remote.params == null) {
                    PDMS.Utility.Settings.Pages.remote.params = $('#js_form_query').serialize().replace(/\+/g, " ");
                }
                url += '?' + PDMS.Utility.Settings.Pages.remote.params;
                window.location.href = url;

              //  PDMS.Utility.MessageBox.info('请选择要导出的数据！');
            } else {
                var FixtureDefectCode_Setting_UIDs = $.map($selectList, function (row) {
                    return row.value;
                });
                $('table').find('.js-checkbox-all,.js-checkbox-item').prop('checked', false);
                var url = StorageReportSetting.urls.doExportFunction;
                url += "?FixtureDefectCode_Setting_UIDs=" + FixtureDefectCode_Setting_UIDs.toString();
                window.location.href = url;
            }
        });
        //下载模板
        $('#js_btn_download_fl').on('click', function () {
            this.form.action = StorageReportSetting.urls.downloadExcel;
            $('#js_form_excel_download').submit();
        });

        //提交     stat
        $('#btn_excel_upload').on('click', function () {
            $.blockUI({ message: "<h1>导入中，请稍后...</h1>" });
            $('#js_form_excel_upload').ajaxSubmit({
                beforeSubmit: function () {

                    var fileName = $('#js_s_input_import').val();
                    var fileExtension = fileName.substring(fileName.lastIndexOf('.') + 1);
                    if (fileExtension.toLowerCase() != "xlsx" && fileExtension.toLowerCase() != "xls") {
                        PDMS.Utility.MessageBox.info('请选择Excel文件');
                        $.unblockUI();
                        return false;
                    }
                    if (!$('#js_form_excel_upload').valid()) {
                        $.unblockUI();
                        return false;
                    }
                },
                success: function (data) {
                    $.unblockUI();
                    if (data != '') {
                        PDMS.Utility.MessageBox.error(data);
                    }
                    else {
                        $('#js_importExcel_modal').modal('hide');
                        PDMS.Utility.MessageBox.info('上传成功');
                        StorageReportSetting.queryStorageReports(true);
                    }
                }
            });
        });
        //提交   END
        //隐藏上传窗口时清空值-----------START
        $('#js_importExcel_modal').on('hidden.bs.modal', function (e) {
            $('#js_importExcel_modal').find('input').val('');
        });
        //隐藏上传窗口时清空值-------------END
        //点击查看的时候的加载的界面
        $('body').on('click', '.js-grid-view', function () {
            $('#js_view_modal').modal('show', $(this));
            // $('#isEdit').val(true);
            
            var FixtureDefectCode_Setting_UID = $(this).attr('data-id'),
                url = StorageReportSetting.urls.getFixtureDefectCode_SettingDTOByUID;
            $.post(url, { FixtureDefectCode_Setting_UID: FixtureDefectCode_Setting_UID }, function (data) {
                $('#js_view_modal').find('input[name=Plant_Organization_UID]').val(data.PlantName);
                $('#js_view_modal').find('input[name=BG_Organization_UID]').val(data.OPName);
                $('#js_view_modal').find('input[name=FunPlant_Organization_UID]').val(data.FunPlantName);
                $('#js_view_modal').find('input[name=Fixture_NO]').val(data.Fixture_NO);
                $('#js_view_modal').find('input[name=DefectCode_ID]').val(data.DefectCode_ID);
                $('#js_view_modal').find('input[name=DefectCode_Name]').val(data.DefectCode_Name);
                $('#js_view_modal').find('input[name=Is_Enable]').val(data.Is_Enable);
                $('#js_view_modal').find('input[name=Modifieder]').val(data.Modifieder);
                $('#js_view_modal').find('input[name=Modified_Date]').val(data.Modified_Date);

            });
        });

        //点击编辑的时候的加载的界面

        $('#js_select_DefectCode_ID_viewedit').on('blur',  function () {
            
            if ($('#js_select_factory_viewedit option:selected').text() == "") {
                PDMS.Utility.MessageBox.info('请选择厂区');
                return false;
            }
            if ($('#js_select_optype_viewedit option:selected').text() == "") {
                PDMS.Utility.MessageBox.info('请选择OP');
                return false;
            }
            if ($("#js_select_DefectCode_ID_viewedit").val()=="")
            {
                PDMS.Utility.MessageBox.info('请填写异常原因编码');
                return false;
            }
            var  DefectCode_ID=$("#js_select_DefectCode_ID_viewedit").val();
            var plant_OrganizationUID = $('#js_select_factory_viewedit option:selected').val();
            var bG_Organization_UID = $('#js_select_optype_viewedit option:selected').val();
            $.get(StorageReportSetting.urls.getFixture_DefectCode, { DefectCode_ID: DefectCode_ID,Plant_Organization_UID:plant_OrganizationUID, BG_Organization_UID:bG_Organization_UID}, function (data) {

                if(data!=null)
                {
                    if (data.Fixture_Defect_UID === 0) {
                        PDMS.Utility.MessageBox.error('没有对应的异常原因编码"' + DefectCode_ID + '" ');
                        return false;
                    }
                    if (data.DefectCode_Name === null || $.trim(data.DefectCode_Name) === '') {
                        PDMS.Utility.MessageBox.error('此治具异常原因不能添加！');
                        return false;
                    }

                    $("#js_select_DefectCode_Name_viewedit").val(data.DefectCode_Name);


                }else
                {
                    PDMS.Utility.MessageBox.error('没有找到对应的治具异常原因');
                    return;
                }
            });
        });



        $('#js_select_factory_viewedit').change(function () {
            GetOPTypesaddedit();

        })

        function GetOPTypesaddedit() {
            
            var oporgid = $('#js_select_factory_viewedit option:selected').val();
            url = StorageReportSetting.urls.getCurrentOPType;
            $('#js_select_optype_viewedit').html('<option></option>');
            $('#js_select_optype_viewedit').selectpicker('refresh');
            $('#js_select_funplant_viewedit').html('<option></option>');
            $('#js_select_funplant_viewedit').selectpicker('refresh');

            if (oporgid != 0) {
                //设置OP
                $.post(url, { plant_OrganizationUID: oporgid }, function (data) {
                    for (var i = 0; i < data.length; i++) {
                        if ($('#js_select_optype_viewedit').find('option[value=' + data[i].Organization_UID + ']').length == 0) {
                            if(@Model.OptypeID!=0)
                            {
                                if(@Model.OptypeID==data[i].Organization_UID )
                                {
                                    $('#js_select_optype_viewedit').append('<option value="' + data[i].Organization_UID + '">' + data[i].OP_TYPES + '</option>');
                                    $('#js_select_optype_viewedit').selectpicker('refresh');
                                }
                            }else
                            {
                                $('#js_select_optype_viewedit').append('<option value="' + data[i].Organization_UID + '">' + data[i].OP_TYPES + '</option>');
                                $('#js_select_optype_viewedit').selectpicker('refresh');
                            }
                        }
                    }
                });

            }
        }
        //OP类型变更  start
        $('#js_select_optype_viewedit').change(function () {
            
            var url = StorageReportSetting.urls.getFunPlantByOPTypes;
            $('#js_select_funplant_viewedit').html('<option></option>');
            $('#js_select_funplant_viewedit').selectpicker('refresh');

            if ($('#js_select_optype_viewedit option:selected').text() != "") {
                //设置功能厂
                $.post(url, { Optype: $('#js_select_optype_viewedit option:selected').val() }, function (data) {
                    for (var i = 0; i < data.length; i++) {
                        if(@Model.FunPlantID!=0)
                        {
                            if(@Model.FunPlantID==data[i].FunPlant_OrganizationUID )
                            {
                                $('#js_select_funplant_viewedit').append('<option value="' + data[i].FunPlant_OrganizationUID + '">' + data[i].FunPlant + '</option>');
                                $('#js_select_funplant_viewedit').selectpicker('refresh');
                            }
                        }else
                        {
                            $('#js_select_funplant_viewedit').append('<option value="' + data[i].FunPlant_OrganizationUID + '">' + data[i].FunPlant + '</option>');
                            $('#js_select_funplant_viewedit').selectpicker('refresh');
                        }
                    }
                });

            }
        });

        $('body').on('click', '.js-grid-edit', function () {

            $('#js_viewedit_modal').modal('show', $(this));
            $('#js_select_factory_viewedit').trigger('change');
            $('#isEdit').val(true);
            var FixtureDefectCode_Setting_UID = $(this).attr('data-id'),
                   url = StorageReportSetting.urls.getFixtureDefectCode_SettingDTOByUID;
            $.post(url, { FixtureDefectCode_Setting_UID: FixtureDefectCode_Setting_UID }, function (data) {

                
                $('#js_select_factory_viewedit').selectpicker('val', data.Plant_Organization_UID);
                $('#js_select_factory_viewedit').selectpicker('refresh');
                $('#js_select_factory_viewedit').trigger('change');
                $('#js_select_optype_viewedit').selectpicker('val', data.BG_Organization_UID);
                $('#js_select_optype_viewedit').selectpicker('refresh');
                if(data.BG_Organization_UID!=0)
                {
                    $('#js_select_optype_viewedit').trigger('change');
                }
                $('#js_select_funplant_viewedit').selectpicker('val', data.FunPlant_Organization_UID);
                $('#js_select_funplant_viewedit').selectpicker('refresh');


                $('#js_viewedit_modal').find('input[name=Fixture_NO]').val(data.Fixture_NO);
                $('#js_viewedit_modal').find('input[name=DefectCode_ID]').val(data.DefectCode_ID);
                $('#js_viewedit_modal').find('input[name=DefectCode_Name]').val(data.DefectCode_Name);
                $('#js_viewedit_modal').find('input[name=Is_Enable]').val(data.Is_Enable);
                //$('#js_viewedit_modal').find('input[name=Modified_UID]').val(data.Modified_UID);
                //$('#js_viewedit_modal').find('input[name=Modified_Date]').val(data.Modified_Date);
                $('#js_viewedit_modal').find('input[name=FixtureDefectCode_Setting_UID]').val(data.FixtureDefectCode_Setting_UID);
            });

        });
        $('#js_btn_save_new').on('click', function () {
            $('#js_form_user_edit').ajaxSubmit({
                beforeSubmit: function () {
                    if ($('#js_select_factory_viewedit option:selected').text() == "") {
                        PDMS.Utility.MessageBox.info('请选择厂区');
                        return false;
                    }
                    if ($('#js_select_optype_viewedit option:selected').text() == "") {
                        PDMS.Utility.MessageBox.info('请选择OP');
                        return false;
                    }
                    //if ($('#js_select_funplant_viewedit option:selected').text() == "") {
                    //    PDMS.Utility.MessageBox.info('请选择功能厂');
                    //    return false;
                    //}

                    if ($('#js_viewedit_modal').find('input[name=Fixture_NO]').val() == "") {
                        PDMS.Utility.MessageBox.info('请填治具编号');
                        return false;
                    }
                    if ($('#js_viewedit_modal').find('input[name=DefectCode_ID]').val() == "") {
                        PDMS.Utility.MessageBox.info('请填异常编码');
                        return false;
                    }
                },
                success: function (data) {
                    if (data.length > 2) {
                        PDMS.Utility.MessageBox.info(data);
                    }
                    else {
                        $('#js_viewedit_modal').modal('hide');
                        StorageReportSetting.queryStorageReports(true);
                        PDMS.Utility.MessageBox.info('更新成功');
                    }
                }
            });
        });

        $('#js_import_modal').on('hidden.bs.modal', function (e) {
            $('#js_import_modal').find('input').val('');
        });
    });
    </script>
</div>

}