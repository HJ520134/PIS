@model PDMS.Model.ViewModels.FixtureRepairVM
<!-- Main content -->
<section class="content portal-content">

    <!--次標題 與 搜尋-->
    <div class="row">
        <!--次標題與Search keyword-->
        <div class="col-md-12 col-lg-8">
            <h4 class="margin-td-5" id="js_search_keywords"></h4>
        </div><!-- /col-次標題與Search keyword -->
        <!--col-右方搜尋與功能按鈕列-->
        <div class="col-md-12 search-field col-lg-4">
            <a class="fa fa-search btn btn-primary" data-toggle="modal" data-target="#js_search_modal"> 查询</a>
            <a class="fa fa-plus btn btn-primary" role="button" data-toggle="modal" data-target="#js_edit_modal" id="js_btn_add"> 维修</a>
            <a id="js_btn_export" class="fa fa-download btn btn-primary" role="button"> @T("Common.Export")</a>
        </div><!-- /col-右方搜尋與功能按鈕列-->
    </div><!--/次標題 與 搜尋-->
    <hr class="hr-custom">

    <!--row Search Keyword collapse-->
    <div class="row">
        <div class="col-xs-12" id="js_criteria_alert_cnt">
        </div>
    </div> <!--/row Search Keyword collapse-->
    <!--內容 表格列-->
    <div class="row">
        <!--表格-->
        <div class="col-md-12 table-container">
            <table class="table table-striped table-hover table-condensed nowrap" id="js_user_fixrepair_datatable">
                <thead>
                    <tr>

                        <th class="table-col-checkbox nosort">
                            <input type="checkbox" class="js-checkbox-all" />
                        </th>
                        <th class="table-col-action nosort">操作</th>
                        <th class="table-col-seq nosort">序号</th>
                        <th>表单编号</th>
                        <th>厂区</th>
                        <th>OP</th>
                        <th>功能厂</th>
                        <th>制程</th>
                        <th>线别</th>
                        <th>设备编号</th>
                        <th>治具编号</th>
                        <th>治具短码</th>
                        <th>治具唯一编码</th>
                        <th>治具状态</th>
                        <th>修改人</th>
                        <th>修改日期</th>
                    </tr>
                </thead>
                <tfoot>
                    <tr>
                        <th class="table-col-checkbox nosort"></th>
                        <th class="table-col-action nosort">操作</th>
                        <th class="table-col-seq nosort">序号</th>
                        <th>表单编号</th>
                        <th>厂区</th>
                        <th>OP</th>
                        <th>功能厂</th>
                        <th>制程</th>
                        <th>线别</th>
                        <th>设备编号</th>
                        <th>治具编号</th>
                        <th>治具短码</th>
                        <th>治具唯一编码</th>
                        <th>治具状态</th>
                        <th>修改人</th>
                        <th>修改日期</th>
                    </tr>
                </tfoot>
            </table>
            <div id="page" class="row"></div>

        </div><!--/表格-->
    </div><!-- / 內容 表格列 -->


</section><!-- /.content -->

@section ViewModals{
    <!-- Modal -->
    <div class="modal fade" id="js_search_modal" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title">查询</h4>
                </div>
                <div class="modal-body">
                    <form id="js_form_query" class="form-horizontal" data-need-validate="true">
                        <div class="row">

                            <div class="form-group col-xs-12 col-md-6 col-lg-6">
                                <label class="col-sm-5 control-label" for="js_select_factory_query">厂区</label>
                                <div class="col-sm-7">
                                    <select class="selectpicker form-control input-sm" id="js_select_factory_query" name="Plant_Organization_UID" data-live-search="true">
                                        @foreach (var item in Model.Plants)
                                        {
                                            <option value=@item.Plant_OrganizationUID>@item.Plant</option>
                                        }
                                    </select>
                                </div>
                            </div>
                            <div class="form-group col-xs-12 col-md-6 col-lg-6">
                                <label class="col-sm-5 control-label" for="js_select_optype_query">OP类型</label>
                                <div class="col-sm-7">
                                    <select class="selectpicker form-control input-sm" id="js_select_optype_query" name="BG_Organization_UID" data-live-search="true"></select>
                                </div>
                            </div>

                            <div class="form-group col-xs-12 col-md-6 col-lg-6">
                                <label class="col-sm-5 control-label" for="js_select_funplant_query">功能厂</label>
                                <div class="col-sm-7">
                                    <select class="selectpicker form-control input-sm" id="js_select_funplant_query" name="FunPlant_Organization_UID" data-live-search="true"></select>
                                </div>
                            </div>
                            <div class="form-group col-xs-12 col-md-6 col-lg-6">
                                <label class="col-sm-5 control-label" for="js_select_Process_Info_UID_query">制程</label>
                                <div class="col-sm-7">
                                    <select class="selectpicker form-control input-sm" id="js_select_Process_Info_UID_query" name="Process_Info_UID" data-live-search="true"></select>
                                </div>
                            </div>
                            <div class="form-group col-xs-12 col-md-6 col-lg-6">
                                <label class="col-sm-5 control-label" for="js_select_Workstation_UID_query">工站</label>
                                <div class="col-sm-7">
                                    <select class="selectpicker form-control input-sm" id="js_select_Workstation_UID_query" name="Workstation_UID" data-live-search="true"></select>
                                </div>
                            </div>
                            <div class="form-group col-xs-12 col-md-6 col-lg-6">
                                <label class="col-sm-5 control-label" for="js_select_Production_Line_query">线别</label>
                                <div class="col-sm-7">
                                    <select class="selectpicker form-control input-sm" id="js_select_Production_Line_query" name="Production_Line_UID" data-live-search="true"></select>
                                </div>
                            </div>
                            <div class="form-group col-xs-12 col-md-6 col-lg-6">
                                <label class="col-sm-5 control-label" for="js_select_Fixture_Machine_UID_query">设备编号</label>
                                <div class="col-sm-7">
                                    <select class="selectpicker form-control input-sm" id="js_select_Fixture_Machine_UID_query" name="Fixture_Machine_UID" data-live-search="true"></select>
                                </div>
                            </div>
                            <div class="form-group col-xs-12 col-md-6 col-lg-6">
                                <label class="col-sm-5 control-label" for="s_input_Fixture_Name_query">治具名称</label>
                                <div class="col-sm-7">
                                    <input type="text" class="form-control input-sm" id="s_input_Fixture_Name_query" name="Fixture_Name" placeholder="Fixture Name">
                                </div>
                            </div>
                            <div class="form-group col-xs-12 col-md-6 col-lg-6">
                                <label class="col-sm-5 control-label" for="s_input_Fixture_NO_query">治具编号</label>
                                <div class="col-sm-7">
                                    <input type="text" class="form-control input-sm" id="s_input_Fixture_NO_query" name="Fixture_NO" placeholder="Fixture_NO">
                                </div>
                            </div>
                            <div class="form-group col-xs-12 col-md-6 col-lg-6">
                                <label class="col-sm-5 control-label" for="s_input_Fixture_ShortCode_query">治具短码</label>
                                <div class="col-sm-7">
                                    <input type="text" class="form-control input-sm" id="s_input_Fixture_ShortCode_query" name="ShortCode" placeholder="Fixture ShortCode">
                                </div>
                            </div>
                            <div class="form-group col-xs-12 col-md-6 col-lg-6">
                                <label class="col-sm-5 control-label" for="js_select_Workshop_UID_query">生产地点</label>
                                <div class="col-sm-7">
                                    <select class="selectpicker form-control input-sm" id="js_select_Workshop_UID_query" name="Workshop_UID" data-live-search="true"></select>
                                </div>
                            </div>

                            <div class="form-group col-xs-12 col-md-6 col-lg-6">
                                <label class="col-sm-5 control-label" for="js_select_Vendor_query">供应商</label>
                                <div class="col-sm-7">
                                    <select class="selectpicker form-control input-sm" id="js_select_Vendor_query" name="Vendor_Info_UID" data-live-search="true"></select>
                                </div>
                            </div>
                            <div class="form-group col-xs-12 col-md-6 col-lg-6">
                                <label class="col-sm-5 control-label" for="js_select_Fixture_Status_query">治具状态</label>
                                <div class="col-sm-7">
                                    <select class="selectpicker form-control input-sm" id="js_select_Fixture_Status_query" name="Status" data-live-search="true"></select>
                                </div>
                            </div>

                            <div class="form-group col-xs-12 col-md-6 col-lg-6">
                                <label class="col-sm-5 control-label" for="js_s_input_form_query">表单单号</label>
                                <div class="col-sm-7">
                                    <input type="text" name="Repair_NO" class="form-control input-sm" id="js_s_input_form_query" placeholder="表单单号">
                                </div>
                            </div>

                            <div class="form-group col-xs-12 col-md-6 col-lg-6">
                                <label class="col-sm-5 control-label" for="js_input_Modified_UserNTID_query">最后修改者(NTID)</label>
                                <div class="col-sm-7">
                                    <input type="text" class="form-control input-sm" id="js_input_Modified_UserNTID_query" name="Modified_UserNTID" placeholder="Modified">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="col-sm-3 control-label error">修改日期</label>
                                    <div class="col-sm-9">
                                        <div class="input-group">
                                            <span class="input-group-addon"><i class="fa fa-calendar"></i></span>
                                            <span class="input-group-addon">From</span>
                                            <input type="text" name="End_Date_From" class="form-control input-sm date" id="js_s_input_modified_from">
                                            <span class="input-group-addon">To</span>
                                            <input type="text" name="End_Date_To" class="form-control input-sm date" id="js_s_input_modified_to">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-xs-12">
                                <ul class="list-group validate-error"></ul>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary btn-sm" id="js_btn_clear"><i class="fa fa-eraser"></i> 清空</button>
                    <button type="button" class="btn btn-primary btn-sm" id="js_btn_query"><i class="fa fa-search"></i> 查询</button>
                </div>
            </div>
        </div>
    </div>



    <div class="modal fade" id="js_view_modal" role="dialog">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title">查看维修信息</h4>
                </div>
                <div class="modal-body form-horizontal">
                    <div class="form-group col-xs-12 col-md-6 col-lg-6">
                        <label class="col-sm-5 control-label" for="js_select_factory_view">厂区</label>
                        <div class="col-sm-7">
                            <input type="text" class="form-control input-sm" id="js_input_factory_view" name="Plant_Organization_Name" placeholder="Plant" readonly>
                        </div>
                    </div>
                    <div class="form-group col-xs-12 col-md-6 col-lg-6">
                        <label class="col-sm-5 control-label" for="js_input_optype_view">OP类型</label>
                        <div class="col-sm-7">
                            <input type="text" class="form-control input-sm" id="js_input_optype_view" name="BG_Organization_Name" placeholder="OP Type" readonly>
                        </div>
                    </div>

                    <div class="form-group col-xs-12 col-md-6 col-lg-6">
                        <label class="col-sm-5 control-label">功能厂</label>
                        <div class="col-sm-7">
                            <input type="text" class="form-control input-sm" name="FunPlant_Organization_Name" readonly>
                        </div>
                    </div>
                    <div class="form-group col-xs-12 col-md-6 col-lg-6">
                        <label class="col-sm-5 control-label">维修地点</label>
                        <div class="col-sm-7">
                            <input type="text" class="form-control input-sm" name="Repair_Location_Name" readonly>
                        </div>
                    </div>

                    <div class="form-group col-xs-12 col-md-6 col-lg-6">
                        <label class="col-sm-5 control-label">送修者工号</label>
                        <div class="col-sm-7">
                            <input type="text" class="form-control input-sm" name="SentOut_Number" readonly>
                        </div>
                    </div>
                    <div class="form-group col-xs-12 col-md-6 col-lg-6">
                        <label class="col-sm-5 control-label">送修者名称</label>
                        <div class="col-sm-7">
                            <input type="text" class="form-control input-sm" name="SentOut_Name" readonly>
                        </div>
                    </div>
                    <div class="form-group col-xs-12 col-md-6 col-lg-6">
                        <label class="col-sm-5 control-label">接收者NTID</label>
                        <div class="col-sm-7">
                            <input type="text" class="form-control input-sm" name="Receiver_NTID" readonly>
                        </div>
                    </div>
                    <div class="form-group col-xs-12 col-md-6 col-lg-6">
                        <label class="col-sm-5 control-label">接收者名称</label>
                        <div class="col-sm-7">
                            <input type="text" class="form-control input-sm" name="Receiver_Name" readonly>
                        </div>
                    </div>

                    <div class="form-group col-xs-12 col-md-6 col-lg-6">
                        <label class="col-sm-5 control-label">送修日期时间</label>
                        <div class="col-sm-7">
                            <input type="text" class="form-control input-sm" name="SentOut_Date" readonly>
                        </div>
                    </div>
                    <div class="form-group col-xs-12 col-md-6 col-lg-6">
                        <label class="col-sm-5 control-label">维修单号</label>
                        <div class="col-sm-7">
                            <input type="text" class="form-control input-sm" name="Repair_NO" readonly>
                        </div>
                    </div>


                    <div class="form-group col-xs-12 col-md-6 col-lg-6">
                        <label class="col-sm-5 control-label">治具唯一编号</label>
                        <div class="col-sm-7">
                            <input type="text" class="form-control input-sm" name="Fixture_Unique_ID" readonly>
                        </div>
                    </div>
                    <div class="form-group col-xs-12 col-md-6 col-lg-6">
                        <label class="col-sm-5 control-label">治具名称</label>
                        <div class="col-sm-7">
                            <input type="text" class="form-control input-sm" name="Fixture_Name" readonly>
                        </div>
                    </div>


                    <div class="form-group col-xs-12 col-md-6 col-lg-6">
                        <label class="col-sm-5 control-label">维修人员NTID</label>
                        <div class="col-sm-7">
                            <input type="text" class="form-control input-sm" name="Repair_Staff_NTID" readonly>
                        </div>
                    </div>
                    <div class="form-group col-xs-12 col-md-6 col-lg-6">
                        <label class="col-sm-5 control-label">维修人员名称</label>
                        <div class="col-sm-7">
                            <input type="text" class="form-control input-sm" name="Repair_Staff_Name" readonly>
                        </div>
                    </div>
                    <div class="form-group col-xs-12 col-md-6 col-lg-6">
                        <label class="col-sm-5 control-label">维修状态</label>
                        <div class="col-sm-7">
                            <input type="text" class="form-control input-sm" name="StatusName" readonly>
                        </div>
                    </div>
                    <div class="form-group col-xs-12 col-md-6 col-lg-6">
                        <label class="col-sm-5 control-label">维修完成日期</label>
                        <div class="col-sm-7">
                            <input type="text" class="form-control input-sm" name="Completion_Date" readonly>
                        </div>
                    </div>


                    @*js_select_factory_view*@

                </div>
                <div class="modal-footer">
                    <hr class="no-margin" />
                    <h4 style="float:left;">
                        维修原因及解决策略
                    </h4>
                    <table class="table table-condensed" id="js_view_sub_repair_table">
                        <thead>
                            <tr>
                                <th class="padding-l-5-i">序号</th>
                                <th class="padding-l-5-i">维修原因</th>
                                <th class="padding-l-5-i">解决策略</th>
                            </tr>
                        </thead>
                    </table>
                    <button type="button" class="btn btn-primary btn-sm" data-dismiss="modal"><i class="fa fa-times"></i> 关闭</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="js_edit_modal" tabindex="-1" role="dialog">
        <div class="modal-dialog1 modal-lg " role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title">治具维修</h4>
                </div>
                <div class="modal-body"> 
                    <form id="js_form_query" class="form-horizontal clearfix" data-need-validate="true">


                        <div class="form-group col-xs-12 col-md-6 col-lg-6">
                            <label class="col-sm-5 control-label" for="js_select_factory_create">厂区</label>
                            <div class="col-sm-7">
                                <select class="selectpicker form-control input-sm" id="js_select_factory_create" name="Plant_Organization_UID" data-live-search="true">
                                    @foreach (var item in Model.Plants)
                                    {
                                        <option value=@item.Plant_OrganizationUID>@item.Plant</option>
                                    }
                                </select>
                            </div>
                        </div>
                        <div class="form-group col-xs-12 col-md-6 col-lg-6">
                            <label class="col-sm-5 control-label" for="js_select_optype_create">OP类型</label>
                            <div class="col-sm-7">
                                <select class="selectpicker form-control input-sm" id="js_select_optype_create" name="BG_Organization_UID" data-live-search="true"></select>
                            </div>
                        </div>

                        <div class="form-group col-xs-12 col-md-6 col-lg-6">
                            <label class="col-sm-5 control-label" for="js_select_funplant_create">功能厂</label>
                            <div class="col-sm-7">
                                <select class="selectpicker form-control input-sm" id="js_select_funplant_create" name="FunPlant_Organization_UID" data-live-search="true"></select>
                            </div>
                        </div>

                        <div class="form-group col-xs-12 col-md-6 col-lg-6">
                            <label class="col-sm-5 control-label" for="s_select_repair_location_create">维修地点</label>
                            <div class="col-sm-7">
                                <select class="selectpicker form-control input-sm" id="s_select_repair_location_create" name="Repair_Location_UID" data-live-search="true"></select>
                            </div>
                        </div>
                        <div class="form-group col-xs-12 col-md-6 col-lg-6">
                            <label class="col-sm-5 control-label" for="js_input_SentOut_Number_create">送修者工号</label>
                            <div class="col-sm-7">
                                <input type="text" name="SentOut_Number" class="form-control input-sm" id="js_input_SentOut_Number_create" onblur="refreshSentOutStaffNameByNTID(this)">
                            </div>
                        </div>
                        <div class="form-group col-xs-12 col-md-6 col-lg-6">
                            <label class="col-sm-5 control-label" for="js_input_SentOut_Name_create">送修者名称</label>
                            <div class="col-sm-7">
                                <input type="text" name="SentOut_Name" class="form-control input-sm" id="js_input_SentOut_Name_create">
                            </div>
                        </div>
                        <div class="form-group col-xs-12 col-md-6 col-lg-6">
                            <label class="col-sm-5 control-label" for="js_select_Receiver_UID_create">接收者NTID</label>
                            <div class="col-sm-7">
                                <input type="text" name="Receiver_UID" class="form-control input-sm" id="js_select_Receiver_UID_create" onchange="refreshReceiverStaffNameByNTID(this)">
                            </div>
                        </div>
                        <div class="form-group col-xs-12 col-md-6 col-lg-6">
                            <label class="col-sm-5 control-label" for="js_input_Receiver_Name_create">接收者名称</label>
                            <div class="col-sm-7">
                                <input type="text" name="Receiver_Name" class="form-control input-sm" disabled="disabled" id="js_input_Receiver_Name_create">
                            </div>
                        </div>

                        <div class="form-group col-xs-12 col-md-6 col-lg-6">
                            <label class="col-sm-5 control-label" for="js_s_input_sentout_date">送修日期时间</label>
                            <div class="col-sm-7">
                                <input type="text" class="form-control input-sm date_time required" id="js_s_input_sentout_date" name="Modified_Date_From">
                            </div>
                        </div>

                        <div class="form-group col-xs-12 col-md-6 col-lg-6">
                            <label class="col-sm-5 control-label" for="s_input_repair_NO_create">维修单号</label>
                            <div class="col-sm-7">
                                <input type="text" name="Repair_NO" class="form-control input-sm" disabled="disabled" id="s_input_repair_NO_create">
                            </div>
                        </div>
                    </form>

                    <hr class="no-margin" />
                    <h4>
                        治具资料
                        <button class="btn btn-primary btn-sm" id="js_btn_add_repair_func">新增维修治具</button>
                        <button class="btn btn-primary btn-sm" id="js_btn_del_reapair_func">删除维修治具</button>
                    </h4>
                    <!--治具模糊查询-->
                    <div class="form-horizontal clearfix">
                        <div class="form-group col-xs-12 col-md-6 col-lg-6 fixture-query-notctu">
                            <label class="col-sm-5 control-label" for="js_input_Line_ID">产线代码</label>
                            <div class="col-sm-7">
                                <input type="text" class="form-control input-sm" id="js_input_Line_ID" name="Line_ID">
                            </div>
                        </div>
                        <div class="form-group col-xs-12 col-md-6 col-lg-6 fixture-query-notctu">
                            <label class="col-sm-5 control-label" for="js_input_Line_Name">产线名称</label>
                            <div class="col-sm-7">
                                <input type="text" class="form-control input-sm" id="js_input_Line_Name" name="Line_Name">
                            </div>
                        </div>

                        <div class="form-group col-xs-12 col-md-6 col-lg-6 fixture-query-notctu">
                            <label class="col-sm-5 control-label" for="js_input_Machine_ID">设备代码</label>
                            <div class="col-sm-7">
                                <input type="text" class="form-control input-sm" id="js_input_Machine_ID" name="Machine_ID">
                            </div>
                        </div>

                        <div class="form-group col-xs-12 col-md-6 col-lg-6 fixture-query-notctu">
                            <label class="col-sm-5 control-label" for="js_input_Machine_Name">设备名称</label>
                            <div class="col-sm-7">
                                <input type="text" class="form-control input-sm" id="js_input_Machine_Name" name="Machine_Name">
                            </div>
                        </div>

                        <div class="form-group col-xs-12 col-md-6 col-lg-6 fixture-query-notctu">
                            <label class="col-sm-5 control-label" for="js_input_Process_ID">制程代码</label>
                            <div class="col-sm-7">
                                <input type="text" class="form-control input-sm" id="js_input_Process_ID" name="Process_ID">
                            </div>
                        </div>

                        <div class="form-group col-xs-12 col-md-6 col-lg-6 fixture-query-notctu">
                            <label class="col-sm-5 control-label" for="js_input_Process_Name">制程名称</label>
                            <div class="col-sm-7">
                                <input type="text" class="form-control input-sm" id="js_input_Process_Name" name="Process_Name">
                            </div>
                        </div>

                        <div class="form-group col-xs-12 col-md-6 col-lg-6">
                            <label class="col-sm-5 control-label" for="js_select_fixture">治具</label>
                            <div class="col-sm-7">
                                <select class="selectpicker form-control input-sm" id="js_select_fixture" name="Fixture_M_UID" data-live-search="true">
                                    <option></option>
                                </select>
                            </div>
                        </div>

                        <div id="js_select_fixture_scan-div" class="form-group col-xs-12 col-md-6 col-lg-6">
                            <label class="col-sm-5 control-label" for="js_select_fixture_scan">治具扫码</label>
                            <div class="col-sm-7">
                                <input type="text" class="form-control input-sm" id="js_select_fixture_scan" placeholder="CTU 扫码" title="请先选择厂区、OP类型、功能厂(可选)，再扫码！">
                            </div>
                        </div>
                    </div>

                    <table class="table table-condensed" id="js_edit_repair_datatable">
                        <thead>
                            <tr>
                                <th class="table-col-checkbox nosort">
                                    <input type="checkbox" class="js-checkbox-all" />
                                </th>
                                <th class="padding-l-5-i">序号</th>
                                <th class="padding-l-5-i">维修人员NTID</th>
                                <th class="padding-l-5-i">维修人员名称</th>
                                <th class="padding-l-5-i">治具短码</th>
                                <th class="padding-l-5-i">产线名称</th>
                                <th class="padding-l-5-i">车间名称</th>
                                <th class="padding-l-5-i">治具名称</th>
                                <th class="padding-l-5-i">维修状态</th>
                                <th class="padding-l-5-i">维修完成日期</th>
                            </tr>
                        </thead>
                    </table>
                    <hr class="no-margin" />
                    <h4>
                        维修原因及解决策略
                        <button class="btn btn-primary btn-sm" id="js_btn_add_repair_solution_func">新增原因及对策</button>
                        <button class="btn btn-primary btn-sm" id="js_btn_del_reapair_solution_func">删除原因及对策</button>
                    </h4>
                    <table class="table table-condensed" id="js_edit_sub_repair_table">
                        <thead>
                            <tr>
                                <th class="table-col-checkbox nosort">
                                    <input type="checkbox" class="js-checkbox-all" />
                                </th>
                                <th class="padding-l-5-i">序号</th>
                                <th class="padding-l-5-i">维修原因</th>
                                <th class="padding-l-5-i">解决策略</th>
                            </tr>
                        </thead>
                    </table>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary btn-sm" id="js_btn_createclear" data-dismiss="modal"><i class="fa fa-times"></i> 取消</button>
                    <button type="button" class="btn btn-primary btn-sm" id="js_btn_create"><i class="fa fa-search"></i> 保存</button>
                    <button type="button" class="btn btn-primary btn-sm" id="js_btn_saveEdit"><i class="fa fa-search"></i> 保存</button>
                </div>
            </div>
        </div>
    </div>



}

@section ViewScripts{
    <link rel="stylesheet" type="text/css" href="~/Content/css/bootstrap-select.css" />
    <script type="text/javascript" src="~/Scripts/EQP/bootstrap-select.js"></script>
    <style type="text/css">
        .modal-dialog1 {
            position: relative;
            display: table; /* This is important */
            overflow-y: auto;
            overflow-x: auto;
            width: 70%;
            margin-left: 15%;
            min-width: 300px;
        }
    </style>
    <script type="text/javascript">

        $(function () {
            var FixtureRepair = (function () {
                var needBuildCriteria = false;
                var urls = {
                    //画面初始化加载
                    QueryFixtureRepairsUrl: '@Url.Action("QueryFixtureRepairs", "Fixture")',

                    //根据厂区取得OP类型
                    getCurrentOPType: '@Url.Action("GetCurrentOPType", "Fixture")',
                    //根据OP类型取得功能厂
                    getFunPlantByOPTypes: '@Url.Action("GetFunPlantByOPTypes", "Fixture")',
                    //根据FixtureUid获取治具信息
                    queryFixtureByID: '@Url.Action("QueryFixtureByUid", "Fixture")',

                    //获取供应商的信息
                    getVendorInfoList: '@Url.Action("GetVendorInfoList", "Fixture")',
                    //获取产线信息
                    getProductionLineList: '@Url.Action("GetProductionLineList", "Fixture")',
                    //根据Production_Line_UID获取对应的制程，专案，工站，生产地点信息
                    getProductionLineByUid: '@Url.Action("GetProductionLineByUid", "Fixture")',
                    //获取治具机台信息
                    getFixtureMachineDTOList: '@Url.Action("GetFixtureMachineDTOList", "Fixture")',
                    //设置机台类型数据
                    getFixtureMachineByUid: '@Url.Action("GetFixtureMachineByUid", "Fixture")',
                    //获取生产地点
                    getWorkshopList: '@Url.Action("GetWorkshopList", "Fixture")',
                    //获取工站
                    getWorkstationList: '@Url.Action("GetWorkstationList", "Fixture")',
                    //获取制程
                    getProcess_InfoList: '@Url.Action("GetProcess_InfoList", "Fixture")',
                    //获取专案
                    getProjectList: '@Url.Action("GetProjectList", "Fixture")',
                    //获取治具状态
                    getFixtureStatusUrl: '@Url.Action("GetFixtureStatusList", "Fixture")',
                    //获取维修地点列表
                    getRepairLoactionList: '@Url.Action("GetRepairLoactionList", "Fixture")',
                    //导出
                    exportFixtureRepairs: '@Url.Action("DoExportFixtureRepair", "Fixture")',
                    exportFixtureRepairsByQuery: '@Url.Action("DoExportFixtureRepairByQuery", "Fixture")',
                    //获取异常原因和维修对策列表
                    getDefectCodeRepairSolutionList: '@Url.Action("GetDefectCodeReapairSolutionList", "Fixture")',
                    //获取异常原因
                    GetDefectCodeList: '@Url.Action("GetDefectList", "Fixture")',
                    //获取维修对策列表
                    GetRepairSolutionList: '@Url.Action("GetRepairSoulutionList", "Fixture")',
                    //維修單新增時，維修狀態只有(3.維修中In-Repair;4.報廢Scrap;5:返供應商維修RTV)三種可以選取。
                    getFixtureStatusWhenAddUrl: '@Url.Action("GetFixtureStatusListWhenAdd", "Fixture")',
                    //新增保存
                    addFixtureRepairUrl: '@Url.Action("AddFixtureRepair", "Fixture")',
                    //根据维修单号获取数据
                    queryFixtureRepairUrl: '@Url.Action("GetFixtureRepairByRepairNo", "Fixture")',
                    //编辑保存
                    editFixtureRepairUrl: '@Url.Action("EditFixtureRepair", "Fixture")',
                    //获取治具列表
                    getFixtureListFixtureRepairUrl:'@Url.Action("GetFixtureListFixtureRepair", "Fixture")',
                    //根据治具唯一编码获取治具列表,用于成都扫码
                    getFixtureListFixtureRepairByUniqueIDUrl:'@Url.Action("GetFixtureListFixtureRepairByUniqueID", "Fixture")',
                    //验证状态
                    validFixtureRepairStatusUrl:'@Url.Action("ValidFixtureRepairStatus", "Fixture")',
                };

                var functionDatatable = null,
                    subDatatable = null,
                    editData = null;
                fixtureDataTable = null;
                var columns = [{
                    createdCell: function (td, cellData, rowData, row, col) {
                        $(td).html('<input type="checkbox" name="cktrans" class="js-checkbox-item" value="' + rowData.Fixture_Repair_D_UID + '">')
                        .addClass('table-col-checkbox');
                    },
                    className: "text-center"
                },

                      {
                          createdCell: function (td, cellData, rowData, row, col) {
                              var disableEdit = false;
                              if (rowData.StatusName == "使用中In - PRD" || rowData.StatusName == "報廢Scrap" || rowData.StatusName == "未使用Non - PRD") {
                                  disableEdit = true;
                              }

                              var html = '<button class="btn btn-primary btn-xs" rel="action-popover">' +
                                              '<i class="fa fa-reorder"></i>' +
                                          '</button>' +
                                          '<div class="hidden popover-content">' +
                                               '<button type="button" class="btn btn-primary btn-xs js-grid-edit ' + (disableEdit ? "disabled" : "") + '" data-id="' + rowData.Repair_NO + '">编辑</button>' +
                                              '<button type="button" class="btn btn-primary btn-xs js-grid-view" data-id="' + rowData.Repair_NO + '" data-repairDUID="' + rowData.Fixture_Repair_D_UID + '">查看</button>' +
                                          '</div>';
                              $(td).html(html);
                          },
                          className: "text-center"
                      },
              {
                  data: null,
                  className: "table-col-seq"
              },
            {
                data: "Repair_NO",
                className: "min-col-xs text-center"
            },
            {
                data: "Plant_Organization_Name",
                className: "min-col-xs text-center"
            }, {
                data: "BG_Organization_Name",
                className: "min-col-xs text-center"
            }, {
                data: "FunPlant_Organization_Name",
                className: "min-col-xs text-center"
            },
             {
                 data: "Process_Info",
                 className: "min-col-xs text-center"
             },
            {
                data: "Production_Line_Name",
                className: "min-col-xs text-center"
            },
           {
               data: "Equipment_No",
               className: "min-col-xs text-right"
           }, {
               data: "Fixture_NO",
               className: "min-col-xs text-right"
           }, {
               data: "ShortCode",
               className: "min-col-xs text-right"
           },
              {
                  data: "Fixture_Unique_ID",
                  className: "min-col-xs text-center"
              },{
                  data: "StatusName",
                  className: "min-col-xs text-right"
              }, {
                  data: "Modified_UserName",
                  className: "min-col-xs text-right"
              }, {
                  data: "Modified_Date",
                  className: "min-col-xs text-right"
              }
                ];
                //#region view columns
                var funcViewColumns = [{
                    className: "table-col-seq",
                    render: function (data, type, full, meta) {
                        return ++meta.row;
                    }
                }, {
                    data: "Function_ID",
                    className: "min-col-xs"
                }, {
                    data: "Function_Name",
                    className: "min-col-lg"
                }, {
                    data: "Order_Index",
                    className: "min-col-lg"
                }, {
                    data: "Is_Show",
                    render: function (data, type, full, meta) {
                        return data ? "Y" : "N";
                    },
                    className: "min-col-lg"
                }, {
                    data: "URL",
                    className: "min-col-lg"
                }, {
                    data: "Is_Show_Role",
                    render: function (data, type, full, meta) {
                        return data ? "Y" : "N";
                    },
                    className: "min-col-xs"
                }];

                var subfuncViewColumns = [
                    {
                        className: "table-col-seq",
                        render: function (data, type, full, meta) {
                            return ++meta.row;
                        }
                    }, {
                        data: "Sub_Fun",
                        className: "min-col-lg",
                    }, {
                        data: "Sub_Fun_Name",
                        className: "min-col-lg",

                    }, {
                        data: "Grant",
                        render: function (data, type, full, meta) {
                            return data ? "Y" : "N";
                        },
                        className: "min-col-lg",
                    }];
                //#endregion view columns

                //#region edit columns
                var funcEditColumns = [{
                    data: null,
                    createdCell: function (td, cellData, rowData, row, col) {

                        var isEdit = false;
                        if (cellData.Fixture_Repair_D_UID != undefined && cellData.Fixture_Repair_D_UID != 0) {
                            isEdit = true;
                        }
                        $(td).html('<input type="checkbox" name="cktrans" class="js-checkbox-item" ' + (isEdit ? 'disabled' : '') + ' value="' + rowData.Fixture_Repair_D_UID + '">')
                         .addClass('table-col-checkbox');
                        //if (!isEdit) {
                        //} else {
                        //    $(td).html('<input type="checkbox" name="cktrans" class="js-checkbox-item" value="' + rowData.Fixture_Repair_D_UID + '">')
                        //     .addClass('table-col-checkbox');
                        //}
                    },
                    className: "text-center min-col-xs"
                },
                {
                    render: function (data, type, full, meta) {
                        if (full.index != undefined) {
                            return full.index;
                        } else {
                            return ++meta.row;
                        }
                    }
                }, {
                    data: "Repair_Staff_NTID",
                    render: function (data, type, full, meta) {

                        var isEdit = false;
                        if (full.Fixture_Repair_D_UID != undefined && full.Fixture_Repair_D_UID != 0) {
                            isEdit = true;
                        }
                        var html = "";
                        if (isEdit) {
                            html = '<input type="text" name="Repair_Staff_NTID" style="max-width:100px;" data-useruid="' + full.Repair_Staff_UID + '" class="form-control input-sm js-input-function-id" value="' + data + '"  onchange="refreshRpairStaffNameAdd(this)">';
                        }
                        else {
                            html = '<input type="text" name="Repair_Staff_NTID" style="max-width:100px;" data-useruid="' + DEFAULTREPAIRSTAFFUID + '" class="form-control input-sm js-input-function-id" value="' + DEFAULTREPAIRSTAFFNTID + '" onchange="refreshRpairStaffNameAdd(this)">';
                        }
                        return html;
                    },
                    className: "min-col-xs"
                }, {
                    data: "Repair_Staff_Name",
                    render: function (data, type, full, meta) {

                        var isEdit = false;
                        if (full.Fixture_Repair_D_UID != undefined && full.Fixture_Repair_D_UID != 0) {
                            isEdit = true;
                        }
                        var html = "";
                        if (isEdit) {
                            html = '<input type="text" name="Repair_Staff_Name" class="form-control input-sm js-input-repair-staff-Name" disabled="disabled" style="max-width:100px;" value="' + data + '"/>';
                        } else {
                            html = '<input type="text" name="Repair_Staff_Name" class="form-control input-sm js-input-repair-staff-Name" disabled="disabled" style="max-width:100px;" value="' + DEFAULTREPAIRSTAFFNAME + '"/>';
                        }
                        //var html = data;

                        return html;
                    },
                    className: "min-col-lg"
                }, {
                    data: "ShortCode",
                    render: function (data, type, full, meta) {
                        var html = data;
                        return html;
                    },
                    className: "min-col-lg"
                },{
                    data: "Line_Name",
                    render: function (data, type, full, meta) {
                        var html = data;
                        return html;
                    },
                    className: "min-col-lg"
                },{
                    data: "Workshop_Name",
                    render: function (data, type, full, meta) {
                        var html = data;
                        return html;
                    },
                    className: "min-col-lg"
                },{
                    data: "Fixture_Name",
                    render: function (data, type, full, meta) {

                        var isEdit = true;
                        var html = data;
                        return html;
                    },
                    className: "min-col-lg"
                },
                {
                    data: "Status",
                    render: function (data, type, full, meta) {
                        var isEdit = false;
                        var html = '<select type="text" name="Status" class="form-control input-sm js-input-function-id js-select-repair-status-list" onchange="repairStatusChang(this)">';
                        var optionHtml = "";
                        if (repairStatusListEditData != null) {
                            optionHtml += '<option></option>';
                            for (var i = 0; i < repairStatusListEditData.length; i++) {
                                if (repairStatusListEditData[i].Status == data) {
                                    optionHtml += '<option selected="selected" value="' + repairStatusListEditData[i].Status + '">' + repairStatusListEditData[i].StatuName + '</option>';
                                } else {
                                    optionHtml += '<option value="' + repairStatusListEditData[i].Status + '">' + repairStatusListEditData[i].StatuName + '</option>';
                                }
                            }
                        }
                        html += optionHtml + '</select>';
                        return html;
                    },
                    className: "min-col-lg"
                },
                {
                    data: "Completion_Date",
                    render: function (data, type, full, meta) {

                        if (data == null) {
                            data = "";
                        } else {
                            data = data.replace("T", " ");
                        }
                        var html = '<input type="text" name="Completion_Date" class="form-control input-sm" value="' + data + '" onchange="complationDateChange(this)">';
                        return html;
                    },
                    className: "min-col-lg"
                }];
                // #endregion
                //维修原因及解决策略栏位
                var subfuncEditColumns = [
                    {
                        data: null,
                        createdCell: function (td, cellData, rowData, row, col) {
                            $(td).html('<input type="checkbox" name="cktrans" class="js-checkbox-item" value="' + rowData.Fixture_Repair_D_UID + '">')
                                 .addClass('table-col-checkbox');
                        },
                        className: "text-center min-col-xs"
                    },
                    {
                        data: "subIndex",
                        render: function (data, type, full, meta) {

                            var isEdit = false;
                            if (full.Fixture_Repair_D_Defect_UID != undefined) {
                                isEdit = true;
                            }
                            if (isEdit) {
                                return data;
                            } else {
                                return full.subIndex;
                            }
                        }
                    }, {
                        data: "Defect_Code_UID",
                        render: function (data, type, full, meta) {
                            //Fixture_Repair_D_Defect_UID 有值则为原有数据，不可修改

                            var isEdit = false;
                            if (full.Fixture_Repair_D_Defect_UID != undefined) {
                                isEdit = true;
                            }
                            var html = '<select type="text" name="Defect_Code_UID" class="form-control input-sm js-input-function-id defect-code-list"' + (isEdit ? ' disabled' : '') + ' value="' + data + '" onchange="defectCodeListChange(this)">';
                            var optionHtml = "";

                            optionHtml += '<option></option>';
                            if (DEFECTCODELISTDATA != undefined && DEFECTCODELISTDATA != null) {
                                //刷新所有维修原因和对策
                                DEFECTCODELISTDATA().each(function (item) {
                                    if (data == item.Fixture_Defect_UID) {
                                        optionHtml += '<option value="' + item.Fixture_Defect_UID + '" selected="selected">' + item.Fixture_DefectName + '</option>';
                                    } else {
                                        optionHtml += '<option value="' + item.Fixture_Defect_UID + '">' + item.Fixture_DefectName + '</option>';
                                    }
                                });
                            }

                            html += optionHtml + '</select>';
                            return html;
                        },
                        className: "min-col-lg",
                    }, {
                        data: "Solution_UID",
                        render: function (data, type, full, meta) {

                            //这里需要获取状态，并循环绑定值
                            var isEdit = false;
                            var html = '<select type="text" name="Solution_UID" class="form-control input-sm js-input-function-id repair-solution-list"' + (isEdit ? 'disabled' : '') + ' value="' + data + '" onchange="repairSolutionListChange(this)">';
                            var optionHtml = "";
                            optionHtml += '<option></option>';
                            if (data != undefined) {
                                var defectCode = DEFECTCODELISTDATA({ Fixture_Defect_UID: String(full.Defect_Code_UID) }).first();
                                if (defectCode != false) {
                                    defectCode.repairSolutionList().each(function (item) {
                                        if (data == item.Repair_Solution_UID) {
                                            optionHtml += '<option value="' + item.Repair_Solution_UID + '" selected="selected">' + item.Repair_SoulutionName + '</option>';
                                        } else {
                                            optionHtml += '<option value="' + item.Repair_Solution_UID + '">' + item.Repair_SoulutionName + '</option>';
                                        }
                                    });
                                }
                            }
                            //if (repairSolutionListData != null) {
                            //    optionHtml += '<option></option>';

                            //    for (var i = 0; i < repairSolutionListData.length; i++) {
                            //        if (data == repairSolutionListData[i].Fixture_RepairSolution_UID) {
                            //            optionHtml += '<option value="' + repairSolutionListData[i].Fixture_RepairSolution_UID + '" selected="selected">' + repairSolutionListData[i].RepairSolution_Name + '</option>';
                            //        } else {
                            //            optionHtml += '<option value="' + repairSolutionListData[i].Fixture_RepairSolution_UID + '">' + repairSolutionListData[i].RepairSolution_Name + '</option>';
                            //        }
                            //    }
                            //}
                            html += optionHtml + '</select>';
                            return html;
                        },
                        className: "min-col-lg",

                    }]

                //新增治具的栏位
                var funcGetColumns = [
                                    {
                                        data: null,
                                        createdCell: function (td, cellData, rowData, row, col) {

                                            $(td).html('<input type="checkbox" name="cktrans" class="js-checkbox-item" value="' + rowData.Fixture_Repair_D_UID + '">')
                                                 .addClass('table-col-checkbox');
                                        },
                                        className: "text-center min-col-xs"
                                    },
                                    {
                                        render: function (data, type, full, meta) {
                                            return LAST_INDEX_FIXTURE_ADD + 1;
                                        }
                                    }, {
                                        data: "Repair_Staff_UID",
                                        render: function (data, type, full, meta) {

                                            var html = '<input type="text" name="Repair_Staff_UID" data-UserUid="' + DEFAULTREPAIRSTAFFUID + '" class="form-control input-sm js-input-repair-staff-NTID" style="max-width:100px;" onchange="refreshRpairStaffNameAdd(this)" placeholder="NTID" value="' + DEFAULTREPAIRSTAFFNTID + '">';
                                            return html;
                                        },
                                        className: "min-col-lg",
                                    }, {
                                        data: "Repair_Staff_Name",
                                        render: function (data, type, full, meta) {

                                            var html = '<input type="text" name="Repair_Staff_Name" class="form-control input-sm js-input-repair-staff-Name" disabled="disabled" style="max-width:100px;" value="' + DEFAULTREPAIRSTAFFNAME + '"/>';
                                            return html;
                                        },
                                        className: "min-col-lg",

                                    }, {
                                        data: "ShortCode",
                                        render: function (data, type, full, meta) {
                                            var isEdit = false;
                                            var html = full.ShortCode;
                                            return html;
                                        },
                                        className: "min-col-lg",

                                    }, {
                                        data: "Line_Name",
                                        render: function (data, type, full, meta) {
                                            var isEdit = false;
                                            var html = full.Line_Name;
                                            return html;
                                        },
                                        className: "min-col-lg",

                                    },{
                                        data: "Workshop_Name",
                                        render: function (data, type, full, meta) {
                                            var isEdit = false;
                                            var html = full.Workshop_Name;
                                            return html;
                                        },
                                        className: "min-col-lg",

                                    },{
                                        data: "Fixture_Name",
                                        render: function (data, type, full, meta) {
                                            var isEdit = false;
                                            var html = full.Fixture_Name;
                                            return html;
                                        },
                                        className: "min-col-lg",

                                    },{
                                        data: "Status",
                                        render: function (data, type, full, meta) {

                                            var isEdit = false;
                                            var html = '<select type="text" name="Status" class="form-control input-sm js-input-function-id js-select-repair-status-list" onchange="repairStatusChang(this)">';
                                            var optionHtml = "";
                                            if (repairStatusListAddData != null) {
                                                optionHtml += '<option></option>';
                                                for (var i = 0; i < repairStatusListAddData.length; i++) {
                                                    optionHtml += '<option value="' + repairStatusListAddData[i].Status + '">' + repairStatusListAddData[i].StatuName + '</option>';
                                                }
                                            }
                                            html += optionHtml + '</select>';
                                            return html;
                                        },
                                        className: "min-col-lg",

                                    }, {
                                        data: "Completion_Date",
                                        render: function (data, type, full, meta) {
                                            var html = '<div class="input-group"><span class="input-group-addon"><i class="fa fa-calendar"></i></span><input type="text" name="Completion_Date" class="form-control input-sm" onchange="complationDateChange(this)">';
                                            return html;
                                        },
                                        className: "min-col-lg",
                                    }]


                //#endregion
                var _getParams = function () {
                    if (needBuildCriteria) {
                        PDMS.Utility.Settings.Pages.remote.params = $('#js_form_query').serialize().replace(/\+/g, " ");
                        return $('#js_form_query').serialize().replace(/\+/g, " ");
                    }
                    else {
                        return null;
                    }
                };

                var _queryStorageReports = function (firstLoad) {

                    var config = {
                        pageId: "#page",
                        tableId: "#js_user_fixrepair_datatable",
                        remoteUrl: urls.QueryFixtureRepairsUrl,
                        searchParams: _getParams(),
                        tableOptions: {
                            scrollX: true,
                            autoWidth: true,
                            columns: columns
                        }
                    };
                    if (!firstLoad) {
                        $('#page').page('destroy');
                    }
                    if (needBuildCriteria) {
                        PDMS.Utility.Criteria.Build();
                    }
                    PDMS.Utility.Pages.Set(config);
                    $('#js_user_fixrepair_datatable tbody tr td').addClass('text-center');
                };
                return {
                    urls: urls,
                    Init: function () {
                        PDMS.Utility.Criteria.Init();
                        _queryStorageReports(true);

                        refreshOPTypesQuery();
                        //refreshFunPlantQuery();
                        //refreshProductionLineQuery();
                        //refreshProcessQuery()
                        //refreshWorkStationQuery();
                        //refreshWorkshopQuery();
                        //refreshRepairLocationQuery();
                        //refreshMachineQuery();
                        //refreshVendorQuery();
                        refreshFixtureStatusQuery();
                    },
                    queryStorageReports: function (isSearchBtn) {
                        needBuildCriteria = (isSearchBtn === true ? true : needBuildCriteria);
                        _queryStorageReports(false);
                    },
                    GetSubDatatable: function () {

                        if (subDatatable == null) {

                            subDatatable = $('#js_edit_sub_repair_table').DataTable({
                                paging: false,
                                searching: false,
                                ordering: false,
                                retrieve: true,
                                columns: subfuncEditColumns,
                            });
                        }
                        return subDatatable;
                    },
                    SetSubDatatable: function (datatable) {
                        subDatatable = datatable;
                    },
                    DestroySubTable: function () {
                        if (subDatatable != null) {
                            subDatatable.destroy();
                        }
                    },
                    GetFunctionDatatable: function () {

                        //if (functionDatatable == null) {

                        functionDatatable = $('#js_edit_repair_datatable').DataTable({
                            paging: false,
                            searching: false,
                            ordering: false,
                            retrieve: true,
                            columns: funcGetColumns,
                        });
                        //}
                        return functionDatatable;

                        //if (subDatatable == null) {

                        //    subDatatable = $('#js_edit_sub_repair_table').DataTable({
                        //        paging: false,
                        //        searching: false,
                        //        ordering: false,
                        //        retrieve: true,
                        //        columns: subfuncEditColumns,
                        //    });
                        //}
                        //return subDatatable;
                    },
                    SetFunctionDatatable: function (datatable) {
                        functionDatatable = datatable;
                    },
                    GetFixtureDataTable: function () {

                        if (fixtureDataTable == null) {

                            fixtureDataTable = $('#js_edit_get_datatable').DataTable({
                                paging: false,
                                searching: false,
                                ordering: false,
                                retrieve: true,
                                columns: funcGetColumns,
                            });
                        }
                        return fixtureDataTable;
                    },
                    SetfixtureDataTable: function (datatable) {
                        fixtureDataTable = datatable;
                    },

                    ViewColumns: { funcView: funcViewColumns, subfuncView: subfuncViewColumns },
                    EditColumns: { funcEdit: funcEditColumns, subFuncEdit: subfuncEditColumns },
                    GetEditData: function () { return editData },
                    SetEditData: function (editdata) {
                        editData = editdata;
                    }
                }
            })();
            FixtureRepair.Init();




            //导出
            $('#js_btn_export').click(function () {
                var $selectList = $('#js_user_fixrepair_datatable').find('.js-checkbox-item:checked');
                var len = $selectList.length;
                if (len == 0) {
                    //PDMS.Utility.MessageBox.info('请选择要导出的数据!');
                    //全部导出
                    var url = FixtureRepair.urls.exportFixtureRepairsByQuery;
                    //没有查询条件的情况，从查询页面获取
                    if (PDMS.Utility.Settings.Pages.remote.params == null) {
                        PDMS.Utility.Settings.Pages.remote.params = $('#js_form_query').serialize().replace(/\+/g, " ");
                    }
                    url +='?' + PDMS.Utility.Settings.Pages.remote.params;
                    window.location.href = url;
                } else {
                    var uids = $.map($selectList, function (row) {
                        return row.value;
                    });
                    var url = FixtureRepair.urls.exportFixtureRepairs;
                    url += "?uids=" + uids.toString();
                    window.location.href = url;
                }
            });

            //do clean up in edit modal show/hide
            $('#js_edit_modal').on('show.bs.modal', function (event) {
                var button = $(event.relatedTarget)
                var modal = $(this)
                var title = modal.find('.modal-title');



                //新增治具维修
                if (button.attr('id') == 'js_btn_add') {
                    //取消禁用
                    $("#js_select_factory_create").removeAttr("disabled");
                    $("#js_select_optype_create").removeAttr("disabled");
                    $("#js_select_funplant_create").removeAttr("disabled");
                    $("#s_select_repair_location_create").removeAttr("disabled");

                    title.text("新增治具维修");
                    //接收者带出登录人的信息
                    $('#js_select_Receiver_UID_create').attr("data-useruid", @Model.Account_UID);
                    $('#js_select_Receiver_UID_create').val('@Model.User_NTID');
                    $("#js_input_Receiver_Name_create").val('@Model.User_Name');

                    $('#js_btn_saveEdit').hide();
                    $('#js_btn_create').show();
                    //新增的时候触发厂区的change 事件，带出其他关联下拉框
                    $('#js_select_factory_create').trigger("change");
                    //初始化治具资料
                    initFixtureInfo();
                    //初始化维修原因及解决策略
                    initDefectRepairSolution();
                    refreshFixtureStatusWhenAdd();
                    //初始化维修原因及解决策略数据
                    DEFECTCODE_REPAIRSOLUTION_DATA = TAFFY();
                }

                //编辑治具维修
                if (button.hasClass('js-grid-edit')) {

                    title.text("编辑治具维修单");
                    $('#js_btn_saveEdit').show();
                    $('#js_btn_create').hide();
                }
                if (button.hasClass('js-grid-view')) {

                    title.text("查看治具维修单");
                    $('#js_btn_saveEdit').hide();
                    $('#js_btn_create').hide();

                }

            })

            $('#js_edit_modal').on('hidden.bs.modal', function (e) {
                $('#js_edit_modal').find('input').val('');
                $('.list-group.validate-error').empty();
            });


            //edit button in grid
            //$('body').on('click', '.js-grid-edit .js-grid-view', function () {
            //
            //    var $sender = $(this);

            //    var uuid = $sender.attr('data-id'),
            //        url = OrganizationMaintenance.urls.queryOrg;

            //    $.post(url, { uuid: uuid }, function (data) {

            //        $('#Organization_UID_hidden').val(uuid);

            //        $('#js_input_Organization_ID').val(data.Organization_ID);
            //        $('#js_input_Organization_Name').val(data.Organization_Name);
            //        $('#js_input_Organization_Desc').val(data.Organization_Desc);

            //        $('#js_input_OrgManager_Name').val(data.OrgManager_Name);
            //        $('#js_input_OrgManager_Tel').val(data.OrgManager_Tel);
            //        $('#js_input_OrgManager_Email').val(data.OrgManager_Email);

            //        $('#js_input_Cost_Center').val(data.Cost_Center);
            //        $('#js_input_begin_date').val(data.Begin_Date);
            //        $('#js_input_end_date').val(data.End_Date).attr("disabled", data.End_Date !== null);

            //    });

            //    $('#js_edit_modal').modal('show', $(this));

            //});



            //新增维修治具
            $('#js_btn_add_repair_func').on('click', function () {
                //带出治具模糊查询下拉框选项
                var fixtureSelected = $("#js_select_fixture option:selected");

                if (fixtureSelected == null || fixtureSelected == undefined) {
                    PDMS.Utility.MessageBox.info("请选择[治具] ");
                    return false;
                }
                var Fixture_M_UID = fixtureSelected.val();
                if (Fixture_M_UID == "" || Fixture_M_UID == null || Fixture_M_UID == undefined) {
                    PDMS.Utility.MessageBox.info("请选择[治具] ");
                    return false;
                }


                var ShortCode=fixtureSelected.attr("data-shortCode");
                var Line_Name=fixtureSelected.attr("data-lineName");
                var Workshop_Name=fixtureSelected.attr("data-workshopName");
                var fixtureName = fixtureSelected.attr("data-fixtureName");
                var uniqueID=fixtureSelected.attr("data-uniqueID");
                var showValue = ShortCode+"_"+uniqueID;

                var statusValid = true;
                //验证是否已存在状态为使用中、未使用以外的其他状态，则不可添加
                $.get(FixtureRepair.urls.validFixtureRepairStatusUrl, { fixtureMUID: Fixture_M_UID }, function (data) {
                    debugger;
                    if (data == false) {
                        PDMS.Utility.MessageBox.info("治具["+showValue+"]已在其他维修单中的维修，不可重复维修!");
                        statusValid = false;
                    }
                });
                if (statusValid == false) {
                    return false;
                }

                var dataTable = FixtureRepair.GetFunctionDatatable();
                var isValid = true;
                var errorMessage = "";
                //验证已填的数据有没问题，此段代码有重复，未优化
                DEFECTCODE_REPAIRSOLUTION_DATA().each(function (item) {

                    if (item.Repair_Staff_UID == "" || item.Repair_Staff_UID == undefined || item.Repair_Staff_UID == 0) {
                        errorMessage += '请完成治具资料第 #' + item.index + "行[维修人员NTID];  ";
                        isValid = false;
                    }
                    if (item.Fixture_M_UID == "" || item.Fixture_M_UID == undefined || item.Fixture_M_UID == 0) {
                        errorMessage += '请完成治具资料第 #' + item.index + "行[治具编码];  ";
                        isValid = false;
                    }
                    if (item.Status == "" || item.Status == undefined || item.Status == 0) {
                        errorMessage += '请选择治具资料第 #' + item.index + "行[维修状态];  ";
                        isValid = false;
                    }
                });

                //验证维修日期
                //数据库可空,暂不验证
                //var completionDate = $tr.find("[name='Completion_Date']")[0];
                //var completionValue = $(completionDate).val();
                //if (completionValue == undefined || completionValue == "") {
                //    PDMS.Utility.MessageBox.info('请先完成第 #' + (rowIdx + 1) + "维修日期");
                //    allowAdd = false;
                //    return false;
                //}

                if (!isValid) {
                    if (errorMessage != "") {
                        PDMS.Utility.MessageBox.info(errorMessage);
                    }
                    return false;
                }

                if (isValid) {
                    var lastTr = $('#js_edit_repair_datatable tr:last');
                    var td = $(lastTr).find("td")[1];
                    if (td == undefined) {
                        LAST_INDEX_FIXTURE_ADD = 0;
                    } else {
                        LAST_INDEX_FIXTURE_ADD = parseInt(td.textContent);
                    }


                    var row = dataTable.row.add({
                        "Fixture_Repair_D_UID": 0,
                        "Repair_Staff_Name": "",
                        "Fixture_Unique_ID": "",
                        "Fixture_Name": fixtureName,
                        "Status": "",
                        "Completion_Date": "",
                        "ShortCode":ShortCode,
                        "Line_Name":Line_Name,
                        "Workshop_Name":Workshop_Name,
                    }).draw();

                    //设置datetimepicker 样式

                    var complationDateTime = $("#js_edit_repair_datatable input[name=Completion_Date]");
                    complationDateTime.datetimepicker({ format: 'yyyy-mm-dd h:i', step: 1, hours12: false, minuteStep: 1, minDate: 0, todayHighlight: true, autoclose: true, language: 'zh-CN' });

                    var newTr = $('#js_edit_repair_datatable tr:last');
                    var repairStaffUID = $($(newTr).find("input[name=Repair_Staff_UID]")[0]).attr("data-useruid");
                    if (repairStaffUID == undefined) {
                        repairStaffUID = "";
                    }
                    var status = $($(newTr).find("select[name=Status]  option:selected")).val();
                    DEFECTCODE_REPAIRSOLUTION_DATA.insert({ index: LAST_INDEX_FIXTURE_ADD + 1, Repair_Staff_UID: repairStaffUID, Status: status, Fixture_M_UID: Fixture_M_UID, ShortCode: ShortCode, Line_Name: Line_Name, Workshop_Name: Workshop_Name, Fixture_Name: fixtureName });

                    $('#js_edit_repair_datatable tr.selected').removeClass('selected');
                    $('#js_edit_repair_datatable tr:last').addClass('selected');
                    //var Fixture_Repair_D_Object = {index:++LAST_INDEX_FIXTURE_ADD, defect: new Array() };
                    //$(row.node()).find('input[name=Repair_Staff_Name]').removeAttr("disabled");

                    //清空子表
                    FixtureRepair.GetSubDatatable().clear().draw();
                    //治具维修每次添加的治具不一样，一次添加完成后要刷新一下
                    refreshFixtureSelect();
                }
            });

            //删除维修治具
            $('#js_btn_del_reapair_func').on('click', function () {

                var dataTable = FixtureRepair.GetFunctionDatatable();

                var checkedItems = $('#js_edit_repair_datatable .js-checkbox-item:checked');

                if (checkedItems.length == 0) {

                    PDMS.Utility.MessageBox.info("请选择需要删除的行。");
                    return;

                } else {
                    checkedItems.each(function (index, checkbox) {
                        var tr = $(checkbox).closest('tr');
                        var td = $(tr).find("td")[1];
                        var index = parseInt(td.textContent);
                        DEFECTCODE_REPAIRSOLUTION_DATA({ index: index }).remove();
                        dataTable.row(tr).remove().draw();
                    });
                    FixtureRepair.GetSubDatatable().clear().draw();

                    //$.map(checkedItems, function (checkbox) {
                    //    var $sender = $(checkbox);
                    //    var systemFuncUId = $sender.val();
                    //    var $tr = $sender.closest('tr');
                    //    var trIndex = $tr.index();
                    //    var editData = FixtureRepair.GetEditData();

                    //    if (systemFuncUId > 0) {

                    //        $.get(FixtureRepairUrls.deleteRoleFunction
                    //            , { uid: systemFuncUId }
                    //            , function (data) {
                    //                if (data != "SUCCESS") {
                    //                    PDMS.Utility.MessageBox.error(data);
                    //                } else {
                    //                    dataTable.row($tr).remove().draw();
                    //                    editData.HeadFunctions.splice(trIndex, 1);
                    //                    FixtureRepair.GetSubDatatable().clear().draw();
                    //                }
                    //            });//end get

                    //    } else {
                    //        dataTable.row($tr).remove().draw();
                    //        if (trIndex < editData.HeadFunctions.length) {
                    //            editData.HeadFunctions.splice(trIndex, 1);
                    //        }
                    //    }

                    //});

                    //dataTable.rows().every(function (rowIdx, tableLoop, rowLoop) {
                    //    dataTable.cell(rowIdx, 1).data(rowIdx + 1).draw()
                    //});
                }
            });

            //第三级联动：维修原因及对策联动事件
            $('#js_edit_repair_datatable').on('click', 'tr', function () {

                var $sender = $(this);
                if (!$sender.hasClass('selected')) {
                    //var dataTable = RoleFunctionSetting.GetSubDatatable();
                    //dataTable.clear().draw();
                    $('#js_edit_repair_datatable tr.selected').removeClass('selected');
                    $sender.addClass('selected');

                    //给维修原因及对策绑定数据
                    var index = getSelectedFixtureIndex();

                    var defectRepairSolutions = DEFECTCODE_REPAIRSOLUTION_DATA({ index: index }).first().defectRepairSolutions;
                    if (defectRepairSolutions != undefined) {
                        var arr = [];
                        DEFECTCODE_REPAIRSOLUTION_DATA({ index: index }).first().defectRepairSolutions().each(function (defectRepair) {
                            arr.push(defectRepair);
                        });
                        debugger;
                        //var arrJson = JSON.stringify(arr);
                        $('#js_edit_sub_repair_table').DataTable({
                            ordering: false,
                            columns: FixtureRepair.EditColumns.subFuncEdit,
                            data: arr,
                            destroy: true
                        });
                        ////绑定数据
                        //FixtureRepair.SetSubDatatable(subTable);
                        //FixtureRepair.GetSubDatatable().clear().draw();
                        //FixtureRepair.SetEditData(arrJson);
                    } else {
                        FixtureRepair.GetSubDatatable().clear().draw();
                    }
                }
                //if (!$sender.hasClass('selected')) {

                //    $('#js_edit_repair_datatable tr.selected').removeClass('selected');
                //    $sender.addClass('selected');

                //    var editData = RoleFunctionSetting.GetEditData();
                //    var headFunc = editData.HeadFunctions[index];

                //    if (headFunc.SubFun === undefined || headFunc.SubFun.length === 0) {

                //    }

                //    $('#js_edit_sub_func_table').DataTable({
                //        columns: RoleFunctionSetting.EditColumns.subFuncEdit,
                //        ordering: false,
                //        data: editData.HeadFunctions[index].SubFun,
                //        destroy: true
                //    });
                //}

                //$('#js_edit_repair_datatable').data('selected-index', index);
            });

            //新增原因及对策
            $('#js_btn_add_repair_solution_func').on('click', function () {
                // 验证是否有选中的治具资料
                var index = getSelectedFixtureIndex();
                if (index == -1) {
                    return false;
                }
                var dataTable = FixtureRepair.GetSubDatatable();
                var allowAdd = true;
                if (allowAdd) {

                    var lastTr = $('#js_edit_sub_repair_table tr:last');
                    var td = $(lastTr).find("td")[1];
                    if (td == undefined) {
                        LAST_INDEX_SUB_ADD = 0;
                    }
                    else {
                        LAST_INDEX_SUB_ADD = parseInt(td.textContent);
                    }

                    var row = dataTable.row.add({
                        "Fixture_Repair_D_UID": 0,
                        "Repair_Staff_Name": "",
                        "Fixture_Unique_ID": "",
                        "Fixture_Name": "",
                        "Status": "",
                        "Completion_Date": "",
                        "subIndex": LAST_INDEX_SUB_ADD + 1,
                    }).draw();

                    //$(row.node()).find('input[name=Repair_Staff_Name]').removeAttr("disabled");

                    //获取选中的治具资料的维修原因及策略
                    var selectedDefectRepair = DEFECTCODE_REPAIRSOLUTION_DATA({ index: getSelectedFixtureIndex() }).first();
                    if (selectedDefectRepair.defectRepairSolutions == undefined) {
                        selectedDefectRepair.defectRepairSolutions = TAFFY();
                    }

                    var tr = $('#js_edit_sub_repair_table tr:last');
                    var td = $(tr).find("td")[1];
                    var subIndex = parseInt(td.textContent);
                    var defectCodeUid = $(tr.find('[name=Defect_Code_UID]')).val();
                    var selectedDefectCodeName = $(tr.find('[name=Defect_Code_UID]')).find("option:selected").text();
                    var solutionUid = $(tr.find('[name=Solution_UID]')).val();
                    var selectedSolutionName = $(tr.find('[name=Solution_UID]')).find("option:selected").text();
                    selectedDefectRepair.defectRepairSolutions.insert({ subIndex: subIndex, Defect_Code_UID: defectCodeUid, Defect_Code_Name: selectedDefectCodeName, Solution_UID: solutionUid, Solution_Name: selectedSolutionName });

                    //刷新数据,不重新绑定会有奇怪的问题，坑死人

                    var defectRepairSolutions = DEFECTCODE_REPAIRSOLUTION_DATA({ index: index }).first().defectRepairSolutions;
                    if (defectRepairSolutions != undefined) {
                        var arr = [];
                        DEFECTCODE_REPAIRSOLUTION_DATA({ index: index }).first().defectRepairSolutions().each(function (defectRepair) {
                            arr.push(defectRepair);
                        });
                        //var arrJson = JSON.stringify(arr);
                        $('#js_edit_sub_repair_table').DataTable({
                            ordering: false,
                            columns: FixtureRepair.EditColumns.subFuncEdit,
                            data: arr,
                            destroy: true
                        });
                    } else {
                        FixtureRepair.GetSubDatatable().clear().draw();
                    }
                }
            });


            //删除原因及对策
            $('#js_btn_del_reapair_solution_func').on('click', function () {
                var dataTable = FixtureRepair.GetSubDatatable();
                var checkedItems = $('#js_edit_sub_repair_table .js-checkbox-item:checked');
                if (checkedItems.length == 0) {
                    PDMS.Utility.MessageBox.info("请选择需要删除的行。");
                    return false;
                } else {
                    checkedItems.each(function (index, checkbox) {

                        var tr = $(checkbox).closest('tr');
                        var td = $(tr).find("td")[1];
                        var index = getSelectedFixtureIndex();
                        var subIndex = parseInt(td.textContent);
                        DEFECTCODE_REPAIRSOLUTION_DATA({ index: index }).first().defectRepairSolutions({ subIndex: subIndex }).remove();
                        dataTable.row(tr).remove().draw();
                    });

                    //刷新数据，不然会跳行
                    var index = getSelectedFixtureIndex();
                    var defectRepairSolutions = DEFECTCODE_REPAIRSOLUTION_DATA({ index: index }).first().defectRepairSolutions;
                    if (defectRepairSolutions != undefined) {
                        var arr = [];
                        DEFECTCODE_REPAIRSOLUTION_DATA({ index: index }).first().defectRepairSolutions().each(function (defectRepair) {
                            arr.push(defectRepair);
                        });
                        //var arrJson = JSON.stringify(arr);
                        $('#js_edit_sub_repair_table').DataTable({
                            ordering: false,
                            columns: FixtureRepair.EditColumns.subFuncEdit,
                            data: arr,
                            destroy: true
                        });
                    } else {
                        FixtureRepair.GetSubDatatable().clear().draw();
                    }
                    //$.map(checkedItems, function (checkbox) {
                    //    var $sender = $(checkbox);
                    //    var systemFuncUId = $sender.val();
                    //    var $tr = $sender.closest('tr');
                    //    var trIndex = $tr.index();
                    //    var editData = FixtureRepair.GetEditData();

                    //    if (systemFuncUId > 0) {

                    //        $.get(FixtureRepairUrls.deleteRoleFunction
                    //            , { uid: systemFuncUId }
                    //            , function (data) {
                    //                if (data != "SUCCESS") {
                    //                    PDMS.Utility.MessageBox.error(data);
                    //                } else {
                    //                    dataTable.row($tr).remove().draw();
                    //                    editData.HeadFunctions.splice(trIndex, 1);
                    //                    FixtureRepair.GetSubDatatable().clear().draw();
                    //                }
                    //            });//end get

                    //    } else {
                    //        dataTable.row($tr).remove().draw();
                    //        if (trIndex < editData.HeadFunctions.length) {
                    //            editData.HeadFunctions.splice(trIndex, 1);
                    //        }
                    //    }

                    //});

                    //dataTable.rows().every(function (rowIdx, tableLoop, rowLoop) {
                    //    dataTable.cell(rowIdx, 1).data(rowIdx + 1).draw()
                    //});
                }
            });
            //$('#bt_search').click(function () {
            //    $('#js_select_factory_query').trigger('change');
            //})

            //增加领用治具行按钮
            $('#js_btn_add_fixture_getfunc').on('click', function () {

                var dataTable = FixtureRepair.GetFixtureDataTable();
                var allowAdd = true;

                if (allowAdd) {
                    var row = dataTable.row.add({
                        "Fixture_Repair_D_UID": 0,
                        "Repair_Staff_Name": "",
                        "Fixture_Unique_ID": "",
                        "Fixture_Name": "",
                        "Status": "",
                        "Completion_Date": ""
                    }).draw();

                    $(row.node()).find('input[name=Repair_Staff_Name]').removeAttr("disabled");

                }
            });

            //删除Function按钮
            $('#js_btn_del_fixture_getfunc').on('click', function () {

                var dataTable = FixtureRepair.GetFixtureDataTable();

                var checkedItems = $('#js_edit_get_datatable .js-checkbox-item:checked');

                if (checkedItems.length == 0) {

                    PDMS.Utility.MessageBox.info("请选择需要删除的行。");
                    return;

                } else {

                    $.map(checkedItems, function (checkbox) {
                        var $sender = $(checkbox);
                        var systemFuncUId = $sender.val();
                        var $tr = $sender.closest('tr');
                        var trIndex = $tr.index();
                        var editData = FixtureRepair.GetEditData();

                        if (systemFuncUId > 0) {

                            $.get(FixtureRepairUrls.deleteRoleFunction
                                , { uid: systemFuncUId }
                                , function (data) {
                                    if (data != "SUCCESS") {
                                        PDMS.Utility.MessageBox.error(data);
                                    } else {
                                        dataTable.row($tr).remove().draw();
                                        editData.HeadFunctions.splice(trIndex, 1);
                                        FixtureRepair.GetSubDatatable().clear().draw();
                                    }
                                });//end get

                        } else {
                            dataTable.row($tr).remove().draw();
                            if (trIndex < editData.HeadFunctions.length) {
                                editData.HeadFunctions.splice(trIndex, 1);
                            }
                        }

                    });

                    dataTable.rows().every(function (rowIdx, tableLoop, rowLoop) {
                        dataTable.cell(rowIdx, 1).data(rowIdx + 1).draw()
                    });
                }
            });


            //查询按钮
            $('#js_btn_query').click(function () {
                if ($('#js_form_query').valid()) {
                    FixtureRepair.queryStorageReports(true);
                    $('#js_search_modal').modal('hide');
                    //$('#js_btn_query')
                }
            });
            //查询界面厂区是OP类型变化
            $('#js_select_factory_query').change(function () {
                //Setsearchbtn();
                refreshOPTypesQuery();
                refreshFunPlantQuery();
                refreshProductionLineQuery();
                refreshProcessQuery();
                refreshWorkStationQuery();
                refreshWorkshopQuery();
                //refreshRepairLocationQuery();
                refreshMachineQuery();
                refreshVendorQuery();
            });

            $('#js_select_optype_query').change(function () {
                refreshFunPlantQuery();
                refreshProductionLineQuery();
                refreshProcessQuery();
                refreshWorkStationQuery();
                refreshWorkshopQuery();
                //refreshRepairLocationQuery();
                refreshMachineQuery();
                refreshVendorQuery();
            });
            //功能厂change(查询)
            $('#js_select_funplant_query').change(function () {
                refreshProductionLineQuery();
                refreshProcessQuery();
                refreshWorkStationQuery();
                refreshWorkshopQuery();
                //refreshRepairLocationQuery();
                refreshMachineQuery();
            });

            $('#js_select_Production_Line_query').change(function () {
                refreshMachineQuery();
            });

            //刷新OP类型(查询)
            function refreshOPTypesQuery() {
                $('#js_select_optype_query').empty();
                $('#js_select_optype_query').html('<option></option>');
                var url = FixtureRepair.urls.getCurrentOPType;
                $.post(url, { plant_OrganizationUID: $('#js_select_factory_query').val() }, function (data) {
                    for (var i = 0; i < data.length; i++) {
                        $('#js_select_optype_query').append('<option value="' + data[i].Organization_UID + '">' + data[i].OP_TYPES + '</option>');
                    }
                });
                $('#js_select_optype_query').selectpicker('refresh');
            }

            //刷新功能厂(查询)
            function refreshFunPlantQuery() {
                $('#js_select_funplant_query').empty();
                $('#js_select_funplant_query').html('<option></option>');
                var opTypeUid = $('#js_select_optype_query').val();
                if (opTypeUid != "" && opTypeUid != undefined) {
                    var url = FixtureRepair.urls.getFunPlantByOPTypes;
                    $.post(url, { Optype: opTypeUid }, function (data) {
                        for (var i = 0; i < data.length; i++) {
                            $('#js_select_funplant_query').append('<option value="' + data[i].FunPlant_OrganizationUID + '">' + data[i].FunPlant + '</option>');
                        }
                    });
                }
                $('#js_select_funplant_query').selectpicker('refresh');
            }

            //刷新产线(查询)
            function refreshProductionLineQuery() {
                $('#js_select_Production_Line_query').empty();
                $('#js_select_Production_Line_query').html('<option></option>');
                var opTypeUid = $('#js_select_optype_query').val();
                if (opTypeUid != "" && opTypeUid != undefined) {
                    var funcPlantUid = $('#js_select_funplant_query').val();
                    if (funcPlantUid == "" || funcPlantUid == undefined) {
                        funcPlantUid = 0;
                    }
                    url = FixtureRepair.urls.getProductionLineList;
                    $.post(url, { Plant_Organization_UID: $('#js_select_factory_query option:selected').val(), BG_Organization_UID: opTypeUid, FunPlant_Organization_UID: funcPlantUid }, function (data) {
                        for (var i = 0; i < data.length; i++) {
                            $('#js_select_Production_Line_query').append('<option value="' + data[i].Production_Line_UID + '">' + data[i].Line_Name + '</option>');
                        }
                    });
                }
                $('#js_select_Production_Line_query').selectpicker('refresh');
            }

            //刷新制程(查询)
            function refreshProcessQuery() {
                $('#js_select_Process_Info_UID_query').empty();
                $('#js_select_Process_Info_UID_query').html('<option></option>');
                //设置制程
                var opTypeUid = $('#js_select_optype_query option:selected').val();
                if (opTypeUid != "" && opTypeUid != undefined) {
                    var funcPlantUid = $('#js_select_funplant_query').val();
                    if (funcPlantUid == "" || funcPlantUid == undefined) {
                        funcPlantUid = 0;
                    }
                    url = FixtureRepair.urls.getProcess_InfoList;
                    $.post(url, { Plant_Organization_UID: $('#js_select_factory_query option:selected').val(), BG_Organization_UID: opTypeUid, FunPlant_Organization_UID: funcPlantUid }, function (data) {
                        for (var i = 0; i < data.length; i++) {
                            $('#js_select_Process_Info_UID_query').append('<option value="' + data[i].Process_Info_UID + '">' + data[i].Process_Name + '</option>');
                        }
                    });
                }
                $('#js_select_Process_Info_UID_query').selectpicker('refresh');
            }

            //刷新工站(查询)
            function refreshWorkStationQuery() {
                $('#js_select_Workstation_UID_query').empty();
                $('#js_select_Workstation_UID_query').html('<option></option>');
                //设置工站
                var optypeUid = $('#js_select_optype_query').val();
                if (optypeUid != "" && optypeUid != undefined) {
                    var funcPlantUid = $('#js_select_funplant_query').val();
                    if (funcPlantUid == "" || funcPlantUid == undefined) {
                        funcPlantUid = 0;
                    }
                    url = FixtureRepair.urls.getWorkstationList;
                    $.post(url, { Plant_Organization_UID: $('#js_select_factory_query option:selected').val(), BG_Organization_UID: optypeUid, FunPlant_Organization_UID: funcPlantUid }, function (data) {
                        for (var i = 0; i < data.length; i++) {

                            $('#js_select_Workstation_UID_query').append('<option value="' + data[i].WorkStation_UID + '">' + data[i].WorkStation_Name + '</option>');
                        }
                    });
                }
                $('#js_select_Workstation_UID_query').selectpicker('refresh');
            }

            //刷新车间(查询)
            function refreshWorkshopQuery() {
                //设置车间
                $('#js_select_Workshop_UID_query').empty();
                $('#js_select_Workshop_UID_query').html('<option></option>');
                var optypeUid = $('#js_select_optype_query').val();
                if (optypeUid != "" && optypeUid != undefined) {
                    var funcPlantUid = $('#js_select_funplant_query').val();
                    if (funcPlantUid == "" || funcPlantUid == undefined) {
                        funcPlantUid = 0;
                    }
                    url = FixtureRepair.urls.getWorkshopList;
                    $.post(url, { Plant_Organization_UID: $('#js_select_factory_query option:selected').val(), BG_Organization_UID: optypeUid, FunPlant_Organization_UID: funcPlantUid }, function (data) {
                        for (var i = 0; i < data.length; i++) {
                            $('#js_select_Workshop_UID_query').append('<option value="' + data[i].Workshop_UID + '">' + data[i].Workshop_Name + '</option>');
                        }
                    });
                }
                $('#js_select_Workshop_UID_query').selectpicker('refresh');
            }

            //刷新维修地点(查询),查询页面每有这项
            //function refreshRepairLocationQuery() {
            //    $('#s_select_repair_location_query').empty();
            //    $('#s_select_repair_location_query').html('<option></option>');
            //    var optypeUid = $('#js_select_optype_query').val();
            //    if (optypeUid == "" || optypeUid == undefined) {
            //        optypeUid=0;
            //    }
            //    var funcPlantUid = $('#js_select_funplant_query').val();
            //    if (funcPlantUid == "" || funcPlantUid == undefined) {
            //        funcPlantUid = 0;
            //    }
            //    var url = FixtureRepair.urls.getRepairLoactionList;
            //    $.post(url, { Plant_Organization_UID: $('#js_select_factory_query').val(), BG_Organization_UID: optypeUid, FunPlant_Organization_UID: funcPlantUid }, function (data) {
            //        for (var i = 0; i < data.length; i++) {
            //            $('#s_select_repair_location_query').append('<option value="' + data[i].Repair_Location_UID + '">' + data[i].Repair_Location_Name + '</option>');
            //        }
            //        $('#s_select_repair_location_query').selectpicker('refresh');
            //    });
            //}

            //刷新机台(查询)
            function refreshMachineQuery() {
                $('#js_select_Fixture_Machine_UID_query').empty();
                $('#js_select_Fixture_Machine_UID_query').html('<option></option>');
                //设置机台
                var optypeUid = $('#js_select_optype_query').val();
                if (optypeUid != "" && optypeUid != undefined) {
                    var funcPlantUid = $('#js_select_funplant_query').val();
                    if (funcPlantUid == "" || funcPlantUid == undefined) {
                        funcPlantUid = 0;
                    }
                    var lineUid = $("#js_select_Production_Line_query").val();
                    if (lineUid == "" || funcPlantUid == undefined) {
                        lineUid = 0;
                    }
                    url = FixtureRepair.urls.getFixtureMachineDTOList;
                    $.post(url, { Plant_Organization_UID: $('#js_select_factory_query option:selected').val(), BG_Organization_UID: optypeUid, FunPlant_Organization_UID: funcPlantUid, Production_Line_UID: lineUid }, function (data) {
                        for (var i = 0; i < data.length; i++) {
                            $('#js_select_Fixture_Machine_UID_query').append('<option value="' + data[i].Fixture_Machine_UID + '">' + data[i].Equipment_No + '</option>');
                        }
                    });
                }
                $('#js_select_Fixture_Machine_UID_query').selectpicker('refresh');
            }

            //刷新厂商列表(查询)
            function refreshVendorQuery() {
                $('#js_select_Vendor_query').empty();
                $('#js_select_Vendor_query').html('<option></option>');
                //设置厂商
                var optypeUid = $('#js_select_optype_query').val();
                if (optypeUid != "" && optypeUid != undefined) {
                    url = FixtureRepair.urls.getVendorInfoList;
                    var oporgid = $('#js_select_factory_query option:selected').val();
                    $.post(url, { Plant_Organization_UID: $('#js_select_factory_query option:selected').val(), BG_Organization_UID: optypeUid }, function (data) {
                        for (var i = 0; i < data.length; i++) {
                            $('#js_select_Vendor_query').append('<option value="' + data[i].Vendor_Info_UID + '">' + data[i].Vendor_Name + '</option>');
                        }
                    });
                }
                $('#js_select_Vendor_query').selectpicker('refresh');
            }


            function refreshFixtureStatusQuery() {
                $("#js_select_Fixture_Status_query").empty();
                $("#js_select_Fixture_Status_query").html("<option></option>");
                var url = FixtureRepair.urls.getFixtureStatusUrl;
                $.get(url, function (data) {
                    for (var i = 0; i < data.length; i++) {
                        $('#js_select_Fixture_Status_query').append('<option value="' + data[i].Status + '">' + data[i].StatuName + '</option>');
                    }
                })
            }

            function Setsearchbtn() {

                $('#js_search_modal').find('input[name=Fixture_NO]').val("");
                $('#js_search_modal').find('input[name=Version]').val("");
                $('#js_search_modal').find('input[name=Fixture_Name]').val("");
                $('#js_search_modal').find('input[name=ShortCode]').val("");
                $('#js_search_modal').find('input[name=Created_Date]').val("");
                $('#js_search_modal').find('input[name=Modified_UID]').val("");
                $('#js_search_modal').find('input[name=End_Date_From]').val("");
                $('#js_search_modal').find('input[name=End_Date_To]').val("");
            }

            //查看
            $('body').on('click', '.js-grid-view', function () {
                var $sender = $(this);
                var repairNo = $sender.attr('data-id');
                var repairDUID = $sender.attr('data-repairDUID');
                var url = FixtureRepair.urls.queryFixtureRepairUrl;
                $.get(url, { repairNo: repairNo }, function (data) {

                    //js_select_factory_view
                    $('#js_view_modal').find('input[name=Plant_Organization_Name]').val(data.Plant_Organization_Name);
                    $('#js_view_modal').find('input[name=BG_Organization_Name]').val(data.BG_Organization_Name);
                    $('#js_view_modal').find('input[name=FunPlant_Organization_Name]').val(data.FunPlant_Organization_Name);
                    $('#js_view_modal').find('input[name=Repair_Location_Name]').val(data.Repair_Location_Name);

                    $('#js_view_modal').find('input[name=SentOut_Number]').val(data.SentOut_Number);
                    $('#js_view_modal').find('input[name=SentOut_Name]').val(data.SentOut_Name);
                    $('#js_view_modal').find('input[name=Receiver_NTID]').val(data.Receiver_NTID);
                    $('#js_view_modal').find('input[name=Receiver_Name]').val(data.Receiver_Name);

                    if (data.SentOut_Date != null && data.SentOut_Date != undefined) {
                        $('#js_view_modal').find('input[name=SentOut_Date]').val(data.SentOut_Date.replace("T", " "));
                    }
                    $('#js_view_modal').find('input[name=Repair_NO]').val(data.Repair_NO);
                    //这里获取全部FixtureRepairD,效率不高，待优化
                    $.each(data.Fixture_Repair_DDTOList, function (i, value) {
                        var fixtureRepairD = value;//data.Fixture_Repair_DDTOList.row[i];
                        if (fixtureRepairD.Fixture_Repair_D_UID == repairDUID) {
                            $('#js_view_modal').find('input[name=Fixture_Unique_ID]').val(fixtureRepairD.Fixture_Unique_ID);
                            $('#js_view_modal').find('input[name=Fixture_Name]').val(fixtureRepairD.Fixture_Name);

                            $('#js_view_modal').find('input[name=Repair_Staff_NTID]').val(fixtureRepairD.Repair_Staff_NTID);
                            $('#js_view_modal').find('input[name=Repair_Staff_Name]').val(fixtureRepairD.Repair_Staff_Name);
                            $('#js_view_modal').find('input[name=StatusName]').val(fixtureRepairD.StatusName);

                            if (fixtureRepairD.Completion_Date != null && fixtureRepairD.Completion_Date != undefined) {
                                $('#js_view_modal').find('input[name=Completion_Date]').val(fixtureRepairD.Completion_Date.replace("T", " "));
                            }


                            //绑定治具维修原因及策略
                            $('#js_view_sub_repair_table').DataTable({
                                ordering: false,
                                columns: [{
                                    render: function (data, type, full, meta) {
                                        return ++meta.row;
                                    },
                                    className: "text-center",
                                }, {
                                    data: "Defect_Code_Name",
                                    render: function (data, type, full, meta) {

                                        return data;
                                    },
                                    className: "text-center",
                                }, {
                                    data: "Solution_Name",
                                    render: function (data, type, full, meta) {

                                        return data;
                                    },
                                    className: "text-center",
                                }],
                                data: fixtureRepairD.Fixture_Repair_D_DefectDTOList,
                                destroy: true
                            });
                        }
                    });

                });



                $('#js_view_modal').modal('show', $(this));
                $('#isEdit').val(true);
                // var fixture_M_UID = $(this).attr('data-id'),
                //  url = FixtureRepair.urls.queryFixtureByID;
                // $.post(url, { fixture_UID: fixture_M_UID }, function (data) {
                //$('#js_view_modal').find('input[name=Fixture_NO]').val(data.Fixture_NO);
                //$('#js_view_modal').find('input[name=Version]').val(data.Version);
                //$('#js_view_modal').find('input[name=Vendor]').val(data.Vendor_Name);
                //$('#js_view_modal').find('input[name=Production_Line]').val(data.Line_Name);
                //$('#js_view_modal').find('input[name=Project_UID]').val(data.Project);
                //$('#js_view_modal').find('input[name=Process_Info]').val(data.Process_Info);
                //$('#js_view_modal').find('input[name=Workstation_UID]').val(data.Workstation);
                //$('#js_view_modal').find('input[name=Workshop_UID]').val(data.Workshop);
                //$('#js_view_modal').find('input[name=Fixture_Machine_UID]').val(data.Equipment_No);
                //$('#js_view_modal').find('input[name=Fixture_Machine_Type]').val(data.Machine_Type);
                //$('#js_view_modal').find('input[name=Fixture_Name]').val(data.Fixture_Name);
                //$('#js_view_modal').find('input[name=Fixture_ShortCode]').val(data.ShortCode);
                //$('#js_view_modal').find('input[name=Fixture_2D_Barcode]').val(data.TwoD_Barcode);
                //$('#js_view_modal').find('input[name=Fixture_Seq]').val(data.Fixture_Seq);
                //$('#js_view_modal').find('input[name=Fixture_Unique_ID]').val(data.Fixture_Unique_ID);
                //$('#js_view_modal').find('input[name=Created_Date]').val(data.Created_Date);
                //$('#js_view_modal').find('input[name=Fixture_Status]').val(data.StatuName);

                //  });
            });

            //治具维修编辑
            $('body').on('click', '.js-grid-edit', function () {
                DEFAULTREPAIRSTAFFUID = '';
                DEFAULTREPAIRSTAFFNTID = '';
                DEFAULTREPAIRSTAFFNAME = '';
                //FixtureRepair.GetFunctionDatatable().clear().draw();
                var $sender = $(this);

                var repairNo = $sender.attr('data-id');

                var url = FixtureRepair.urls.queryFixtureRepairUrl;
                $.get(url, { repairNo: repairNo }, function (data) {


                    $("#js_select_factory_create").selectpicker('val', data.Plant_Organization_UID);
                    $("#js_select_factory_create").attr("disabled", "disabled");
                    refreshOPTypesAdd();

                    //OP类型,编辑时禁用
                    $("#js_select_optype_create").selectpicker('val', data.BG_Organization_UID);
                    $("#js_select_optype_create").attr("disabled", "disabled");
                    refreshFunPlantAdd();

                    //功能厂,编辑时禁用
                    $("#js_select_funplant_create").selectpicker('val', data.FunPlant_Organization_UID);
                    $("#js_select_funplant_create").attr("disabled", "disabled");
                    refreshRepairLocationAdd();

                    //刷新治具下拉列表
                    refreshFixtureSelect();

                    //维修地点,编辑时禁用
                    $('#s_select_repair_location_create').selectpicker('val', data.Repair_Location_UID);
                    $("#s_select_repair_location_create").attr("disabled", "disabled");

                    //Fixture_M
                    //$('#js_input_SentOut_Number_create').attr("data-useruid", data.SentOut_UID);
                    $("#js_input_SentOut_Number_create").val(data.SentOut_Number);
                    $("#js_input_SentOut_Name_create").val(data.SentOut_Name);
                    $('#js_select_Receiver_UID_create').attr("data-useruid", data.Receiver_UID);
                    $('#js_select_Receiver_UID_create').val(data.Receiver_NTID);
                    $("#js_input_Receiver_Name_create").val(data.Receiver_Name);
                    if (data.SentOut_Date != null && data.SentOut_Date != "" && data.SentOut_Date != undefined) {
                        data.SentOut_Date = data.SentOut_Date.replace("T", " ");
                        $("#js_s_input_sentout_date").val(data.SentOut_Date);
                    }
                    $("#s_input_repair_NO_create").val(data.Repair_NO);

                    //编辑时获取维修状态
                    var funcPlantUid = data.FunPlant_Organization_UID;
                    if (funcPlantUid == "" || funcPlantUid == undefined) {
                        funcPlantUid = 0;
                    }
                    $.get(FixtureRepair.urls.getFixtureStatusUrl, { Plant_Organization_UID: data.Plant_Organization_UID, BG_Organization_UID: data.BG_Organization_UID, FunPlant_Organization_UID: funcPlantUid }, function (data) {
                        repairStatusListEditData = data;
                    });

                    //编辑时获取维修原因列表
                    //要改
                    DEFECTCODELISTDATA = TAFFY();
                    refreshDefectCodeRepairSolutionData(data.Plant_Organization_UID, data.BG_Organization_UID, funcPlantUid);
                    //$.get(FixtureRepair.urls.GetDefectCodeList, { Plant_Organization_UID: data.Plant_Organization_UID, BG_Organization_UID: data.BG_Organization_UID, FunPlant_Organization_UID: funcPlantUid }, function (data) {
                    //    DEFECTCODELISTDATA = data;
                    //});

                    //编辑时获取对策列表
                    //$.get(FixtureRepair.urls.GetRepairSolutionList, { Plant_Organization_UID: data.Plant_Organization_UID, BG_Organization_UID: data.BG_Organization_UID, FunPlant_Organization_UID: funcPlantUid }, function (data) {
                    //    repairSolutionListData = data;
                    //});

                    //绑定数据:治具资料表
                    $('#js_edit_repair_datatable').DataTable({
                        ordering: false,
                        columns: FixtureRepair.EditColumns.funcEdit,
                        data: data.Fixture_Repair_DDTOList,
                        destroy: true
                    });

                    //渲染datetimepicker 效果
                    var complationDateTime = $("#js_edit_repair_datatable input[name=Completion_Date]");
                    complationDateTime.datetimepicker({ format: 'yyyy-mm-dd h:i', step: 1, hours12: false, minuteStep: 1, minDate: 0, todayHighlight: true, autoclose: true, language: 'zh-CN' });

                    //存到TAFFY 数据
                    DEFECTCODE_REPAIRSOLUTION_DATA = TAFFY();
                    $.each(data.Fixture_Repair_DDTOList, function (i, fixtureRepairDDTO) {
                        var index = i + 1;
                        DEFECTCODE_REPAIRSOLUTION_DATA.insert({ index: index, Fixture_Repair_D_UID: fixtureRepairDDTO.Fixture_Repair_D_UID, Repair_Staff_UID: fixtureRepairDDTO.Repair_Staff_UID, Fixture_M_UID: fixtureRepairDDTO.Fixture_M_UID,ShortCode:fixtureRepairDDTO.ShortCode, Workshop_Name:fixtureRepairDDTO.Workshop_Name, Line_Name:fixtureRepairDDTO.Line_Name, Status: fixtureRepairDDTO.Status, Completion_Date: fixtureRepairDDTO.Completion_Date });

                        var selectedDefectRepair = DEFECTCODE_REPAIRSOLUTION_DATA({ index: index }).first();
                        if (selectedDefectRepair.defectRepairSolutions == undefined) {
                            selectedDefectRepair.defectRepairSolutions = TAFFY();
                        }
                        $.each(data.Fixture_Repair_DDTOList[i].Fixture_Repair_D_DefectDTOList, function (j, subItem) {

                            var subIndex = j + 1;
                            selectedDefectRepair.defectRepairSolutions.insert({ subIndex: subIndex, Fixture_Repair_D_Defect_UID: subItem.Fixture_Repair_D_Defect_UID, Defect_Code_UID: subItem.Defect_Code_UID, Defect_Code_Name: subItem.Defect_Code_Name, Solution_UID: subItem.Solution_UID, Solution_Name: subItem.Solution_Name });

                        })
                    });

                });



                //$.post(url, { uuid: uuid }, function (data) {

                //    $('#Organization_UID_hidden').val(uuid);

                //    $('#js_input_Organization_ID').val(data.Organization_ID);
                //    $('#js_input_Organization_Name').val(data.Organization_Name);
                //    $('#js_input_Organization_Desc').val(data.Organization_Desc);

                //    $('#js_input_OrgManager_Name').val(data.OrgManager_Name);
                //    $('#js_input_OrgManager_Tel').val(data.OrgManager_Tel);
                //    $('#js_input_OrgManager_Email').val(data.OrgManager_Email);

                //    $('#js_input_Cost_Center').val(data.Cost_Center);
                //    $('#js_input_begin_date').val(data.Begin_Date);
                //    $('#js_input_end_date').val(data.End_Date).attr("disabled", data.End_Date !== null);

                //});

                //清空子表,不然上一次编辑的数据会留在页面
                FixtureRepair.GetSubDatatable().clear().draw();
                DEFAULTREPAIRSTAFFNAME = "";
                $('#js_edit_modal').modal('show', $(this));

                //选中第1条

                //第0行是表头
                var firstTr = $('#js_edit_repair_datatable tr[role=row]:eq(1)');
                if (firstTr != undefined) {
                    firstTr.trigger('click');
                }
            });

            //$('.js-grid-edit').click(function () {
            //
            //    var $sender = $(this);

            //    var uuid = $sender.attr('data-id'),
            //        url = OrganizationMaintenance.urls.queryOrg;

            //    $.post(url, { uuid: uuid }, function (data) {

            //        $('#Organization_UID_hidden').val(uuid);

            //        $('#js_input_Organization_ID').val(data.Organization_ID);
            //        $('#js_input_Organization_Name').val(data.Organization_Name);
            //        $('#js_input_Organization_Desc').val(data.Organization_Desc);

            //        $('#js_input_OrgManager_Name').val(data.OrgManager_Name);
            //        $('#js_input_OrgManager_Tel').val(data.OrgManager_Tel);
            //        $('#js_input_OrgManager_Email').val(data.OrgManager_Email);

            //        $('#js_input_Cost_Center').val(data.Cost_Center);
            //        $('#js_input_begin_date').val(data.Begin_Date);
            //        $('#js_input_end_date').val(data.End_Date).attr("disabled", data.End_Date !== null);

            //    });

            //    $('#js_edit_modal').modal('show', $(this));
            //});


            //查询界面厂区是OP类型变化
            $('#js_select_factory_create').change(function () {
                var selectedFactoryText=$("#js_select_factory_create").find("option:selected").text();
                //成都厂由于加载全部数据导致速度很慢，改为用扫码得到的治具唯一码Fixture_Unique_ID去模糊查询治具，这里判断厂区是CTU即为成都厂
                if (selectedFactoryText.toLowerCase().indexOf('ctu') <0 ) {
                    $(".fixture-query-notctu").show();
                    $("#js_select_fixture_scan-div").hide();
                }else {
                    $(".fixture-query-notctu").hide();
                    $("#js_select_fixture_scan-div").show();
                }

                //Seteditadd();
                refreshOPTypesAdd();
                refreshFunPlantAdd();
                refreshRepairLocationAdd();
                refreshDefectCodeListAdd();
                refreshFixtureSelect();
                //refreshRepairSolutionListAdd();
            });
            $('#js_select_optype_create').change(function () {
                refreshFunPlantAdd();
                refreshRepairLocationAdd();
                refreshDefectCodeListAdd();
                refreshFixtureSelect();
                //refreshRepairSolutionListAdd();
            });

            $('#js_select_funplant_create').change(function () {
                refreshRepairLocationAdd();
                refreshDefectCodeListAdd();
                refreshFixtureSelect();
                //refreshRepairSolutionListAdd();
            });

            //刷新OP类型(新增)
            function refreshOPTypesAdd() {
                $('#js_select_optype_create').empty();
                $('#js_select_optype_create').html('<option></option>');
                var url = FixtureRepair.urls.getCurrentOPType;
                $.post(url, { plant_OrganizationUID: $('#js_select_factory_create option:selected').val() }, function (data) {
                    for (var i = 0; i < data.length; i++) {
                        $('#js_select_optype_create').append('<option value="' + data[i].Organization_UID + '">' + data[i].OP_TYPES + '</option>');
                    }
                });
                $('#js_select_optype_create').selectpicker('refresh');
            }

            //刷新功能厂(新增)
            function refreshFunPlantAdd() {
                $('#js_select_funplant_create').empty();
                $('#js_select_funplant_create').html('<option></option>');
                var url = FixtureRepair.urls.getFunPlantByOPTypes;
                $.post(url, { Optype: $('#js_select_optype_create option:selected').val() }, function (data) {
                    for (var i = 0; i < data.length; i++) {
                        $('#js_select_funplant_create').append('<option value="' + data[i].FunPlant_OrganizationUID + '">' + data[i].FunPlant + '</option>');
                    }
                });
                $('#js_select_funplant_create').selectpicker('refresh');
            }

            //刷新维修地点(新增)
            function refreshRepairLocationAdd() {
                $('#s_select_repair_location_create').empty();
                var url = FixtureRepair.urls.getRepairLoactionList;
                var opTypeUid = $('#js_select_optype_create').val();
                if (opTypeUid != "" && opTypeUid != undefined) {
                    var funcPlantUid = $('#js_select_funplant_create').val();
                    if (funcPlantUid == "" || funcPlantUid == undefined) {
                        funcPlantUid = 0;
                    }
                    $.post(url, { Plant_Organization_UID: $('#js_select_factory_create').val(), BG_Organization_UID: opTypeUid, FunPlant_Organization_UID: funcPlantUid }, function (data) {
                        $('#s_select_repair_location_create').append('<option></option>');
                        for (var i = 0; i < data.length; i++) {
                            $('#s_select_repair_location_create').append('<option value="' + data[i].Repair_Location_UID + '">' + data[i].Repair_Location_Name + '</option>');
                        }
                    });
                }
                $('#s_select_repair_location_create').selectpicker('refresh');
            }

            //刷新维修状态(新增)
            function refreshFixtureStatusWhenAdd() {
                $.get(FixtureRepair.urls.getFixtureStatusWhenAddUrl, function (data) {
                    repairStatusListAddData = data;
                });
            }

            //刷新异常原因和维修对策data(新增)
            function refreshDefectCodeRepairSolutionDataAdd() {
                url = FixtureRepair.urls.getDefectCodeRepairSolutionList;
                var opTypeUid = $('#js_select_optype_create').val();
                DEFECTCODELISTDATA = TAFFY();
                if (opTypeUid != "" && opTypeUid != undefined) {
                    var funcPlantUid = $('#js_select_funplant_create').val();
                    if (funcPlantUid == "" || funcPlantUid == undefined) {
                        funcPlantUid = 0;
                    }
                    refreshDefectCodeRepairSolutionData($('#js_select_factory_create').val(), opTypeUid, funcPlantUid);
                }
            }

            //刷新异常原因和维修对策data
            function refreshDefectCodeRepairSolutionData(Plant_Organization_UID, BG_Organization_UID, FunPlant_Organization_UID) {
                DEFECTCODELISTDATA = new TAFFY();
                url = FixtureRepair.urls.getDefectCodeRepairSolutionList;
                $.get(url, { Plant_Organization_UID: Plant_Organization_UID, BG_Organization_UID: BG_Organization_UID, FunPlant_Organization_UID: FunPlant_Organization_UID }, function (data) {

                    //遍历，建立树状结构
                    $(data).each(function (i, element) {
                        var defectUIDStr = String(element.Fixtrue_Defect_UID);
                        var defectCode = DEFECTCODELISTDATA({ Fixture_Defect_UID: defectUIDStr }).first();
                        if (defectCode == false) {
                            DEFECTCODELISTDATA.insert({ Fixture_Defect_UID: defectUIDStr, Fixture_DefectName: element.Fixture_DefectName, repairSolutionList: new TAFFY() });
                            defectCode = DEFECTCODELISTDATA({ Fixture_Defect_UID: defectUIDStr }).first();
                        }
                        defectCode.repairSolutionList.insert({ Repair_Solution_UID: element.Repair_Solution_UID, Repair_SoulutionName: element.Repair_SoulutionName });
                    });
                });
            }

            //刷新维修原因列表(新增)
            function refreshDefectCodeListAdd() {
                refreshDefectCodeRepairSolutionDataAdd();
                if (DEFECTCODELISTDATA != undefined && DEFECTCODELISTDATA != null) {
                    //刷新所有维修原因和对策
                    $("select.defect-code-list").each(function (i, element) {
                        $(element).empty();
                        $(element).append('<option></option>');
                        DEFECTCODELISTDATA().each(function (item) {
                            $(element).append('<option value="' + item.Fixture_Defect_UID + '">' + item.Fixture_DefectName + '</option>');
                        });
                        $(element).trigger("change");
                    });
                }
            }

            //刷新解决策略列表(新增)
            //function refreshRepairSolutionListAdd() {
            //    url = FixtureRepair.urls.GetRepairSolutionList;
            //    var opTypeUid = $('#js_select_optype_create').val();
            //    if (opTypeUid != "" && opTypeUid != undefined) {
            //        var funcPlantUid = $('#js_select_funplant_create').val();
            //        if (funcPlantUid == "" || funcPlantUid == undefined) {
            //            funcPlantUid = 0;
            //        }

            //        $.get(url, { Plant_Organization_UID: $('#js_select_factory_create').val(), BG_Organization_UID: opTypeUid, FunPlant_Organization_UID: funcPlantUid }, function (data) {
            //            repairSolutionListData = data;
            //            $("select.repair-solution-list").each(function (i, element) {
            //                $(element).empty();
            //                for (var i = 0; i < data.length; i++) {
            //                    $(element).append('<option value="' + data[i].Fixture_RepairSolution_UID + '">' + data[i].RepairSolution_Name + '</option>');
            //                }
            //                $(element).trigger("change");
            //                //以下代码导致下拉框可能向上展开，部分选项被遮挡
            //                //$(element).selectpicker('refresh');
            //            });
            //        });
            //    } else {
            //        repairSolutionListData = null;
            //    }
            //}


            //初始化治具资料
            function initFixtureInfo() {
                //新增治具的序号
                LAST_INDEX_FIXTURE_ADD = 0;
                DEFAULTREPAIRSTAFFNTID = '';
                DEFAULTREPAIRSTAFFUID = 0;
                DEFAULTREPAIRSTAFFNAME = '';

                //清空列表
                FixtureRepair.GetFunctionDatatable().clear().draw();
            }

            //初始化维修原因及解决策略
            function initDefectRepairSolution() {
                //新增维修原因及解决方案的序号
                LAST_INDEX_SUB_ADD = 0;
                //清空列表
                FixtureRepair.GetSubDatatable().clear().draw();
                //获取维修原因及解决策略列表

            }

            //刷新治具列表
            function refreshFixtureSelect() {
                debugger;
                var selectedFactoryText=$("#js_select_factory_create").find("option:selected").text();
                //成都厂由于加载全部数据导致速度很慢，改为用扫码得到的治具唯一码Fixture_Unique_ID去模糊查询治具，这里判断厂区是CTU即为成都厂
                if (selectedFactoryText.toLowerCase().indexOf('ctu') <0 ) {
                    var plant_Organization_UID = $('#js_select_factory_create').val();
                    var BG_Organization_UID = $('#js_select_optype_create').val()
                    var funPlant_Organization_UID = $('#js_select_funplant_create').val();
                    var Line_ID = $('#js_input_Line_ID').val();
                    var Line_Name = $('#js_input_Line_Name').val();
                    var Machine_ID = $('#js_input_Machine_ID').val();
                    var Machine_Name = $('#js_input_Machine_Name').val();
                    var Process_ID = $('#js_input_Process_ID').val();
                    var Process_Name = $('#js_input_Process_Name').val();

                    if (BG_Organization_UID == "") {
                        BG_Organization_UID = 0;
                    }

                    if (funPlant_Organization_UID == "") {
                        funPlant_Organization_UID = 0;
                    }
                    var url = FixtureRepair.urls.getFixtureListFixtureRepairUrl;
                    $('#js_select_fixture').html('<option></option>');
                    if (BG_Organization_UID != 0) {
                        $.post(url, { Plant_Organization_UID: $('#js_select_factory_query option:selected').val(), BG_Organization_UID: BG_Organization_UID, FunPlant_Organization_UID: funPlant_Organization_UID,Line_ID:Line_ID, Line_Name: Line_Name,Machine_ID:Machine_ID, Machine_Name: Machine_Name,Process_ID:Process_ID,Process_Name:Process_Name }, function (data) {
                            for (var i = 0; i < data.length; i++) {
                                $('#js_select_fixture').append('<option value="' + data[i].Fixture_M_UID + '" data-shortCode="'+(data[i].ShortCode!=null? data[i].ShortCode:'')  +'" data-lineName="'+(data[i].Line_Name!=null?data[i].Line_Name:'') +'" data-workshopName="'+(data[i].Workshop!=null?data[i].Workshop:'')+'" data-fixtureName="'+data[i].Fixture_Name+'" data-uniqueID="'+data[i].Fixture_Unique_ID+'">' + data[i].ShortCode + "_" + data[i].Fixture_Unique_ID + '</option>');
                            }
                        });
                    }
                    $('#js_select_fixture').selectpicker('refresh');
                }
            }

            
            //扫描唯一编码
            //$('#js_select_fixture_scan').change(function () {
            //    debugger;
            //    var uniqueID = $(this).val();
            //    GetFixtureByUniqueID(uniqueID);
            //});
            //change触发
            $('#js_select_fixture_scan').change(function () {
                var uniqueID = $(this).val();
                if (uniqueID != '') {
                    GetFixtureByUniqueID(uniqueID);
                }
            });

            function GetFixtureByUniqueID(uniqueID) {
                if (uniqueID != '') {
                    var plant_Organization_UID = $('#js_select_factory_create').val();
                    var BG_Organization_UID = $('#js_select_optype_create').val()
                    var funPlant_Organization_UID = $('#js_select_funplant_create').val();

                    if (BG_Organization_UID == "") {
                        BG_Organization_UID = 0;
                        PDMS.Utility.MessageBox.info("请选择[OP类型]");
                    }

                    if (funPlant_Organization_UID == "") {
                        funPlant_Organization_UID = 0;
                    }
                    var url = FixtureRepair.urls.getFixtureListFixtureRepairByUniqueIDUrl;
                    if (BG_Organization_UID != 0) {
                        $.post(url, { Plant_Organization_UID: $('#js_select_factory_query option:selected').val(), BG_Organization_UID: BG_Organization_UID, FunPlant_Organization_UID: funPlant_Organization_UID,UniqueID:uniqueID }, function (data) {
                            if (data.length == 1) {
                                $('#js_select_fixture').html('<option selected="selected" value="' + data[0].Fixture_M_UID + '" data-shortCode="'+(data[0].ShortCode!=null? data[0].ShortCode:'')  +'" data-lineName="'+(data[0].Line_Name!=null?data[0].Line_Name:'') +'" data-workshopName="'+(data[0].Workshop!=null?data[0].Workshop:'')+'" data-fixtureName="'+data[0].Fixture_Name+'" data-uniqueID="'+data[0].Fixture_Unique_ID+'">' + data[0].ShortCode + "_" + data[0].Fixture_Unique_ID + '</option>');
                                $('#js_select_fixture').selectpicker('refresh');
                                //触发click事件，将扫码得到的治具填入table
                                $("#js_btn_add_repair_func").click();
                                setTimeout(function () {
                                    $("#js_select_fixture_scan").val("");
                                },1000);
                            }
                            else{
                                $('#js_select_fixture').html('<option></option>');
                                for (var i = 0; i < data.length; i++) {
                                    $('#js_select_fixture').append('<option value="' + data[i].Fixture_M_UID + '" data-shortCode="'+(data[i].ShortCode!=null? data[i].ShortCode:'')  +'" data-lineName="'+(data[i].Line_Name!=null?data[i].Line_Name:'') +'" data-workshopName="'+(data[i].Workshop!=null?data[i].Workshop:'')+'" data-fixtureName="'+data[i].Fixture_Name+'" data-uniqueID="'+data[i].Fixture_Unique_ID+'">' + data[i].ShortCode + "_" + data[i].Fixture_Unique_ID + '</option>');
                                }
                                $('#js_select_fixture').selectpicker('refresh');
                            }
                            //$('#js_select_fixture').selectpicker('val', '');
                        });
                    }
                }
            }

            $('#js_input_Line_ID,#js_input_Line_Name,#js_input_Machine_ID,#js_input_Machine_Name,#js_input_Process_ID,#js_input_Process_Name').change(function () {
                refreshFixtureSelect();
            });

            //编辑保存
            $("#js_btn_saveEdit").click(function () {
                //验证,被禁用的可以不验证
                var plant_Organization_UID = $('#js_select_factory_create').val();
                var BG_Organization_UID = $('#js_select_optype_create').val()
                var funPlant_Organization_UID = $('#js_select_funplant_create').val();
                if (funPlant_Organization_UID == "") {
                    funPlant_Organization_UID = 0;
                }

                var isValid = true;
                var errorMessage = "";

                var opTypeSelect = $("#js_select_optype_create").val();
                if (opTypeSelect == "") {
                    errorMessage += "请选择[OP类型];  ";
                    isValid = false;
                }

                var repairLocation = $("#s_select_repair_location_create").val();
                if (repairLocation == "" || repairLocation == null) {
                    errorMessage += "请选择[维修地点];  ";
                    isValid = false;
                }

                var SentOut_Number = $('#js_input_SentOut_Number_create').val();
                if (SentOut_Number == "" || SentOut_Number == undefined || SentOut_Number == 0) {
                    errorMessage += "请填写[送修者工号];  ";
                    isValid = false;
                }
                var SentOut_Name = $('#js_input_SentOut_Name_create').val();
                if (SentOut_Name == "" || SentOut_Name == undefined || SentOut_Name == 0) {
                    errorMessage += "请填写[送修者名称];  ";
                    isValid = false;
                }

                var Receiver_UID = $('#js_select_Receiver_UID_create').attr("data-useruid");
                if (Receiver_UID == "" || Receiver_UID == undefined || Receiver_UID == 0) {
                    errorMessage += "请填写[接收者];  ";
                    isValid = false;
                }

                var SentOut_Date = $('#js_s_input_sentout_date').val();
                if (SentOut_Date == "") {
                    errorMessage += "请选择[送修日期时间];  ";
                    isValid = false;
                } else {
                    SentOut_Date = SentOut_Date.replace("T", " ");
                }

                if (DEFECTCODE_REPAIRSOLUTION_DATA().count() < 1) {
                    errorMessage += "请添加[治具资料];  "
                    isValid = false;
                }
                if ($('#js_edit_sub_repair_table').find('tr:eq(1)').find('td').length < 2) {
                    errorMessage += "请添加[维修原因及解决策略];  ";
                    isValid = false;
                }

                if (!isValid) {
                    if (errorMessage != "") {
                        PDMS.Utility.MessageBox.info(errorMessage);
                    }
                    return false;
                }


                //改为在taffydb 里验证
                var fixtureRepairDArr = [];
                var isValid = true;
                DEFECTCODE_REPAIRSOLUTION_DATA().each(function (item) {

                    if (item.Repair_Staff_UID == "" || item.Repair_Staff_UID == undefined || item.Repair_Staff_UID == 0) {
                        errorMessage += '请完成治具资料第 #' + item.index + "行[维修人员NTID];  ";
                        isValid = false;
                    }
                    if (item.Fixture_M_UID == "" || item.Fixture_M_UID == undefined || item.Fixture_M_UID == 0) {
                        errorMessage += '请完成治具资料第 #' + item.index + "行[治具编码];  ";
                        isValid = false;
                    }
                    if (item.Status == "" || item.Status == undefined || item.Status == 0) {
                        errorMessage += '请选择治具资料第 #' + item.index + "行[维修状态];  ";
                        isValid = false;
                    }
                    //更新状态为使用中、未使用时，必须填入维修完成时间
                    var selectedStatus = repairStatusListEditData.find((n)=>n.Status==item.Status);
                    if (selectedStatus.StatuName == '使用中In-PRD' || selectedStatus.StatuName == '未使用Non-PRD') {
                        if (item.Completion_Date == null || item.Completion_Date == undefined) {
                            errorMessage += '请完成治具资料第 #' + item.index + "行[维修完成日期];  ";
                            isValid = false;
                        }
                    }
                    if (item.Completion_Date != null && item.Completion_Date != undefined) {
                        if (Date.parse(SentOut_Date) >= Date.parse(item.Completion_Date)) {
                            errorMessage += '治具资料第 #' + item.index + "行[维修完成日期] 不能小于或等于[送修日期时间];  ";
                            isValid = false;
                        }
                    }

                    //判重
                    $.each(fixtureRepairDArr, function (i, fixtureItem) {
                        if (fixtureItem.Fixture_M_UID == item.Fixture_M_UID) {
                            errorMessage += '治具资料第 #' + item.index + '行[治具短码:' + fixtureItem.ShortCode + ']重复;  ';
                            isValid = false;
                        }
                    });
                    if (!isValid) {
                        if (errorMessage != "") {
                            PDMS.Utility.MessageBox.info(errorMessage);
                        }
                        return false;
                    }

                    if (item.defectRepairSolutions != undefined) {
                        var subItemArr = [];
                        item.defectRepairSolutions().each(function (subItem) {
                            if (subItem.Defect_Code_UID == "" || subItem.Defect_Code_UID == undefined || subItem.Defect_Code_UID == 0) {
                                errorMessage += '维修原因及解决策略第 #' + subItem.subIndex + '行,请选择[维修原因];  ';
                                isValid = false;
                            }
                            if (subItem.Solution_UID == "" || subItem.Solution_UID == undefined || subItem.Solution_UID == 0) {
                                errorMessage += '维修原因及解决策略第 #' + subItem.subIndex + '行,请选择[解决策略];  ';
                                isValid = false;
                            }
                            //维修原因及解决策略判重
                            $.each(subItemArr, function (i, arrItem) {
                                if (arrItem.Defect_Code_UID == subItem.Defect_Code_UID && arrItem.Solution_UID == subItem.Solution_UID) {
                                    errorMessage += '维修原因及解决策略第 #' + subItem.subIndex + '行[维修原因:' + subItem.Defect_Code_Name + "],[解决策略:" + subItem.Solution_Name + "]重复;  ";
                                    isValid = false;
                                }
                            });
                            if (isValid) {
                                subItemArr.push(subItem);
                            }
                        });
                        item.Fixture_Repair_D_DefectDTOList = subItemArr;
                    }
                    fixtureRepairDArr.push(item);
                });
                //验证不通过
                if (!isValid) {
                    if (errorMessage != "") {
                        PDMS.Utility.MessageBox.info(errorMessage);
                    }
                    return false;
                }
                var Repair_NO = $("#s_input_repair_NO_create").val();
                var Fixture_Repair_M_Object = {
                    Plant_Organization_UID: plant_Organization_UID,
                    BG_Organization_UID: BG_Organization_UID,
                    FunPlant_Organization_UID: funPlant_Organization_UID,
                    Repair_Location_UID: repairLocation,
                    SentOut_Number: SentOut_Number,
                    SentOut_Name: SentOut_Name,
                    Receiver_UID: Receiver_UID,
                    SentOut_Date: SentOut_Date,
                    Repair_NO: Repair_NO,
                    Fixture_Repair_DDTOList: fixtureRepairDArr
                };
                //var Fixture_Repair_M_Json = JSON.stringify(Fixture_Repair_M_Object);
                //提交数据
                var url = FixtureRepair.urls.editFixtureRepairUrl;//, fixtureRepairDList: fixtureRepairDArr
                $.post(url, { fixtureRepairM: Fixture_Repair_M_Object }, function (data) {

                    //需要改成正则表达式验证
                    if (data.indexOf("维修单号") != -1) {
                        PDMS.Utility.MessageBox.info(data, function () {
                            $('#js_edit_modal').modal('hide');
                            window.location.reload();
                        });
                    } else {
                        PDMS.Utility.MessageBox.info(data);
                    }
                });
            });

            //新增保存
            $('#js_btn_create').click(function () {
                //验证

                var plant_Organization_UID = $('#js_select_factory_create').val();
                var BG_Organization_UID = $('#js_select_optype_create').val()
                var funPlant_Organization_UID = $('#js_select_funplant_create').val();
                if (funPlant_Organization_UID == "") {
                    funPlant_Organization_UID = 0;
                }

                var isValid = true;
                var errorMessage = "";

                var opTypeSelect = $("#js_select_optype_create").val();
                if (opTypeSelect == "") {
                    errorMessage += "请选择[OP类型];  ";
                    isValid = false;
                }

                var repairLocation = $("#s_select_repair_location_create").val();
                if (repairLocation == "" || repairLocation == null) {
                    errorMessage += "请选择[维修地点];  ";
                    isValid = false;
                }

                var SentOut_Number = $('#js_input_SentOut_Number_create').val();
                if (SentOut_Number == "" || SentOut_Number == undefined || SentOut_Number == 0) {
                    errorMessage += "请填写[送修者工号];  ";
                    isValid = false;
                }
                var SentOut_Name = $('#js_input_SentOut_Name_create').val();
                if (SentOut_Name == "" || SentOut_Name == undefined || SentOut_Name == 0) {
                    errorMessage += "请填写[送修者名称];  ";
                    isValid = false;
                }

                var Receiver_UID = $('#js_select_Receiver_UID_create').attr("data-useruid");
                if (Receiver_UID == "" || Receiver_UID == undefined || Receiver_UID == 0) {
                    errorMessage += "请填写[接收者];  ";
                    isValid = false;
                }

                var SentOut_Date = $('#js_s_input_sentout_date').val();
                if (SentOut_Date == "") {
                    errorMessage += "请选择[送修日期时间];  ";
                    isValid = false;
                } else {
                    SentOut_Date = SentOut_Date.replace("T", " ");
                }

                if (DEFECTCODE_REPAIRSOLUTION_DATA().count() < 1) {
                    errorMessage += "请添加[治具资料];  "
                    isValid = false;
                }
                if ($('#js_edit_sub_repair_table').find('tr:eq(1)').find('td').length < 2) {
                    errorMessage += "请添加[维修原因及解决策略];  ";
                    isValid = false;
                }

                if (!isValid) {
                    if (errorMessage != "") {
                        PDMS.Utility.MessageBox.info(errorMessage);
                    }
                    return false;
                }

                //改为在taffydb 里验证
                var fixtureRepairDArr = [];
                DEFECTCODE_REPAIRSOLUTION_DATA().each(function (item) {
                    if (item.Repair_Staff_UID == "" || item.Repair_Staff_UID == undefined  || item.Repair_Staff_UID == 0) {
                        errorMessage += '请完成治具资料第 #' + item.index + "行[维修人员NTID];  ";
                        isValid = false;
                    }
                    if (item.Fixture_M_UID == "" || item.Fixture_M_UID == undefined || item.Fixture_M_UID == 0) {
                        errorMessage += '请完成治具资料第 #' + item.index + "行[治具编码];  ";
                        isValid = false;
                    }
                    if (item.Status == "" || item.Status == undefined || item.Status == 0) {
                        errorMessage += '请选择治具资料第 #' + item.index + "行[维修状态];  ";
                        isValid = false;
                    }

                    if (item.Completion_Date != null && item.Completion_Date != undefined) {
                        if (Date.parse(SentOut_Date) >= Date.parse(item.Completion_Date)) {
                            errorMessage += '治具资料第 #' + item.index + "行[维修完成日期] 不能小于或等于[送修日期时间];  ";
                            isValid = false;
                        }
                    }

                    //判重
                    $.each(fixtureRepairDArr, function (i, fixtureItem) {
                        if (fixtureItem.Fixture_M_UID == item.Fixture_M_UID) {
                            errorMessage += '治具资料第 #' + item.index + '行[治具短码:' + fixtureItem.ShortCode + ']重复;  ';
                            isValid = false;
                        }
                    });


                    if (!isValid) {
                        if (errorMessage != "") {
                            PDMS.Utility.MessageBox.info(errorMessage);
                        }
                        return false;
                    }

                    if (item.defectRepairSolutions != undefined) {
                        var subItemArr = [];
                        item.defectRepairSolutions().each(function (subItem) {
                            if (subItem.Defect_Code_UID == "" || subItem.Defect_Code_UID == undefined || subItem.Defect_Code_UID == 0) {
                                errorMessage += '维修原因及解决策略第 #' + subItem.subIndex + '行,请选择[维修原因];  ';
                                isValid = false;
                            }
                            if (subItem.Solution_UID == "" || subItem.Solution_UID == undefined || subItem.Solution_UID == 0) {
                                errorMessage += '维修原因及解决策略第 #' + subItem.subIndex + '行,请选择[解决策略];  ';
                                isValid = false;
                            }
                            //维修原因及解决策略判重
                            $.each(subItemArr, function (i, arrItem) {
                                if (arrItem.Defect_Code_UID == subItem.Defect_Code_UID && arrItem.Solution_UID == subItem.Solution_UID) {
                                    errorMessage += '维修原因及解决策略第 #' + subItem.subIndex + '行[维修原因:' + subItem.Defect_Code_Name + "],[解决策略:" + subItem.Solution_Name + "]重复;  ";
                                    isValid = false;
                                }
                            });

                            if (isValid) {
                                subItemArr.push(subItem);
                            }
                        });

                        item.Fixture_Repair_D_DefectDTOList = subItemArr;
                    }
                    fixtureRepairDArr.push(item);
                });
                //验证不通过
                if (!isValid) {
                    if (errorMessage != "") {
                        PDMS.Utility.MessageBox.info(errorMessage);
                    }
                    return false;
                }

                var Fixture_Repair_M_Object = {
                    Plant_Organization_UID: plant_Organization_UID,
                    BG_Organization_UID: BG_Organization_UID,
                    FunPlant_Organization_UID: funPlant_Organization_UID,
                    Repair_Location_UID: repairLocation,
                    SentOut_Number: SentOut_Number,
                    SentOut_Name: SentOut_Name,
                    Receiver_UID: Receiver_UID,
                    SentOut_Date: SentOut_Date,
                    Fixture_Repair_DDTOList: fixtureRepairDArr
                };
                //var Fixture_Repair_M_Json = JSON.stringify(Fixture_Repair_M_Object);
                //提交数据
                var url = FixtureRepair.urls.addFixtureRepairUrl;//, fixtureRepairDList: fixtureRepairDArr
                $.post(url, { fixtureRepairM: Fixture_Repair_M_Object }, function (data) {

                    //需要改成正则表达式验证
                    if (data.indexOf("维修单号") != -1) {
                        PDMS.Utility.MessageBox.info(data, function () {
                            $('#js_edit_modal').modal('hide');
                            window.location.reload();
                        });
                    } else {
                        PDMS.Utility.MessageBox.info(data);
                    }

                    //StorageReportSetting.GetFixtureDataTable().clear().draw();
                    //StorageReportSetting.SetEditData(null);
                    //$('#js_edit_modal').modal('hide');
                    //StorageReportSetting.queryStorageReports(true);
                    //PDMS.Utility.MessageBox.info(data);
                    //$('#js_AbnormalReason_table').data('selected-index', 0);
                });
            });

        });
        //根据NTID查询用户信息
        function refreshRpairStaffNameAdd(sender) {
            var NTID = $(sender).val();
            var repairStaffInfo = $(sender).parent().next().find("[name='Repair_Staff_Name']")[0];//children("label[name='Repair_Staff_UID']");
            var url = '@Url.Action("GetSystemUserByNTId", "Fixture")';
            $.get(url, { NTID: NTID }, function (data) {
                var accountUId = "";
                var userName = "";
                if (data != null && data != "") {
                    userName = data.User_Name;
                    accountUId = data.Account_UID;
                    $(repairStaffInfo).val(userName);
                    $(sender).attr("data-UserUid", accountUId);


                    //全局变量用于保存上次输入的数据
                    DEFAULTREPAIRSTAFFNTID = NTID;
                    DEFAULTREPAIRSTAFFUID = accountUId;
                    DEFAULTREPAIRSTAFFNAME = userName;
                }
                else {
                    $(repairStaffInfo).val('');
                    $(sender).attr("data-UserUid", '');
                }
                //更新维修人员
                var tr = $(sender).closest('tr');
                var td = $(tr).find("td")[1];
                var index = parseInt(td.textContent);
                DEFECTCODE_REPAIRSOLUTION_DATA({ index: index }).update({ Repair_Staff_UID: accountUId, Repair_Staff_Name: userName });
            });
        }

        //根据NTID获取用户名称
        function refreshStaffNameByNTID(element, refreshElemnt) {
            var NTID = element.val();
            $.get('@Url.Action("GetSystemUserByNTId", "Fixture")', { NTID: NTID }, function (data) {
                if (data != null && data != "") {
                    var userName = data.User_Name;
                    var accountUId = data.Account_UID;
                    refreshElemnt.val(userName);
                    element.attr("data-UserUid", accountUId);
                }
                else {
                    refreshElemnt.html('');
                    element.attr("data-UserUid", 0);
                }
            });
        }

        function GetSentRepairNameById(element, refreshElemnt) {
            var SentOut_Number = element.val();
            $.get('@Url.Action("GetSentRepairNameById", "Fixture")', { SentOut_Number: SentOut_Number }, function (data) {
                if (data != null && data != "") {
                    refreshElemnt.val(data);
                }
                else {
                    refreshElemnt.html('');
                    element.attr("data-UserUid", 0);
                }
            });
        }

        //刷新送修者名称
        function refreshSentOutStaffNameByNTID(element) {
            GetSentRepairNameById($(element), $("#js_input_SentOut_Name_create"));
        }
        //刷新接收者名称
        function refreshReceiverStaffNameByNTID(element) {
            refreshStaffNameByNTID($(element), $("#js_input_Receiver_Name_create"));
        }


        function repairStatusChang(sender) {
            var status = $(sender).val();
            //更新状态
            var tr = $(sender).closest('tr');
            var td = $(tr).find("td")[1];
            var index = parseInt(td.textContent);
            DEFECTCODE_REPAIRSOLUTION_DATA({ index: index }).update({ Status: status });
        }

        function complationDateChange(sender) {
            var date = $(sender).val();
            //更新完成日期
            var tr = $(sender).closest('tr');
            var td = $(tr).find("td")[1];
            var index = parseInt(td.textContent);
            DEFECTCODE_REPAIRSOLUTION_DATA({ index: index }).update({ Completion_Date: date });
        }

        //设置默认日期时间
        //function setDefaultDateTime(sender) {
        //
        //    var d = new Date();
        //    var year = d.getFullYear();
        //    var month = d.getMonth();
        //    if (month < 10) {
        //        month = '0' + month;
        //    }
        //    var date = d.getDate();
        //    if (date < 10) {
        //        date = '0' + date;
        //    }
        //    var hours = d.getHours();
        //    if (hours < 10) {
        //        hours = '0' + hours;
        //    }
        //    var minutes = d.getMinutes();
        //    if (minutes < 10) {
        //        minutes = '0' + minutes;
        //    }
        //    var dateTime = year + '-' + month + '-' + date + 'T' + hours + ':' + minutes;
        //    $(sender).val(dateTime);
        //}

        function defectCodeListChange(sender) {

            //更新DEFECTCODE_REPAIRSOLUTION_DATA
            var selectedDefectCodeUID = $(sender).val();
            var selectedDefectCodeName = $(sender).find("option:selected").text();
            var tr = $(sender).parents("tr")[0]
            var td = $(tr).find("td")[1];
            var subIndex = parseInt(td.textContent);
            var index = getSelectedFixtureIndex();
            var selectedDefectRepair = DEFECTCODE_REPAIRSOLUTION_DATA({ index: index }).first();
            var defectRepairSolutions = selectedDefectRepair.defectRepairSolutions;
            //defectRepairSolutions({ subIndex: subIndex }).update({ Defect_Code_UID: selectedDefectCodeUID });
            //DEFECTCODE_REPAIRSOLUTION_DATA({ index: index }).update({ defectRepairSolutions: defectRepairSolutions });
            //(selectedDefectRepair.repairDefects)({ index: subIndex }).first().Defect_Code_UID = selectedDefectCodeUID;
            //defectRepairSolutions.insert({ subIndex: LAST_INDEX_SUB_ADD, Defect_Code_UID: defectCodeUid, Solution_UID: solutionUid });
            DEFECTCODE_REPAIRSOLUTION_DATA({ index: index }).first().defectRepairSolutions({ subIndex: subIndex }).update({ Defect_Code_UID: selectedDefectCodeUID, Defect_Code_Name: selectedDefectCodeName });


            var repairSolutionSelect = $(tr).find("[name='Solution_UID']")[0];
            $(repairSolutionSelect).empty();
            $(repairSolutionSelect).append('<option></option>');
            if (selectedDefectCodeUID != "") {
                var defectCode = DEFECTCODELISTDATA({ Fixture_Defect_UID: selectedDefectCodeUID }).first();
                if (defectCode != false) {
                    defectCode.repairSolutionList().each(function (item) {
                        $(repairSolutionSelect).append('<option value="' + item.Repair_Solution_UID + '">' + item.Repair_SoulutionName + '</option>');
                    });
                }
            }
            $(repairSolutionSelect).trigger("change");
        }

        function repairSolutionListChange(sender) {

            //更新DEFECTCODE_REPAIRSOLUTION_DATA
            var selectedSolutionUID = $(sender).val();
            var selectedSolutionName = $(sender).find("option:selected").text();
            var tr = $(sender).parents("tr")[0]
            var td = $(tr).find("td")[1];
            var subIndex = parseInt(td.textContent);
            var index = getSelectedFixtureIndex();
            var selectedDefectRepair = DEFECTCODE_REPAIRSOLUTION_DATA({ index: index }).first();
            var defectRepairSolutions = selectedDefectRepair.defectRepairSolutions;
            //defectRepairSolutions({ subIndex: subIndex }).update({ Solution_UID: selectedSolutionUID });
            //DEFECTCODE_REPAIRSOLUTION_DATA({ index: index }).update({ defectRepairSolutions: defectRepairSolutions, Solution_Name: selectedSolutionName });
            DEFECTCODE_REPAIRSOLUTION_DATA({ index: index }).first().defectRepairSolutions({ subIndex: subIndex }).update({ Solution_UID: selectedSolutionUID, Solution_Name: selectedSolutionName });
        }

        //获取当前选中的治具维修的index
        function getSelectedFixtureIndex() {
            var selectedRow = $('#js_edit_repair_datatable tr.selected');
            if (selectedRow.length == 0) {
                return -1;
            } else {
                var indexTd = selectedRow.find("td")[1];
                var indexStr = indexTd.textContent;
                if (indexStr != "") {
                    return parseInt(indexStr);
                } else {
                    return -1;
                }
            }
        }

        $('#js_btn_clear').click(function () {

            $('#js_select_factory_query').selectpicker('val', '');
            $("#js_select_factory_query").trigger("liszt:updated");

            $('#js_select_optype_query').selectpicker('val', '');
            $("#js_select_optype_query").trigger("liszt:updated");

            $('#js_select_funplant_query').selectpicker('val', '');
            $("#js_select_funplant_query").trigger("liszt:updated");

            $('#js_select_Process_Info_UID_query').selectpicker('val', '');
            $("#js_select_Process_Info_UID_query").trigger("liszt:updated");

            $('#js_select_Workstation_UID_query').selectpicker('val', '');
            $("#js_select_Workstation_UID_query").trigger("liszt:updated");

            $('#js_select_Production_Line_query').selectpicker('val', '');
            $("#js_select_Production_Line_query").trigger("liszt:updated");

            $('#js_select_Fixture_Machine_UID_query').selectpicker('val', '');
            $("#js_select_Fixture_Machine_UID_query").trigger("liszt:updated");

            $('#js_select_Workshop_UID_query').selectpicker('val', '');
            $("#js_select_Workshop_UID_query").trigger("liszt:updated");

            $('#js_select_Vendor_query').selectpicker('val', '');
            $("#js_select_Vendor_query").trigger("liszt:updated");

            $('#js_select_Fixture_Status_query').selectpicker('val', '');
            $("#js_select_Fixture_Status_query").trigger("liszt:updated");
            PDMS.Utility.Criteria.Clear();
        });
    </script>
}