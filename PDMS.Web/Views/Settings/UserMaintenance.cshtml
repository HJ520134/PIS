<!-- Main content -->
<section class="content portal-content">

    <!--次標題 與 搜尋-->
    <div class="row">
        <!--次標題與Search keyword-->
        <div class="col-md-12 col-lg-9">
            <h4 class="margin-td-5" id="js_search_keywords"></h4>
        </div>
        <!-- /col-次標題與Search keyword -->
        <!--col-右方搜尋與功能按鈕列-->
        <div class="col-md-12 search-field col-lg-3">
            <a class="btn btn-primary btn-sm" data-toggle="modal" data-target="#js_search_modal"><i class="fa fa-search"></i> 查询</a>
            <a class="btn btn-primary btn-sm" role="button" data-toggle="modal" data-target="#js_edit_modal" id="js_btn_add_user">
                <i class="fa fa-plus"></i> 新增
            </a>
            @*<a id="js_btn_export" class="btn btn-primary btn-sm" role="button">
                    <i class="glyphicon glyphicon-save"></i> 导出
                </a>*@
        </div><!-- /col-右方搜尋與功能按鈕列-->
    </div><!--/次標題 與 搜尋-->
    <hr class="hr-custom">

    <!--row Search Keyword collapse-->
    <div class="row">
        <div class="col-xs-12" id="js_criteria_alert_cnt">
        </div>
    </div> <!--/row Search Keyword collapse-->
    <!--內容 表格列-->
    <div class="row">
        <!--表格-->
        <div class="col-md-12 table-container">
            <table class="table table-striped table-hover table-condensed nowrap" id="js_user_datatable">
                <thead>
                    <tr>
                        <th class="table-col-checkbox nosort">
                            <input type="checkbox" class="js-checkbox-all" />
                        </th>
                        <th class="table-col-action nosort">操作</th>
                        <th class="table-col-seq nosort">序号</th>
                        <th>用户UID</th>
                        <th>用户NTID</th>
                        <th>用户名称</th>
                        <th>是否可用</th>
                        <th>用户Email</th>
                        <th>用户Tel</th>
                        <th>用户组织</th>
                        <th>用户专案</th>
                        <th>修改者</th>
                        <th>修改时间</th>
                        <th>用户角色</th>
                    </tr>
                </thead>
                <tfoot>
                    <tr>
                        <th class="table-col-checkbox nosort"></th>
                        <th class="table-col-action nosort">操作</th>
                        <th class="table-col-seq nosort">序号</th>
                        <th>用户UID</th>
                        <th>用户NTID</th>
                        <th>用户名称</th>
                        <th>是否可用</th>
                        <th>用户Email</th>
                        <th>用户Tel</th>
                        <th>用户组织</th>
                        <th>用户专案</th>
                        <th>修改者</th>
                        <th>修改时间</th>
                        <th>用户角色</th>
                    </tr>
                </tfoot>
            </table>
            <div id="page" class="row"></div>

        </div><!--/表格-->
    </div><!-- / 內容 表格列 -->

</section><!-- /.content -->

@section ViewModals{
    <!-- Modal -->
    <div class="modal fade" id="js_search_modal" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title">查询</h4>
                </div>
                <div class="modal-body">
                    <form id="js_form_query" class="form-horizontal" data-need-validate="true">
                        <div class="row">
                            @*<div class="col-md-6">
                                    <div class="form-group">
                                        <label class="col-sm-4 control-label" for="js_s_input_user_account_id">用户Uid</label>
                                        <div class="col-sm-8">
                                            <input type="text" name="Account_UID" class="form-control input-sm" id="js_s_input_user_account_id" placeholder="用户Uid"
                                                   data-rule-digits="true" data-msg-digits="用户Uid必须为数字">
                                        </div>
                                    </div>
                                </div>*@
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="col-sm-4 control-label" for="js_s_input_user_ntid">用户NTID</label>
                                    <div class="col-sm-8">
                                        <input type="text" name="User_NTID" class="form-control input-sm" id="js_s_input_user_ntid" placeholder="用户NTID">
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="col-sm-4 control-label" for="js_s_input_user_name">用户名称</label>
                                    <div class="col-sm-8">
                                        <input type="text" name="User_Name" class="form-control input-sm" id="js_s_input_user_name" placeholder="用户名称">
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="col-sm-4 control-label" for="js_s_input_user_email">用户Email</label>
                                    <div class="col-sm-8">

                                        <input type="hidden" name="CurrentUID" id="js_s_input_CurrentUID" value="0">
                                        <input type="text" name="Email" class="form-control input-sm" id="js_s_input_user_email" placeholder="用户Email">
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="col-sm-4 control-label" for="js_s_input_user_tel">用户Tel</label>
                                    <div class="col-sm-8">
                                        <input type="text" name="Tel" class="form-control input-sm" id="js_s_input_user_tel" placeholder="用户Tel">
                                    </div>
                                </div>
                            </div>
                            @*<div class="col-md-6">
                                    <div class="form-group">
                                        <label class="col-sm-4 control-label" data-type="select" for="js_s_select_enable_flag">是否可用</label>
                                        <div class="col-sm-8">
                                            <select class="form-control input-sm" id="js_s_select_enable_flag" name="Enable_Flag">
                                                <option value=""></option>
                                                <option value="true">Y</option>
                                                <option value="false">N</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>*@
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="col-sm-4 control-label no-padding-l" for="js_s_input_modified_by">修改者</label>
                                    <div class="col-sm-8">
                                        <input type="text" name="Modified_By" class="form-control input-sm" id="js_s_input_modified_by" placeholder="修改者(NTID)">
                                    </div>
                                </div>
                            </div>
                            @*<div class="col-md-6">
                                    <div class="form-group">
                                        <label class="col-sm-4 control-label" data-type="date-interval">修改日期</label>
                                        <div class="col-sm-8">
                                            <div class="input-group">
                                                <span class="input-group-addon"><i class="fa fa-calendar"></i></span>
                                                <span class="input-group-addon">From</span>
                                                <input type="text" name="Modified_Date_From" class="form-control input-sm date" id="js_s_input_modified_from">
                                                <span class="input-group-addon">To</span>
                                                <input type="text" name="Modified_Date_End" class="form-control input-sm date" id="js_s_input_modified_to">
                                            </div>
                                        </div>
                                    </div>
                                </div>*@
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary btn-sm" id="js_btn_clear"><i class="fa fa-eraser"></i> 清空条件</button>
                    <button type="button" class="btn btn-primary btn-sm" id="js_btn_query"><i class="fa fa-search"></i> 查询</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="js_edit_modal" role="dialog">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h3 class="modal-title">用户信息维护</h3>
                </div>
                @using (Html.BeginForm("EditProfile", "Settings", FormMethod.Post, new { id = "js_form_user_edit" }))
                {
                    <div class="modal-body form-horizontal">

                        <div class="row">
                            <div class="col-md-12 panel panel-default">
                                <div class="panel-heading">
                                    <h3 class="panel-title">
                                        添加基本信息
                                    </h3>
                                </div>
                                <div class="panel-body">
                                    <div class="col-md-6 col-lg-6">
                                        <div class="form-group">
                                            <label class="col-sm-5 control-label" for="js_input_user_ntid">用户NTID</label>
                                            <div class="col-sm-7">
                                                <input type="text" class="form-control input-sm valid" id="js_input_user_ntid" name="User_NTID" placeholder="用户NTID" required="" data-msg-required="请输入用户的NTID" data-rule-maxlength="20" data-msg-maxlength="请至少输入{0}字." aria-required="true" aria-invalid="false">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6 col-lg-6">
                                        <div class="form-group">
                                            <label class="col-sm-5 control-label" for="js_input_user_name">用户名称</label>
                                            <div class="col-sm-7">
                                                <input type="text" class="form-control input-sm" id="js_input_user_name" name="User_Name" placeholder="用户名称"
                                                       required data-msg-required="请输入用户名称"
                                                       data-rule-maxlength="50" data-msg-maxlength="请至少输入{0}字.">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6 col-lg-6">
                                        <div class="form-group">
                                            <label class="col-sm-5 control-label" for="js_input_user_email">Email</label>
                                            <div class="col-sm-7">
                                                <input type="text" class="form-control input-sm" id="js_input_user_email" name="Email" placeholder="Email"
                                                       required data-msg-required="请输入用户Email"
                                                       data-rule-maxlength="50" data-msg-maxlength="请至少输入{0}字."
                                                       data-rule-email="true">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6 col-lg-6">
                                        <div class="form-group">
                                            <label class="col-sm-5 control-label" for="js_input_user_tel">Tel</label>
                                            <div class="col-sm-7">
                                                <input type="text" class="form-control input-sm" id="js_input_user_tel" name="Tel" placeholder="Tel"
                                                       required data-msg-required="请输入用户Tel"
                                                       data-rule-maxlength="20" data-msg-maxlength="请至少输入{0}字.">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6 col-lg-6">
                                        <div class="form-group">
                                            <label class="col-sm-5 control-label" for="js_input_user_EmployeeNumber">用户工号</label>
                                            <div class="col-sm-7">
                                                <input type="number" class="form-control input-sm" id="js_input_user_EmployeeNumber" name="EmployeeNumber" placeholder="用户工号">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6 col-lg-6">
                                        <div class="form-group">
                                            <label class="col-sm-5 control-label" for="js_input_user_password">密码</label>
                                            <div class="col-sm-7">
                                                <input type="text" class="form-control input-sm" id="js_input_user_password" name="EmployeePassword" placeholder="密码">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6 col-lg-6">
                                        <div class="form-group">
                                            <label class="col-sm-5 control-label" for="js_e_select_enable_flag">是否启用</label>
                                            <div class="col-sm-7">
                                                <select class="form-control input-sm" id="js_e_select_enable_flag" name="Enable_Flag">
                                                    <option value="true">启用</option>
                                                    <option value="false">禁用</option>

                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6 col-lg-6">
                                        <div class="form-group">
                                            <label class="col-sm-5 control-label" for="js_e_select_EnableEmpIdLogin">是否使用工号登录</label>
                                            <div class="col-sm-7">
                                                <select class="form-control input-sm" id="js_e_select_EnableEmpIdLogin" name="EnableEmpIdLogin">
                                                    <option value="1">启用</option>
                                                    <option value="0">禁用</option>

                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6 col-lg-6">
                                        <div class="form-group">
                                            <label class="col-sm-5 control-label" for="js_input_building">Building</label>
                                            <div class="col-sm-7">
                                                <input type="text" class="form-control input-sm" id="js_input_building" name="Building" placeholder="楼栋">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6 col-lg-6">
                                        <div class="form-group">
                                            <label class="col-sm-5 control-label" for="js_e_select_Language">语种</label>
                                            <div class="col-sm-7">
                                                <select class="form-control input-sm" id="js_e_select_Language" name="System_Language_UID">
                                                    <option value="2">中文</option>
                                                    <option value="1">英文</option>

                                                </select>
                                            </div>
                                        </div>
                                    </div>

                                </div>
                            </div>


                            <div class="col-md-12 panel panel-default">
                                <div class="panel-heading">
                                    <h3 class="panel-title">
                                        用户组织设定
                                    </h3>
                                </div>
                                <div class="panel-body">
                                    <div class="col-md-6 col-lg-6">
                                        <div class="form-group">
                                            <label class="col-sm-5 control-label" for="js_e_select_org_ctu">厂区</label>
                                            <div class="col-sm-7">
                                                <select class="form-control input-sm" id="js_e_select_org_ctu" name="Org_CTU"></select>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6 col-lg-6">
                                        <div class="form-group">
                                            <label class="col-sm-5 control-label" for="js_e_select_org_op">BG</label>
                                            <div class="col-sm-7">
                                                <select class="form-control input-sm" id="js_e_select_org_op" name="Org_OP"></select>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6 col-lg-6">
                                        <div class="form-group">
                                            <label class="col-sm-5 control-label" for="js_e_select_org_pp">部门</label>
                                            <div class="col-sm-7">
                                                <select class="form-control input-sm " id="js_e_select_org_pp" name="Org_PP"></select>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6 col-lg-6">
                                        <div class="form-group">
                                            <label class="col-sm-5 control-label" for="js_e_select_org_funcplant">功能厂</label>
                                            <div class="col-sm-7">
                                                <input type="text" style="display:none" id="Org_FuncPlant_Hidden" name="Org_FuncPlant_Hidden">
                                                <select class="form-control input-sm" id="js_e_select_org_funcplant" name="Org_FuncPlant"></select>
                                            </div>
                                        </div>
                                    </div>

                                    @*<div class="col-md-6 col-lg-6">
                                            <div class="form-group">
                                                <label class="col-sm-5 control-label" for="js_e_select_enable_flag">是否启用</label>
                                                <div class="col-sm-7">
                                                    <select class="form-control input-sm" id="js_e_select_enable_flag" name="Enable_Flag">
                                                        <option value="true">启用</option>
                                                        <option value="false">禁用</option>

                                                    </select>
                                                </div>
                                            </div>
                                        </div>*@
                                </div>
                            </div>
                            <div class="col-md-6 panel panel-default">
                                <div class="panel-heading">
                                    <h3 class="panel-title">
                                        用户角色设定
                                    </h3>
                                </div>
                                <div class="panel-body">
                                    <div class="col-md-12 col-lg-12">
                                        <div class="form-group">
                                            <label class="col-sm-2 control-label" for="js_e_select_role">角色</label>
                                            <div class="col-sm-10">
                                                <select multiple="multiple" size="6" class="form-control" required data-msg-required="请选择用户角色" id="js_e_select_role" name="Role"></select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 panel panel-default">
                                <div class="panel-heading">
                                    <h3 class="panel-title">
                                        用户专案设定
                                    </h3>
                                </div>
                                <div class="panel-body">
                                    <div class="col-md-12 col-lg-12">
                                        <div class="form-group">
                                            <label class="col-sm-2 control-label" for="js_e_select_project">专案</label>
                                            <div class="col-sm-8">
                                                <select multiple="multiple" size="6" class="form-control " id="js_e_select_project" name="Project"></select>
                                            </div>
                                            全选<input type="checkbox" value="1" id="pro_checkall" name="pro_checkall" class="col-sm-1" />
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <input type="hidden" id="js_hidden_is_edit" name="isEdit" value="false" />
                            <!--jquery validata error container-->
                            <div class="col-xs-12"><ul class="list-group validate-error"></ul></div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-primary btn-sm" data-dismiss="modal"><i class="fa fa-times"></i> 取消</button>
                        <button type="submit" class="btn btn-primary btn-sm" id="js_btn_save_new_user"><i class="fa fa-save"></i> 保存</button>
                        <button type="submit" class="btn btn-primary btn-sm" id="js_btn_save_edit_user"><i class="fa fa-save"></i> 保存修改</button>
                    </div>
                }
            </div>
        </div>
    </div>
}

@section ViewScripts{
    @*<script src="~/Scripts/bootstrap-select.min.js"></script>
        <link href="~/Content/css/bootstrap-select.min.css" rel="stylesheet" />*@
    <link rel="stylesheet" type="text/css" href="~/Content/css/bootstrap-select.css" />
    <script type="text/javascript" src="~/Scripts/EQP/bootstrap-select.js"></script>
    <script src="~/Scripts/plugins/jquery.select-multiple.js"></script>
    <link href="~/Content/css/select-multiple.css" rel="stylesheet" />
    <script type="text/javascript">

        $(function () {
            var proAndOrg = null;
            var UserMaintenanceUrls = {
                queryUsers: '@Url.Action("QueryUsers", "Settings")',
                queryUserByNTID: '@Url.Action("queryUserByNTID", "Settings")',
                queryUser: '@Url.Action("QueryUser", "Settings")',
                deleteUser: '@Url.Action("DeleteUser", "Settings")',
                exportUser: '@Url.Action("DoExportUser", "Settings")',
                checkUserByUId: '@Url.Action("SystemUserWithUIdNotExist", "Settings")',
                checkUserByNTId: '@Url.Action("SystemUserWithNTIdNotExist", "Settings")',
                getOrgAndPro: '@Url.Action("getOrgAndPro", "Settings")',
                getUserRole: '@Url.Action("getUserRole", "Setting")',
                getUserPlant: '@Url.Action("getUserPlant", "Settings")',
                forbidUser: '@Url.Action("ForbidUser", "Settings")',
            };
            //初始化给下拉框赋值
            initSelect();

            //#region UserMaintenance
            var UserMaintenance = (function () {

                var needBuildCriteria = false;

                var columns = [
                    {
                        createdCell: function (td, cellData, rowData, row, col) {
                            $(td).html('<input type="checkbox" name="cktrans" class="js-checkbox-item" value="' + rowData.Account_UID + '">')
                                .addClass('table-col-checkbox');
                        },
                        className: "text-center"
                    }, {
                        createdCell: function (td, cellData, rowData, row, col) {
                            var result = '<button class="btn btn-primary btn-xs" rel="action-popover">' +
                                '<i class="fa fa-reorder"></i>' +
                                '</button>' +
                                '<div class="hidden popover-content">' +
                                '<button type="button" class="btn btn-primary btn-xs js-grid-edit" data-id="' + rowData.Account_UID + '">Edit</button>' +
                                '<button type="button" class="btn btn-primary btn-xs js-grid-forbid" data-id="' + rowData.Account_UID + '">Forbid</button>' +
                                '{0}'+
                                '</div>';
                            if (@ViewBag.IsSuperAd == 1)
                            {
                                //因为很多外键关联，不能物理删除，先隐藏
                                result = result.replace('{0}',
                                '<button type="button" class="btn btn-primary btn-xs js-grid-delete" style="display:none;" data-id="' + rowData.Account_UID + '">Delete</button>' )
                            }
                            else{
                                result = result.replace('{0}',"");
                            }
                            $(td).html(result);
                        },
                        className: "text-center"
                    }, {
                        data: null,
                        className: "table-col-seq"
                    }, {
                        data: "Account_UID",
                        className: "min-col-xs"
                    }, {
                        data: "User_NTID",
                        className: "min-col-xs"
                    }, {
                        data: "User_Name",
                        className: "min-col-sm"
                    }, {
                        data: "Enable_Flag",
                        render: function (data, type, full, meta) {
                            return data ? "Y" : "N";
                        },
                        className: "min-col-sm"
                    }, {
                        data: "Email",
                        className: "min-col-md"
                    }, {
                        data: "Tel",
                        className: "min-col-md"
                    }, {
                        data: "Org_CTU",
                        className: "min-col-md"
                    }, {
                        data: "Project",
                        className: "min-col-md"
                    },
                     {
                        data: "Modified_UserName",
                        className: "text-center"
                    }, {
                        data: "Modified_Date",
                        className: "text-center"
                    },{
                        //data: "User_Role",
                        //className: "min-col-md"
                        data: null,
                        createdCell: function (td, cellData, rowData, row, col) {
                            $(td).html('<input type="text"  size="20" style="border:none"  value="' + rowData.User_Role + '">')
                                .addClass('table-col-checkbox');
                        },
                        className: "text-center"
                    }
                ];

                var _getParams = function () {

                    if (needBuildCriteria) {
                        return $('#js_form_query').serialize().replace(/\+/g, " ");
                    } else {
                        return null;
                    }
                };

                var _queryUsers = function (firstLoad) {

                    var config = {
                        pageId: "#page",
                        tableId: "#js_user_datatable",
                        remoteUrl: UserMaintenanceUrls.queryUsers,
                        searchParams: _getParams(),
                        tableOptions: {
                            columns: columns
                        }
                    };

                    if (!firstLoad) {
                        $('#page').page('destroy');
                    }

                    if (needBuildCriteria) {
                        PDMS.Utility.Criteria.Build();
                    }

                    PDMS.Utility.Pages.Set(config);
                };

                return {
                    Init: function () {
                        PDMS.Utility.Criteria.Init();
                        _queryUsers(true);

                    },

                    QueryUsers: function (isSearchBtn) {
                        needBuildCriteria = (isSearchBtn === true ? true : needBuildCriteria);
                        _queryUsers(false);
                    }
                }

            }
            )();
            //#endregion

            UserMaintenance.Init();

            //#region 获取组织架构及Project----------------------Sidney
            function initSelect() {
                var url = UserMaintenanceUrls.getOrgAndPro;
                $.post(url, function (data) {
                    if (data != null) {
                        proAndOrg = data;
                        var temp = "";
                        //添加空的选择框
                        //$("<option></option>")
                        //    .val("Nothing")
                        //    .text("")
                        //    .appendTo($("#js_e_select_project"));
                        //添加从数据库中查询的Project
                        //$.each(data.Project, function (i, item) {
                        //    if (temp !== item.Project)
                        //        $("<option></option>")
                        //            .val(item.Project)
                        //            .text(item.Project)
                        //            .appendTo($("#js_e_select_project"));
                        //    temp = item.Project;
                        //});

                        getplant();
                        getRole();


                    }
                });




            }

            //function getOrgCTU() {
            //    $("#js_e_select_org_ctu").empty();
            //    $("<option></option>").val("Nothing").text("").appendTo($("#js_e_select_org_ctu"));
            //    $("<option></option>").val("CTU").text("CTU").appendTo($("#js_e_select_org_ctu"));
            //}

            function getplant() {

                var url = UserMaintenanceUrls.getUserPlant;
                $.post(url, function (data) {
                    if (data != null) {
                        $("#js_e_select_org_ctu").empty();
                        //添加空的选择框
                        $("<option></option>")
                            .val("Nothing")
                            .text("")
                            .appendTo($("#js_e_select_org_ctu"));
                        //添加从数据库中查询的Project
                        $.each(data, function (i, item) {

                            $("<option></option>")
                                .val(item)
                                .text(item)
                                .appendTo($("#js_e_select_org_ctu"));

                        });


                    }

                });
            }

            function getOpTypes(temp) {
                $("#js_e_select_org_op").empty();
                if (temp != "WUXI_M") {
                    $("<option></option>").val("Nothing").text("").appendTo($("#js_e_select_org_op"));
                }
                //$("<option></option>").val("Nothing").text("").appendTo($("#js_e_select_org_op"));
                //添加从数据库中查询的Project
                $.each(proAndOrg.SystemOrg, function (i, item) {
                    if (item.Father_Org == temp)
                        $("<option></option>").val(item.Organization_UID).text(item.Child_Org).appendTo($("#js_e_select_org_op"));
                });
                $("#js_e_select_org_op").trigger('change');
            };

            function getPPorPE(optypes) {
                $("#js_e_select_org_pp").empty();
                $("<option></option>").val("Nothing").text("").appendTo($("#js_e_select_org_pp"));
                //添加从数据库中查询的Project
                var org = [];
                $.each(proAndOrg.SystemOrg, function (i, item) {
                    if (item.Father_Org_ID == optypes)
                        $("<option></option>")
                            .val(item.Organization_UID)
                            .text(item.Child_Org)
                           .appendTo($("#js_e_select_org_pp"));
                    org.push(item.Child_Org);

                });
                //$('#js_e_select_project').val(org);
            };

            function getFuncPlant(pp) {
                $("#js_e_select_org_funcplant").empty();
                $("<option></option>").val("Nothing").text("").appendTo($("#js_e_select_org_funcplant"));
                //添加节点
                $.each(proAndOrg.SystemOrg, function (i, item) {
                    if (item.Father_Org_ID == pp)
                        $("<option></option>")
                            .val(item.Organization_UID)
                            .text(item.Child_Org)
                            .appendTo($("#js_e_select_org_funcplant"));
                });
            };

            //function getMH(PP) {
            //    $("#js_e_select_org_mh").empty();
            //    $("<option></option>").val("Nothing").text("").appendTo($("#js_e_select_org_mh"));
            //    //添加从数据库中查询的Project
            //    $.each(proAndOrg.SystemOrg, function(i, item) {
            //        if (item.Father_Org === PP)
            //            $("<option></option>")
            //                .val(item.Child_Org)
            //                .text(item.Child_Org)
            //                .appendTo($("#js_e_select_org_mh"));
            //    });
            //};

            function getProject(palnt,optypes) {
                $("#js_e_select_project").empty();
                //添加从数据库中查询的Project
                if (optypes == "Nothing" || optypes == null || optypes==0) {
                    $.each(proAndOrg.Project, function (i, item) {
                        if (item.plant == palnt)
                            $("<option></option>")
                                .val(item.ProjectID)
                                .text(item.Project)
                                .appendTo($("#js_e_select_project"));
                    });
                }
                else {
                    $.each(proAndOrg.Project, function (i, item) {
                        if (item.OPTypes == optypes)
                            $("<option></option>")
                                .val(item.ProjectID)
                                .text(item.Project)
                                .appendTo($("#js_e_select_project"));
                    });
                }
                $('#js_e_select_project').selectMultiple("refresh");
            };

            function getRole() {
                $("#js_e_select_role").empty();
                $.each(proAndOrg.UserRole, function (i, item) {
                    $("<option></option>").val(item.UserRoleID).text(item.UserRoleName).appendTo($("#js_e_select_role"));
                });
            };

            $("#js_input_user_ntid").change(function ff() {
                var url = UserMaintenanceUrls.checkUserByNTId;
                var ntid = $("#js_input_user_ntid").val();
                $.post(url, { User_NTID: ntid }, function (data) {
                    if (data == false) {


                        $('#js_btn_save_new_user').hide();
                        $('#js_btn_save_edit_user').show();
                        $("#js_hidden_is_edit").val(true);

                        url = UserMaintenanceUrls.queryUserByNTID;

                        $.post(url, { NTID: ntid }, function (data) {

                            //$('#js_input_account_uid').val(uuid);
                            $('#js_input_user_ntid').val(data.User_NTID).data('original', data.User_NTID);
                            $('#js_input_user_name').val(data.User_Name);
                            $('#js_input_user_email').val(data.Email);
                            $('#js_input_user_tel').val(data.Tel);
                            $('#js_e_select_enable_flag').val(data.Enable_Flag ? "true" : "false");
                            $('#js_e_select_EnableEmpIdLogin').val(data.EnableEmpIdLogin);
                            $('#js_hidden_is_edit').val(true);
                            $('#js_input_user_EmployeeNumber').val(data.EmployeeNumber);
                            $('#js_input_user_password').val(data.EmployeePassword);
                            $('#js_input_building').val(data.Building);
                            $('#js_e_select_Language').val(data.System_Language_UID);
                            //getOrgCTU();
                            getOpTypes(data.Org_CTU);
                            getPPorPE(data.Org_OP_ID);
                            getProject(data.Org_CTU,data.Org_OP_ID);
                            getFuncPlant(data.Org_PP_ID);
                            getRole();
                            if (data.Role != null) {

                                $('#js_e_select_role').val(data.Role);
                                $('#js_e_select_role').selectMultiple();
                            }
                            if (data.Project != null) {
                                $('#js_e_select_project').val(data.Project);
                            }
                            $('#js_e_select_project').selectMultiple();
                            if (data.Org_CTU != null) {
                                //getOrgCTU();
                                $("#js_e_select_org_ctu").val(data.Org_CTU);
                                if (data.Org_OP != null) {
                                    //getOpTypes(data.Org_CTU);
                                    $("#js_e_select_org_op").val(data.Org_OP_ID);
                                    if (data.Org_PP != null) {
                                        //getPPorPE(data.Org_OP);
                                        //getProject(data.Org_OP);
                                        $("#js_e_select_org_pp").val(data.Org_PP_ID);

                                        if (data.Org_FuncPlant != null) {
                                            //getMH(data.Org_PP);
                                            $.each(data.Org_FuncPlant_ID, function () {
                                                $("#js_e_select_org_funcplant").val(this.toString());
                                            });
                                        } else {
                                            //getMH(data.Org_PP);
                                            $("#js_e_select_org_funcplant").val();
                                        }
                                    } else {
                                        //getPPorPE(data.Org_OP);
                                        //getProject(data.Org_OP);
                                        $("#js_e_select_org_pp").val();
                                        // $("#js_e_select_project").val();
                                    }
                                } else {
                                    //getOpTypes(data.Org_CTU);
                                    $("#js_e_select_org_op").val();
                                }
                            } else {
                                //getOrgCTU();
                                $("#js_e_select_org_ctu").val();
                            }
                        });

                        $('#js_edit_modal').modal('show');
                    }

                });
            });
            $("#js_e_select_org_ctu").change(function ff() {
                $("#js_e_select_org_op").empty();
                var temp1 = $("#js_e_select_org_ctu").val();
                var temp2 = $("#js_e_select_org_op").val();
                getOpTypes(temp1);
                getProject(temp1,temp2);
            });
            $("#js_e_select_org_op").change(function ff() {
                $("#js_e_select_org_pp").empty();
                $("#js_e_select_org_funcplant").empty();
                var temp1 = $("#js_e_select_org_ctu").val();
                var temp2 = $("#js_e_select_org_op").val();
                var tempText = $("#js_e_select_org_op").find("option:selected").text()
                getPPorPE(temp2);
                getProject(temp1,temp2);
            });
            $("#js_e_select_org_pp").change(function ff() {
                $("#js_e_select_org_funcplant").empty();
                var temp = $("#js_e_select_org_pp").val();
                getFuncPlant(temp);
            });
            //#endregion

            //#region Page elements events
            $('#js_btn_query').click(function () {

                if ($("#js_form_query").valid()) {

                    UserMaintenance.QueryUsers(true);
                    $('#js_search_modal').modal('hide');
                }
            });

            //全选
            $('#pro_checkall').click(function () {
                var selectNum = $.find('#pro_checkall:checked').length;
                if (selectNum == 1) {
                    $('#js_e_select_project').selectMultiple('select_all');
                } else {
                    $('#js_e_select_project').selectMultiple('deselect_all');
                }
            })

            $('#js_btn_export').click(function () {
                var $selectList = $('#js_user_datatable').find('.js-checkbox-item:checked');
                var len = $selectList.length;
                if (len == 0) {
                    PDMS.Utility.MessageBox.info('please select datas to export!');
                } else {
                    var uuids = $.map($selectList, function (row) {
                        return row.value;
                    });
                    var url = UserMaintenanceUrls.exportUser;
                    url += "?uuids=" + uuids.toString();
                    window.location.href = url;
                }
            });

            //extra configuration of validate in add/edit model, others via data-attribute
            $('#js_form_user_edit').validate({
                errorContainer: $('ul.validate-error'),
                errorLabelContainer: $('#js_edit_modal ul.validate-error'),
                wrapper: 'li'
            });

            //clear query conditions in search modal
            $('#js_search_modal').on('click', '.btn-clear', function () {
                $(this).closest('.modal-content').find('input').val('');
                $('#js_s_select_enable_flag').val('');
            });

            //do clean up in edit modal show/hide
            $('#js_edit_modal').on('show.bs.modal', function (event) {
                $('#js_e_select_role').selectMultiple();
                $('#js_e_select_project').selectMultiple();
                var button = $(event.relatedTarget);
                var modal = $(this);
                var title = modal.find('.modal-title');
                if (button.attr('id') != 'js_btn_add_user') {
                    title.text("修改用户信息");
                    //$('#js_input_account_uid').rules('remove');

                    $('#js_btn_save_new_user').hide();
                    $('#js_btn_save_edit_user').show();
                    $('#js_hidden_is_edit').val(true);
                    //$('#js_input_account_uid').attr("readonly", "readonly");
                } else {

                    title.text("新增用户及相关信息");
                    //    //$('#js_input_account_uid').rules('add', {
                    //    required: true,
                    //    digits: true,
                    //    max: 1000000,
                    //    remote: UserMaintenanceUrls.checkUserByUId,
                    //    messages: {
                    //        required: "Please enter account id",
                    //        digits: "account id should be a digits",
                    //        max: "account id should be a digits and small than {0}.",
                    //        remote: "Account Id is already in use"
                    //    }
                    //});

                    $('#js_input_user_ntid').data('original', '');
                    $('#js_btn_save_new_user').show();
                    $('#js_btn_save_edit_user').hide();
                    $('#js_e_select_enable_flag').val('true');
                    $('#js_hidden_is_edit').val(false);
                    //$('#js_input_account_uid').removeAttr('readonly');

                }
            })

            $('#js_edit_modal').on('hidden.bs.modal', function (e) {
                $('#js_edit_modal').find('input').val('');
                $('#js_edit_modal').find('select').val('');
                $('.list-group.validate-error').empty();
                $('#js_e_select_role').selectMultiple('deselect_all');
                $('#pro_checkall').removeAttr('checked');
                $('#js_e_select_project').selectMultiple('deselect_all');
                //window.location.href = window.location.href;
            });

            //edit button in grid
            $('body').on('click', '.js-grid-edit', function () {

                var uuid = $(this).attr('data-id'),
                    url = UserMaintenanceUrls.queryUser;

                $.post(url, { uuid: uuid }, function (data) {

                    //$('#js_input_account_uid').val(uuid);
                    $('#js_input_user_ntid').val(data.User_NTID).data('original', data.User_NTID);
                    $('#js_input_user_name').val(data.User_Name);
                    $('#js_input_user_email').val(data.Email);
                    $('#js_input_user_tel').val(data.Tel);
                    $('#js_e_select_enable_flag').val(data.Enable_Flag ? "true" : "false");
                    $('#js_e_select_EnableEmpIdLogin').val(data.EnableEmpIdLogin);
                    $('#js_hidden_is_edit').val(true);
                    $('#js_input_user_EmployeeNumber').val(data.EmployeeNumber);
                    $('#js_input_user_password').val(data.EmployeePassword);
                    $('#js_input_building').val(data.Building);
                    $('#js_e_select_Language').val(data.System_Language_UID);

                    //getOrgCTU();
                    getOpTypes(data.Org_CTU);
                    getPPorPE(data.Org_OP_ID);
                    if (data.Org_CTU!=null)
                        getProject(data.Org_CTU, data.Org_OP_ID);
                    getFuncPlant(data.Org_PP_ID);
                    getRole();
                    if (data.Role != null) {
                        $('#js_e_select_role').val(data.Role);
                        $('#js_e_select_role').selectMultiple();
                    }
                    if (data.Project != null) {
                        $('#js_e_select_project').val(data.Project);

                    }
                    $('#js_e_select_project').selectMultiple();
                    if (data.Org_CTU != null) {
                        //getOrgCTU();
                        $("#js_e_select_org_ctu").val(data.Org_CTU);
                        if (data.Org_OP != null) {
                            //getOpTypes(data.Org_CTU);
                            $("#js_e_select_org_op").val(data.Org_OP_ID);
                            if (data.Org_PP != null) {
                                //getPPorPE(data.Org_OP);
                                //getProject(data.Org_OP);
                                $("#js_e_select_org_pp").val(data.Org_PP_ID);

                                if (data.Org_FunP != null) {
                                    //getMH(data.Org_PP);
                                    $('#js_e_select_org_funcplant').val(data.Org_FunP_ID);
                                    //$.each(data.Org_FunP_ID, function () {
                                    //    $("#js_e_select_org_funcplant").val(this.toString());
                                    //});
                                } else {
                                    //getMH(data.Org_PP);
                                    $("#js_e_select_org_funcplant").val();
                                }
                            } else {
                                //getPPorPE(data.Org_OP);
                                //getProject(data.Org_OP);
                                $("#js_e_select_org_pp").val();
                                // $("#js_e_select_project").val();
                            }
                        } else {
                            //getOpTypes(data.Org_CTU);
                            $("#js_e_select_org_op").val();
                        }
                    } else {
                        //getOrgCTU();
                        $("#js_e_select_org_ctu").val();
                    }
                });

                $('#js_edit_modal').modal('show');

            });

            //forbid button  in grid
            $('body').on('click', '.js-grid-forbid', function () {

                var uuid = $(this).attr('data-id');
                PDMS.Utility.MessageBox.confirm(
                    "Are you sure to forbid this item?", function () {
                        var url = UserMaintenanceUrls.forbidUser;
                        $.post(url, { Account_UID: uuid }, function (data) {
                            if (data != 'FAIL') {
                                UserMaintenance.QueryUsers();
                            } else {
                                PDMS.Utility.MessageBox.error("User already role assigned!");
                            }
                        });
                    });
            });

            //delete button in grid
            $('body').on('click', '.js-grid-delete', function () {

                var uuid = $(this).attr('data-id');
                PDMS.Utility.MessageBox.confirm(
                    "Are you sure to delete this item?", function () {
                        var url = UserMaintenanceUrls.deleteUser;
                        $.post(url, { Account_UID: uuid }, function (data) {
                            if (data != 'FAIL') {
                                UserMaintenance.QueryUsers();
                            } else {
                                PDMS.Utility.MessageBox.error("User already created datas!");
                            }
                        });
                    });
            });

            $('#js_btn_clear').click(function () {

                PDMS.Utility.Criteria.Clear();
            });
            //#endregion
        });

    </script>
}