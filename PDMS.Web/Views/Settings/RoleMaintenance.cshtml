<!-- Main content -->
<section class="content portal-content">

    <!--次標題 與 搜尋-->
    <div class="row">
        <!--次標題與Search keyword-->
        <div class="col-md-12 col-lg-9">
            <h4 class="margin-td-5" id="js_search_keywords"></h4>
        </div><!-- /col-次標題與Search keyword -->
        <!--col-右方搜尋與功能按鈕列-->
        <div class="col-md-12 search-field col-lg-3">
            <a class="btn btn-primary btn-sm" data-toggle="modal" data-target="#js_search_modal"><i class="fa fa-search"></i> Search</a>
            <a class="btn btn-primary btn-sm" role="button" data-toggle="modal" data-target="#js_edit_modal" id="js_btn_add_role">
                <i class="fa fa-plus"></i> Add
            </a>
            <a id="js_btn_export" class="btn btn-primary btn-sm" role="button">
                <i class="glyphicon glyphicon-save"></i> Export
            </a>
        </div><!-- /col-右方搜尋與功能按鈕列-->
    </div><!--/次標題 與 搜尋-->
    <hr class="hr-custom">

    <!--row Search Keyword collapse-->
    <div class="row">
        <div class="col-xs-12" id="js_criteria_alert_cnt">
        </div>
    </div> <!--/row Search Keyword collapse-->
    <!--內容 表格列-->
    <div class="row">
        <!--表格-->
        <div class="col-md-12 table-container">
            <table class="table table-striped table-hover table-condensed nowrap" id="js_role_datatable">
                <thead>
                    <tr>
                        <th class="table-col-checkbox nosort">
                            <input type="checkbox" class="js-checkbox-all" />
                        </th>
                        <th class="table-col-action nosort">Action</th>
                        <th class="table-col-seq nosort">Seq</th>
                        <th name="Role_ID">Role ID</th>
                        <th>Role Name</th>
                        <th>父ID</th>
                        <th>Modified User</th>
                        <th>Modified Date</th>
                    </tr>
                </thead>
                <tfoot>
                    <tr>
                        <th class="table-col-checkbox nosort"></th>
                        <th class="table-col-action nosort">Action</th>
                        <th class="table-col-seq nosort">Seq</th>
                        <th>Role ID</th>
                        <th>Role Name</th>
                        <th>父ID</th>
                        <th>Modified User</th>
                        <th>Modified Date</th>
                    </tr>
                </tfoot>
            </table>
            <div id="page" class="row"></div>

        </div><!--/表格-->
    </div><!-- / 內容 表格列 -->


</section><!-- /.content -->

@section ViewModals{
    <!-- Modal -->
    <div class="modal fade" id="js_search_modal" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title">Search</h4>
                </div>
                <div class="modal-body">
                    <form id="js_form_query" class="form-horizontal" data-need-validate="true">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="col-sm-4 control-label" for="js_s_input_role_id">Role ID</label>
                                    <div class="col-sm-8">
                                        <input type="text" name="Role_ID" class="form-control input-sm" id="js_s_input_role_id" placeholder="Role ID">
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="col-sm-4 control-label" for="js_s_input_role_name">Role Name</label>
                                    <div class="col-sm-8">
                                        <input type="text" name="Role_Name" class="form-control input-sm" id="js_s_input_role_name" placeholder="Role Name">
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="col-sm-4 control-label" for="js_s_input_father_id">父ID</label>
                                    <div class="col-sm-8">
                                        <input type="text" name="Father_Role_ID" class="form-control input-sm" id="js_s_input_father_id" placeholder="Role Name">
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="col-sm-4 control-label" for="js_s_input_modified_by">Modified By</label>
                                    <div class="col-sm-8">
                                        <input type="text" name="Modified_By" class="form-control input-sm" id="js_s_input_modified_by" placeholder="Modified By (NTID)">
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="col-sm-4 control-label" data-type="date-interval">Modified Date</label>
                                    <div class="col-sm-8">
                                        <div class="input-group">
                                            <span class="input-group-addon"><i class="fa fa-calendar"></i></span>
                                            <span class="input-group-addon">From</span>
                                            <input type="text" name="Modified_Date_From" class="form-control input-sm date" id="js_s_input_modified_from">
                                            <span class="input-group-addon">To</span>
                                            <input type="text" name="Modified_Date_End" class="form-control input-sm date" id="js_s_input_modified_to">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary btn-sm" id="js_btn_clear"><i class="fa fa-eraser"></i> Clear</button>
                    <button type="button" class="btn btn-primary btn-sm" id="js_btn_query"><i class="fa fa-search"></i> Query</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="js_edit_modal" role="dialog">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title">Maintain Role</h4>
                </div>
                @using (Html.BeginForm("Editfile", "Settings", FormMethod.Post, new { id = "js_form_role_edit" }))
                {
                    <div class="modal-body form-horizontal">

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="col-sm-4 control-label" for="js_input_role_id">Role ID</label>
                                    <div class="col-sm-7">
                                        <input type="text" class="form-control input-sm" id="js_input_role_id"  name="Role_ID" placeholder="Role ID"
                                               required data-msg-required="Please enter Role ID"
                                               data-rule-maxlength="30" data-msg-maxlength="Please enter no more than {0} characters in Role ID."
                                               data-remote="CheckRoleExistById" data-original=""
                                               data-rule-checkwhetherexist="true" data-msg-checkwhetherexist="Role Id is already in use">
                                    </div>
                                </div>

                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="col-sm-4 control-label" for="js_input_role_name">Role Name</label>
                                    <div class="col-sm-7">
                                        <input type="text" class="form-control input-sm" id="js_input_role_name" name="Role_Name" placeholder="Role Name"
                                               required data-msg-required="Please enter Role Name"
                                               data-rule-maxlength="50" data-msg-maxlength="Please enter no more than {0} characters in Role Name.">
                                    </div>
                                </div>
                            </div>
                            <div class=" col-md-6">
                                <div class="form-group">
                                    <label class="col-sm-4 control-label" for="js_input_father_role_id">父ID</label>
                                    <div class="col-sm-7">
                                        <input type="text" class="form-control input-sm" id="js_input_father_role_id" name="Father_Role_ID" placeholder="Father ID">
                                    </div>
                                </div>
                            </div>
                            <input type="hidden" name="isEdit" value="false" />
                            <input type="hidden" name="Role_UID" value="0" />
                            <!--jquery validata error container-->
                            <div class="col-xs-12"><ul class="list-group validate-error"></ul></div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-primary btn-sm" data-dismiss="modal"><i class="fa fa-times"></i> Cancel</button>
                        <button type="submit" class="btn btn-primary btn-sm" id="js_btn_save_new_role"><i class="fa fa-save"></i> Save</button>
                        <button type="submit" class="btn btn-primary btn-sm" id="js_btn_save_edit_role"><i class="fa fa-save"></i> Edit Save</button>
                    </div>
                }
            </div>
        </div>
    </div>
}

@section ViewScripts{
    <script type="text/javascript">

        $(function () {
            var RoleMaintenance = (function () {
                var urls = {
                    queryRoles: '@Url.Action("QueryRoles", "Settings")',
                    IsExistRoleID: '@Url.Action("IsExistRoleID", "Settings")',
                    queryRole: '@Url.Action("QueryRole", "Settings")',
                    deleteRole: '@Url.Action("DeleteRole", "Settings")',
                    exportRoles: '@Url.Action("DoExportRole", "Settings")'
                };
                var columns = [{

                    createdCell: function (td, cellData, rowData, row, col) {
                        $(td).html('<input type="checkbox" name="cktrans" class="js-checkbox-item" value="' + rowData.Role_UID + '">')
                             .addClass('table-col-checkbox');
                    },
                    className: "text-center"
                }, {
                    createdCell: function (td, cellData, rowData, row, col) {
                        $(td).html('<button class="btn btn-primary btn-xs" rel="action-popover">' +
                                        '<i class="fa fa-reorder"></i>' +
                                    '</button>' +
                                    '<div class="hidden popover-content">' +
                                        '<button type="button" class="btn btn-primary btn-xs js-grid-edit" data-id="' + rowData.Role_UID + '">Edit</button> ' +
                                        '<button type="button" class="btn btn-primary btn-xs js-grid-delete" data-id="' + rowData.Role_UID + '">Delete</button>' +
                                    '</div>');
                    },
                    className: "text-center"
                }, {
                    data: null,
                    className: "table-col-seq"
                }, {
                    //data: "Role_ID",
                    //className: "min-col-xs"
                    data: null,
                    createdCell: function (td, cellData, rowData, row, col) {
                        $(td).html(rowData.Role_ID);
                    },
                    className: "min-col-xs"
                }, {
                    data: "Role_Name",
                    className: "min-col-xs"
                }
                , {
                    data: "Father_Role_ID",
                    className: "min-col-xs"
                }, {
                    data: "ModifiedUser.User_Name",
                    className: "min-col-lg"
                }, {
                    data: "Modified_Date",
                    className: "min-col-lg"
                }];

                var _getParams = function () {
                    return $('#js_form_query').serialize().replace(/\+/g, " ");
                };

                var _queryRoles = function (firstLoad) {

                    var config = {
                        pageId: "#page",
                        tableId: "#js_role_datatable",
                        remoteUrl: urls.queryRoles,
                        searchParams: _getParams(),
                        tableOptions: {
                            columns: columns
                        },
                        createdRow: function (row, data, index) {
                            $(row).data('Role_ID', data.Role_ID);
                        }
                    };

                    if (!firstLoad) {
                        $('#page').page('destroy');
                        PDMS.Utility.Criteria.Build();

                    }
                    PDMS.Utility.Pages.Set(config);

                };

                return {
                    urls: urls,
                    Init: function () {
                        PDMS.Utility.Criteria.Init();
                        _queryRoles(true);
                    },
                    QueryRoles: function () {
                        _queryRoles(false);
                    },

                    GetDatatable: function () {
                        var subDatatable = $('#js_role_datatable').DataTable({
                            paging: false,
                            searching: false,
                            ordering: false,
                            retrieve: true,
                            columns: columns
                        });
                        return subDatatable;
                    },
                }

            })();

            RoleMaintenance.Init();

            $('#js_btn_query').click(function () {
                if ($("#js_form_query").valid()) {
                    RoleMaintenance.QueryRoles();
                    $('#js_search_modal').modal('hide');
                }
            });

            $('#js_btn_export').click(function () {
                var $selectList = $('#js_role_datatable').find('.js-checkbox-item:checked');
                var len = $selectList.length;
                if (len == 0) {
                    PDMS.Utility.MessageBox.info('please select datas to export!');
                } else {
                    var ruids = $.map($selectList, function (row) {
                        return row.value;
                    });
                    var url = RoleMaintenance.urls.exportRoles;
                    url += "?ruids=" + ruids.toString();
                    window.location.href = url;
                }
            });

            //extra configuration of validate in add/edit model, others via data-attribute
            $('#js_form_role_edit').validate({
                errorContainer: $('ul.validate-error'),
                errorLabelContainer: $('#js_edit_modal ul.validate-error'),
                wrapper: 'li'
            });

            //clear query conditions in search modal
            $('#js_btn_clear').click(function () {
                PDMS.Utility.Criteria.Clear();
            });

            //do clean up in edit modal show/hide
            $('#js_edit_modal').on('show.bs.modal', function (event) {
                var button = $(event.relatedTarget)
                var modal = $(this)
                var title = modal.find('.modal-title');

                if (button.attr('id') != 'js_btn_add_role') {

                    title.text('Edit Role');
                    document.getElementById("js_input_role_id").removeAttribute("onblur");
                    $('#js_btn_save_new_role').hide();
                    $('#js_btn_save_edit_role').show();
                    $('#js_edit_modal').find('input[name=isEdit]').val(true);
                } else {

                    title.text('Add Role');
                    document.getElementById("js_input_role_id").setAttribute("onblur", "IsExis(this)");
                    $('#js_btn_save_new_role').show();
                    $('#js_btn_save_edit_role').hide();
                    $('#js_input_role_id').data('original', '');
                    $('#js_edit_modal').find('input[name=isEdit]').val(false);
                }
            })

            $('#js_edit_modal').on('hidden.bs.modal', function (e) {
                $('#js_edit_modal').find('input').val('');
                $('.list-group.validate-error').empty();
            });

            //edit button in grid
            $('body').on('click', '.js-grid-edit', function () {

                var uuid = $(this).data('id'),
                    url = RoleMaintenance.urls.queryRole;

                $.post(url, { uuid: uuid }, function (data) {

                    $('#js_input_role_id').val(data.Role_ID).data('original', data.Role_ID);
                    $('#js_input_role_name').val(data.Role_Name);
                    $('#js_input_father_role_id').val(data.Father_Role_ID);
                    $('#js_edit_modal').find('input[name=Role_UID]').val(uuid);
                    $('#js_edit_modal').find('input[name=isEdit]').val(true);
                });

                $('#js_edit_modal').modal('show');

            });

            //delete button in grid
            //2.以欲刪除記錄的＂Role_UID＂為依據，
            //到＂使用者角色設定檔(System_Users_Role)＂、＂角色功能設定檔(System_Role_Function)＂
            //去檢查是否有該筆資料存在，若是已有被其中一個Table使用，表示本筆資料已被使用，不能刪
            //除；反之，則本筆記錄沒有被使用，可以刪除。
            $('body').on('click', '.js-grid-delete', function () {

                var uuid = $(this).attr('data-id');

                PDMS.Utility.MessageBox.confirm(
                    "Are you sure to delete this item?"
                    , function () {
                        var url = RoleMaintenance.urls.deleteRole;
                        $.post(url, { Role_UID: uuid }, function (data) {
                            if (data == 'success') {
                                RoleMaintenance.QueryRoles();
                            }
                            else {
                                if (data == '1') {
                                    PDMS.Utility.MessageBox.error("Role already assigned to role function!");
                                }
                                if (data == '2') {
                                    PDMS.Utility.MessageBox.error("Role already assigned to user roles!");
                                }
                            }
                        });
                    });
            });
            $('#js_btn_clear').click(function () {
                //如果没有特殊项的Clear，直接调用Clear方法
                PDMS.Utility.Criteria.Clear();
            });

            IsExis = function (param) {
                var Role_ID = param.value;
                url = RoleMaintenance.urls.IsExistRoleID;
                $.post(url, { role_ID: Role_ID }, function (data) {
                    if (data) {
                        PDMS.Utility.MessageBox.error("Role ID already assigned to user roles!");
                    }
                });
            }
        });
    </script>
}
