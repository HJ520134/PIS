<!-- Main content -->
<section class="content portal-content">

    <!--次標題 與 搜尋-->
    <div class="row">
        <!--次標題與Search keyword-->
        <div class="col-md-12 col-lg-9">
            <h4 class="margin-td-5" id="js_search_keywords"></h4>
        </div><!-- /col-次標題與Search keyword -->
        <!--col-右方搜尋與功能按鈕列-->
        <div class="col-md-12 search-field col-lg-3">
            <a class="btn btn-primary btn-sm" role="button" data-toggle="modal" data-target="#js_search_modal"><i class="fa fa-search"></i> Search</a>
            <a class="btn btn-primary btn-sm" role="button" data-toggle="modal" data-target="#js_edit_modal" id="js_btn_add_funcplant">
                <i class="fa fa-plus"></i> Add
            </a>
            <a id="js_btn_export" class="btn btn-primary btn-sm" role="button">
                <i class="glyphicon glyphicon-save"></i> Export
            </a>
        </div><!-- /col-右方搜尋與功能按鈕列-->
    </div><!--/次標題 與 搜尋-->
    <hr class="hr-custom">

    <!--row Search Keyword collapse-->
    <div class="row">
        <div id="js_criteria_alert_cnt">
        </div>
    </div> <!--/row Search Keyword collapse-->
    <!--內容 表格列-->
    <div class="row">
        <!--表格-->
        <div class="col-md-12 table-container">
            <table class="table table-striped table-hover table-condensed nowrap" id="js_funcplant_datatable">
                <thead>
                    <tr>
                        <th class="table-col-checkbox nosort">
                            <input type="checkbox" class="js-checkbox-all" />
                        </th>
                        <th class="table-col-action nosort">操作</th>
                        <th class="table-col-seq nosort">序号</th>
                        <th>功能厂</th>
                        <th>厂区</th>
                        <th>OP类型</th>
                        <th>功能厂管理者</th>
                        <th>功能厂联系方式</th>
                        <th>Organization_ID</th>                     
                        <th>修改者</th>
                        <th>修改时间</th>
                    </tr>
                </thead>
          
            </table>
            <input type="hidden" name="System_edit_id" id="js_hidden_edit_id" value="0" />
            <div id="page" class="row"></div>

        </div><!--/表格-->
    </div><!-- / 內容 表格列 -->


</section><!-- /.content -->
@section ViewModals{
    <div class="modal fade" id="js_search_modal" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title">查询</h4>
                </div>
                <div class="modal-body form-horizontal">
                    <div class="row">
                        <form id="js_form_query" data-need-validate="true">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="col-sm-4 control-label" for="js_s_input_funcplant">功能厂</label>
                                    <div class="col-sm-8">
                                        <input type="text" name="FunPlant" class="form-control input-sm" id="js_s_input_funcplant" placeholder="功能厂">
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="col-sm-4 control-label" for="js_s_input_plant">厂区</label>
                                    <div class="col-sm-8">
                                        <select class="form-control input-sm" id="js_s_input_plant" name="Plant"></select>                                   
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="col-sm-4 control-label" for="js_s_input_optype">OP类型</label>
                                    <div class="col-sm-8">
                                        <select class="form-control input-sm" id="js_s_input_optype" name="OPType">
                                            <option>OP1</option>
                                            <option selected="selected">OP2</option>
                                            <option >OP3</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="col-sm-4 control-label" for="js_s_input_plant_funcmanager">功能厂管理者</label>
                                    <div class="col-sm-8">
                                        <input type="text" name="FuncPlant_Manager" class="form-control input-sm" id="js_s_input_plant_funcmanager" placeholder="功能厂管理者">
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="col-sm-4 control-label" for="js_s_input_Organization_ID">Organization_ID</label>
                                    <div class="col-sm-8">
                                        <input type="text" name="Organization_ID" class="form-control input-sm" id="js_s_input_Organization_ID" placeholder="组织ID">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="col-sm-4 control-label" for="js_s_input_modified_by_ntid">修改者(NTID)</label>
                                    <div class="col-sm-8">
                                        <input type="text" name="Modified_By_NTID" class="form-control input-sm" id="js_s_input_modified_by_ntid" placeholder="修改者(NTID)">
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="col-sm-4 control-label">修改时间</label>
                                    <div class="col-sm-8">
                                        <div class="input-group">
                                            <span class="input-group-addon"><i class="fa fa-calendar"></i></span>
                                            <span class="input-group-addon">From</span>
                                            <input type="text" name="Modified_Date_From" class="form-control input-sm date" id="js_s_input_modified_from">
                                            <span class="input-group-addon">To</span>
                                            <input type="text" name="Modified_Date_End" class="form-control input-sm date" id="js_s_input_modified_to">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary btn-sm" id="js_btn_clear"><i class="fa fa-eraser"></i> Clear</button>
                    <button type="button" class="btn btn-primary btn-sm" id="js_btn_query"><i class="fa fa-search"></i> Query</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="js_edit_modal" role="dialog">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title">功能厂维护</h4>
                </div>

                <form id="js_form_funcplant_edit" class="form-horizontal clearfix">
                    <div class="modal-body form-horizontal">
                        <div class="row">
                            <input type="hidden" name="System_FuncPlant_UID" id="js_hidden_funcplant_uid" value="0" />
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="col-sm-5 control-label" for="js_input_funcplant">功能厂</label>
                                    <div class="col-sm-7">
                                        <input type="text" class="form-control input-sm required" id="js_input_funcplant" name="FunPlant" placeholder="功能厂"
                                               required data-msg-required="请输入功能厂名称"
                                               data-rule-maxlength="3" data-msg-maxlength="请至少输入3个字符"
                                               data-remote="CheckFunPlantExistByFunPlant" data-original=""
                                               data-rule-checkwhetherexist="true" data-msg-checkwhetherexist="功能厂已经被使用，不能修改！">
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="col-sm-5 control-label" for="js_input_plant">厂区</label>
                                    <div class="col-sm-7">
                                        <select class="form-control input-sm" id="js_input_plant" required data-msg-required="请选择厂区！" name="Plant">
                                        </select>               
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="col-sm-5 control-label" for="js_input_optype">OP类型</label>
                                    <div class="col-sm-7">
                                        <select class="form-control input-sm" id="js_input_optype" required data-msg-required="请选择OP类型！" name="OPType">
                                            <option selected="selected">OP2</option>
                                            <option>OP1</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            @*获取功能厂ＩＤ*@
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="col-sm-5 control-label" for="js_input_Organization_ID">Organization_ID</label>
                                    <div class="col-sm-7">
                                        <input type="text" class="form-control input-sm required" id="js_input_Organization_ID" name="Organization_ID" placeholder="Organization_ID"
                                               required data-msg-required="请输入Organization_ID名称">
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="col-sm-5 control-label" for="js_input_plant_manager">功能厂管理者</label>
                                    <div class="col-sm-7">
                                        <input type="text" class="form-control input-sm required" id="js_input_plant_manager" name="Plant_Manager" placeholder="功能厂管理者(NTID)"
                                               required data-msg-required="请输入功能厂管理者的NTID"
                                               data-remote="CheckNTIDExistByNTID" data-original=""
                                               data-rule-checkwhetherexist="true" data-msg-checkwhetherexist="该NTID不存在！"/>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-12">
                                <div class="form-group">
                                    <label class="col-sm-3 control-label">功能厂联系方式</label>
                                    
                                    <div class="col-sm-9">
                                        <input type="text" class="form-control input-sm context" id="js_input_context" name="FuncPlant_Context" placeholder="联系方式(多个联系方式，请用分号隔开)"/>
                                        <input type="hidden" name="Context_Text" id="js_context_text" />
                                    </div>
                                </div>
                            </div>
                            

                            <!--jquery validata error container-->
                            <div class="col-xs-12"><ul class="list-group validate-error"></ul></div>

                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-primary btn-sm" data-dismiss="modal"><i class="fa fa-times"></i> Cancel</button>
                        <button type="button" class="btn btn-primary btn-sm" id="js_btn_save_new_funcplant"><i class="fa fa-save"></i> Save</button>
                        <button type="button" class="btn btn-primary btn-sm" id="js_btn_save_edit_funcplant"><i class="fa fa-save"></i> Edit Save</button>
                    </div>
                </form>

            </div>
        </div>
    </div>
    <!-- View Modal -->
    <div class="modal fade" id="js_view_modal" role="dialog">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title">查看</h4>
                </div>
                <div class="modal-body form-horizontal">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="col-sm-5 control-label" for="js_v_input_funcplant">功能厂</label>
                                <div class="col-sm-7">
                                    <input type="text" class="form-control input-sm" id="js_v_input_funcplant" disabled>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="col-sm-5 control-label" for="js_v_input_plant">厂区</label>
                                <div class="col-sm-7">
                                    <input type="text" class="form-control input-sm" id="js_v_input_plant" disabled>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="col-sm-5 control-label" for="js_v_input_optype">OP类型</label>
                                <div class="col-sm-7">
                                    <input type="text" class="form-control input-sm" id="js_v_input_optype" disabled>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="col-sm-5 control-label" for="js_v_input_Organization_ID">Organization_ID</label>
                                <div class="col-sm-7">
                                    <input type="text" class="form-control input-sm" id="js_v_input_Organization_ID" disabled>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="col-sm-5 control-label" for="js_v_input_funcmanager">功能厂管理者</label>
                                <div class="col-sm-7">
                                    <input type="text" class="form-control input-sm" id="js_v_input_funcmanager" disabled>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="col-sm-5 control-label" for="js_v_input_context_text">功能厂联系方式</label>
                                <div class="col-sm-7">
                                    <input type="text" class="form-control input-sm" id="js_v_input_context_text" disabled>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-primary btn-sm" data-dismiss="modal"><i class="fa fa-times"></i> Cancel</button>
                </div>
            </div>
        </div>
    </div>
}

@section ViewScripts{
    <script type="text/javascript">
        $(function() {


            var FuncPlantMaintenance = (function() {
                var needBuildCriteria = false;
                var urls =
                {
                    EditFuncPlant: '@Url.Action("EditFuncPlant", "Settings")',
                    AddFuncPlant: '@Url.Action("AddFuncPlant", "Settings")',
                    QueryFuncPlants: '@Url.Action("QueryFuncPlants", "Settings")',
                    queryFuncPlant: '@Url.Action("QueryFuncPlant", "Settings")',
                    deleteFuncPlant: '@Url.Action("DeleteFuncPlant", "Settings")',
                    exportFuncPlants: '@Url.Action("DoExportFuncPlant", "Settings")',
                    getPlant: '@Url.Action("getPlant", "Settings")',
                    getFunPOrgId:'@Url.Action("getFunPOrgId", "Settings")'
                };
                var columns = [
                    {
                        createdCell: function(td, cellData, rowData, row, col) {
                            $(td).html('<input type="checkbox" name="cktrans" class="js-checkbox-item" value="' + rowData.System_FuncPlant_UID + '">')
                                .addClass('table-col-checkbox');
                        },
                        className: "text-center"
                    }, {
                        createdCell: function(td, cellData, rowData, row, col) {
                            var disableEdit = false;
                            //if (rowData.End_Date !== null && moment().startOf('day').isAfter(rowData.End_Date)) {
                            //    disableEdit = true;
                            //}
                            $(td).html('<button class="btn btn-primary btn-xs" rel="action-popover">' +
                                '<i class="fa fa-reorder"></i>' +
                                '</button>' +
                                '<div class="hidden popover-content">' +
                                '<button type="button" class="btn btn-primary btn-xs js-grid-view" data-id="' + rowData.System_FuncPlant_UID + '">View</button>' +
                                '<button type="button" class="btn btn-primary btn-xs js-grid-edit" data-id="' + rowData.System_FuncPlant_UID + '">Edit</button>' +
                                '<button type="button" class="btn btn-primary btn-xs js-grid-delete" data-id="' + rowData.System_FuncPlant_UID + '">Delete</button>' +
                                '</div>');
                        },
                        className: "text-center"
                    }, {
                        data: null,
                        className: "table-col-seq"
                    }, {
                        data: "FunPlant",
                        className: "min-col-xs"
                    }, {
                        data: "Plant",
                        className: "min-col-xs"
                    }, {
                        data: "OPType",
                        className: "min-col-xs"
                    }, {
                        data: "Plant_Manager",
                        className: "min-col-xs"
                    }, {
                        data: "FuncPlant_Context",
                        className: "min-col-xs"
                    },
                    {
                        data: "Organization_ID",
                        className: "min-col-xs"
                    },


                    {
                        data: "Modified_UserName",
                        className: "min-col-xs"
                    }, {
                        data: "Modified_Date",
                        className: "min-col-xs"
                    }
                ];

                var _getParams = function() {
                    if (needBuildCriteria) {
                        return $('#js_form_query').serialize().replace(/\+/g, " ");
                    } else {
                        return null;
                    }
                };

                var _queryPlants = function(firstLoad) {

                    var config = {
                        pageId: "#page",
                        tableId: "#js_funcplant_datatable",
                        remoteUrl: urls.QueryFuncPlants,
                        searchParams: _getParams(),
                        tableOptions: {
                            scrollX: true,
                            scrollCollapse: false,
                            autoWidth: true,
                            columns: columns
                        }
                    };

                    if (!firstLoad) {
                        $('#page').page('destroy');
                    }

                    if (needBuildCriteria) {
                        PDMS.Utility.Criteria.Build();
                    }

                    PDMS.Utility.Pages.Set(config);
                };

                return {
                    urls: urls,
                    Init: function() {
                        //页面初始化加载查询时，初始化Criteria
                        PDMS.Utility.Criteria.Init();
                        _queryPlants(true);
                    },
                    queryPlants: function(isSearchBtn) {
                        needBuildCriteria = (isSearchBtn === true ? true : needBuildCriteria);
                        _queryPlants(false);
                    }
                }

            })();
            FuncPlantMaintenance.Init();
            //初始化数据
            GetPlant();
            //do clean up in edit modal show/hide
            $('#js_edit_modal').on('show.bs.modal', function(event) {
                var button = $(event.relatedTarget);
                var modal = $(this);
                var title = modal.find('.modal-title');

                if (button.hasClass('js-grid-edit')) {
                    title.text("修改功能厂");

                    $('#js_btn_save_new_funcplant').hide();
                    $('#js_btn_save_edit_funcplant').show();
                    $("#js_hidden_edit_id").val(0);

                } else if (button.attr('id') == 'js_btn_add_funcplant') {

                    title.text("新增功能厂");
                    $('#js_input_funcplant').data('original', '');
                    $('#js_btn_save_new_funcplant').show();
                    $('#js_btn_save_edit_funcplant').hide();
                }
            })
            $('#js_edit_modal').on('hidden.bs.modal', function(e) {
                //功能厂名称可编辑
                $("#js_input_funcplant").attr("disabled", false);

                $('#js_edit_modal').find('input').val('');
                $('.list-group.validate-error').empty();
            });
            //Form Validate
            $('#js_form_funcplant_edit').validate({
                errorContainer: $('ul.validate-error'),
                errorLabelContainer: $('#js_edit_modal ul.validate-error'),
                wrapper: 'li'
            });
            //新增保存FunPlant按钮
            $("#js_btn_save_new_funcplant").click('click', function() {

                var editform = $('#js_form_funcplant_edit');
                if (editform.valid()) {

                    var submitJson = editform.serializeObject();
                    submitJson.System_FuncPlant_UID = 0;
                    $.post(FuncPlantMaintenance.urls.AddFuncPlant, { jsonAddPlant: JSON.stringify(submitJson) }, function(data) {
                        if (data == 'SUCCESS') {

                            PDMS.Utility.MessageBox.info("新增成功");
                            editform.find("input").val("");
                        } else {
                            PDMS.Utility.MessageBox.error(data);
                        }
                    });
                }
            });
            //查询FunPlant
            $('#js_btn_query').click(function() {
                if ($("#js_form_query").valid()) {
                    FuncPlantMaintenance.queryPlants(true);
                    $('#js_search_modal').modal('hide');
                }
            });

            //edit button in grid
            $('body').on('click', '.js-grid-edit', function() {
                var $sender = $(this);
                if ($sender.hasClass('disabled')) {
                    PDMS.Utility.MessageBox.error("Plant already expired, can't edit!");
                    return;
                }

                $("#js_hidden_edit_id").val(1);
                var uuid = $(this).attr('data-id'),
                    url = FuncPlantMaintenance.urls.queryFuncPlant;
                $.post(url, { uuid: uuid }, function(data) {
                    $('#js_hidden_funcplant_uid').val(uuid);
                    $('#js_input_funcplant').val(data.FunPlant).data('original', data.FunPlant);
                    //使某功能厂被选中
                    $("#js_input_plant option").each(function () {
                        if ($(this).text() == data.Plant) {
                            $(this).attr("selected", "selected");
                        };
                    });
                    //使某OP类型被选中
                    $("#js_input_optype option").each(function() {
                        if ($(this).text() == data.OPType) {
                            $(this).attr("selected", "selected");
                        };
                    });
                    $("#js_input_Organization_ID").val(data.Organization_ID);
                    $("#js_input_plant_manager").val(data.Plant_Manager);
                    $("#js_input_context").val(data.FuncPlant_Context);
                    //功能厂名称不能修改
                    //$("#js_input_funcplant").attr("disabled",true);

                });

                $('#js_edit_modal').modal('show', $(this));

            });
            //delete button in grid
            $('body').on('click', '.js-grid-delete', function() {

                var uuid = $(this).attr('data-id');


                PDMS.Utility.MessageBox.confirm(
                    "Are you sure to delete this item?", function() {
                        var url = FuncPlantMaintenance.urls.deleteFuncPlant;
                        $.post(url, { System_FuncPlant_UID: uuid }, function(data) {
                            if (data == 'FuncPlant_Is_Exit') {
                                PDMS.Utility.MessageBox.error("FuncPlant already in used!");
                            } else {
                                FuncPlantMaintenance.queryFuncPlants();
                            }
                        });
                    });
            });
            //Grid中View按钮
            $('body').on('click', '.js-grid-view', function() {

                var uuid = $(this).attr('data-id'),
                    url = FuncPlantMaintenance.urls.queryFuncPlant;

                $.post(url, { uuid: uuid }, function(data) {
                    $('#js_v_input_funcplant').val(data.FunPlant).data('original', data.FunPlant);
                    $("#js_v_input_plant").val(data.Plant);
                    $("#js_v_input_optype").val(data.OPType);
                    $("#js_v_input_funcmanager").val(data.Plant_Manager);
                    $("#js_v_input_context_text").val(data.FuncPlant_Context);
                });
                $('#js_view_modal').modal('show', $(this));
            });

            //新增修改Plant按钮
            $("#js_btn_save_edit_funcplant").click('click', function () {

                var $editform = $('#js_form_funcplant_edit');

                if ($editform.valid()) {
                    var submitJson = $editform.serializeObject();
                    $.post(FuncPlantMaintenance.urls.EditFuncPlant, { jsonEditPlant: JSON.stringify(submitJson) }, function (data) {
                        if (data == 'SUCCESS') {
                            PDMS.Utility.MessageBox.info("Edit Plant Success");
                            $('#js_edit_modal').modal('hide');

                            FuncPlantMaintenance.queryFuncPlants();
                        } else {
                            PDMS.Utility.MessageBox.error(data);
                        }
                    });
                }
            });

            //导出EXCEL
            $('#js_btn_export').click(function () {
                var $selectList = $('#js_funcplant_datatable').find('.js-checkbox-item:checked');
                var len = $selectList.length;
                if (len == 0) {
                    PDMS.Utility.MessageBox.info('please select datas to export!');
                } else {
                    var uuids = $.map($selectList, function (row) {
                        return row.value;
                    });
                    var url = FuncPlantMaintenance.urls.exportFuncPlants;
                    url += "?uuids=" + uuids.toString();
                    window.location.href = url;
                }
            });
            //查询所有厂区
            function GetPlant() {
                $.post(FuncPlantMaintenance.urls.getPlant, function(data) {
                    if (data != "") {
                        $.each(data, function(i, item) {
                            $("<option></option>")
                                .val(item)
                                .text(item)
                                .appendTo($("#js_input_plant"));
                            $("<option></option>")
                                .val(item)
                                .text(item)
                                .appendTo($("#js_s_input_plant"));
                        });
                    }
                });
            };
        });
    </script>
}

