@*@model IEnumerable<PDMS.Model.SystemRoleDTO>*@
<!-- Main content -->
@{

    ViewBag.Edit = T("QA.Edit").Text;
    ViewBag.Delete = T("QA.Delete").Text;
    ViewBag.Selectnewtype = T("QA.Selectnewtype").Text;
    ViewBag.Addedsuccessfullys = T("QA.Addedsuccessfullys").Text;
    ViewBag.Modifyreasons = T("QA.Modifyreasons").Text;
    ViewBag.Successfullymodified = T("QA.Successfullymodified").Text;
    ViewBag.Pleasereasondeletion = T("QA.Pleasereasondeletion").Text;
    ViewBag.Successfullydeleted = T("QA.Successfullydeleted").Text;
    ViewBag.Suredelete = T("QA.Suredelete").Text;
    ViewBag.Pleasewait = T("QA.Pleasewait").Text;
    ViewBag.Naturalnumber = T("QA.Naturalnumber").Text;
    ViewBag.Numberofrepairs = T("QA.Numberofrepairs").Text;
    ViewBag.Numberofspecialmining = T("QA.Numberofspecialmining").Text;
    ViewBag.NumberofrepatriationNG = T("QA.NumberofrepatriationNG").Text;
    ViewBag.NGaggregatedquantity = T("QA.NGaggregatedquantity").Text;
    ViewBag.Replacementquantitysummary = T("QA.Replacementquantitysummary").Text;
    ViewBag.Submittedsuccessfully = T("QA.Submittedsuccessfully").Text; 
    ViewBag.BTNAddbaddetails = T("QA.BTNAddbaddetails").Text;
}
<style>
    tr:hover {
        background-color: Highlight !important;
        color: red;
    }
</style>
<section class="content-header portal-content-header">
    <h1>
        <input type="hidden" id="CriteriaHidden" value=@ViewBag.Criteria />
        <small>@ViewBag.Criteria</small>
    </h1>
</section>
<section class="content portal-content">

    <!--次標題 與 搜尋-->
    <div class="row">
        <!--次標題與Search keyword-->
        <div class="col-md-12 col-lg-9">
            <h4 class="margin-td-5" id="js_search_keywords"></h4>
        </div>
        <!-- /col-次標題與Search keyword -->
        <!--col-右方搜尋與功能按鈕列-->
        <div class="col-md-12 search-field col-lg-3">
            <a class="btn btn-primary btn-sm" data-toggle="modal" data-target="#js_search_modal" id="js_btn_search"><i class="fa fa-search"></i> @T("QA.Search")</a>
            <a class="btn btn-primary btn-sm @ViewBag.From" data-toggle="modal" data-target="#js_search_add_modal" id="js_btn_add_role_function">
                <i class="fa fa-plus"></i> @T("QA.Addbaddetails")
            </a>
        </div><!-- /col-右方搜尋與功能按鈕列-->

    </div><!--/次標題 與 搜尋-->

    <hr class="hr-custom">
    <div hidden="hidden" name="PageData">
        <input type="hidden" id="PageData_Project_Name" value=@ViewBag.Project />
    </div>

    <!--row Search Keyword collapse-->
    <div class="row">
        <div class="col-xs-12" id="js_criteria_alert_cnt">
        </div>
    </div>
    <!--row Search Keyword collapse-->
    <!--內容 表格列-->
    <div class="row">
        <!--表格-->
        <div class="col-md-12 table-container">
            <table class="table table-striped table-hover table-condensed nowrap" id="js_bad_detail_datatable">
                <thead>
                    <tr>
                        <th class="table-col-checkbox nosort">
                            <input type="checkbox" class="js-checkbox-all" />
                        </th>
                        <th class="table-col-action nosort">@T("Common.Action")</th>
                        <th class="table-col-seq nosort">@T("Common.Seq")</th>
                        @*<th>专案</th>
                        <th>工站</th>*@
                        <th>@T("QA.Baddetail")</th>
                        <th>@T("QA.Rework")</th>
                        <th>@T("QA.Specialmining")</th>
                        <th>@T("QA.ReworkNG")</th>
                        <th>@T("QA.NG")</th>
                        <th>@T("QA.Replacement")</th>
                        <th>@T("QA.Ownedfactory")</th>
                    </tr>
                </thead>

            </table>
            <div id="page" class="row" hidden="hidden"></div>

        </div><!--/表格-->
    </div><!-- / 內容 表格列 -->
    <div class="bottom_btn">
        <div class="col-xs-12" style="padding-top:20px">
            <div class="col-xs-9"></div>
            <div class="col-xs-1">
                <button id="btn-return-inner" type="button" onclick="javascript: self.location = document.referrer;" class="btn btn-primary btn-query">@T("QA.Returnpage")</button>
            </div>
            <div class="col-xs-1">
                <button id="btn-return" type="button" class="btn btn-primary @ViewBag.From">@T("QA.Returnprocesslist")</button>
            </div>
                <div class="col-xs-1">
                    <button id="btn-submit-inner" type="button" class="btn btn-primary btn-query @ViewBag.From">@T("QA.Submit")</button>
                </div>
            </div><!-- /col-次標題與Search keyword -->

    </div>

</section><!-- /.content -->
@section ViewModals{

    <!-- Search Modal -->
    <div class="modal fade" id="js_search_modal" role="dialog">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title">@T("QA.Search")</h4>
                </div>
                <div class="modal-body">
                    <form id="js_form_query" class="form-horizontal" data-need-validate="true">
                        <div class="form-group col-md-6">
                            <input type="hidden" id="CanModify_Search" name="CanModify" value=@ViewBag.CanModify />
                            <input type="hidden" id="FlowChart_Master_UID" name="FlowChart_Master_UID" value=@ViewBag.FlowChart_Master_UID />
                            <input type="hidden" id="master_UID_Hidden" name="QAMaster_UID" value=@ViewBag.MasterUID />
                            <input type="hidden" id="FlowChart_Detail_UID_Search" name="FlowChart_Detail_UID" value=@ViewBag.FlowChart_Detail_UID />
                            <input type="hidden" id="ProductDate_Search" name="ProductDate" value=@ViewBag.ProductDate />
                            <input type="hidden" id="Project_Search" name="ProjectName" value=@ViewBag.Project />
                            <input type="hidden" id="Time_interval_Search" name="Time_interval" value=@ViewBag.Time_interval />

                            <input type="hidden" id="MaterialType_Search" name="MaterialType" value=@ViewBag.MaterialType />
                            <input type="hidden" id="Color_Search" name="Color" value=@ViewBag.Color />


                            <label class="col-sm-4 control-label" data-type="select" for="js_s_select_first_type">@T("QA.Badspecies")</label>
                            <div class="col-sm-8">
                                <select class="form-control input-sm" id="js_s_select_first_type" name="First_Type"></select>
                            </div>
                        </div>
                        <div class="form-group col-md-6">
                            <div class="col-sm-6">
                                <select class="form-control input-sm" id="js_s_select_second_type" name="Second_Type"></select>
                            </div>
                            <div class="col-sm-6">
                                <select class="form-control input-sm" id="js_s_select_three_type" name="Three_Type"></select>
                            </div>
                        </div>


                        <div class="form-group  col-md-6">
                            <label class="col-sm-4 control-label" for="js_s_select_type_name">@T("QA.Typename")</label>
                            <div class="col-sm-8">
                                <input type="text" name="TypeName" class="form-control input-sm" id="js_s_select_type_name" placeholder="@T("QA.Typename")">
                            </div>
                        </div>


                        <div class="form-group col-md-6">
                            <label class="col-sm-4 control-label" for="js_s_input_function_ShortName">@T("QA.Referredto")</label>
                            <div class="col-sm-8">
                                <input type="text" name="ShortName" class="form-control input-sm" id="js_s_input_function_ShortName" placeholder="@T("QA.Referredto")">
                            </div>
                        </div>

                        <div class="form-group col-md-6" hidden="hidden">
                            <label class="col-sm-4 control-label" for="js_s_input_function_name">@T("QA.Typecode")</label>
                            <div class="col-sm-8">
                                <input type="text" name="TypeCode" class="form-control input-sm" id="js_s_input_function_name" placeholder="@T("QA.Typecode")">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-primary btn-sm" id="js_btn_clear" type="button"><i class="fa fa-eraser"></i> @T("QA.Emptied")</button>
                    <button class="btn btn-primary btn-sm" id="js_btn_query" type="button"><i class="fa fa-search"></i> @T("QA.Inquire")</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div class="modal fade" id="js_edit_modal" role="dialog">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title">@T("QA.Edit")</h4>
                </div>
                <form id="js_form_org_edit" class="form-horizontal clearfix">
                    <div class="modal-body">
                        <div class="form-group col-xs-12 col-md-6 col-lg-6">
                            <input type="hidden" name="QualityAssurance_InputMaster_UID" value=@ViewBag.MasterUID />
                            <input type="hidden" id="QualityAssurance_InputDetail_UID_Edit" name="QualityAssurance_InputDetail_UID" />
                            <label class="col-sm-4 control-label" for="js_s_edit_ExceptionTypeName">@T("QA.Baddetail")</label>
                            <div class="col-sm-8">
                                <input type="text" name="ExceptionTypeName" disabled="disabled" class="form-control input-sm" id="js_s_edit_ExceptionTypeName">
                            </div>
                        </div>
                        <div class="form-group col-xs-12 col-md-6 col-lg-6">
                            <label class="col-sm-4 control-label" for="js_s_select_repair_Qty">@T("QA.Rework")</label>
                            <div class="col-sm-8">
                                <input type="text" name="Repair_Qty" class="form-control input-sm" id="js_s_select_repair_Qty" data-rule-digits="true" data-msg-digits="@T("QA.Naturalnumber")" placeholder="@T("QA.Rework")">
                            </div>
                        </div>
                        <div class="form-group col-xs-12 col-md-6 col-lg-6">
                            <label class="col-sm-4 control-label" for="js_s_input_sepcialAccept_Qty">@T("QA.Specialmining")</label>
                            <div class="col-sm-8">
                                <input type="text" name="SepcialAccept_Qty" class="form-control input-sm" id="js_s_input_sepcialAccept_Qty" data-rule-digits="true" data-msg-digits="@T("QA.Naturalnumber")" placeholder="@T("QA.Specialmining")">
                            </div>

                        </div>
                        <div class="form-group col-xs-12 col-md-6 col-lg-6">
                            <label class="col-sm-4 control-label" for="js_s_input_repairNG_Qty">@T("QA.ReworkNG")</label>
                            <div class="col-sm-8">
                                <input type="text" name="RepairNG_Qty" class="form-control input-sm" id="js_s_input_repairNG_Qty" data-rule-digits="true" data-msg-digits="@T("QA.Naturalnumber")" placeholder="@T("QA.ReworkNG")">
                            </div>
                        </div>

                        <div class="form-group col-xs-12 col-md-6 col-lg-6">
                            <label class="col-sm-4 control-label" for="js_s_input_nG_Qty">@T("QA.NG")</label>
                            <div class="col-sm-8">
                                <input type="text" name="NG_Qty" class="form-control input-sm" id="js_s_input_nG_Qty" data-rule-digits="true" data-msg-digits="@T("QA.Naturalnumber")" placeholder="@T("QA.NG")">
                            </div>
                        </div>

                        <div class="form-group col-xs-12 col-md-6 col-lg-6">
                            <label class="col-sm-4 control-label" for="js_s_input_Displace_Qty">@T("QA.Replacements")</label>
                            <div class="col-sm-8">
                                <input type="text" name="Displace_Qty" class="form-control input-sm" id="js_s_input_Displace_Qty" data-rule-digits="true" data-msg-digits="@T("QA.Naturalnumber")" placeholder="@T("QA.Replacements")">
                            </div>
                        </div>

                        <div class="form-group col-xs-12 col-md-6 col-lg-6">
                            <label class="col-sm-4 control-label" for="js_s_input_System_FunPlant_UID">@T("QA.Ownedfactory")</label>
                            <div class="col-sm-8">
                                <select class="form-control input-sm" id="js_s_input_System_FunPlant_UID" name="System_FunPlant_UID"></select>
                            </div>
                        </div>

                        <div class="form-group  col-lg-12">
                            <div class="form-group">
                                <label class="col-sm-2 control-label" for="js_s_input_ModifyReason">@T("QA.Modifyreason")</label>
                                <div class="col-sm-10">
                                    <input type="text" name="ModifyReason" class="form-control input-sm" id="js_s_input_ModifyReason" placeholder="@T("QA.Modifyreason")">
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
                <div class="modal-footer">
                    <button class="btn btn-primary btn-sm" data-dismiss="modal"><i class="fa fa-times"></i> @T("QA.Cancel")</button>
                    <button type="button" class="btn btn-primary btn-sm" id="js_btn_save"><i class="fa fa-save"></i> @T("QA.Save")</button>
                    @*<button type="button" class="btn btn-primary btn-sm" id="js_btn_save_edit"><i class="fa fa-save"></i> Edit Save</button>*@
                </div>
                <div class="col-xs-12"><ul class="list-group validate-error"></ul></div>
            </div>
        </div>
    </div>


    <!-- 删除model-->
    <div class="modal fade" id="js_delete_modal" role="dialog">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title">@T("QA.Removebaddetails")</h4>
                </div>
                <form id="js_form_org_delete" class="form-horizontal clearfix">
                    <div class="modal-body">

                        <div class="form-group  col-lg-12">
                            <div class="form-group">
                                <input type="hidden" name="QualityAssurance_InputMaster_UID" value=@ViewBag.MasterUID />
                                <input type="hidden" id="QualityAssurance_InputDetail_UID_Delete" name="QualityAssurance_InputDetail_UID" />
                                <label class="col-sm-2 control-label" for="js_s_input_deleteReason">@T("QA.Pleasereasondeletion")</label>
                                <div class="col-sm-10">
                                    <input type="text" name="ModifyReason" class="form-control input-sm" id="js_s_input_deleteReason" placeholder="@T("QA.Removecause")">
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
                <div class="modal-footer">
                    <button class="btn btn-primary btn-sm" data-dismiss="modal"><i class="fa fa-times"></i> @T("QA.Cancel")</button>
                    <button type="button" class="btn btn-primary btn-sm" id="js_btn_delete"><i class="fa fa-save"></i> @T("QA.Submit")</button>
                    @*<button type="button" class="btn btn-primary btn-sm" id="js_btn_save_edit"><i class="fa fa-save"></i> Edit Save</button>*@
                </div>
                <div class="col-xs-12"><ul class="list-group validate-error"></ul></div>
            </div>
        </div>
    </div>

    <!-- 不良类型新增Search Modal -->
    <div class="modal fade" id="js_search_add_modal" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title">@T("QA.Search")</h4>
                </div>

                <div class="modal-body">
                    <form id="js_form_add_query" class="form-horizontal" data-need-validate="true">

                        <div class="form-group col-md-6">
                            <label class="col-sm-4 control-label" data-type="select" for="js_s_add_first_type">@T("QA.Badspecies")</label>
                            <div class="col-sm-8">
                                <select class="form-control input-sm" id="js_s_add_first_type" name="First_Type"></select>
                            </div>
                        </div>
                        <div class="form-group col-md-6">
                            <div class="col-sm-6">
                                <select class="form-control input-sm" id="js_s_add_second_type" name="Second_Type"></select>
                            </div>
                            <div class="col-sm-6">
                                <select class="form-control input-sm" id="js_s_add_three_type" name="Three_Type"></select>
                            </div>
                        </div>

                        <div class="form-group col-md-6">
                            <label class="col-sm-4 control-label" for="js_s_add_type_name">@T("QA.Typename")</label>
                            <div class="col-sm-8">
                                <input type="text" name="TypeName" class="form-control input-sm" id="js_s_add_type_name" placeholder="@T("QA.Typename")">
                                <input type="hidden" name="FlowChart_Master_UID" id="js_s_add_Flowchart_Master_UID">
                            </div>
                        </div>

                        <div class="form-group col-md-6">
                            <label class="col-sm-4 control-label" for="js_s_add_function_id">@T("QA.Referredto")</label>
                            <div class="col-sm-8">
                                <input type="text" name="ShortName" class="form-control input-sm" id="js_s_add_function_id" placeholder="@T("QA.Referredto")">
                            </div>
                        </div>

                        <div class="form-group col-md-6" hidden="hidden">
                            <label class="col-sm-4 control-label" for="js_s_add_function_name">@T("QA.Typecode")</label>
                            <div class="col-sm-8">
                                <input type="text" name="TypeCode" class="form-control input-sm" id="js_s_add_function_name" placeholder="Function Name">
                            </div>
                        </div>

                        <div class="form-group col-md-12" hidden="hidden">
                            @*<input type="hidden" name="IsContainsChild" id="IsContainsChild" />*@
                            <label class="col-sm-4 control-label">@T("QA.Includesubclasses"): <input type="radio" checked="checked" name="IsContainsChild" value=true /></label>
                            <label class="col-sm-4 control-label">@T("QA.Notcontainsubclasses"): <input type="radio" name="IsContainsChild" value=false /> </label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-primary btn-sm" id="js_btn_add_clear" type="button"><i class="fa fa-eraser"></i> @T("QA.Emptied")</button>
                    <button class="btn btn-primary btn-sm" id="js_btn_add_query" type="button"><i class="fa fa-search"></i> @T("QA.Inquire")</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 不良类型新增Edit Modal -->
    <div class="modal fade" id="js_edit_add_modal" role="dialog">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title">@T("QA.Edit")</h4>
                </div>
                <div class="modal-body">
                    <form id="js_form_edit" class="form-horizontal" data-need-validate="true">
                        <div class="container-fluid">
                            <div class="row-fluid">
                                <div class="span12">
                                    <div class="row-fluid">
                                        <div class="col-sm-4">
                                            @T("QA.Badtypelist"):<br />
                                            <select class="form-control input-sm" id="sourceSelect" multiple="multiple"></select>

                                        </div>
                                        <div class="col-sm-4">
                                            <br />
                                            <input type="button" class="btn btn-primary btn-sm" style="width:90px;" value="选择" onclick="moveRight();"><br /><br />
                                            <input type="button" class="btn btn-primary btn-sm" style="width:90px;" value="去除" onclick="moveLeft();">

                                        </div>
                                        <div class="col-sm-4">
                                            @T("QA.Selectedbadtypes"):<br />
                                            <select class="form-control input-sm" id="targetSelect" multiple="multiple"></select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                    <div class="modal-footer">
                        <button class="btn btn-primary btn-sm" data-dismiss="modal"><i class="fa fa-times"></i> @T("QA.Emptied")</button>
                        <button type="button" class="btn btn-primary btn-sm" id="js_btn_add_save"><i class="fa fa-save"></i> @T("QA.Save")</button>
                    </div>
                    <div class="col-xs-12"><ul class="list-group validate-error"></ul></div>
                </div>
            </div>
        </div>
    </div>

}

@section ViewScripts{
    <script type="text/javascript">
        $(function () {
            var BadDetailUrls = {
                queryQAInputDetailsByMasterUID: '@Url.Action("QueryQAInputDetailByMasterUID", "Quality")',
                queryQAInputDetails: '@Url.Action("QueryQAInputDetailVM", "Quality")',
                queryInputDetail: '@Url.Action("QueryQAInputDetailVMByUID", "Quality")',
                getType: '@Url.Action("QueryExceptionTypeForSearch", "Quality")',
                getAddType: '@Url.Action("QueryExceptionType", "Quality")',
                getAddSearchType: '@Url.Action("QueryQAExceptionType", "Quality")',
                deleteBadDetail: '@Url.Action("DeleteBadDetail", "Quality")',
                updateQAInputDetail: '@Url.Action("UpdateQAInputDetail", "Quality")',
                modifyQAInputDetail: '@Url.Action("ModifyQAInputDetail", "Quality")',
                insertQAInputDetail: '@Url.Action("InsertQAInputDetail", "Quality")',
                ReworkToPointsList: '@Url.Action("CheckPointsList", "Quality")'
            };
            function GetQueryString(name) {
                var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)");
                var r = window.location.search.substr(1).match(reg);
                if (r != null) return decodeURI(r[2]); return null;
            }
            //#region BadDetailsetting
            var BadDetailsetting = (function () {
                var functionDatatable = null,
                    subDatatable = null,
                    editData = null;
                //#region columns
                var columns = [{
                    data: null,
                    createdCell: function (td, cellData, rowData, row, col) {
                        $(td).html('<input type="checkbox" name="cktrans" class="js-checkbox-item" value="' + rowData.QualityAssurance_InputDetail_UID + '">')
                             .addClass('table-col-checkbox');
                    },
                    className: "min-col-xs"
                },
                {
                    data: null,
                    createdCell: function (td, cellData, rowData, row, col) {
                        var editHtml = '<button type="button" class="btn btn-primary btn-xs js-grid-edit" data-etypeUID="' + rowData.ExceptionType_UID + '"  data-id="' + rowData.QualityAssurance_InputDetail_UID + '">@ViewBag.Edit</button>';
                        var editHtmlDis = '<button type="button" class="btn btn-primary btn-xs js-grid-edit"data-etypeUID="' + rowData.ExceptionType_UID + '"  disabled="true"  data-id="' + rowData.QualityAssurance_InputDetail_UID + '">@ViewBag.Edit</button>';
                        var deletHtml = '<button type="button" class="btn btn-primary btn-xs js-grid-delete" data-etypeUID="' + rowData.ExceptionType_UID + '"  id="' + row + 1 + "_delete" + '"+ data-id="' + rowData.QualityAssurance_InputDetail_UID + '">@ViewBag.Delete</button>';
                        var deletHtmlDis = '<button type="button" class="btn btn-primary btn-xs js-grid-delete"data-etypeUID="' + rowData.ExceptionType_UID + '"  disabled="true" id="' + row + 1 + "_delete" + '"+ data-id="' + rowData.QualityAssurance_InputDetail_UID + '">@ViewBag.Delete</button>';
                        var result = '<button type="button" class="btn btn-default btn-xs" rel="action-popover">' +
                                      '<i class="fa fa-reorder text-info"></i>' +
                                   '</button>' +
                                   '<div class="hidden popover-content">';
                        if (rowData.QualityAssurance_InputDetail_UID == 0){
                            result = result + '</div>';
                        }
                        else if (rowData.Repair_Qty == null) {
                            result = result + deletHtml + '</div>';
                        }
                        else if (rowData.QualityAssurance_InputMaster_UID == 0 || $("#CanModify").val() == false)
                        {
                            result = result + editHtmlDis + '</br>' + deletHtmlDis + '</div>';
                        }
                        else
                        {
                            result = result + editHtml + '</br>' + deletHtml + '</div>';
                        }
                        $(td).html(result);
                    },
                    className: "min-col-xs"
                },
                {
                    data: null,
                    className: "table-col-seq min-col-xs"
                },  
                {
                    data: null,
                    createdCell: function (td, cellData, rowData, row, col) {
                        $(td).html(' <input type="text" class="form-control input-xs text-center"  disabled="disabled"   name="ExceptionTypeName"  value="' + rowData.ExceptionTypeName + '">' +
                                  '  <input type="text"   style="display:none;" name="QualityAssurance_InputDetail_UID"  value="' + rowData.QualityAssurance_InputDetail_UID + '">' +
                               '  <input type="text" style="display:none;"  name="ExceptionType_UID"  value="' + rowData.ExceptionType_UID + '">');
                    },
                    className: "min-col-xs"
                },
                {
                    data: null,
                    createdCell: function (td, cellData, rowData, row, col) {

                        if (rowData.Repair_Qty!=null)
                            $(td).html('  <input type="text" class="form-control input-xs text-center" style="width:80%" disabled="disabled"   name="Repair_Qty"  value="' + rowData.Repair_Qty + '">');
                        else

                            $(td).html('  <input type="text" class="form-control input-xs text-center" style="width:80%" name="Repair_Qty"  value="' + "" + '">');
                    },
                    className: "min-col-xs"
                },
                {
                    data: null,
                    createdCell: function (td, cellData, rowData, row, col) {
                        if ( rowData.SepcialAccept_Qty != null)
                            $(td).html('  <input type="text" class="form-control input-xs text-center" style="width:80%" disabled="disabled"   name="SepcialAccept_Qty"  value="' + rowData.SepcialAccept_Qty + '">');
                        else
                            $(td).html('  <input type="text" class="form-control input-xs text-center" style="width:80%"  name="SepcialAccept_Qty"  value="' + "" + '">');
                    },
                    className: "min-col-xs"
                },
                {
                    data: null,
                    createdCell: function (td, cellData, rowData, row, col) {
                        if (rowData.RepairNG_Qty != null)
                            $(td).html('  <input type="text" class="form-control input-xs text-center" style="width:80%" disabled="disabled"   name="RepairNG_Qty"  value="' + rowData.RepairNG_Qty + '">');
                        else
                            $(td).html('  <input type="text" class="form-control input-xs text-center" style="width:80%"  name="RepairNG_Qty"  value="' + "" + '">');
                    },
                    className: "min-col-xs"
                },
                {
                    data: null,
                    createdCell: function (td, cellData, rowData, row, col) {
                        if (rowData.NG_Qty != null)
                            $(td).html('  <input type="text" class="form-control input-xs text-center" style="width:80%" disabled="disabled"   name="NG_Qty"  value="' + rowData.NG_Qty + '">');
                        else
                            $(td).html('  <input type="text" class="form-control input-xs text-center"style="width:80%"   name="NG_Qty"  value="' + "" + '">');
                    },
                    className: "min-col-lg"
                }, {
                    data: null,
                    createdCell: function (td, cellData, rowData, row, col) {
                        if (rowData.Displace_Qty != null)
                            $(td).html('<input type="text" class="form-control input-xs text-center" style="width:80%" disabled="disabled"  name="Displace_Qty"  value="' + rowData.Displace_Qty + '">');
                        else
                            $(td).html('<input type="text" class="form-control input-xs text-center" style="width:80%" name="Displace_Qty"  value="' + "" + '">');
                    },
                    className: "min-col-lg"
                }, {
                    data: null,
                    createdCell: function (td, cellData, rowData, row, col) {
                        var result;
                        var readOnlyHtml = '<select name="System_FunPlant_UID"  class="form-control input-sm system_funplant_uid"></select>';
                        if (rowData.FunPlants == null || rowData.FunPlants == undefined || rowData.FunPlants.length == 0) {
                            result = readOnlyHtml;
                        }
                        else {
                            var optionSub;
                            var data = rowData.FunPlants;
                            for (i = 0; i < data.length; i++) {
                                if (rowData.System_FunPlant_UID == data[i].System_FunPlant_UID) {
                                    optionSub = '<option value="' + data[i].System_FunPlant_UID + '" selected="selected">' + data[i].FunPlant + '</option>';
                                }
                                else {
                                    optionSub = '<option value="' + data[i].System_FunPlant_UID + '">' + data[i].FunPlant + '</option>';
                                }
                                readOnlyHtml = $(readOnlyHtml).append(optionSub);
                            }
                            result = readOnlyHtml[0].outerHTML;
                        }
                        if (rowData.Displace_Qty != null)
                        {
                            result = $(readOnlyHtml).attr("Disabled", true);
                        }
                        $(td).html(result);
                    },
                    className: "min-col-lg"
                }
                ];
                //#endregion
                var _getParams = function () {
                    return $('#js_form_query').serialize().replace(/\+/g, " ");
                };
                var _queryBadDetails = function (firstLoad) {
                    var config = {
                        pageId: "#page",
                        tableId: "#js_bad_detail_datatable",
                        remoteUrl: BadDetailUrls.queryQAInputDetails,
                        searchParams: _getParams(),
                        tableOptions: {
                            scrollX: true,
                            scrollCollapse: false,
                            autoWidth: true,
                            columns: columns
                        }
                    };
                    if (!firstLoad) {
                        $('#page').page('destroy');
                        PDMS.Utility.Criteria.Build();
                    }
                    PDMS.Utility.Pages.Set(config);
                };
                return {
                    Init: function () {
                        PDMS.Utility.Criteria.Init();
                        _queryBadDetails(true);
                    },
                    QueryBadDetails: function () {
                        _queryBadDetails(false);
                    },
                    GetFunctionDatatable: function () {
                        if (functionDatatable == null) {
                            functionDatatable = $('#js_bad_detail_datatable').DataTable({
                                paging: false,
                                searching: false,
                                ordering: false,
                                retrieve: true,
                                columns: columns,
                            });
                        }
                        return functionDatatable;
                    },
                }
            })();
            //#endregion
            BadDetailsetting.Init();
            //#region Page elements events
            //查询按钮
            $('#js_btn_query').click(function () {
                if ($("#js_form_query").valid()) {
                    BadDetailsetting.QueryBadDetails();
                    $('#js_search_modal').modal('hide');
                }
            });
            //新增不良类型保存按钮点击
            $("#js_btn_add_save").click(function () {
                //先获取选择的不良类型
                var selectType = $("#targetSelect").val();
                if (selectType==null)
                {
                    PDMS.Utility.MessageBox.info("@ViewBag.Selectnewtype "); 
                    return;
                }
                var funPlantValue = {};
                var funPlantInfo = [];
                $.each(selectType, function (i, val) {
                    var sub = {};
                    sub["ExceptionType_UID"] = val;
                    sub["QualityAssurance_InputMaster_UID"] = $("#master_UID_Hidden").val();;
                    sub["QualityAssurance_InputDetail_UID"] = 0;
                    sub["ExceptionTypeName"] = "";
                    sub["IsDeleted"] = false;
                    sub["ModifyReason"] = "";
                    sub["Modified_UID"] = 90014;
                    sub["Creator_UID"] = 90014;
                    sub["CreateDate"] = new Date();
                    sub["Modified_Date"] = new Date();
                    funPlantInfo.push(sub);
                });
                funPlantValue.DataList = funPlantInfo;
                $.post(BadDetailUrls.insertQAInputDetail, { jsonBadType: JSON.stringify(funPlantValue) }, function (data) {
                    $("#js_edit_add_modal").modal('hide');
                    BadDetailsetting.QueryBadDetails();

                    if (data != "Success")
                        PDMS.Utility.MessageBox.error(data);
                    else
                    {
                        PDMS.Utility.MessageBox.info("@ViewBag.Addedsuccessfullys");
                    }
                });
            });
            function banInclude(obj) {
                if (obj.checked) {
                    $("#IsContainsChild").val(true);
                }
            }
            function banUnInclude(obj) {
                if (obj.checked) {
                    $("#IsContainsChild").val(false);
                }
            }
            //查询清除
            $('#js_btn_clear').click(function () {
                PDMS.Utility.Criteria.Clear(function () {
                    $('#js_s_querytype_valid').prop('checked', true);
                });
            });
            //查询页面出现时候绑定值
            $('#js_search_modal').on('show.bs.modal', function (event) {
                var masterUID = $("#master_UID_Hidden").val();
                $("#js_s_select_first_type").empty();
                $("<option></option>")
                            .val("")
                            .text("")
                            .appendTo($("#js_s_select_first_type"));
                var ProductDate = $("#ProductDate_Search").val();
                var Flowchart_Master_UID = $("#FlowChart_Master_UID").val();
                $.post(BadDetailUrls.getType, { typeLevel: 1, parentCode: "", QAMasterUID: masterUID, ProductDate: ProductDate, Flowchart_Master_UID: Flowchart_Master_UID }, function (data) {
                    if (data != "") {
                        $.each(data, function (i, item) {
                            $("<option></option>")
                                .val(item.Org_TypeCode)
                                .text(item.TypeName)
                                .appendTo($("#js_s_select_first_type"));
                        });
                        GetSecondType();
                    }
                });
            });
            //新增页面去除上次选择的
            $('#js_edit_add_modal').on('show.bs.modal', function (event) {
                $("#targetSelect option").remove();
            });
            //获取第二级不良类型
            function GetSecondType() {
                $("#js_s_select_second_type").empty();
                var temp = $("#js_s_select_first_type").val();
                if (temp == "") return;
                var masterUID = $("#master_UID_Hidden").val();
                $("<option></option>")
                            .val("")
                            .text("")
                            .appendTo($("#js_s_select_second_type"));
                var ProductDate = $("#ProductDate_Search").val();
                var Flowchart_Master_UID = $("#FlowChart_Master_UID").val();
                $.post(BadDetailUrls.getType, { typeLevel: 2, parentCode: temp, QAMasterUID: masterUID, ProductDate: ProductDate, Flowchart_Master_UID: Flowchart_Master_UID }, function (data) {
                    if (data != "") {
                        $.each(data, function (i, item) {
                            $("<option></option>")
                                .val(item.Org_TypeCode)
                                .text(item.TypeName)
                                .appendTo($("#js_s_select_second_type"));
                        });
                        GetThirdType();
                    }
                });
            }
            //获取第三阶不良
            function GetThirdType() {
                $("#js_s_select_three_type").empty();
                var temp = $("#js_s_select_second_type").val();
                if (temp == "") return;
                var masterUID = $("#master_UID_Hidden").val();
                $("<option></option>")
                            .val("")
                            .text("")
                            .appendTo($("#js_s_select_three_type"));
                var ProductDate = $("#ProductDate_Search").val();
                var Flowchart_Master_UID = $("#FlowChart_Master_UID").val();
                $.post(BadDetailUrls.getType, { typeLevel: 3, parentCode: temp, QAMasterUID: masterUID,ProductDate:ProductDate,Flowchart_Master_UID:Flowchart_Master_UID }, function (data) {
                    if (data != "") {
                        $.each(data, function (i, item) {
                            $("<option></option>")
                                .val(item.Org_TypeCode)
                                .text(item.TypeName)
                                .appendTo($("#js_s_select_three_type"));
                        });
                    }
                });
            }
            //第一级不良类型改变事件
            $("#js_s_select_first_type").click(function ff() {
                GetSecondType();
                if ($("#js_s_select_first_type").find("option:selected").text() != '') {
                    SetSearchTypeName();
                }
            });
            //第二级不良类型改变事件
            $("#js_s_select_second_type").click(function ff() {
                GetThirdType();
                if ($("#js_s_select_second_type").find("option:selected").text() != '') {
                    $("#js_s_select_type_name").empty();
                    $("#js_s_select_type_name").val($("#js_s_select_second_type").find("option:selected").text());
                }
            });
            //第三级不良类型改变事件
            $("#js_s_select_three_type").click(function ff() {
                if ($("#js_s_select_three_type").find("option:selected").text() != '') {
                    $("#js_s_select_type_name").empty();
                    $("#js_s_select_type_name").val($("#js_s_select_three_type").find("option:selected").text());
                }
            });
            function SetSearchTypeName() {
                var result = $("#js_s_select_first_type").find("option:selected").text();
                if (result == '') {
                    result = $("#js_s_select_second_type").find("option:selected").text();
                    if (result == '') {
                        result = $("#js_s_select_three_type").find("option:selected").text();
                    }
                }
                $("#js_s_select_type_name").empty();
                $("#js_s_select_type_name").val(result);
            }
            $('#js_search_add_modal').on('hide.bs.modal', function (event) {
                $("#js_s_add_type_name").val("");
                $("#js_s_add_function_id").val("");
                $("#js_s_add_function_name").val("");
                $("#js_s_add_first_type").empty();
                $("#js_s_add_second_type").empty();
                $("#js_s_add_three_type").empty();
            });
            $('#js_search_modal').on('hide.bs.modal', function (event) {
                $("#js_s_select_type_name").val("");
                $("#js_s_input_function_ShortName").val("");
                $("#js_s_input_function_name").val("");
                $("#js_s_select_first_type").empty();
                $("#js_s_select_second_type").empty();
                $("#js_s_select_three_type").empty();
            });

            $('#js_edit_select_role_id').on('change', function () {
                $('#js_edit_p_role_name').text($(this).find('option:selected').data('role-name'));
            });
            //#endregion
            //新增弹出窗口的JavaScript*******************************************************************************
            $('#js_btn_add_query').click(function () {

                if ($('#js_form_add_query').valid()) {
                    //获取专案
                    var Flowchart_Master_UID = $("#FlowChart_Master_UID").val();
                    $("#js_s_add_Flowchart_Master_UID").val(Flowchart_Master_UID);
                    //判断是否包含子类
                    var BadType = $('#js_form_add_query').serializeObject()
                    $.post(BadDetailUrls.getAddSearchType, { JsonBadType: JSON.stringify(BadType) }, function (data) {
                        if (data != "") {
                            $.each(data, function (i, item) {
                                $("<option></option>")
                                    .val(item.ExceptionType_UID)
                                    .text(item.TypeName)
                                    .appendTo($("#sourceSelect"));
                            });
                        }
                    });
                    $('#js_search_add_modal').modal('hide');
                    $('#js_edit_add_modal').modal('show');
                }
            });
            //获取第一级不良类型
            $('#js_search_add_modal').on('show.bs.modal', function (event) {
                $("#js_s_add_first_type").empty();
                $('#sourceSelect').empty();
                $('#targetSelect').empty();
                var Flowchart_Master_UID = $("#FlowChart_Master_UID").val();
                $("<option></option>").val("").text("").appendTo($("#js_s_add_first_type"));
                $.post(BadDetailUrls.getAddType, { typeLevel: 1, parentCode: "", Flowchart_Master_UID: Flowchart_Master_UID }, function (data) {
                    if (data != "") {
                        $.each(data, function (i, item) {
                            $("<option></option>")
                                .val(item.Org_TypeCode)
                                .text(item.TypeName)
                                .appendTo($("#js_s_add_first_type"));
                        });
                        GetSecondTypeAdd();
                    }
                });
            });
            //获取第二级不良类型
            function GetSecondTypeAdd() {
                var temp = $("#js_s_add_first_type").val();
                var Flowchart_Master_UID = $("#FlowChart_Master_UID").val();
                if (temp == "") return;
                $("#js_s_add_second_type").empty();
                $("<option></option>").val("").text("").appendTo($("#js_s_add_second_type"));
                $.post(BadDetailUrls.getAddType, { typeLevel: 2, parentCode: temp, Flowchart_Master_UID: Flowchart_Master_UID }, function (data) {
                    $("#js_s_add_three_type").empty();
                    if (data != "") {
                        $.each(data, function (i, item) {
                            $("<option></option>")
                                .val(item.Org_TypeCode)
                                .text(item.TypeName)
                                .appendTo($("#js_s_add_second_type"));
                        });
                        GetThirdTypeAdd();
                    }
                });
            }
            //获取第三阶不良
            function GetThirdTypeAdd() {
                var Flowchart_Master_UID = $("#FlowChart_Master_UID").val();
                var temp = $("#js_s_add_second_type").val();
                if (temp == "") return;
                $("#js_s_add_three_type").empty();
                $("<option></option>").val("").text("").appendTo($("#js_s_add_three_type"));
                $.post(BadDetailUrls.getAddType, { typeLevel: 3, parentCode: temp, Flowchart_Master_UID: Flowchart_Master_UID }, function (data) {
                    if (data != "") {
                        $.each(data, function (i, item) {
                            $("<option></option>")
                                .val(item.Org_TypeCode)
                                .text(item.TypeName)
                                .appendTo($("#js_s_add_three_type"));
                        });
                    }
                });
            }
            //第一级不良类型改变事件
            $("#js_s_add_first_type").click(function ff() {
                GetSecondTypeAdd();
                if ($("#js_s_add_second_type").find("option:selected").text() == '') {
                    SetTypeName();
                }
            });
            //第二级不良类型改变事件
            $("#js_s_add_second_type").click(function ff() {
                GetThirdTypeAdd();
                if ($("#js_s_add_three_type").find("option:selected").text() == '') {
                    SetTypeName();
                }
            });
            $("#js_s_add_three_type").click(function ff() {
                if ($("#js_s_add_three_type").find("option:selected").text() != '')
                {
                    SetTypeName();
                }
            });
            //#endregion
            function SetTypeName()
            {
                var result = $("#js_s_add_three_type").find("option:selected").text();
                if (result=='')
                {
                    result = $("#js_s_add_second_type").find("option:selected").text();
                    if (result == '')
                    {
                        result = $("#js_s_add_first_type").find("option:selected").text();
                    }
                }
                $("#js_s_add_type_name").empty();
                $("#js_s_add_type_name").val(result);
            }
            //保存修改
            $("#js_btn_save").click(function ff() {
                var submitJson = $('#js_form_org_edit').serializeObject();
                if ($("#js_s_input_ModifyReason").val() == "")
                {
                    PDMS.Utility.MessageBox.error("@ViewBag.Modifyreasons"); 
                    return;
                }
                $.post(BadDetailUrls.modifyQAInputDetail, { jsonWithProduct: JSON.stringify(submitJson) }, function (data) {
                    if (data == 'Success') {
                        PDMS.Utility.MessageBox.info("@ViewBag.Successfullymodified"); 
                        //window.location.reload();
                        $('#js_edit_modal').modal('hide');
                        BadDetailsetting.QueryBadDetails();
                    } else {
                        PDMS.Utility.MessageBox.error(data);
                        $('#errorModal').on('click', '.btn-default', function () {
                            BadDetailsetting.QueryBadDetails();
                        });
                    }
                });
            });
            //删除
            $("#js_btn_delete").click(function ff() {
                var InputDetail_UID= $("#QualityAssurance_InputDetail_UID_Delete").val();

                if ($("#js_s_input_deleteReason").val() == "") {
                    PDMS.Utility.MessageBox.error("@ViewBag.Pleasereasondeletion");
                    return;
                }
                var result = {};
                result["QualityAssurance_InputMaster_UID"] = $("#master_UID_Hidden").val();;
                result["ExceptionType_UID"] = 0;
                result["FlowChart_Detail_UID"] = 0;
                result["ExceptionTypeName"] = "";
                result["IsDeleted"] = true;
                result["ModifyReason"] = $("#js_s_input_deleteReason").val();
                result["Modified_UID"] = 0;
                result["Creator_UID"] = 0;
                result["Modified_Date"] = new Date();
                result["CreateDate"] = new Date();
                result["QualityAssurance_InputDetail_UID"] = InputDetail_UID;
                $.post(BadDetailUrls.modifyQAInputDetail, { jsonWithProduct: JSON.stringify(result) }, function (data) {
                    if (data == 'Success') {
                        PDMS.Utility.MessageBox.info("@ViewBag.Successfullydeleted");
                        //window.location.reload();
                        BadDetailsetting.QueryBadDetails();

                    } else {
                        PDMS.Utility.MessageBox.error(data);
                        //window.location.reload();
                        BadDetailsetting.QueryBadDetails();
                    }
                });
                $('#js_delete_modal').modal('hide');
            });
            //Grid中编辑按钮
            $('body').on('click', '.js-grid-edit', function () {
                var $sender = $(this);
                var uuid = $sender.attr('data-id'),
                    url = BadDetailUrls.queryInputDetail;
                $.post(url, { uuid: uuid }, function (data) {
                    var funPlants = data.FunPlants;
                    $('#QualityAssurance_InputDetail_UID_Edit').val(uuid);
                    $('#js_s_edit_ExceptionTypeName').val(data.ExceptionTypeName);
                    $('#js_s_select_repair_Qty').val(data.Repair_Qty);
                    $('#js_s_input_sepcialAccept_Qty').val(data.SepcialAccept_Qty);
                    $('#js_s_input_repairNG_Qty').val(data.RepairNG_Qty);
                    $('#js_s_input_nG_Qty').val(data.NG_Qty);
                    $('#js_s_input_Displace_Qty').val(data.Displace_Qty);
                    if (funPlants != "") {
                        $("#js_s_input_System_FunPlant_UID").empty();
                        $.each(funPlants, function (i, item) {
                            $("<option></option>")
                                .val(item.System_FunPlant_UID)
                                .text(item.FunPlant)
                                .appendTo($("#js_s_input_System_FunPlant_UID"));
                        });
                    }
                    var select = document.getElementById("js_s_input_System_FunPlant_UID");
                    for (var i = 0; i < select.options.length; i++) {
                        if (select.options[i].value == data.System_FunPlant_UID) {
                            select.options[i].selected = true;
                            break;
                        }
                    }
                });
                $('#js_edit_modal').modal('show', $(this));
            });
            //删除 需要判断是否为新增的
            $('body').on('click', '.js-grid-delete', function () {
                var InputDetail_UID = $(this).attr('data-id');
                var dd = $($($($('table[id="js_bad_detail_datatable"]  tr:eq(' + $(this).attr("id").split("_")[0] + ')').find("td")[4])).find("input")[0]).val();
                if (dd != "")  //说明有值不能删除
                {
                    $('#js_delete_modal').modal('show', $(this));
                    $("#QualityAssurance_InputDetail_UID_Delete").val(InputDetail_UID);
                    return;
                }
                else {
                    var result = {};
                    result["ExceptionType_UID"] = 0;
                    result["FlowChart_Detail_UID"] = 0;
                    result["ExceptionTypeName"] = "";
                    result["IsDeleted"] = true;
                    result["QualityAssurance_InputMaster_UID"] = $("#master_UID_Hidden").val();
                    result["ModifyReason"] = "";
                    result["Modified_UID"] = 0;
                    result["Creator_UID"] = 0;
                    result["Modified_Date"] = new Date();
                    result["CreateDate"] = new Date();
                    result["QualityAssurance_InputDetail_UID"] = InputDetail_UID;                   
                    PDMS.Utility.MessageBox.confirm("@ViewBag.Suredelete", function () {
                        $.blockUI({ message: "<h1>@ViewBag.Pleasewait</h1>" });
                        var url = BadDetailUrls.modifyQAInputDetail;
                        $.post(url, { jsonWithProduct: JSON.stringify(result) }, function (data) {
                            $.unblockUI();
                            //window.location.reload();
                            BadDetailsetting.QueryBadDetails();
                        });
                    });
                }
            });
            //保存资料按钮
            $('#btn-submit-inner').click('click', function () {
                var dataTable = BadDetailsetting.GetFunctionDatatable();
                var funPlantValue = {};
                var funPlantInfo = [];
                var flag = true;
                // 首先检查用户输入的数字是否为 自然数
                function checkRate(input) {
                    if (!flag)
                    { return; }
                    var re = /^[0-9]+[0-9]*]*$/;

                    if (!re.test(input)) {
                        PDMS.Utility.MessageBox.error("@ViewBag.Naturalnumber");
                        flag = false;
                    }
                }
                //定义汇总数据变量
                var SumRepairQTY = 0; var SumSepcialAccept = 0; var SumRepairNG = 0; var SumNG = 0; var SumDisplace = 0;
                dataTable.rows().every(function (rowIdx, tableLoop, rowLoop) {
                        var sub = {};
                        var row = $('#js_bad_detail_datatable>tbody>tr').eq(rowIdx);
                        var Repair_Qty = $.trim(row.find('input[name=Repair_Qty]').val());
                        var SepcialAccept_Qty = $.trim(row.find('input[name=SepcialAccept_Qty]').val());
                        var RepairNG_Qty = $.trim(row.find('input[name=RepairNG_Qty]').val());
                        var NG_Qty = $.trim(row.find('input[name=NG_Qty]').val());
                        var detail_UID = $.trim(row.find('input[name=QualityAssurance_InputDetail_UID]').val());
                        var Displace_Qty = $.trim(row.find('input[name=Displace_Qty]').val());
                        var ex_UID = $.trim(row.find('input[name=ExceptionType_UID]').val());
                        var System_FunPlant_UID = $.trim(row.find('.system_funplant_uid option:selected').val());
                        // 用户未输入值时候，系统默认为"0"，输入值提交时 需要验证用户输入的值是否为自然数。
                        if (Repair_Qty == "") {
                            Repair_Qty = 0;
                        }
                        else {
                            checkRate(Repair_Qty);
                        }
                        if (Displace_Qty == "") {
                            Displace_Qty = 0;
                        }
                        else {
                            checkRate(Displace_Qty);
                        }
                        if (SepcialAccept_Qty == "") {
                            SepcialAccept_Qty = 0;
                        }
                        else {
                            checkRate(SepcialAccept_Qty);
                        }
                        if (RepairNG_Qty == "") {
                            RepairNG_Qty = 0;
                        }
                        else {
                            checkRate(RepairNG_Qty);
                        }
                        if (NG_Qty == "") {
                            NG_Qty = 0;
                        }
                        else {
                            checkRate(NG_Qty);
                        }
                        sub["Displace_Qty"] = Displace_Qty;
                        sub["Repair_Qty"] = Repair_Qty;
                        sub["SepcialAccept_Qty"] = SepcialAccept_Qty;
                        sub["RepairNG_Qty"] = RepairNG_Qty;
                        sub["NG_Qty"] = NG_Qty;
                        sub["ExceptionType_UID"] = ex_UID;
                        sub["QualityAssurance_InputMaster_UID"] = $("#master_UID_Hidden").val();
                        sub["QualityAssurance_InputDetail_UID"] = detail_UID;
                        sub["ExceptionTypeName"] = "";
                        sub["IsDeleted"] = false;
                        sub["ModifyReason"] = "";
                        sub["Modified_UID"] = 90014;
                        sub["Creator_UID"] = 90014;
                        sub["CreateDate"] = new Date();
                        sub["Modified_Date"] = new Date();
                        sub["System_FunPlant_UID"] = System_FunPlant_UID;
                        funPlantInfo.push(sub);
                        SumDisplace += parseInt(Displace_Qty);
                        SumNG += parseInt(NG_Qty);
                        SumRepairNG += parseInt(RepairNG_Qty);
                        SumRepairQTY += parseInt(Repair_Qty);
                        SumSepcialAccept += parseInt(SepcialAccept_Qty);
                    });
                funPlantValue.DataList = funPlantInfo;
                if (funPlantInfo.length > 0)
                {
                    if (flag) {
                        PDMS.Utility.MessageBox.confirm("@ViewBag.Numberofrepairs：" + SumRepairQTY + ";" + "       @ViewBag.Numberofspecialmining：" + SumSepcialAccept + ";" + "        @ViewBag.NumberofrepatriationNG：" +
                             SumRepairNG + ";" + "      @ViewBag.NGaggregatedquantity：" + SumNG + ";" + "     @ViewBag.Replacementquantitysummary" + SumDisplace, function () {
                                 $.post(BadDetailUrls.updateQAInputDetail, { jsonBadType: JSON.stringify(funPlantValue) }, function (data) {
                                     if (data == 'Success') {
                                         alert("@ViewBag.Submittedsuccessfully");
                                         BadDetailsetting.QueryBadDetails();
                                     } else {
                                         PDMS.Utility.MessageBox.error(data);

                                         $('#errorModal').on('click', '.btn-default', function () {
                                             BadDetailsetting.QueryBadDetails();
                                         });
                                     }
                                 });
                             });
                    }
                }
                else {
                    PDMS.Utility.MessageBox.error("@ViewBag.BTNAddbaddetails");
                }
            });
            //返回按钮
            $('#btn-return').click(function () {
                var flowchartMasterUID = $('#FlowChart_Master_UID').val();
                var MaterialType = $('#MaterialType_Search').val();
                var Color = $('#Color_Search').val();
                var url = BadDetailUrls.ReworkToPointsList + '?FlowChart_Master_UID=' + flowchartMasterUID + '&&Color=' + Color + '&&MaterialType=' + MaterialType;
                window.location.href = url;
            });
        });
        function moveRight() {
            var sourceSelect = document.getElementById("sourceSelect");
            var targetSelect = document.getElementById("targetSelect");
            while (sourceSelect.options.selectedIndex != -1) {
                targetSelect.options.add(sourceSelect.options.item(sourceSelect.selectedIndex));
            }
        }
        function moveLeft() {
            var sourceSelect = document.getElementById("targetSelect");
            var targetSelect = document.getElementById("sourceSelect");
            while (sourceSelect.options.selectedIndex != -1) {
                targetSelect.options.add(sourceSelect.options.item(sourceSelect.selectedIndex));
            }
        }
    </script>
}
