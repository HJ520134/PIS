@using PDMS.Model.ViewModels;
@{
    ViewBag.Edit = T("Common.Edit").Text;
    ViewBag.setfangong = T("FlowChart.setfangong").Text;
    ViewBag.MaintanceDetailInfo = T("Producton.MaintanceDetailInfo").Text;
    ViewBag.alter1 = T("FlowChart.alter1").Text;
    ViewBag.JustInputPercent = T("Production.JustInputPercent").Text;
    ViewBag.Savesuccessfully = T("QA.Savesuccessfully").Text;
    ViewBag.Processinformationeditpage = T("QA.Processinformationeditpage").Text;
    ViewBag.Imported = T("QA.Imported").Text;
    ViewBag.Importsuccessful = T("QA.Importsuccessful").Text;
    ViewBag.MaintenanceIEDetail = T("Production.MaintenanceIEDetail").Text;
    ViewBag.Pleasewait = T("QA.Pleasewait").Text;

}
<!-- Main content -->
<section class="content portal-content">
    @using (Html.BeginForm("SaveAllFLDetailInfo", "FlowChart", FormMethod.Post, new { id = "js_form_saveall_fl" }))
    {
    <!--次標題 與 搜尋-->
        <div class="row">
            <!--次標題與Search keyword-->
            <div class="col-md-12 col-lg-9">
                <h4 class="margin-td-5" id="js_search_keywords"></h4>
            </div><!-- /col-次標題與Search keyword -->
            <!--col-右方搜尋與功能按鈕列-->
            <div class="col-md-9">
                <label class="control-label" id="lblTitle"></label>
            </div>
            <div class="col-md-3 search-field col-lg-3">
                <button type="button" class="btn btn-primary btn-sm hidden" id="btn_save"><i class="fa fa-save"></i> @T("Common.Save")</button>
                <button type="button" class="btn btn-default btn-sm" id="btn_back"><i class="fa fa-reply"></i> @T("Common.Back")</button>
            </div><!-- /col-右方搜尋與功能按鈕列-->
        </div><!--/次標題 與 搜尋-->
        <hr class="hr-custom">

    <!--內容 表格列-->
        <div class="row">
            <!--表格-->
            <div class="col-md-12 table-container" id="js_saveall_datatables">
                <table class="table table-striped table-hover table-condensed nowrap" id="js_FL_datatable">
                    <thead>
                        <tr>
                            @*<th class="table-col-checkbox nosort">
                                    <input type="checkbox" class="js-checkbox-all" />
                                </th>*@
                            <th class="table-col-action nosort">@T("Common.Action")</th>
                            <th>@T("Production.Binding_Seq")</th>
                            <th>@T("Production.Process_Seq")</th>
                            <th>@T("FlowChart.ZhuGuan")</th>
	                        <th>@T("FlowChart.Place")</th>
	                        <th>@T("FlowChart.Location_Flag")</th>
                            <th>@T("Production.FatherProcess")</th>
                            <th>@T("QA.Process")</th>
                            <th>@T("QA.Functionfactory")</th>
                            <th>@T("FlowChart.Class")</th>
                            <th>@T("QA.Colour")</th>
                            <th>@T("FlowChart.Shuoming")</th>
                            <th>@T("FlowChart.Rework")</th>
                            <th>@T("FlowChart.Jiance")</th>
                            <th>WIP</th>
                            <th>@T("FlowChart.notWIP")</th>
                            <th>@T("Flowchart.CurrentWarehouse")</th>
                            <th>@T("Flowchart.Data_Source")</th>
                            <th>@T("Flowchart.Is_Synchronous")</th>
                        </tr>
                    </thead>
                    <tfoot>
                        <tr>
                            @*<th class="table-col-checkbox nosort"></th>*@
                            <th class="table-col-action nosort">@T("Common.Action")</th>
                            <th>@T("Production.Binding_Seq")</th>
                            <th>@T("Production.Process_Seq")</th>
                            <th>@T("FlowChart.ZhuGuan")</th>
	                        <th>@T("FlowChart.Place")</th>
	                        <th>@T("FlowChart.Location_Flag")</th>
                            <th>@T("Production.FatherProcess")</th>
                            <th>@T("QA.Process")</th>
                            <th>@T("QA.Functionfactory")</th>
                            <th>@T("FlowChart.Class")</th>
                            <th>@T("QA.Colour")</th>
                            <th>@T("FlowChart.Shuoming")</th>
                            <th>@T("FlowChart.Rework")</th>
                            <th>@T("FlowChart.Jiance")</th>
                            <th>WIP</th>
                            <th>@T("FlowChart.notWIP")</th>
                            <th>@T("Flowchart.CurrentWarehouse")</th>
                            <th>@T("Flowchart.Data_Source")</th>
                            <th>@T("Flowchart.Is_Synchronous")</th>
                        </tr>
                    </tfoot>
                </table>
                <div id="page" class="row"></div>

            </div><!--/表格-->
        </div><!-- / 內容 表格列 -->
        <input type="hidden" id="DetailUID" name="DetailUID" value=@ViewBag.DetailUID />
        <input type="hidden" id="IsTemp" name="IsTemp" value=@ViewBag.IsTemp />
        <input type="hidden" id="Version" name="Version" value=@ViewBag.Version />
    }
</section>
<!-- /.content -->

@section ViewModals{

    <div class="modal fade" id="js_edit_modal" role="dialog">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title">@T("QA.Processinformationeditpage")</h4>
                </div>
                @using (Html.BeginForm("EditFLDetailInfo", "FlowChart", FormMethod.Post, new { id = "js_form_edit_fl" }))
                {
                    <div class="modal-body form-horizontal">
                        <div class="row">
                            <input type="hidden" id="FlowChart_Detail_UID" name="FlowChart_Detail_UID" />
                            <input type="hidden" id="Rework_Flag_Old" name="Rework_Flag_old" />
                            <input type="hidden" id="RelatedRepairUID_old" name="RelatedRepairUID_old" />
                            <input type="hidden" id="Process_Seq" name="Process_Seq" />
                            <input type="hidden" id="Binding_Seq" name="Binding_Seq" />

                            <div class="form-group col-xs-12 col-md-6 col-lg-6" style="display:none">
                                <label class="col-sm-5 control-label" for="s_input_dri">@T("FlowChart.ZhuGuan")</label>
                                <div class="col-sm-7">
                                    <input type="text" class="form-control input-sm required" id="s_input_dri" name="DRI" placeholder="@T("FlowChart.ZhuGuan")"
                                           required data-msg-required="@T("FlowChart.InputZhuGuan")">
                                </div>
                            </div>
                            <div class="form-group col-xs-12 col-md-6 col-lg-6">
                                <label class="col-sm-5 control-label" for="s_input_place">@T("FlowChart.Place")</label>
                                <div class="col-sm-7">
                                    <input type="text" class="form-control input-sm required" id="s_input_place" name="Place" placeholder="@T("FlowChart.Place")"
                                           required data-msg-required="@T("FlowChart.InputPlace")">
                                </div>
                            </div>
                            <div class="form-group col-xs-12 col-md-6 col-lg-6">
                                <label class="col-sm-5 control-label" for="s_input_dri">@T("QA.Functionfactory")</label>
                                <div class="col-sm-7">
                                    <select id="js_s_input_funplant_uid" name="System_FunPlant_UID" class="form-control input-sm">
                                        @foreach (var item in ViewBag.FunPlantList)
                                        {
                                            <option value=@item.System_FunPlant_UID>@item.FunPlant</option>
                                        }
                                    </select>
                                </div>
                            </div>
                            <div class="form-group col-xs-12 col-md-6 col-lg-6">
                                <label class="col-sm-5 control-label" for="js_s_input_location_flag">@T("FlowChart.Location_Flag")</label>
                                <div class="col-sm-7">
                                    <select id="js_s_input_location_flag" name="Location_Flag" class="form-control input-sm">
	                                    <option value="true">Y</option>
										<option value="false">N</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group col-xs-12 col-md-6 col-lg-6">
                                <label class="col-sm-5 control-label" for="s_input_dri">@T("Production.FatherProcess")</label>
                                <div class="col-sm-7">
                                    <select id="input_fatherproceeuid" name="FatherProcess_UID" class="form-control input-sm"></select>
                                </div>
                            </div>

                            <div class="form-group col-xs-12 col-md-6 col-lg-6">
                                <label class="col-sm-5 control-label" for="s_input_processdesc">@T("FlowChart.Shuoming")</label>
                                <div class="col-sm-7">
                                    <textarea type="text" class="form-control input-sm" id="s_input_desc" name="Process_Desc" placeholder="@T("FlowChart.Shuoming")"></textarea>
                                </div>
                            </div>
                            <div class="form-group col-xs-12 col-md-6 col-lg-6">
                                <label class="col-sm-5 control-label" for="js_s_input_rework_types">@T("FlowChart.ReworkType")</label>
                                <div class="col-sm-7">
                                    <select class="form-control input-sm" id="js_s_input_rework_types" name="Rework_Flag">
                                        <option value="Rework">@T("FlowChart.Reworkstation")</option>
                                        <option value="Repair">@T("FlowChart.Repair")</option>
                                        <option value="NULL">NULL</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group col-xs-12 col-md-6 col-lg-6">
                                <label class="col-sm-5 control-label" for="js_s_input_check_types">@T("FlowChart.JianceType")</label>
                                <div class="col-sm-7">
                                    <select class="form-control input-sm" id="js_s_input_check_types" name="IsQAProcess">
                                        <option value="Inspect_IPQC">@T("FlowChart.IPQC1")</option>
                                        <option value="Polling_IPQC">@T("FlowChart.IPQC2")</option>
                                        <option value="Inspect_OQC">@T("FlowChart.OQC")</option>
                                        <option value="Inspect_Assemble">@T("FlowChart.zuzhuang")</option>
                                        @*<option value="Inspect_Assemble,Inspect_OQC">@T("FlowChart.OQC2")</option>*@
                                        <option value="">NULL</option>
                                    </select>
                                </div>
                            </div>
                            <div id="js_s_input_rework_binding_seq_div" class="form-group col-xs-12 col-md-6 col-lg-6"  hidden="hidden">
                                <label class="col-sm-5 control-label" for="js_s_input_rework_binding_seq">修复站点绑定序号:</label>
                                <div class="col-sm-7">
                                    <select class="form-control input-sm" id="js_s_input_rework_binding_seq" name="RelatedRepairUID"></select>
                                    <label id="js_s_label_reworksite"></label>
                                </div>
                            </div>
                            <div class="form-group col-xs-12 col-md-6 col-lg-6">
                                <label class="col-sm-5 control-label" for="s_input_WIP">WIP</label>
                                <div class="col-sm-7">

                                    <input type="text" class="form-control input-sm" id="s_input_WIP" name="WIP_QTY" />
                                </div>
                            </div>
                            <div class="form-group col-xs-12 col-md-6 col-lg-6">
                                <label class="col-sm-5 control-label" for="s_input_NullWIP">不可用WIP</label>
                                <div class="col-sm-7">

                                    <input type="text" class="form-control input-sm" id="s_input_NullWIP" name="NullWIP" />
                                </div>
                            </div>

                            <div class="form-group col-xs-12 col-md-6 col-lg-6">
                                <label class="col-sm-5 control-label" for="s_input_Current_WH_QTY">仓库数</label>
                                <div class="col-sm-7">

                                    <input type="text" class="form-control input-sm" id="s_input_Current_WH_QTY" name="Current_WH_QTY" />
                                </div>
                            </div>
                            <div class="form-group col-xs-12 col-md-6 col-lg-6">
                                <label class="col-sm-5 control-label" for="s_input_dri">数据来源</label>
                                <div class="col-sm-7">
                                    <select id="js_s_input_Data_Source" name="Data_Source" class="form-control input-sm">
                                        <option value=""></option>
                                         @foreach (var item in ViewBag.Data_SourceList)
                                        {
                                            <option value="@item.Enum_Value">@item.Enum_Value</option>
                                        }
                                    </select>
                                </div>
                            </div>
                            <div class="form-group col-xs-12 col-md-6 col-lg-6">
                                <label class="col-sm-5 control-label" for="js_s_Is_Synchronous">是否同步</label>
                                <div class="col-sm-7">
                                    <select id="js_s_input_Is_Synchronous" name="Is_Synchronous" class="form-control input-sm">
                                        <option value="true">Y</option>
                                        <option value="false">N</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <div class="col-sm-12">
                                <div class=" pull-right">
                                    <button type="button" class="btn btn-primary btn-sm" id="btn_save_edit"><i class="fa fa-save"></i> @T("Common.Save")</button>
                                    <button class="btn btn-default btn-sm" data-dismiss="modal"><i class="fa fa-times"></i> @T("Common.Cancel")</button>
                                </div>
                            </div>
                        </div>
                     

                    </div>
                    <!--jquery validata error container-->
                        <div class="col-xs-12"><ul class="list-group validate-error"></ul></div>
                }
            </div>
        </div>

    </div>
}


@section ViewScripts{
    <script type="text/javascript">
        $(function () {
            var FLDetail = (function () {
                var urls = {
                    queryFLS: '@Html.Raw(Url.Action("QueryFLDetailList", "FlowChart", new { id=ViewBag.ID,IsTemp=ViewBag.IsTemp,Version=ViewBag.Version }))',
                    backFL: '@Url.Action("FlowChartList", "FlowChart")',
                    queryFLDetail: '@Url.Action("QueryFLDetailByID","FlowChart")',
                    SaveFLDetail: '@Html.Raw(Url.Action("EditFLDetailInfo", "FlowChart", new { id=ViewBag.ID,IsTemp=ViewBag.IsTemp,Version=ViewBag.Version}))',
                    SaveAllDetail: '@Url.Action("SaveAllDetailInfo","FlowChart")'
                };

                var contentDatatable = null;
                var columns = [
                {
                    createdCell: function (td, cellData, rowData, row, col) {
                        
                        var IsTemp = '@ViewBag.IsTemp';
                        if (IsTemp == 'False') {
                            var hiddenHtml = '<input type="hidden" name="cktrans" value=' + rowData.FlowChartDetailDTO.FlowChart_Detail_UID + '>'
                                + '<input type="hidden" name="flowchartUID" value="' + rowData.FlowChartDetailDTO.FlowChart_Detail_UID + '">'
                                + '<input type="hidden" name="processSeq" value="' + rowData.FlowChartDetailDTO.Process_Seq + '">'
                                + '<input type="hidden" name="process" value="' + rowData.FlowChartDetailDTO.Process + '">'
                                + '<input type="hidden" name="color" value="' + rowData.FlowChartDetailDTO.Color + '">'
                                + '<input type="hidden" name="place" value="' + rowData.FlowChartDetailDTO.Place + '">'
                                + '<input type="hidden" name="bindingSeq" value="' + rowData.FlowChartDetailDTO.Binding_Seq + '">'
                                + '<input type="hidden" name="reworkFlag" value="' + rowData.FlowChartDetailDTO.Rework_Flag + '">'
                                + '<input type="hidden" name="relatedRepairUID" value="' + rowData.FlowChartDetailDTO.RelatedRepairUID + '">';
                            var buttonEdit = '<button type="button" class="btn btn-default btn-sm js-grid-edit" data-id="' + rowData.FlowChartDetailDTO.FlowChart_Detail_UID + '">@ViewBag.Edit</button>';
                            var buttonRework = '<button type="button" class="btn btn-default btn-sm js-grid-info" data-id="' + rowData.FlowChartDetailDTO.FlowChart_Detail_UID + '">@ViewBag.setfangong</button>';
                            var result = '<button type="button" class="btn btn-default" rel="action-popover">' +
                                '<i class="fa fa-reorder"></i>' +
                                '</button>' +
                                '<div class="hidden popover-content">';
                            result = hiddenHtml + buttonEdit;
                            $(td).html(result);

                        }
                        else {
                            $(td).html('');
                        }
                    },
                    className: "text-center"
                }, {
                    data: "FlowChartDetailDTO.Binding_Seq",
                    className: "min-col-xs Binding_Seq"
                }, {
                    data: "FlowChartDetailDTO.Process_Seq",
                    className: "min-col-xs Process_Seq"
                }, {
                    data: "FlowChartDetailDTO.DRI",
                    className: "min-col-xs DRI"
                }, {
                    data: "FlowChartDetailDTO.Place",
                    className: "min-col-xs"
                }, {
                    data: "FlowChartDetailDTO.Location_Flag",
                    className: "min-col-xs text-center",
					createdCell: function (td, cellData, rowData, row, col) {
					    if (cellData == true) {
					        $(td).html("Y");
					    } else {
					        $(td).html("N");
					    }
                    }
                },{
                    data: "FlowChartDetailDTO.FatherProcess",
                    className: "min-col-xs"
                }, {
                    data: "FlowChartDetailDTO.Process",
                    className: "min-col-xs"
                }, {
                    data: "FunPlant",
                    className: "min-col-xs"
                }, {
                    data: "FlowChartDetailDTO.Product_Stage",
                    className: "min-col-xs"
                }, {
                    data: "FlowChartDetailDTO.Color",
                    className: "min-col-xs"
                }, {
                    data: "FlowChartDetailDTO.Process_Desc",
                    className: "min-col-xs",
                    createdCell: function (td, cellData, rowData, row, col) {
                        var html = rowData.FlowChartDetailDTO.Process_Desc;
                        if (html != null) {
                            if (html.length > 40) {
                                var result = html.substring(0, 40) + "<br/>" + html.substring(40, html.length);
                                $(td).html(result);
                            }
                            else {
                                $(td).html(html);
                            }

                        }
                    }
                }, {
                    data: "FlowChartDetailDTO.Rework_Flag",
                    className: "min-col-xs"
                },
                {
                    data: "FlowChartDetailDTO.IsQAProcessName",
                    className: "min-col-xs"
                },
                 {
                     data: "FlowChartDetailDTO.WIP_QTY",
                     className: "min-col-xs"
                 },
                   {
                       data: "FlowChartDetailDTO.NullWip",
                       className: "min-col-xs"
                   },
                     {
                         data: "FlowChartDetailDTO.Current_WH_QTY",
                         className: "min-col-xs"
                     }
                     ,
                     {
                         data: "FlowChartDetailDTO.Data_Source",
                         className: "min-col-xs"
                     }
                     ,
                     {
                         data: "FlowChartDetailDTO.Is_Synchronous",
                         className: "min-col-xs",
                         createdCell: function (td, cellData, rowData, row, col) {
                             if (cellData == true) {
                                 $(td).html("Y");
                             } else {
                                 $(td).html("N");
                             }
                         }
                     }
                ];

                var CalculateSum = function (num1, num2) {
                    var baseNum = 0;
                    try {
                        baseNum += num1.toString().split(".")[1].length;
                    } catch (e) {
                    }
                    try {
                        baseNum += num2.toString().split(".")[1].length;
                    } catch (e) {
                    }
                    return Number(num1.toString().replace(".", "")) * Number(num2.toString().replace(".", "")) / Math.pow(10, baseNum);
                };

                var _queryFLS = function (firstLoad) {

                    var config = {
                        pageId: "#page",
                        tableId: "#js_FL_datatable",
                        remoteUrl: urls.queryFLS,

                        tableOptions: {
                            //scrollX: true,
                            //autoWidth: true,
                            //scrollCollapse: true,
                            //paging: false,
                            //fixedColumns: true,
                            //scrollY: 500,

                            //fixedHeader:true,
                            fixedHeader: {
                                header: true,
                                footer: true
                            },
                            columns: columns
                        }

                    };

                    //$.blockUI({ message: "<h1>正在加载，请稍后...</h1>" });
                    PDMS.Utility.Pages.Set(config);
                    var IsTemp = '@ViewBag.IsTemp';
                    if (IsTemp != 'False') {
                        $('#btn_save').hide();
                    }
                };

                return {
                    urls: urls,
                    Init: function () {
                        //$.blockUI({ message: "<h1>读取中，请稍后...</h1>" });
                        _queryFLS(true);
                        var title = '@ViewBag.CustomerName' + ' ' + '@ViewBag.ProjectName' + ' ' + '@ViewBag.PartTypes' + ' ' + '@ViewBag.ProductPhase' + '@ViewBag.MaintanceDetailInfo'
                        $('#lblTitle').text(title);
                        @*var noAccess = '@ViewBag.NoAccess';
                        if (noAccess != 'False') {
                            PDMS.Utility.MessageBox.info("@ViewBag.alter1");
                        }*@
                        //$.unblockUI();
                    },
                    QueryFLCharts: function () {
                        _queryFLS(false);
                    },
                    GetDataTables: function () {
                        if (contentDatatable == null) {
                            contentDatatable = $('#js_FL_datatable').DataTable({
                                paging: false,
                                searching: false,
                                ordering: false,
                                retrieve: true,
                                columns: columns,
                            });
                        }
                        return contentDatatable;
                    }
                }
            })();

            FLDetail.Init();

            //$("tbody").attr("id", "droppable");
            //$("#droppable").dragsort({ dragSelector: "tr", dragEnd: saveOrder });
            //function saveOrder() {
            //}

            $('#js_form_edit_fl').validate({
                errorContainer: $('ul.validate-error'),
                errorLabelContainer: $('#js_edit_modal ul.validate-error'),
                wrapper: 'li'
            });

            //$('#js_form_saveall_fl').validate({
            //    errorContainer: $('ul.validate-error'),
            //    errorLabelContainer: $('#js_saveall_datatables ul.validate-error'),
            //    wrapper: 'li'
            //});

            $('#btn_back').on('click', function () {
                var url = FLDetail.urls.backFL;
                window.location.href = url;
            });

            jQuery.validator.addMethod("percent", function (value, element) {
                var reg = /^((\d+\.?\d*)|(\d*\.\d+))\%$/;
                var result = reg.test(value);
                return result;
            }, "@ViewBag.JustInputPercent");

            $('#btn_save').on('click', function () {
                $.blockUI({ message: "<h1>@ViewBag.Pleasewait</h1>" });
                var url = FLDetail.urls.backFL;
                if ($('#js_form_saveall_fl').valid()) {
                    var dataTable = FLDetail.GetDataTables();
                    var jsonTable = [];
                    //var submitJson = $('#js_form_saveall_fl').serializeObject();
                    dataTable.rows().every(function (rowIdx, tableLoop, rowLoop) {
                        var rowData = {};
                        var row = $('#js_FL_datatable>tbody>tr').eq(rowIdx);
                        var keyID = $.trim(row.find('input[name=cktrans]').val());
                        rowData["FlowChart_Detail_UID"] = keyID;
                        var inputPlanID = 'input[name=Product_Plan' + rowIdx + ']';
                        var Product_Plan = $.trim(row.find(inputPlanID).val());
                        rowData["Product_Plan"] = Product_Plan;
                        var inputTargetID = 'input[name=Target_Yield' + rowIdx + ']';
                        var Target_Yield = $.trim(row.find(inputTargetID).val());
                        rowData["Target_Yield"] = Target_Yield;
                        jsonTable.push(rowData);
                    });
                    //submitJson.jsonTable = jsonTable;

                    $.post(FLDetail.urls.SaveAllDetail, { jsonDataTable: JSON.stringify(jsonTable) },
                        function (data) {
                            $.unblockUI();
                            PDMS.Utility.MessageBox.info("@ViewBag.Savesuccessfully");
                            window.location.reload();
                        });
                    //$('#js_form_saveall_fl').submit();
                }
            });




            //#region  div弹出编辑画面

            //#region 点击DataTable弹出div并加载信息
            $('body').on('click', '.js-grid-edit', function () {
                var FlowChart_Detail_UID = $(this).attr('data-id');
                $('#FlowChart_Detail_UID').val(FlowChart_Detail_UID);
                $.get(FLDetail.urls.queryFLDetail, { FlowChart_Detail_UID: FlowChart_Detail_UID }, function (data) {
                    //用隐藏标签保存要编辑的制程信息
                    $('#Rework_Flag_old').val(data.FlowChartDetailDTO.Rework_Flag);
                    $('#RelatedRepairUID_old').val(data.FlowChartDetailDTO.RelatedRepairUID);
                    $('#Process_Seq').val(data.FlowChartDetailDTO.Process_Seq);
                    $('#s_input_WIP').val(data.FlowChartDetailDTO.WIP_QTY);
                    $('#s_input_Current_WH_QTY').val(data.FlowChartDetailDTO.Current_WH_QTY);
                    $('#s_input_NullWip').val(data.FlowChartDetailDTO.NullWip);
                    $('#s_input_dri').val(data.FlowChartDetailDTO.DRI);
                    $('#s_input_place').val(data.FlowChartDetailDTO.Place);
                    $('#js_s_input_funplant_uid').val(data.FlowChartDetailDTO.System_FunPlant_UID);
                    $('#s_input_color').val(data.FlowChartDetailDTO.Color);
                    $('#s_input_stage').val(data.FlowChartDetailDTO.Product_Stage);
                    $('#s_input_materialno').val(data.FlowChartDetailDTO.Material_No);
                    $('#s_input_desc').val(data.FlowChartDetailDTO.Process_Desc);
                    var location_flag = data.FlowChartDetailDTO.Location_Flag == true? 'true':'false';
                    $("#js_s_input_location_flag").val(location_flag);
                    $('#js_s_input_Data_Source').val(data.FlowChartDetailDTO.Data_Source);
                    debugger;
                    var is_Synchronous = data.FlowChartDetailDTO.Is_Synchronous == true ? 'true' : 'false';
                    $('#js_s_input_Is_Synchronous').val(is_Synchronous);
                    var rework_flag = data.FlowChartDetailDTO.Rework_Flag;
                    if (rework_flag == null)
                        $("#js_s_input_rework_types").val("NULL");
                    else
                        $("#js_s_input_rework_types").val(rework_flag);
                    var qa_flag = data.FlowChartDetailDTO.IsQAProcess;
                    $("#js_s_input_check_types").val(qa_flag);
                    var optionstring = "";
                    var emptyOption = "<option value=''></option>";
                    $.each(data.FatherProcess, function (key, value) {
                        optionstring += "<option value=" + key + ">" + value + "</option>";
                    });
                    $("#input_fatherproceeuid").html(emptyOption + optionstring);
                    $("#input_fatherproceeuid").val(data.FlowChartDetailDTO.FatherProcess_UID);
                    //for (var i = 0; i < data.FatherProcess.length; i++) {
                    //    optionstring += "<option value=" + data.FatherProcess[] >" + jsonObj[j].chinesename + "</option>";
                    //}
                    //绑定下拉框

                    $('#js_edit_modal').find('.modal-title').text(data.FunPlant + "@ViewBag.Processinformationeditpage");

                    //处理返修逻辑begin ********************
                    
                    $("#js_s_label_reworksite").html("");
                    var dataTable = FLDetail.GetDataTables();
                    //当前制程为Repair, 并且有关联的Rework 制程则不可选择“Rework”选项
                    var canRework = true;
                    if (rework_flag.toLowerCase() == 'repair') {
                        dataTable.rows().every(function (rowIdx, tableLoop, rowLoop) {
                            var row = $('#js_FL_datatable>tbody>tr').eq(rowIdx);
                            var relativeRepairUID = $.trim(row.find('input[name=relatedRepairUID]').val());
                            if (relativeRepairUID == FlowChart_Detail_UID) {
                                canRework = false;
                            }
                        });
                    }
                    if (canRework) {
                        //返工站点设为可选
                        $("#js_s_input_rework_types").children("[value='Rework']").attr("disabled", false);

                        //清空原选项
                        var reworkSelect = $("#js_s_input_rework_binding_seq");
                        reworkSelect.empty();
                        var currentProcessSeq = $('#Process_Seq').val();

                        //遍历所有制程，将可返修的制程的绑定序号绑定到下拉框
                        dataTable.rows().every(function (rowIdx, tableLoop, rowLoop) {
                            var row = $('#js_FL_datatable>tbody>tr').eq(rowIdx);

                            var processSeq = $.trim(row.find('input[name=processSeq]').val());
                            var reworkFlag = $.trim(row.find('input[name=reworkFlag]').val());
                            //只能返修到上游制程并且Rework_Flag="Repair"
                            if (parseInt(processSeq) < parseInt(currentProcessSeq) && reworkFlag.toLocaleLowerCase() == "repair") {
                                var flowChartUID = $.trim(row.find('input[name=cktrans]').val());
                                var process = $.trim(row.find('input[name=process]').val());
                                var color = $.trim(row.find('input[name=color]').val());
                                var place = $.trim(row.find('input[name=place]').val());
                                var bindingSeq = $.trim(row.find('input[name=bindingSeq]').val());

                                var relativeRepairUID = $('#RelatedRepairUID_old').val();

                                //修复站点绑定序号绑数据 value:flowChartUID, text:processSeq;
                                var option = $("<option>").val(flowChartUID).text(bindingSeq).attr("process", process).attr("bindingSeq", bindingSeq).attr("color", color).attr("place", place);
                                reworkSelect.append(option);
                            }
                        });

                        //如果当前编辑制程已有指定返修制程，则在下拉框选中返修制程
                        
                        if (reworkSelect[0].options.length > 0 && rework_flag.toLowerCase() == 'rework') {
                            var relativeRepairUID = $('#RelatedRepairUID_old').val();
                            $("#js_s_input_rework_binding_seq").val(relativeRepairUID);
                            $("#js_s_input_rework_binding_seq_div").show();

                            var selectedOption = $("#js_s_input_rework_binding_seq").children('option:selected');
                            if (selectedOption.val().toLowerCase() != "null") {
                                var process = selectedOption.attr("process");
                                var color = selectedOption.attr("color");
                                var place = selectedOption.attr("place");
                                //列出选中制程的重要信息
                                $("#js_s_label_reworksite").html("@T("QA.Process"):" + process + ";" + "@T("QA.Colour"):" + color + ";" + "@T("FlowChart.Place"):" + place);
                            } else {
                                $("#js_s_label_reworksite").html("");
                            }
                        } else {
                            $("#js_s_input_rework_binding_seq_div").hide();
                        }

                    } else {
                        //返工站点设为不可选
                        $("#js_s_input_rework_types").children("[value='Rework']").attr("disabled", true);
                        $("#js_s_input_rework_binding_seq_div").hide();
                    }
                    //处理返修逻辑end ********************
                });
                $('#js_edit_modal').modal('show');

                $("#js_s_input_rework_types").change(function () {
                    var reworkTypeValue = $(this).children('option:selected').val();
                    if (reworkTypeValue == "Rework") {
                        $("#js_s_input_rework_binding_seq_div").fadeIn(500);
                    } else {
                        $("#js_s_input_rework_binding_seq_div").fadeOut(500);
                    }
                });

                $("#js_s_input_rework_binding_seq").change(function () {
                    //选项数目>1 才有可选的选项
                    if ($(this).children('option').length > 0) {
                        var selectedOption = $(this).children('option:selected');
                        if (selectedOption.val().toLowerCase() != "null") {
                            var process = selectedOption.attr("process");
                            var color = selectedOption.attr("color");
                            var place = selectedOption.attr("place");
                            //列出选中制程的重要信息
                            $("#js_s_label_reworksite").html("@T("QA.Process"):" + process + ";" + "@T("QA.Colour"):" + color + ";" + "@T("FlowChart.Place"):" + place);
                        } else {
                            $("#js_s_label_reworksite").html("");
                        }
                    }
                });

            });

            //#endregion 点击DataTable弹出div并加载信息

            //#region 保存单笔修改的信息
            $('#btn_save_edit').on('click', function () {
                this.form.action = FLDetail.urls.SaveFLDetail;
                $('#js_form_edit_fl').submit();
            });
            //#endregion 保存单笔修改的信息

            //隐藏modal框时清空值
            $('#js_edit_modal').on('hidden.bs.modal', function (e) {
                $('#js_edit_modal').find('input').val('');
                $('.list-group.validate-error').empty();
            });
            //#endregion 隐藏modal框时清空值

            //#endregion

        });
    </script>
}
